<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <title>åœ†æ£’å…¥åº“æ•°æ®ç®¡ç†-AIæµ‹è¯•</title>
    <link rel="stylesheet" href="https://unpkg.com/mdui@2/mdui.css">
    
    <script src="https://unpkg.com/mdui@2.0.3/mdui.global.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<style>
    /* ğŸ¨ å…¨å±€æ ·å¼ä¸é»‘æš—æ¨¡å¼ */
    :root {
        --primary-color: #00796b;
        --background-color: #f5f5f5;
        --surface-color: #ffffff;
        --text-color: #212121;
        --border-color: #e0e0e0;
        --drawer-icon-size: 24px;
    }

    body.dark-mode {
        --primary-color: #80cbc4; 
        --background-color: #121212; 
        --surface-color: #1e1e1e; 
        --text-color: #ffffff;
        --border-color: #333333;
    }

    body.mdui-theme-dark {
        --mdui-theme-color-surface: var(--surface-color);
        --mdui-theme-color-background: var(--background-color);
        --mdui-theme-color-primary: var(--primary-color);
        --mdui-top-app-bar-background-color: var(--surface-color);
    }
    
    .data-form input, .data-form select, .search-bar input {
        background-color: var(--background-color);
        color: var(--text-color);
    }
    
    .search-bar {
        background-color: var(--background-color); 
    }

    body {
        font-family: 'Roboto', 'Helvetica', 'Arial', sans-serif;
        margin: 0;
        padding-bottom: 0; 
        background-color: var(--background-color);
        color: var(--text-color);
        transition: background-color 0.3s, color 0.3s;
    }
    
    /* ğŸŒŸ é¡¶éƒ¨å›ºå®šåŒºåŸŸæ ·å¼ ğŸŒŸ */
    .top-fixed-area {
        position: sticky;
        top: 0;
        z-index: 100;
        background-color: var(--surface-color);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 8px 16px 0 16px;
    }
    
    .action-bar {
        display: flex;
        align-items: center; 
        justify-content: flex-start;
        gap: 8px;
        flex-wrap: nowrap; 
        background-color: var(--surface-color);
        padding-bottom: 8px;
    }

    .search-bar {
        display: flex;
        align-items: center;
        border-radius: 8px;
        padding: 4px 8px;
        flex-grow: 1;
        width: 50%;
        max-width: 400px;
        border: 1px solid var(--border-color);
    }

    .search-bar input {
        border: none;
        outline: none;
        background: none;
        padding: 8px;
        flex-grow: 1;
        min-width: 0;
    }
    
    /* æœç´¢æ›¿æ¢å®¹å™¨ */
    .search-replace-container {
        padding: 8px 0;
        margin-bottom: 8px;
        border-top: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .search-replace-row {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .search-replace-row input {
        flex-grow: 1;
        padding: 8px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        box-sizing: border-box;
        background-color: var(--background-color);
        color: var(--text-color);
    }
    
    .search-replace-row mdui-button {
        flex-shrink: 0;
    }

    .search-clear-btn {
        display: none;
        cursor: pointer;
        color: #757575;
    }

    .search-clear-btn.active {
        display: inline-block;
    }
    
    .batch-action-container {
        width: 100%;
        padding: 0 0 8px 0;
        background-color: var(--surface-color);
        border-top: 1px solid var(--border-color);
        margin-top: -1px; 
    }

    .item-count {
        padding: 8px 16px;
        font-size: 0.9rem;
        color: #757575;
        background-color: var(--surface-color);
        border-top: 1px solid var(--border-color);
    }
    
    /* è¡¨å•è¾“å…¥æ¡†æ ·å¼ */
    .data-form {
        padding: 16px;
    }
    .data-form input, .data-form select {
        width: 100%;
        padding: 10px;
        margin-bottom: 12px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        box-sizing: border-box;
    }

    .data-form label {
        display: block;
        margin-bottom: 4px;
        font-size: 0.9rem;
        color: #757575;
    }
    
    #remarks {
        height: 200px; 
        font-size: 16px; 
    }
    
    .readonly-input {
         cursor: pointer !important;
         background-color: #e0e0e0 !important;
    }
    
    .dark-mode .readonly-input {
         background-color: #333333 !important;
    }

    .empty-state {
        text-align: center;
        padding: 50px 20px;
        color: #757575;
        height: 1000px;
        display: none;
    }
    
    /* è™šæ‹Ÿé”®ç›˜æ ·å¼ */
    #virtualKeyboard {
        position: fixed;
        bottom: 0; 
        left: 0;
        width: 100%;
        background-color: var(--surface-color);
        border-top: 1px solid var(--border-color);
        padding: 5px;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
        z-index: 2000; 
        display: none;
        box-sizing: border-box;
    }
    
    .keyboard-row {
        display: flex;
        justify-content: center;
        margin-bottom: 5px;
    }

    .keyboard-key {
        background-color: var(--background-color);
        color: var(--text-color);
        flex: 1;
        margin: 3px;
        padding: 10px 5px;
        border-radius: 8px;
        text-align: center;
        font-size: 1rem;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.1s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .keyboard-key:active {
        background-color: var(--primary-color);
        color: #ffffff;
    }

    .special {
        background-color: #bdbdbd;
        color: #212121;
    }

    .dark-mode .special {
        background-color: #424242;
        color: #ffffff;
    }

    .wide { flex: 1.5; }
    .extra-wide { flex: 5; }
    
    #shortcutContainer {
        padding: 5px 0;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 5px;
        overflow-x: auto;
        white-space: nowrap;
    }
    
    #shortcutContainer .keyboard-row {
        flex-wrap: nowrap;
        justify-content: flex-start;
    }

    .shortcut-key, .status-key {
        flex: none;
        padding: 8px 12px;
        margin: 3px;
    }

    .clear-key { background-color: #f44336 !important; color: white !important; }
    .system-keyboard { background-color: #2196f3 !important; color: white !important; }
    
    /* è¡¨æ ¼æ•´ä½“ç¼©æ”¾å®¹å™¨ï¼ˆå…³é”®ä¿®æ”¹ï¼‰ */
    .data-table-container {
        overflow-x: auto; 
        overflow-y: auto; 
        min-width: 100%
        max-height: calc(100vh - 120px);
        margin-top: 0;
        padding: 0 8px;
        -webkit-overflow-scrolling: touch;
        transform-origin: top left;
        transition: transform 0.2s ease-out;
    }

    #dataTable {
        width: 100%;
        border-collapse: collapse;
        table-layout: auto;
    }
    
    /* å†»ç»“è¡¨å¤´ */
    #dataTable th {
        position: sticky;
        top: 0; 
        z-index: 50; 
        background-color: var(--surface-color);
        box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1); 
        font-weight: 500;
        border-bottom: 2px solid var(--border-color);
    }

    /* å•å…ƒæ ¼ï¼ˆå·²å»é™¤æ‰€æœ‰ calc * scaleï¼Œæ”¹ä¸ºå›ºå®šå€¼ï¼‰ */
    #dataTable th, #dataTable td {
        padding: 12px 8px; 
        border: 1px solid var(--border-color);
        text-align: center;
        white-space: normal;
        word-break: break-word;
        font-size: 1rem; 
        min-width: 80px; 
        max-width: 300px;
        overflow: visible;
    }
    
    .action-col   { min-width: 100px; width: 100px; max-width: 100px; }
    .seq-col      { min-width: 60px; width: 60px; position: relative; }
    .checkbox-col { min-width: 50px; width: 50px; }
    .remark-col   { min-width: 150px; max-width: 300px; }
    
    .delete-btn { color: #f44336; }

    .selected {
        background-color: rgba(0, 121, 107, 0.1) !important;
    }
    .dark-mode .selected {
        background-color: rgba(128, 203, 196, 0.2) !important;
    }

    .highlight {
        background-color: rgba(255, 193, 7, 0.3) !important;
        transition: background-color 0.5s ease-out;
    }
    
    /* æœç´¢æ›¿æ¢é«˜äº® */
    .search-match-highlight {
        background-color: #ffc107; 
        font-weight: bold;
        color: #212121;
    }
    .dark-mode .search-match-highlight {
        background-color: #ffd54f; 
        color: #212121;
    }
    .current-match-highlight {
        outline: 2px solid var(--primary-color);
        outline-offset: -2px;
    }
    
    /* ç§»åŠ¨æŒ‰é’® */
    .move-buttons {
        display: none;
        flex-direction: column;
        position: absolute;
        left: 0; top: 0;
        height: 100%;
        justify-content: center;
        z-index: 10;
        background-color: rgba(255, 255, 255, 0.8);
        border-right: 1px solid var(--border-color);
        padding: 0 4px;
    }
    .dark-mode .move-buttons { background-color: rgba(30, 30, 30, 0.8); }
    #dataTable tr:hover .move-buttons { display: flex; }
    
    .move-btn {
        background: none;
        border: none;
        padding: 2px;
        cursor: pointer;
        margin: 1px 0;
        color: var(--primary-color);
        transition: color 0.1s;
    }
    .move-btn:hover { color: #f44336; }
    
    #dataTable td, #dataTable th { position: relative; }
    
    /* è‡ªå®šä¹‰ Modal/Sheet æ ·å¼ */
    .modal-custom {
        display: none; 
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.4);
        z-index: 1050; 
    }
    
    .modal-content-custom {
        background-color: var(--surface-color);
        margin: 15% auto; 
        padding: 0;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        width: 90%; 
        max-width: 500px; 
        display: flex;
        flex-direction: column;
        max-height: 90vh; 
    }

    .full-height-custom .modal-content-custom {
        width: 100%;
        max-width: 100%;
        height: 100%;
        margin: 0;
        border-radius: 0; 
    }

    .modal-header-custom {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        height: 56px;
        border-bottom: 1px solid var(--border-color);
        position: sticky; 
        top: 0; 
        background-color: var(--surface-color);
        z-index: 10;
    }
    
    .modal-header-custom h2 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 500;
    }

    .modal-body-custom {
        padding: 16px; 
        overflow-y: auto; 
        flex-grow: 1; 
    }
    
    .full-height-custom .modal-body-custom {
        max-height: calc(100vh - 120px); 
        height: calc(100vh - 120px);
        padding: 0; 
    }
    
    #calculatorModalCustom .modal-body-custom {
        max-height: calc(100vh - 370px); 
        height: auto;
        overflow-y: scroll; 
        padding: 0; 
    }
    
    #sortModalCustom .modal-body-custom { padding: 16px; }

    .modal-footer-custom {
        padding: 8px 16px; 
        display: flex; 
        justify-content: flex-end; 
        gap: 8px; 
        position: sticky; 
        bottom: 0; 
        background-color: var(--surface-color); 
        z-index: 10;
        box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
        height: 64px;
        box-sizing: border-box;
        flex-shrink: 0; 
    }

    .modal-custom:not(.full-height-custom) .modal-content-custom {
        position: absolute; 
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%; 
        max-width: 450px;
        max-height: 90vh;
    }
    
    #confirmModalCustom .modal-body-custom { padding: 16px; }
    
    /* é‡å¤æ•°æ®ç¡®è®¤æ¨¡æ€æ¡† */
    #duplicateConfirmationModalCustom .modal-body-custom {
        max-height: calc(100vh - 170px);
        padding: 16px;
        overflow-y: auto;
    }
    
    .duplicate-item {
        border: 1px solid var(--border-color);
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
        background-color: var(--background-color);
    }
    .dark-mode .duplicate-item { background-color: #282828; }
    
    .duplicate-actions label { margin-right: 15px; font-size: 0.9rem; }
    
    .duplicate-item table { width: 100%; margin: 10px 0 15px; border-collapse: collapse; }
    .duplicate-item table th, .duplicate-item table td { padding: 8px; border: 1px solid var(--border-color); text-align: center; }
    .duplicate-item table th { background-color: var(--surface-color); }

    #drawerList mdui-icon { font-size: var(--drawer-icon-size); }

    .checkbox-col {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 !important; 
    }
    
    .checkbox-col > mdui-checkbox {
        margin: 0; 
        padding: 12px 8px; 
    }
    
    .top-action-buttons {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-shrink: 0; 
    }
    
    #mainFab {
        position: fixed;
        right: 16px;
        bottom: 16px;
        z-index: 1000; 
    }
    
    /* å¿«é€Ÿç¼–è¾‘å¼¹çª— */
    #quickEditDialog .modal-content-custom {
        max-width: 400px;
        top: 30%; 
        transform: translate(-50%, -50%); 
    }
    
    #quickEditDialog .modal-body-custom { padding: 20px; }
    
    #quickEditDialog label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--primary-color);
    }
    
    #quickEditInput {
        font-size: 1.2rem;
        padding: 12px;
        border: 2px solid var(--primary-color);
        border-radius: 4px;
        width: 100%;
        box-sizing: border-box;
        background-color: var(--background-color);
        color: var(--text-color);
    }
</style>
</head>
<body>

    <mdui-navigation-drawer id="drawer" close-on-overlay-click placement="left" close-on-esc>
        <mdui-top-app-bar slot="header">
            <mdui-top-app-bar-title>åŠŸèƒ½èœå•</mdui-top-app-bar-title>
        </mdui-top-app-bar>
        
        <mdui-list id="drawerList">
            <mdui-collapse>
                <mdui-collapse-item id="themeCollapse">
                    <mdui-list-item slot="header" icon="dark_mode" headline="ä¸»é¢˜æ¨¡å¼ (å½“å‰: è‡ªåŠ¨)"></mdui-list-item>
                    <mdui-list id="themeCollapseContent">
                        <mdui-list-item class="theme-option" data-theme="auto" icon="brightness_auto" headline="è‡ªåŠ¨ (è·Ÿéšç³»ç»Ÿ)"></mdui-list-item>
                        <mdui-list-item class="theme-option" data-theme="light" icon="light_mode" headline="æ—¥é—´æ¨¡å¼"></mdui-list-item>
                        <mdui-list-item class="theme-option" data-theme="dark" icon="dark_mode" headline="å¤œé—´æ¨¡å¼"></mdui-list-item>
                    </mdui-list>
                </mdui-collapse-item>
            </mdui-collapse>
            
            <mdui-list-item id="importItem" icon="file_upload" headline="å¯¼å…¥ Excel"></mdui-list-item>
            <mdui-list-item id="exportItem" icon="file_download" headline="å¯¼å‡º Excel"></mdui-list-item>
            <mdui-list-item id="calculatorBtn" icon="calculate" headline="è®¡ç®—é‡é‡"></mdui-list-item>
            
            <mdui-divider></mdui-divider>
            <mdui-list-item id="sortItem" icon="sort" headline="æ•°æ®æ’åº"></mdui-list-item>
        </mdui-list>
    </mdui-navigation-drawer>

    <div class="top-fixed-area">
        <div class="action-bar">
            <mdui-button-icon icon="menu" id="openDrawerBtn"></mdui-button-icon>
            
            <div class="search-bar">
                <span class="material-icons" style="color:#757575;">search</span>
                <input type="text" id="searchInput" placeholder="æœç´¢æ‰€æœ‰å­—æ®µ...">
                <span class="material-icons search-clear-btn" id="searchClearBtn">clear</span>
            </div>
            
            <div class="top-action-buttons">
                 <mdui-button-icon icon="find_replace" id="toggleSearchReplaceBtn" style="margin-right: -8px;"></mdui-button-icon>
                <mdui-dropdown placement="bottom-end">
                    <mdui-button-icon slot="trigger" icon="more_vert" id="topMenuBtn"></mdui-button-icon>
                    <mdui-menu>
                        <mdui-menu-item id="multiSelectMenuItem" icon="check_box_outline_blank">
                            <span id="multiSelectMenuText">è¿›å…¥å¤šé€‰æ¨¡å¼</span>
                        </mdui-menu-item>
                        <mdui-menu-item id="aboutItem" icon="info">å…³äº</mdui-menu-item>
                    </mdui-menu>
                </mdui-dropdown>
            </div>
        </div>
        
        <div class="search-replace-container" id="searchReplaceContainer" style="display: none;">
             <div class="search-replace-row">
                <input type="text" id="replaceQuery" placeholder="æ›¿æ¢ä¸º">
                <mdui-button variant="filled" id="replaceOneBtn" disabled style="width: 80px;">æ›¿æ¢</mdui-button>
                <mdui-button variant="outlined" id="replaceAllBtn" color="error" disabled style="width: 80px;">æ›¿æ¢å…¨éƒ¨</mdui-button>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; margin-top: -5px;">
                <span id="searchResultCount" style="font-size: 0.9rem; color: #757575;"></span>
                <div style="display: flex; gap: 8px;">
                    <mdui-button-icon icon="arrow_upward" id="prevMatchBtn"></mdui-button-icon>
                    <mdui-button-icon icon="arrow_downward" id="nextMatchBtn"></mdui-button-icon>
                </div>
            </div>
        </div>
        <div class="batch-action-container">
             <mdui-button variant="outlined" color="error" id="deleteSelectedBtn" style="display: none; margin-Top:10px; width: 100%;">
                <mdui-icon name="delete"></mdui-icon>
                æ‰¹é‡åˆ é™¤ (<span id="selectedCount">0</span>)
            </mdui-button>
        </div>

        <div class="item-count" id="itemCount"></div>
    </div>
    
    <div class="data-table-container">
        <table id="dataTable">
            <thead>
                <tr>
                    <th class="seq-col">åºå·</th>
                    <th class="checkbox-col" style="display: none;">
                        <mdui-checkbox id="selectAllCheckbox">å…¨é€‰</mdui-checkbox>
                    </th>
                    <th>é’¢ç§</th>
                    <th>äº§å“å·</th>
                    <th>å¡ç‰‡å·</th>
                    <th>ç‚‰å·</th>
                    <th>å®é™…ç›´å¾„</th>
                    <th>ç›´å¾„</th>
                    <th>é•¿åº¦</th>
                    <th>é‡é‡</th>
                    <th>çŠ¶æ€</th>
                    <th>ä½ç½®</th>
                    <th>ç¡¬åº¦</th>
                    <th class="remark-col">å¤‡æ³¨</th>
                    <th class="action-col">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                </tbody>
        </table>
    </div>

    <div class="empty-state" id="emptyState">
        <span class="material-icons" style="font-size: 48px;">inbox</span>
        <p>æš‚æ— æ•°æ®ï¼Œç‚¹å‡»å³ä¸‹è§’â€œæ·»åŠ â€æŒ‰é’®å¼€å§‹å½•å…¥ã€‚</p>
    </div>

    <input type="file" id="fileInput" accept=".xlsx, .xls" style="display: none;">

    <div id="dataSheetCustom" class="modal-custom full-height-custom"> 
        <div class="modal-content-custom">
            <div id="dataSheetHeader" class="modal-header-custom">
                <h2 id="modalTitle">æ·»åŠ æ•°æ®</h2>
                <mdui-button-icon icon="close" id="closeDataModal"></mdui-button-icon>
            </div>

            <div id="dataSheetContent" class="modal-body-custom">
                 <form id="dataForm" class="data-form">
                    <input type="hidden" id="editIndex" value="-1">
                    
                    <label for="steelType">é’¢ç§</label>
                    <input type="text" id="steelType" class="readonly-input">

                    <label for="productId">äº§å“å·</label>
                    <input type="text" id="productId" class="readonly-input">

                    <label for="cardId">å¡ç‰‡å·</label>
                    <input type="text" id="cardId" class="readonly-input">

                    <label for="furnaceId">ç‚‰å·</label>
                    <input type="text" id="furnaceId" class="readonly-input">
                    
                    <mdui-divider style="margin-bottom:10px"></mdui-divider>
                    
                    <label for="actualDiameter">å®é™…ç›´å¾„</label>
                    <input type="text" id="actualDiameter" class="numeric-input readonly-input">

                    <label for="diameter">ç›´å¾„</label>
                    <input type="text" id="diameter" class="numeric-input readonly-input">

                    <label for="length">é•¿åº¦</label>
                    <input type="text" id="length" class="numeric-input readonly-input">

                    <label for="weight">é‡é‡</label>
                    <input type="text" id="weight" class="numeric-input readonly-input">
                    
                    <mdui-divider style="margin-bottom:10px"></mdui-divider>

                    <label for="status">çŠ¶æ€</label>
                    <input type="text" id="status" class="readonly-input">
                    
                    <label for="position">ä½ç½®</label>
                    <input type="text" id="position" class="readonly-input">

                    <label for="hardness">ç¡¬åº¦</label>
                    <input type="text" id="hardness" class="numeric-input readonly-input">

                    <label for="remarks">å¤‡æ³¨</label>
                    <input type="text" rows="5" cols="30" id="remarks">
                </form>
            </div>
            
            <div id="dataSheetFooter" class="modal-footer-custom">
                <mdui-button variant="text" id="cancelBtn">å–æ¶ˆ</mdui-button>
                <mdui-button variant="filled" id="saveBtn">ä¿å­˜</mdui-button>
            </div>
        </div>
    </div>
    
    <div id="quickEditDialog" class="modal-custom">
        <div class="modal-content-custom">
            <div class="modal-header-custom">
                <h2 id="quickEditTitle">å¿«é€Ÿç¼–è¾‘</h2>
                <mdui-button-icon icon="close" id="closeQuickEdit"></mdui-button-icon>
            </div>
            <div class="modal-body-custom">
                <label id="quickEditLabel">å­—æ®µå</label>
                <input type="text" id="quickEditInput" class="readonly-input">
                <input type="hidden" id="quickEditIndex">
                <input type="hidden" id="quickEditField">
            </div>
            <div class="modal-footer-custom" style="justify-content: space-between;">
                <mdui-button variant="text" id="openFullEditBtn">æ‰“å¼€å®Œæ•´ç¼–è¾‘ç•Œé¢</mdui-button>
                <mdui-button variant="filled" id="saveQuickEditBtn">ä¿å­˜</mdui-button>
            </div>
        </div>
    </div>
    
    <div id="virtualKeyboard">
        <div id="shortcutContainer"></div>
        <div id="keyboardRows"></div>
    </div>
    
    <div id="confirmModalCustom" class="modal-custom">
        <div class="modal-content-custom">
            <div class="modal-header-custom">
                <h2 class="modal-title">æ“ä½œç¡®è®¤</h2>
                <mdui-button-icon icon="close" id="closeConfirmModal"></mdui-button-icon>
            </div>
            
            <div class="modal-body-custom">
                <p id="confirmMessage">æ‚¨ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
            </div>
            
            <div class="modal-footer-custom">
                <mdui-button variant="text" id="cancelConfirmBtn">å–æ¶ˆ</mdui-button>
                <mdui-button variant="filled" color="error" id="confirmActionBtn">ç¡®å®š</mdui-button>
            </div>
        </div>
    </div>

    <div id="calculatorModalCustom" class="modal-custom full-height-custom">
        <div class="modal-content-custom">
            <div class="modal-header-custom">
                <h2 class="modal-title">åœ†æ£’é‡é‡è®¡ç®—</h2>
                <mdui-button-icon icon="close" id="closeCalculatorModal"></mdui-button-icon>
            </div>
            
            <div id="calculatorContent" class="modal-body-custom">
                <form id="calculatorForm" class="data-form" style="padding: 16px;">
                    <label for="calcDiameter1">ç›´å¾„ 1 (mm)</label>
                    <input type="text" id="calcDiameter1" class="numeric-input readonly-input">

                    <label for="calcDiameter2">ç›´å¾„ 2 (mm)</label>
                    <input type="text" id="calcDiameter2" class="numeric-input readonly-input">

                    <label for="calcLength">é•¿åº¦ (mm)</label>
                    <input type="text" id="calcLength" class="numeric-input readonly-input">

                    <label for="calcDensity">å¯†åº¦ (Kg/mmÂ³, é»˜è®¤ 0.00617)</label>
                    <input type="text" id="calcDensity" readonly>
                    
                    <label for="calcResult">è®¡ç®—ç»“æœ (Kg)</label>
                    <input type="text" id="calcResult" readonly style="font-weight: bold; font-size: 1.2em;">
                </form>
            </div>
            
            <div class="modal-footer-custom">
                <mdui-button variant="text" id="clearCalcBtn" color="error">æ¸…ç©ºå…¨éƒ¨</mdui-button>
                <mdui-button variant="text" id="cancelCalcBtn">å–æ¶ˆ</mdui-button>
                <mdui-button variant="filled" id="calculateAndAddBtn">è®¡ç®—å¹¶å¡«å……</mdui-button>
            </div>
        </div>
    </div>
    
    <div id="duplicateConfirmationModalCustom" class="modal-custom full-height-custom">
        <div class="modal-content-custom">
            <div class="modal-header-custom">
                <h2 class="modal-title">å¯¼å…¥é‡å¤æ•°æ®ç¡®è®¤</h2>
                <mdui-button-icon icon="close" id="closeDuplicateModal"></mdui-button-icon>
            </div>
            
            <div class="modal-body-custom">
                <p>æ€»å…±å¯¼å…¥ <span id="modal-total-count" style="font-weight: bold;">0</span> æ¡è®°å½•ã€‚å…¶ä¸­ï¼š</p>
                <ul>
                    <li>æ–°æ•°æ® <span id="modal-new-count" style="font-weight: bold; color: var(--primary-color);">0</span> æ¡ï¼ˆå°†ç›´æ¥æ·»åŠ ï¼‰</li>
                    <li>é‡å¤æ•°æ® <span id="modal-duplicate-count" style="font-weight: bold; color: #f44336;">0</span> æ¡ï¼ˆè¯·é€‰æ‹©å¤„ç†æ–¹å¼ï¼‰</li>
                </ul>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <mdui-button variant="outlined" id="modal-btn-select-all-skip">å…¨éƒ¨è·³è¿‡ (ä¿ç•™ç°æœ‰)</mdui-button>
                    <mdui-button variant="outlined" id="modal-btn-select-all-override">å…¨éƒ¨è¦†ç›– (ä½¿ç”¨æ–°å€¼)</mdui-button>
                </div>
                
                <div id="modal-duplicate-list">
                </div>
            </div>
            
            <div class="modal-footer-custom">
                <mdui-button variant="text" id="modal-btn-cancel-import">å–æ¶ˆå¯¼å…¥</mdui-button>
                <mdui-button variant="filled" id="modal-btn-confirm">ç¡®è®¤å¤„ç†å¹¶å®Œæˆå¯¼å…¥</mdui-button>
            </div>
        </div>
    </div>
    
    <div id="sortModalCustom" class="modal-custom">
        <div class="modal-content-custom">
            <div class="modal-header-custom">
                <h2 class="modal-title">æ•°æ®æ’åº</h2>
                <mdui-button-icon icon="close" id="closeSortModal"></mdui-button-icon>
            </div>
            
            <div class="modal-body-custom">
                <div class="data-form">
                    <label for="sortField">æ’åºå­—æ®µ</label>
                    <select id="sortField">
                        <option value="productId">äº§å“å·</option>
                        <option value="steelType">é’¢ç§</option>
                        <option value="actualDiameter">å®é™…ç›´å¾„</option>
                        <option value="diameter">ç›´å¾„</option>
                        <option value="length">é•¿åº¦</option>
                        <option value="weight">é‡é‡</option>
                        <option value="status">çŠ¶æ€</option>
                        <option value="position">ä½ç½®</option>
                        <option value="hardness">ç¡¬åº¦</option>
                        <option value="furnaceId">ç‚‰å·</option>
                    </select>
                    
                    <label for="sortOrder" style="margin-top: 10px;">æ’åºæ–¹å¼</label>
                    <select id="sortOrder">
                        <option value="asc">ä»å°åˆ°å¤§ (å‡åº)</option>
                        <option value="desc">ä»å¤§åˆ°å° (é™åº)</option>
                    </select>
                </div>
            </div>
            
            <div class="modal-footer-custom">
                <mdui-button variant="text" id="cancelSortBtn">å–æ¶ˆ</mdui-button>
                <mdui-button variant="filled" id="applySortBtn">ç¡®å®šæ’åº</mdui-button>
            </div>
        </div>
    </div>
    <mdui-fab icon="add" id="mainFab"></mdui-fab>
    
    <script type="text/template" id="duplicate-item-template">
        <div class="duplicate-item">
            <h4>äº§å“å·ï¼šPRODUCT_ID</h4>
            <div class="duplicate-differences">
                <table>
                    <thead>
                        <tr>
                            <th>å­—æ®µ</th>
                            <th>ç°æœ‰å€¼</th>
                            <th>æ–°å€¼</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
            <div class="duplicate-actions">
                <label><input type="radio" name="action-ITEM_INDEX" value="skip" checked> è·³è¿‡ (ä¿ç•™ç°æœ‰å€¼)</label>
                <label><input type="radio" name="action-ITEM_INDEX" value="override"> è¦†ç›– (ä½¿ç”¨æ–°å€¼)</label>
            </div>
        </div>
    </script>
    
    <script type="text/template" id="difference-row-template">
        <tr>
            <th>FIELD_NAME</th>
            <td>OLD_VALUE</td>
            <td style="color: #f44336; font-weight: bold;">NEW_VALUE</td>
        </tr>
    </script>
    
    <mdui-dialog
      id="aboutDialog"
      headline="å…³äº"
      description="HTML Made with Gemini.
      Version: 0.9.6"
      close-on-overlay-click
    >
        <div slot="body">
            <p style="text-align: center; margin-bottom: 15px;">åœ†æ£’å…¥åº“æ•°æ®ç®¡ç†</p>
            <p style="text-align: center; color: #757575; font-size: 0.9rem;">Made by XXX with Gemini</p>
        </div>
        <mdui-button slot="action" variant="text" onclick="document.getElementById('aboutDialog').open = false;">å…³é—­</mdui-button>
    </mdui-dialog>


    <mdui-snackbar id="general-snackbar" placement="bottom-center" closeable>
        </mdui-snackbar>
        
<script>
/**
 * =========================================================================
 * åœ†æ£’å…¥åº“æ•°æ®ç®¡ç†ç³»ç»Ÿ - JavaScript æ ¸å¿ƒé€»è¾‘
 * Based on MDUI v2
 * =========================================================================
 */

// æ ¸å¿ƒæ•°æ®å­˜å‚¨
let tableData = [];             // å­˜å‚¨æ‰€æœ‰åœ†æ£’æ•°æ®çš„æ•°ç»„
let currentInput = null;        // å½“å‰æ¿€æ´»çš„è¾“å…¥æ¡† DOM å…ƒç´ 
let keyboardState = JSON.parse(localStorage.getItem('keyboardState')) || {
  mode: 'normal',               // é”®ç›˜æ¨¡å¼ï¼šnormal, shift, caps, number, symbol, etc.
  shiftState: 'off',            // Shift çŠ¶æ€ï¼šoff, on (ä¸€æ¬¡æ€§), lock (é”å®š)
  inputType: 'text'             // ç»‘å®šçš„è¾“å…¥å­—æ®µç±»å‹ï¼Œç”¨äºå†³å®šé”®ç›˜å¸ƒå±€
};
let currentEditIndex = -1;      // å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ•°æ®é¡¹åœ¨ tableData ä¸­çš„ç´¢å¼•ï¼Œ-1 è¡¨ç¤ºæ–°å¢
let isMultiSelectMode = false;  // æ˜¯å¦å¤„äºå¤šé€‰æ¨¡å¼
let selectedRows = new Set();   // å­˜å‚¨é€‰ä¸­çš„è¡Œåœ¨ tableData ä¸­çš„åŸå§‹ç´¢å¼•
let selectedTheme = localStorage.getItem('theme') || 'auto'; // å½“å‰ä¸»é¢˜æ¨¡å¼
let searchTerm = '';            // å½“å‰æœç´¢å…³é”®å­—
let isSearchReplaceVisible = false; // æ–°å¢ï¼šæœç´¢æ›¿æ¢åŒºåŸŸæ˜¯å¦å¯è§

// æ–°å¢æ ¸å¿ƒæœç´¢/æ›¿æ¢å˜é‡
let searchMatches = [];         // å­˜å‚¨æ‰€æœ‰åŒ¹é…é¡¹çš„æ•°ç»„ï¼š[{index: row_index, field: field_id, value: matched_value}]
let currentMatchIndex = -1;     // å½“å‰èšç„¦çš„åŒ¹é…é¡¹åœ¨ searchMatches ä¸­çš„ç´¢å¼•
let isSearchActive = false;     // æœç´¢åŠŸèƒ½æ˜¯å¦æ¿€æ´»
const searchableFields = [
    'steelType', 'productId', 'cardId', 'furnaceId', 'actualDiameter', 
    'diameter', 'length', 'weight', 'status', 'position', 'hardness', 'remarks'
];

// æ•°æ®è¡¨å•å­—æ®µé¡ºåºï¼Œç”¨äºè™šæ‹Ÿé”®ç›˜çš„ Tab åˆ‡æ¢é€»è¾‘
const inputFieldOrder = [
  'steelType', 'productId', 'cardId', 'furnaceId',
  'actualDiameter', 'diameter', 'length', 'weight',
  'status', 'position', 'hardness', 'remarks'
];

// å­—æ®µä¸­æ–‡æ ‡ç­¾æ˜ å°„
const fieldLabels = {
    'steelType': 'é’¢ç§',
    'productId': 'äº§å“å·',
    'cardId': 'å¡ç‰‡å·',
    'furnaceId': 'ç‚‰å·',
    'actualDiameter': 'å®é™…ç›´å¾„',
    'diameter': 'ç›´å¾„',
    'length': 'é•¿åº¦',
    'weight': 'é‡é‡',
    'status': 'çŠ¶æ€',
    'position': 'ä½ç½®',
    'hardness': 'ç¡¬åº¦',
    'remarks': 'å¤‡æ³¨'
};

// DOM å…ƒç´ å¼•ç”¨
const dom = {
  themeCollapse: document.getElementById('themeCollapse'),
  themeCollapseContent: document.getElementById('themeCollapseContent'),
  tableBody: document.getElementById('tableBody'),
  emptyState: document.getElementById('emptyState'),
  itemCount: document.getElementById('itemCount'),
  addBtn: document.getElementById('mainFab'), 
  importItem: document.getElementById('importItem'),
  exportItem: document.getElementById('exportItem'),
  fileInput: document.getElementById('fileInput'),
  multiSelectBtn: document.getElementById('multiSelectBtn'),
  deleteSelectedBtn: document.getElementById('deleteSelectedBtn'),
  selectedCount: document.getElementById('selectedCount'),
  selectAllCheckbox: document.getElementById('selectAllCheckbox'),
  drawer: document.getElementById('drawer'),
  openDrawerBtn: document.getElementById('openDrawerBtn'),
  dataSheet: document.getElementById('dataSheetCustom'), 
  closeDataModal: document.getElementById('closeDataModal'),
  saveBtn: document.getElementById('saveBtn'),
  cancelBtn: document.getElementById('cancelBtn'),
  dataForm: document.getElementById('dataForm'),
  modalTitle: document.getElementById('modalTitle'),
  editIndex: document.getElementById('editIndex'),
  quickEditDialog: document.getElementById('quickEditDialog'),
  closeQuickEdit: document.getElementById('closeQuickEdit'),
  quickEditLabel: document.getElementById('quickEditLabel'),
  quickEditInput: document.getElementById('quickEditInput'),
  quickEditIndex: document.getElementById('quickEditIndex'),
  quickEditField: document.getElementById('quickEditField'),
  saveQuickEditBtn: document.getElementById('saveQuickEditBtn'),
  openFullEditBtn: document.getElementById('openFullEditBtn'),
  confirmModal: document.getElementById('confirmModalCustom'), 
  closeConfirmModal: document.getElementById('closeConfirmModal'),
  confirmMessage: document.getElementById('confirmMessage'),
  cancelConfirmBtn: document.getElementById('cancelConfirmBtn'),
  confirmActionBtn: document.getElementById('confirmActionBtn'),
  virtualKeyboard: document.getElementById('virtualKeyboard'),
  keyboardRows: document.getElementById('keyboardRows'),
  shortcutContainer: document.getElementById('shortcutContainer'),
  searchInput: document.getElementById('searchInput'),
  searchClearBtn: document.getElementById('searchClearBtn'),
  calculatorModal: document.getElementById('calculatorModalCustom'), 
  calculatorBtn: document.getElementById('calculatorBtn'),
  closeCalculatorModal: document.getElementById('closeCalculatorModal'),
  calculatorForm: document.getElementById('calculatorForm'),
  calcDiameter1: document.getElementById('calcDiameter1'),
  calcDiameter2: document.getElementById('calcDiameter2'),
  calcLength: document.getElementById('calcLength'),
  calcDensity: document.getElementById('calcDensity'),
  calcResult: document.getElementById('calcResult'),
  calculateAndAddBtn: document.getElementById('calculateAndAddBtn'),
  cancelCalcBtn: document.getElementById('cancelCalcBtn'),
  clearCalcBtn: document.getElementById('clearCalcBtn'),
  duplicateConfirmationModal: document.getElementById('duplicateConfirmationModalCustom'), 
  closeDuplicateModal: document.getElementById('closeDuplicateModal'),
  generalSnackbar: document.getElementById('general-snackbar'),
  
  // æœç´¢æ›¿æ¢å’Œå¤šé€‰èœå•å¼•ç”¨
  multiSelectMenuText: document.getElementById('multiSelectMenuText'), 
  multiSelectMenuItem: document.getElementById('multiSelectMenuItem'), 
  
  // é¡¶éƒ¨æœç´¢æ›¿æ¢åŒºåŸŸçš„æ–°å¢å¼•ç”¨
  toggleSearchReplaceBtn: document.getElementById('toggleSearchReplaceBtn'),
  searchReplaceContainer: document.getElementById('searchReplaceContainer'),
  replaceQueryInput: document.getElementById('replaceQuery'),       
  searchResultCount: document.getElementById('searchResultCount'), 
  prevMatchBtn: document.getElementById('prevMatchBtn'),           
  nextMatchBtn: document.getElementById('nextMatchBtn'),           
  replaceOneBtn: document.getElementById('replaceOneBtn'),         
  replaceAllBtn: document.getElementById('replaceAllBtn'),
  
  // æ’åºæ¨¡æ€æ¡†å¼•ç”¨
  sortItem: document.getElementById('sortItem'),
  sortModal: document.getElementById('sortModalCustom'),
  closeSortModal: document.getElementById('closeSortModal'),
  cancelSortBtn: document.getElementById('cancelSortBtn'),
  applySortBtn: document.getElementById('applySortBtn'),
  sortField: document.getElementById('sortField'),
  sortOrder: document.getElementById('sortOrder'),
  
  // å…³äºä¿¡æ¯å¯¹è¯æ¡†å¼•ç”¨
  aboutDialog: document.getElementById('aboutDialog'),
  aboutItem: document.getElementById('aboutItem') 
};

// è¡¨å•è¾“å…¥å­—æ®µ DOM å¼•ç”¨
const formElements = {
  steelType: document.getElementById('steelType'),
  productId: document.getElementById('productId'),
  cardId: document.getElementById('cardId'),
  furnaceId: document.getElementById('furnaceId'),
  actualDiameter: document.getElementById('actualDiameter'),
  diameter: document.getElementById('diameter'),
  length: document.getElementById('length'),
  weight: document.getElementById('weight'),
  status: document.getElementById('status'),
  position: document.getElementById('position'),
  hardness: document.getElementById('hardness'),
  remarks: document.getElementById('remarks')
};
// å°†è¡¨å•å…ƒç´ å­˜å…¥æ•°ç»„æ–¹ä¾¿éå†
const inputFields = Object.values(formElements); 

// è™šæ‹Ÿé”®ç›˜çš„å¿«æ·é€‰é¡¹å¸¸é‡
const statusOptions = ['è½¦å…‰', 'è°ƒè½¦', 'èŠ±çš®', 'é»‘çš®', 'é»‘è°ƒ', 'èŠ±è°ƒ'];
const positionOptions = ['å¤–', 'è¿‡', 'ç«‹è½¦', 'æ‰“å¡æœº'];
const steelTypeOptions = [
    '42CrMo4',
    'C45E',
    'S355J2G3',
    '16/20MnCrS5',
    'C45',
    'C45R+N',
    'S355J2+N',
    'S355J2-P RE',
    'C45-P RE',
    '708M40T',
    '1.2714',
    '4145',
    'LF2',
    'A105/LF2',
    '34NiCrMo6 T-RE',
];
const cardIdOptions = [
    'æ— å¤‡',
    'AUSA',
    'V2526',
    'V15P',
    'SA504',
    'V2523',
    'SA503',
    'V25',
    'å¤‡åº“',
    'TS',
    'TH',
    'V4',
    'VT'
];
const furnaceIdOptions = [
    '1251',
    'VD25/',
    '1250',
    '251050',
    '25D0',
    '123',
    '25C0',
    'VD24/'
];


/**
 * è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºåº•éƒ¨é€šçŸ¥æ ï¼ˆSnackbarï¼‰
 * @param {string} message - è¦æ˜¾ç¤ºçš„æ¶ˆæ¯
 * @param {string} color - å¯é€‰ï¼ŒMDUI ä¸»é¢˜è‰²ï¼Œå¦‚ 'error', 'success', 'warning'
 */
function showSnackbar(message, color) {
  const snackbar = dom.generalSnackbar;
  if (!snackbar) return;
  
  snackbar.innerHTML = message;
  
  if (color) {
      snackbar.color = color;
  } else {
      snackbar.removeAttribute('color');
  }
  
  snackbar.open = true;
}

/**
 * æ£€æŸ¥ç³»ç»Ÿæ˜¯å¦å¤„äºé»‘æš—æ¨¡å¼
 * @returns {boolean}
 */
function isSystemDarkMode() {
    return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
}

/**
 * åˆå§‹åŒ–åº”ç”¨ä¸»é¢˜
 * æ ¹æ® localStorage æˆ–ç³»ç»Ÿè®¾ç½®åº”ç”¨ 'dark-mode' ç±»å’Œ MDUI çš„ä¸»é¢˜ç±»
 */
function initTheme() {
  let mode;
  if (selectedTheme === 'auto') {
    mode = isSystemDarkMode() ? 'dark' : 'light';
  } else {
    mode = selectedTheme;
  }
  
  const body = document.body;

  if (mode === 'dark') {
    body.classList.add('dark-mode');
    body.classList.add('mdui-theme-dark'); 
  } else {
    body.classList.remove('dark-mode');
    body.classList.remove('mdui-theme-dark');
  }
  
  updateThemeSelectionInDrawer();
}

/**
 * åˆ‡æ¢åº”ç”¨ä¸»é¢˜æ¨¡å¼å¹¶ä¿å­˜åˆ° localStorage
 * @param {string} theme - 'auto', 'light', æˆ– 'dark'
 */
function changeTheme(theme) {
  selectedTheme = theme;
  localStorage.setItem('theme', selectedTheme);
  initTheme();
  dom.drawer.open = false; 
}

/**
 * æ›´æ–°æŠ½å±‰ä¸­ä¸»é¢˜é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€å’Œå¤´éƒ¨æè¿°
 * **æ ¸å¿ƒå˜æ›´ï¼šä½¿ç”¨ MDUI æ ‡å‡†çš„ `selected` å±æ€§æ¥è§¦å‘ MDUI ç»„ä»¶çš„å†…ç½®æ ·å¼ã€‚**
 */
function updateThemeSelectionInDrawer() {
    const themeOptions = dom.themeCollapseContent.querySelectorAll('.theme-option');
    const headerItem = dom.themeCollapse.querySelector('mdui-list-item[slot="header"]');
    
    themeOptions.forEach(item => {
        // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
        item.removeAttribute('selected'); 
    });
    
    const currentSelection = dom.themeCollapseContent.querySelector(`.theme-option[data-theme="${selectedTheme}"]`);
    if (currentSelection) {
        // ä»…è®¾ç½® selected å±æ€§ï¼Œè®© MDUI ç»„ä»¶çš„å†…ç½®æ ·å¼æ¥ç®¡
        currentSelection.setAttribute('selected', 'true');
    }
    
    let headlineText = "ä¸»é¢˜æ¨¡å¼ (å½“å‰: è‡ªåŠ¨)";
    let iconName = "brightness_auto";
    
    // æ ¹æ®å½“å‰é€‰ä¸­çš„ä¸»é¢˜æ›´æ–°æŠ½å±‰å¤´éƒ¨çš„æ–‡æœ¬å’Œå›¾æ ‡
    if (selectedTheme === 'light') {
        headlineText = "ä¸»é¢˜æ¨¡å¼ (å½“å‰: æ—¥é—´)";
        iconName = "light_mode";
    } else if (selectedTheme === 'dark') {
        headlineText = "ä¸»é¢˜æ¨¡å¼ (å½“å‰: å¤œé—´)";
        iconName = "dark_mode";
    }
    
    if (headerItem) {
        headerItem.setAttribute('headline', headlineText);
        headerItem.setAttribute('icon', iconName);
    }
}

/**
 * æ˜¾ç¤ºè‡ªå®šä¹‰ Modal/Dialog
 * @param {HTMLElement} modalElement 
 */
function openCustomModal(modalElement) {
    if (modalElement) modalElement.style.display = 'block';
}

/**
 * éšè—è‡ªå®šä¹‰ Modal/Dialog
 * @param {HTMLElement} modalElement 
 */
function closeCustomModal(modalElement) {
    if (modalElement) modalElement.style.display = 'none';
}

/**
 * ç»‘å®šæ‰€æœ‰ DOM å…ƒç´ çš„äº‹ä»¶ç›‘å¬å™¨
 */
function initEventListeners() {
  dom.openDrawerBtn.addEventListener('click', () => { dom.drawer.open = true; });
  dom.themeCollapseContent.querySelectorAll('.theme-option').forEach(item => {
      item.addEventListener('click', (e) => {
          const theme = e.currentTarget.getAttribute('data-theme');
          changeTheme(theme);
      });
  });

  dom.closeDataModal.addEventListener('click', () => { closeCustomModal(dom.dataSheet); dom.virtualKeyboard.style.display = 'none'; });
  dom.cancelBtn.addEventListener('click', () => { closeCustomModal(dom.dataSheet); dom.virtualKeyboard.style.display = 'none'; });
  
  dom.closeQuickEdit.addEventListener('click', () => { closeCustomModal(dom.quickEditDialog); dom.virtualKeyboard.style.display = 'none'; });
  dom.saveQuickEditBtn.addEventListener('click', saveQuickEdit);
  dom.openFullEditBtn.addEventListener('click', () => {
      const index = parseInt(dom.quickEditIndex.value);
      closeCustomModal(dom.quickEditDialog);
      setTimeout(() => { openEditModal(index); }, 100);
  });
  
  // å¿«é€Ÿç¼–è¾‘è¾“å…¥æ¡†ç‚¹å‡»äº‹ä»¶ï¼šç»‘å®šè™šæ‹Ÿé”®ç›˜
  dom.quickEditInput.addEventListener('click', (e) => {
      e.stopPropagation();
      currentInput = e.target;
      const realFieldId = dom.quickEditField.value; // è·å–çœŸå®å­—æ®µID
      updateKeyboardForInput(currentInput, realFieldId); 
      showVirtualKeyboard();
  });
  
  dom.closeConfirmModal.addEventListener('click', () => closeCustomModal(dom.confirmModal));
  dom.cancelConfirmBtn.addEventListener('click', () => closeCustomModal(dom.confirmModal));
  dom.closeCalculatorModal.addEventListener('click', () => { closeCustomModal(dom.calculatorModal); dom.virtualKeyboard.style.display = 'none'; });
  dom.cancelCalcBtn.addEventListener('click', () => { closeCustomModal(dom.calculatorModal); dom.virtualKeyboard.style.display = 'none'; });
  dom.clearCalcBtn.addEventListener('click', clearCalculatorInputs);
  dom.closeDuplicateModal.addEventListener('click', () => closeCustomModal(dom.duplicateConfirmationModal));
  document.getElementById('modal-btn-cancel-import').addEventListener('click', () => {
      closeCustomModal(dom.duplicateConfirmationModal);
      showSnackbar('å¯¼å…¥æ“ä½œå·²å–æ¶ˆ', 'warning');
  });
  
  // **æ–°å¢ï¼šæ’åºæ¨¡æ€æ¡†äº‹ä»¶**
  dom.sortItem.addEventListener('click', openSortModal);
  dom.closeSortModal.addEventListener('click', () => closeCustomModal(dom.sortModal));
  dom.cancelSortBtn.addEventListener('click', () => closeCustomModal(dom.sortModal));
  dom.applySortBtn.addEventListener('click', applySort);
  
  // æ–°å¢ï¼šæœç´¢æ›¿æ¢åŒºåŸŸåˆ‡æ¢æŒ‰é’®äº‹ä»¶
  dom.toggleSearchReplaceBtn.addEventListener('click', toggleSearchReplaceVisibility);
  
  dom.multiSelectMenuItem.addEventListener('click', () => { 
      dom.drawer.open = false; 
      toggleMultiSelectMode(); 
  });
  
  // **æ–°å¢å…³äºæŒ‰é’®äº‹ä»¶ç»‘å®š**
  if (dom.aboutItem && dom.aboutDialog) {
      dom.aboutItem.addEventListener('click', () => {
          dom.aboutDialog.open = true;
          dom.drawer.open = false; // å…³é—­æŠ½å±‰
      });
  }
  
  // æœç´¢/æ›¿æ¢è¾“å…¥æ¡†äº‹ä»¶
  // ä¸»æœç´¢æ¡†è¾“å…¥æ—¶ï¼Œè§¦å‘å…¨å±€æœç´¢
  dom.searchInput.addEventListener('input', (e) => {
    searchTerm = e.target.value.trim().toLowerCase();
    updateTable(); // å®æ—¶æœç´¢
    
    // å¦‚æœæœç´¢æ›¿æ¢åŒºåŸŸå¯è§ï¼Œä¹Ÿè§¦å‘å…¶ä¸­çš„åŒ¹é…é¡¹æ›´æ–°
    if (isSearchReplaceVisible) {
        startSearch();
    }
  });
  
  // æ›¿æ¢è¾“å…¥æ¡†è¾“å…¥æ—¶ï¼Œæ›´æ–°æŒ‰é’®çŠ¶æ€
  dom.replaceQueryInput.addEventListener('input', () => {
    // å³ä½¿æ›¿æ¢å†…å®¹ä¸ºç©ºï¼Œåªè¦æœ‰æœç´¢åŒ¹é…é¡¹ï¼Œæ›¿æ¢æŒ‰é’®ä¹Ÿåº”è¯¥å¯ç”¨
    dom.replaceOneBtn.disabled = searchMatches.length === 0;
    dom.replaceAllBtn.disabled = searchMatches.length === 0;
  });
  
  dom.prevMatchBtn.addEventListener('click', () => navigateMatch(-1));
  dom.nextMatchBtn.addEventListener('click', () => navigateMatch(1));
  dom.replaceOneBtn.addEventListener('click', replaceOne);
  dom.replaceAllBtn.addEventListener('click', confirmReplaceAll);

  // ä¸»è¡¨å•è¾“å…¥æ¡†ç‚¹å‡»äº‹ä»¶ï¼šç»‘å®šè™šæ‹Ÿé”®ç›˜å’Œåªè¯»é€»è¾‘
  inputFields.forEach(field => {
    field.addEventListener('click', (e) => {
      e.stopPropagation();
      currentInput = e.target;
      
      if (currentInput.id === 'remarks') {
        // å¤‡æ³¨å­—æ®µè§£é™¤åªè¯»å¹¶éšè—é”®ç›˜
        currentInput.removeAttribute('readonly');
        currentInput.classList.remove('readonly-input');
        dom.virtualKeyboard.style.display = 'none';
        currentInput.focus();
        return; 
      }
      
      currentInput.setAttribute('readonly', 'true');
      currentInput.classList.add('readonly-input');
      updateKeyboardForInput(currentInput);
      showVirtualKeyboard();
      
      // ä¼˜åŒ–æ¨¡æ€æ¡†æ»šåŠ¨ï¼Œä½¿å½“å‰è¾“å…¥æ¡†å¯è§
      setTimeout(() => {
        const modalContent = document.getElementById('dataSheetContent');
        if(modalContent) {
            const inputRect = currentInput.getBoundingClientRect();
            const modalRect = modalContent.getBoundingClientRect();
            const offset = inputRect.top - modalRect.top + modalContent.scrollTop - modalRect.height * 0.3; 
            modalContent.scrollTo({ top: offset, behavior: 'smooth' });
        }
      }, 100);
    });
    
    // åŒå‡»è¾“å…¥æ¡†äº‹ä»¶ï¼šåˆ‡æ¢åªè¯»çŠ¶æ€ï¼ˆå…è®¸ä½¿ç”¨ç³»ç»Ÿé”®ç›˜ï¼‰
    field.addEventListener('dblclick', (e) => {
      e.stopPropagation();
      currentInput = e.target;
      if (currentInput.id === 'remarks') return; 
      
      if (currentInput.hasAttribute('readonly')) {
        currentInput.removeAttribute('readonly');
        currentInput.classList.remove('readonly-input');
        dom.virtualKeyboard.style.display = 'none';
        currentInput.focus();
      } else {
        currentInput.setAttribute('readonly', 'true');
        currentInput.classList.add('readonly-input');
        updateKeyboardForInput(currentInput);
        showVirtualKeyboard();
      }
    });
  });
  
  dom.importItem.addEventListener('click', () => { dom.drawer.open = false; dom.fileInput.click(); });
  dom.exportItem.addEventListener('click', () => { dom.drawer.open = false; exportToExcel(); });
  dom.addBtn.addEventListener('click', openAddModal); 
  dom.fileInput.addEventListener('change', handleFileImport);
  dom.selectAllCheckbox.addEventListener('change', handleSelectAll);
  dom.deleteSelectedBtn.addEventListener('click', confirmDeleteSelected);
  dom.saveBtn.addEventListener('click', saveData);

  dom.searchClearBtn.addEventListener('click', () => {
    dom.searchInput.value = '';
    searchTerm = '';
    updateTable();
  });

  dom.calculatorBtn.addEventListener('click', openCalculatorModal);
  dom.calculateAndAddBtn.addEventListener('click', calculateAndAddData);
  
  // è¡¨æ ¼ä¸»ä½“ç‚¹å‡»äº‹ä»¶ï¼šå®ç°å¿«é€Ÿç¼–è¾‘æˆ–å®Œæ•´ç¼–è¾‘
  dom.tableBody.addEventListener('click', (e) => {
    if (isMultiSelectMode) return;
    
    // å¿½ç•¥æ“ä½œæŒ‰é’®å’Œå¤é€‰æ¡†çš„ç‚¹å‡»
    if (e.target.closest('mdui-button-icon') || e.target.closest('mdui-checkbox')) {
      return;
    }
    
    const row = e.target.closest('tr');
    if (!row) return;
    
    const index = parseInt(row.getAttribute('data-index'));
    const cell = e.target.closest('td');
    const targetFieldId = cell ? cell.getAttribute('data-field') : null;
    
    if (targetFieldId) {
        if (targetFieldId === 'remarks') {
            openEditModal(index, targetFieldId); // å¤‡æ³¨å­—æ®µç›´æ¥æ‰“å¼€å®Œæ•´ç¼–è¾‘
        } else {
            openQuickEdit(index, targetFieldId); // å…¶ä»–å­—æ®µæ‰“å¼€å¿«é€Ÿç¼–è¾‘
        }
    } else {
        openEditModal(index); // ç‚¹å‡»éå­—æ®µåŒºåŸŸï¼Œæ‰“å¼€å®Œæ•´ç¼–è¾‘
    }
  });
}

/**
 * åˆ‡æ¢é¡¶éƒ¨æœç´¢å’Œæ›¿æ¢åŒºåŸŸçš„å¯è§æ€§
 */
function toggleSearchReplaceVisibility() {
    isSearchReplaceVisible = !isSearchReplaceVisible;
    const container = dom.searchReplaceContainer;
    
    if (isSearchReplaceVisible) {
        container.style.display = 'flex';
        dom.toggleSearchReplaceBtn.icon = 'expand_less';
        // åˆ‡æ¢åï¼Œç«‹å³æ ¹æ®ä¸»æœç´¢æ¡†çš„å†…å®¹è¿›è¡Œæœç´¢åŒ¹é…
        startSearch();
    } else {
        container.style.display = 'none';
        dom.toggleSearchReplaceBtn.icon = 'find_replace';
        // æ¸…é™¤æœç´¢çŠ¶æ€å’Œé«˜äº®
        isSearchActive = false;
        searchMatches = [];
        currentMatchIndex = -1;
        updateTable();
    }
}

/**
 * å¤„ç†å…¨é€‰/å…¨ä¸é€‰å¤é€‰æ¡†çš„é€»è¾‘
 */
function handleSelectAll() {
    if (!isMultiSelectMode) return;
    
    selectedRows.clear();
    const filteredData = getFilteredData();
    if (dom.selectAllCheckbox.checked) {
      filteredData.forEach(item => {
          const originalIndex = tableData.indexOf(item);
          if (originalIndex !== -1) selectedRows.add(originalIndex);
      });
    }
    updateTable();
}

/**
 * æ‰“å¼€é‡é‡è®¡ç®—å™¨æ¨¡æ€æ¡†å¹¶åˆå§‹åŒ–é”®ç›˜
 */
function openCalculatorModal() {
    dom.drawer.open = false;
    openCustomModal(dom.calculatorModal); 
    dom.calcDiameter1.value = '';
    dom.calcDiameter2.value = '';
    dom.calcLength.value = '';
    dom.calcResult.value = '';
    
    // èšç„¦ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†å¹¶æ˜¾ç¤ºé”®ç›˜
    currentInput = dom.calcDiameter1;
    updateKeyboardForInput(currentInput);
    showVirtualKeyboard();
    currentInput.focus();
}

/**
 * æ¸…ç©ºé‡é‡è®¡ç®—å™¨æ‰€æœ‰è¾“å…¥å­—æ®µ
 */
function clearCalculatorInputs() {
    dom.calcDiameter1.value = '';
    dom.calcDiameter2.value = '';
    dom.calcLength.value = '';
    dom.calcResult.value = '';
    calculateWeight(); 
    
    dom.calcDiameter1.focus();
    currentInput = dom.calcDiameter1;
    updateKeyboardForInput(currentInput);
}

/**
 * æ ¹æ®æœç´¢å…³é”®å­—è¿‡æ»¤æ•°æ®
 * @returns {Array<Object>} è¿‡æ»¤åçš„æ•°æ®æ•°ç»„
 */
function getFilteredData() {
  if (!searchTerm) {
    return [...tableData];
  }
  return tableData.filter(item => {
    return Object.values(item).some(value => 
      value !== null && value !== undefined && value.toString().toLowerCase().includes(searchTerm)
    );
  });
}

/**
 * åˆ·æ–°æ•°æ®è¡¨æ ¼ UIï¼ŒåŒ…æ‹¬ç­›é€‰ã€å¤šé€‰æ¨¡å¼åˆ‡æ¢ã€è¡Œæ¸²æŸ“å’Œäº‹ä»¶ç»‘å®š
 */
function updateTable() {
  const filteredData = getFilteredData();

  dom.itemCount.textContent = `å…± ${tableData.length} æ¡æ•°æ®ï¼Œç­›é€‰å‡º ${filteredData.length} æ¡`;
  dom.emptyState.style.display = tableData.length === 0 ? 'block' : 'none';
  dom.searchClearBtn.classList.toggle('active', !!searchTerm);
  dom.selectedCount.textContent = selectedRows.size;

  const checkboxColHeader = document.querySelector('#dataTable th.checkbox-col');
  // æ³¨æ„ï¼šéœ€è¦ä½¿ç”¨ DOM API æ¥æŸ¥æ‰¾å•å…ƒæ ¼ï¼Œå› ä¸ºå®ƒä»¬æ˜¯åŠ¨æ€ç”Ÿæˆçš„
  const allCheckboxColCells = document.querySelectorAll('#dataTable td.checkbox-col'); 
  
  // æ§åˆ¶å¤šé€‰ç›¸å…³å…ƒç´ çš„æ˜¾ç¤º/éšè—
  const displayStyle = isMultiSelectMode ? 'table-cell' : 'none';
  dom.deleteSelectedBtn.style.display = isMultiSelectMode ? 'inline-flex' : 'none';
  if(checkboxColHeader) checkboxColHeader.style.display = displayStyle;
  dom.selectAllCheckbox.style.display = isMultiSelectMode ? 'block' : 'none'; 
  allCheckboxColCells.forEach(cell => cell.style.display = displayStyle);

  // æ›´æ–°å…¨é€‰æ¡†çŠ¶æ€
  dom.selectAllCheckbox.checked = filteredData.length > 0 && selectedRows.size === filteredData.length;

  dom.tableBody.innerHTML = '';
  
  // æ¸…é™¤æ‰€æœ‰é«˜äº®å’Œå®šä½åˆ°å½“å‰é¡¹ (åœ¨é‡æ–°æ¸²æŸ“ä¹‹å‰)
  document.querySelectorAll('.search-match-highlight').forEach(el => el.classList.remove('search-match-highlight'));
  document.querySelectorAll('.current-match-highlight').forEach(el => el.classList.remove('current-match-highlight'));

  // æ¸²æŸ“è¡¨æ ¼è¡Œ
  filteredData.forEach((item, displayIndex) => {
    const row = document.createElement('tr');
    const originalIndex = tableData.indexOf(item);
    row.setAttribute('data-index', originalIndex);
    
    if (isMultiSelectMode && selectedRows.has(originalIndex)) {
      row.classList.add('selected');
    }

    if (searchTerm) {
      row.classList.add('highlight'); // æœç´¢ç»“æœé«˜äº®
    }
    
    row.innerHTML = `
      <td class="seq-col">
        ${displayIndex + 1}
        <div class="move-buttons">
            <button class="move-btn up-btn" data-index="${originalIndex}" ${originalIndex === 0 ? 'disabled' : ''}>
              <i class="material-icons" style="font-size: 14px;">arrow_upward</i>
            </button>
            <button class="move-btn down-btn" data-index="${originalIndex}" ${originalIndex === tableData.length - 1 ? 'disabled' : ''}>
              <i class="material-icons" style="font-size: 14px;">arrow_downward</i>
            </button>
        </div>
      </td>
      <td class="checkbox-col" style="display:${displayStyle};">
        <mdui-checkbox class="row-checkbox" data-index="${originalIndex}" ${isMultiSelectMode && selectedRows.has(originalIndex) ? 'checked' : ''}></mdui-checkbox>
      </td>
      <td data-field="steelType">${item.steelType || '-'}</td>
      <td data-field="productId">${item.productId || '-'}</td>
      <td data-field="cardId">${item.cardId || '-'}</td>
      <td data-field="furnaceId">${item.furnaceId || '-'}</td>
      <td data-field="actualDiameter">${item.actualDiameter || '-'}</td>
      <td data-field="diameter">${item.diameter || '-'}</td>
      <td data-field="length">${item.length || '-'}</td>
      <td data-field="weight">${item.weight || '-'}</td>
      <td data-field="status">${item.status || '-'}</td>
      <td data-field="position">${item.position || '-'}</td>
      <td data-field="hardness">${item.hardness || '-'}</td>
      <td class="remark-col" data-field="remarks">${item.remarks || '-'}</td>
      <td class="action-col">
        <mdui-button-icon icon="edit" class="edit-btn" data-index="${originalIndex}"></mdui-button-icon>
        <mdui-button-icon icon="delete" class="delete-btn" data-index="${originalIndex}"></mdui-button-icon>
      </td>
    `;
    
    dom.tableBody.appendChild(row);
    
    // æœç´¢å’Œæ›¿æ¢é«˜äº®é€»è¾‘ (ä»…åœ¨æœç´¢/æ›¿æ¢åŒºåŸŸå¯è§æ—¶)
    if (isSearchActive && isSearchReplaceVisible) {
        searchableFields.forEach(field => {
            const cell = row.querySelector(`td[data-field="${field}"]`);
            if (!cell) return;
            
            const query = dom.searchInput.value.trim().toLowerCase(); // ä½¿ç”¨ä¸»æœç´¢æ¡†çš„å†…å®¹è¿›è¡Œæ›¿æ¢æœç´¢
            const cellValue = (item[field] || '').toString();
            
            if (query && cellValue.toLowerCase().includes(query)) {
                // æ·»åŠ æ‰€æœ‰åŒ¹é…é¡¹çš„é€šç”¨é«˜äº®
                cell.classList.add('search-match-highlight');

                // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰èšç„¦çš„åŒ¹é…é¡¹
                const isCurrentMatch = searchMatches.some((match, idx) => 
                    idx === currentMatchIndex && match.index === originalIndex && match.field === field
                );
                
                if (isCurrentMatch) {
                    cell.classList.add('current-match-highlight');
                    
                    // æ»šåŠ¨åˆ°å½“å‰åŒ¹é…é¡¹ (å¦‚æœå½“å‰åŒ¹é…é¡¹åœ¨ç­›é€‰åçš„æ•°æ®ä¸­)
                    if (currentMatchIndex !== -1) {
                         // 3. æ»šåŠ¨åˆ°å½“å‰åŒ¹é…é¡¹
                        const container = document.querySelector('.data-table-container');
                        if (container) {
                            const cellRect = cell.getBoundingClientRect();
                            const containerRect = container.getBoundingClientRect();
                            const scrollTop = container.scrollTop;
                            const offset = cellRect.top - containerRect.top + scrollTop - (containerRect.height / 2) + (cellRect.height / 2);
                            container.scrollTo({ top: offset, behavior: 'smooth' });
                        }
                    }
                }
            }
        });
    }
  });
  
  bindRowEvents(); // é‡æ–°ç»‘å®šäº‹ä»¶
}

/**
 * ç»‘å®šè¡¨æ ¼è¡Œå†…çš„æ‰€æœ‰åŠ¨æ€äº‹ä»¶ï¼Œå¦‚ç¼–è¾‘ã€åˆ é™¤ã€å¤é€‰æ¡†å’Œç§»åŠ¨æŒ‰é’®
 */
function bindRowEvents() {
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const index = parseInt(e.currentTarget.getAttribute('data-index'));
      openEditModal(index);
    });
  });
  
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const index = parseInt(e.currentTarget.getAttribute('data-index'));
      confirmDeleteRow(index);
    });
  });
  
  document.querySelectorAll('.row-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', (e) => {
      e.stopPropagation();
      const index = parseInt(e.target.getAttribute('data-index'));
      const row = e.target.closest('tr');
      
      // æ›´æ–°é€‰ä¸­çŠ¶æ€é›†åˆ
      e.target.checked ? selectedRows.add(index) : selectedRows.delete(index);
      
      const filteredData = getFilteredData();
      dom.selectAllCheckbox.checked = selectedRows.size === filteredData.length && filteredData.length > 0;
      dom.selectedCount.textContent = selectedRows.size;
      row.classList.toggle('selected', e.target.checked);
    });
  });
  
  document.querySelectorAll('.up-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      moveRow(parseInt(e.currentTarget.getAttribute('data-index')), 'up');
    });
  });
  
  document.querySelectorAll('.down-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      moveRow(parseInt(e.currentTarget.getAttribute('data-index')), 'down');
    });
  });
}

/**
 * ç¡®è®¤å¹¶åˆ é™¤å•è¡Œæ•°æ®
 * @param {number} index - å¾…åˆ é™¤æ•°æ®åœ¨ tableData ä¸­çš„ç´¢å¼•
 */
function confirmDeleteRow(index) {
    const itemToDelete = tableData[index];
    const message = `æ‚¨ç¡®å®šè¦åˆ é™¤ä»¥ä¸‹æ•°æ®å—ï¼Ÿ<br><br>` +
                    `äº§å“å·: <strong style="color: var(--primary-color);">${itemToDelete.productId || 'N/A'}</strong><br>` +
                    `é’¢ç§: ${itemToDelete.steelType || 'N/A'}<br>` +
                    `é‡é‡: ${itemToDelete.weight || 'N/A'}`;
    dom.confirmMessage.innerHTML = message;
    openCustomModal(dom.confirmModal); 
    
    dom.confirmActionBtn.onclick = () => {
      tableData.splice(index, 1); // ä»æ•°ç»„ä¸­ç§»é™¤
      selectedRows.clear(); // æ¸…ç©ºé€‰ä¸­çŠ¶æ€
      saveDataToLocalStorage();
      updateTable();
      closeCustomModal(dom.confirmModal); 
      dom.confirmActionBtn.onclick = null;
      showSnackbar('æ•°æ®å·²åˆ é™¤', 'success');
    };
}

/**
 * ä¸Šä¸‹ç§»åŠ¨è¡¨æ ¼è¡Œæ•°æ®
 * @param {number} index - ç›®æ ‡æ•°æ®åœ¨ tableData ä¸­çš„ç´¢å¼•
 * @param {string} direction - 'up' æˆ– 'down'
 */
function moveRow(index, direction) {
  if (direction === 'up' && index > 0) {
    [tableData[index - 1], tableData[index]] = [tableData[index], tableData[index - 1]];
  } else if (direction === 'down' && index < tableData.length - 1) {
    [tableData[index], tableData[index + 1]] = [tableData[index + 1], tableData[index]];
  }
  
  saveDataToLocalStorage();
  updateTable();
}

/**
 * ç¡®è®¤å¹¶æ‰§è¡Œæ‰¹é‡åˆ é™¤æ“ä½œ
 */
function confirmDeleteSelected() {
    if (selectedRows.size > 0) {
      dom.confirmMessage.innerHTML = `æ‚¨ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ <strong style="color: #f44336;">${selectedRows.size}</strong> æ¡æ•°æ®å—ï¼Ÿ`;
      openCustomModal(dom.confirmModal); 
      dom.confirmActionBtn.onclick = () => {
        deleteSelected();
        closeCustomModal(dom.confirmModal); 
        dom.confirmActionBtn.onclick = null;
      };
    }
}

/**
 * æ‰§è¡Œæ‰¹é‡åˆ é™¤å·²é€‰ä¸­çš„æ•°æ®
 */
function deleteSelected() {
  // å€’åºæ’åˆ—ç´¢å¼•ï¼Œé¿å…åˆ é™¤æ—¶å½±å“åç»­ç´¢å¼•
  const sortedIndexes = Array.from(selectedRows).sort((a, b) => b - a);
  sortedIndexes.forEach(index => {
    tableData.splice(index, 1);
  });
  
  const deletedCount = sortedIndexes.length;
  selectedRows.clear();
  dom.selectAllCheckbox.checked = false;
  
  saveDataToLocalStorage();
  updateTable();
  showSnackbar(`æˆåŠŸåˆ é™¤ ${deletedCount} æ¡æ•°æ®`, 'success');
}

/**
 * æ‰“å¼€æ–°å¢æ•°æ®æ¨¡æ€æ¡†ï¼ˆä¸å¸¦é¢„å¡«å……æ•°æ®ï¼‰
 */
function openAddModal() {
  openAddModalWithData({});
}

/**
 * æ‰“å¼€æ–°å¢æ•°æ®æ¨¡æ€æ¡†ï¼Œå¹¶ä½¿ç”¨é¢„å¡«å……æ•°æ®ï¼ˆå¦‚è®¡ç®—å™¨ç»“æœï¼‰
 * @param {Object} preFilledData - é¢„å¡«å……çš„å­—æ®µé”®å€¼å¯¹
 */
function openAddModalWithData(preFilledData) {
  if(dom.dataForm) dom.dataForm.reset();
  if(dom.modalTitle) dom.modalTitle.textContent = 'æ·»åŠ æ•°æ®';
  if(dom.editIndex) dom.editIndex.value = '-1';
  
  currentEditIndex = -1;
  
  // å¡«å……é¢„è®¾æ•°æ®
  for(const key in preFilledData) {
    if (preFilledData.hasOwnProperty(key) && formElements[key]) {
      formElements[key].value = preFilledData[key];
    }
  }

  // è®¾ç½®å­—æ®µåªè¯»çŠ¶æ€å’Œèšç„¦é€»è¾‘
  let inputToFocus = formElements.steelType;
  inputFields.forEach(field => {
    if(field.id !== 'remarks') {
        field.setAttribute('readonly', 'true');
        field.classList.add('readonly-input');
    } else {
        field.removeAttribute('readonly'); 
        field.classList.remove('readonly-input');
    }
    if(field.id === 'steelType') inputToFocus = field;
  });
  
  openCustomModal(dom.dataSheet);
  currentInput = inputToFocus;
  
  // å¦‚æœèšç„¦åˆ°å¤‡æ³¨å­—æ®µï¼Œåˆ™ä¸å¼¹å‡ºè™šæ‹Ÿé”®ç›˜
  if (currentInput.id === 'remarks') {
      dom.virtualKeyboard.style.display = 'none';
  } else {
      updateKeyboardForInput(currentInput);
      showVirtualKeyboard();
  }
  
  currentInput.focus();
}

/**
 * æŸ¥æ‰¾æ˜¯å¦æœ‰äº§å“å·é‡å¤çš„æ•°æ®
 * @param {Object} newItem - å¾…æ·»åŠ /ä¿®æ”¹çš„æ–°æ•°æ®
 * @returns {Array<Object>} é‡å¤é¡¹çš„æ•°ç»„
 */
function findDuplicates(newItem) {
  const duplicates = [];
  if(!tableData || !Array.isArray(tableData)) return duplicates;

  tableData.forEach((existingItem, index) => {
    const isPrimaryDuplicate = (newItem.productId && newItem.productId.trim() !== '' && newItem.productId === existingItem.productId);

    if (isPrimaryDuplicate) {
      duplicates.push({ 
        index, 
        reason: 'äº§å“å·é‡å¤', 
        existingItem: existingItem,
        newItem: newItem,
        productId: newItem.productId,
        differences: getObjectDifferences(existingItem, newItem)
      });
      return;
    }
  });

  return duplicates;
}

/**
 * çªå‡ºæ˜¾ç¤ºå¹¶æ»šåŠ¨åˆ°æŒ‡å®šçš„è¡¨æ ¼è¡Œ
 * @param {number} index - è¦é«˜äº®æ˜¾ç¤ºçš„è¡Œåœ¨ tableData ä¸­çš„ç´¢å¼•
 */
function highlightAndScrollToRow(index) {
  setTimeout(() => {
    const row = document.querySelector(`tbody tr[data-index="${index}"]`);
    
    if (row) {
      // ç§»é™¤æ—§çš„é«˜äº®ï¼Œæ·»åŠ æ–°é«˜äº®
      document.querySelectorAll('#dataTable .highlight').forEach(r => r.classList.remove('highlight'));
      row.classList.add('highlight');
      setTimeout(() => {
        if(row.classList.contains('highlight')) row.classList.remove('highlight');
      }, 2000);
      
      // æ»šåŠ¨è§†å›¾å±…ä¸­
      const container = document.querySelector('.data-table-container');
      if (container) {
          const rowRect = row.getBoundingClientRect();
          const containerRect = container.getBoundingClientRect();
          const scrollTop = container.scrollTop;
          const offset = rowRect.top - containerRect.top + scrollTop - (containerRect.height / 2) + (rowRect.height / 2);
          container.scrollTo({ top: offset, behavior: 'smooth' });
      } else {
        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
  }, 100);
}

/**
 * ä¿å­˜è¡¨å•æ•°æ®ï¼ˆæ–°å¢æˆ–ç¼–è¾‘ï¼‰ï¼ŒåŒ…å«é‡å¤æ•°æ®æ£€æŸ¥
 */
function saveData() {
  const formData = {};
  for(const key in formElements) {
    if (formElements.hasOwnProperty(key)) {
      formData[key] = formElements[key] ? formElements[key].value.trim() : '';
    }
  }

  // åŸºç¡€æ ¡éªŒï¼šäº§å“å·ã€å¡ç‰‡å·ã€ç‚‰å·è‡³å°‘å¡«å†™ä¸€é¡¹
  if (!formData.productId && !formData.cardId && !formData.furnaceId) {
    showSnackbar('äº§å“å·ã€å¡ç‰‡å·ã€ç‚‰å·è‡³å°‘å¡«å†™ä¸€é¡¹ï¼', 'warning');
    return;
  }

  const isEditMode = currentEditIndex !== -1;
  const isProductIdChanged = isEditMode && tableData[currentEditIndex].productId !== formData.productId;

  if (!isEditMode || isProductIdChanged) {
      // æŸ¥é‡é€»è¾‘
      const duplicateItems = findDuplicates(formData);
      const realDuplicates = duplicateItems.filter(dup => dup.index !== currentEditIndex); // æ’é™¤è‡ªèº«
      
      if (realDuplicates.length > 0) {
        let message = `å‘ç° ${realDuplicates.length} æ¡äº§å“å·é‡å¤çš„æ•°æ®ï¼`;
        message += `\næ‚¨æ­£åœ¨${isEditMode ? 'ä¿®æ”¹ä¸º' : 'æ·»åŠ äº§å“å·'}ï¼š${formData.productId || 'N/A'}\nç¡®å®šè¦ç»§ç»­æ·»åŠ å—ï¼Ÿç‚¹å‡»å–æ¶ˆå¯ä»¥æŸ¥çœ‹é‡å¤é¡¹`;

        if (!window.confirm(message)) { 
          const firstDuplicateIndex = realDuplicates[0].index;
          closeCustomModal(dom.dataSheet);
          dom.virtualKeyboard.style.display = 'none';
          highlightAndScrollToRow(firstDuplicateIndex);
          return;
        }
      }
  }

  // æ‰§è¡Œä¿å­˜æ“ä½œ
  if (!isEditMode) {
    if(!tableData) tableData = [];
    tableData.push(formData); // æ–°å¢
  } else {
    if(tableData && tableData[currentEditIndex] !== undefined) {
      tableData[currentEditIndex] = formData; // ç¼–è¾‘
    }
  }

  saveDataToLocalStorage();
  updateTable();
  closeCustomModal(dom.dataSheet);
  dom.virtualKeyboard.style.display = 'none';

  showSnackbar(isEditMode ? 'æ•°æ®ä¿®æ”¹æˆåŠŸ' : 'æ•°æ®æ·»åŠ æˆåŠŸ', 'success');
}

/**
 * æ‰“å¼€ç¼–è¾‘æ•°æ®æ¨¡æ€æ¡†å¹¶å¡«å……æ•°æ®
 * @param {number} index - å¾…ç¼–è¾‘æ•°æ®åœ¨ tableData ä¸­çš„ç´¢å¼•
 * @param {string} [targetFieldId=null] - å¯é€‰ï¼ŒæŒ‡å®šæ‰“å¼€ååº”èšç„¦çš„å­—æ®µID
 */
function openEditModal(index, targetFieldId = null) {
  currentEditIndex = index;
  if (dom.editIndex) dom.editIndex.value = index;

  const item = tableData[index];
  
  // å¡«å……è¡¨å•
  for (const key in formElements) {
    if (formElements.hasOwnProperty(key)) {
      formElements[key].value = item[key] || '';
    }
  }
  
  // è®¾ç½®å­—æ®µåªè¯»çŠ¶æ€å’Œèšç„¦é€»è¾‘
  let inputToFocus = formElements.steelType;
  inputFields.forEach(field => {
    if(field.id !== 'remarks') {
        field.setAttribute('readonly', 'true');
        field.classList.add('readonly-input');
    } else {
        field.removeAttribute('readonly'); 
        field.classList.remove('readonly-input');
    }
    if(field.id === 'steelType') inputToFocus = field;
  });
  
  dom.modalTitle.textContent = 'ç¼–è¾‘æ•°æ®';
  openCustomModal(dom.dataSheet); 
  
  // å¦‚æœæŒ‡å®šäº†èšç„¦å­—æ®µ
  if (targetFieldId && formElements[targetFieldId]) {
      inputToFocus = formElements[targetFieldId];
  }
  
  currentInput = inputToFocus;
  
  // èšç„¦å¹¶å¤„ç†é”®ç›˜æ˜¾ç¤º/éšè—
  if (currentInput.id === 'remarks') {
      dom.virtualKeyboard.style.display = 'none';
  } else {
      updateKeyboardForInput(currentInput);
      showVirtualKeyboard();
  }

  currentInput.focus();
  
  // ä¼˜åŒ–æ»šåŠ¨
  const modalContent = document.getElementById('dataSheetContent');
  if(modalContent) {
      setTimeout(() => {
          const inputRect = currentInput.getBoundingClientRect();
          const modalRect = modalContent.getBoundingClientRect();
          const offset = inputRect.top - modalRect.top + modalContent.scrollTop - modalRect.height * 0.3; 
          modalContent.scrollTo({ top: offset, behavior: 'smooth' });
      }, 50);
  }
}

/**
 * æ‰“å¼€å¿«é€Ÿç¼–è¾‘å¼¹çª—
 * @param {number} index - å¾…ç¼–è¾‘æ•°æ®åœ¨ tableData ä¸­çš„ç´¢å¼•
 * @param {string} fieldId - å¾…ç¼–è¾‘çš„å­—æ®µID
 */
function openQuickEdit(index, fieldId) {
    const item = tableData[index];
    const fieldName = fieldLabels[fieldId] || fieldId;
    
    dom.quickEditLabel.textContent = fieldName;
    dom.quickEditInput.value = item[fieldId] || '';
    dom.quickEditIndex.value = index;
    dom.quickEditField.value = fieldId;
    
    dom.quickEditInput.setAttribute('readonly', 'true');
    dom.quickEditInput.classList.add('readonly-input');
    
    openCustomModal(dom.quickEditDialog);
    
    // è‡ªåŠ¨èšç„¦å¹¶å¼¹å‡ºé”®ç›˜
    currentInput = dom.quickEditInput;
    updateKeyboardForInput(currentInput, fieldId); 
    showVirtualKeyboard();
    currentInput.focus();
}

/**
 * ä¿å­˜å¿«é€Ÿç¼–è¾‘çš„ä¿®æ”¹
 */
function saveQuickEdit() {
    const index = parseInt(dom.quickEditIndex.value);
    const fieldId = dom.quickEditField.value;
    const newValue = dom.quickEditInput.value.trim();
    
    if (index >= 0 && index < tableData.length) {
        // æ ¡éªŒæ•°å­—å­—æ®µ
        if (['actualDiameter', 'diameter', 'length', 'weight', 'hardness'].includes(fieldId) && isNaN(parseFloat(newValue)) && newValue.length > 0) {
            showSnackbar('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—æˆ–ç•™ç©º', 'error');
            return;
        }
        
        tableData[index][fieldId] = newValue;
        saveDataToLocalStorage();
        updateTable();
        closeCustomModal(dom.quickEditDialog);
        dom.virtualKeyboard.style.display = 'none';
        showSnackbar('å¿«é€Ÿä¿®æ”¹å·²ä¿å­˜', 'success');
    }
}

/**
 * å¼€å§‹æ‰§è¡Œæœç´¢ï¼Œæ‰¾åˆ°æ‰€æœ‰åŒ¹é…é¡¹
 */
function startSearch() {
    // å§‹ç»ˆä½¿ç”¨ä¸»æœç´¢æ¡†çš„å†…å®¹è¿›è¡ŒåŒ¹é…
    const query = dom.searchInput.value.trim().toLowerCase(); 
    searchMatches = [];
    currentMatchIndex = -1;
    isSearchActive = !!query;
    
    if (!isSearchActive || !isSearchReplaceVisible) {
        dom.searchResultCount.textContent = '';
        dom.replaceOneBtn.disabled = true;
        dom.replaceAllBtn.disabled = true;
        updateTable();
        return;
    }
    
    // éå†æ‰€æœ‰æ•°æ®å’Œå¯æœç´¢å­—æ®µï¼Œæ‰¾åˆ°åŒ¹é…é¡¹
    tableData.forEach((item, index) => {
        searchableFields.forEach(field => {
            const value = (item[field] || '').toString().toLowerCase();
            if (value.includes(query)) {
                searchMatches.push({
                    index: index,       // åŒ¹é…é¡¹æ‰€åœ¨è¡Œçš„åŸå§‹ç´¢å¼•
                    field: field,       // åŒ¹é…é¡¹æ‰€åœ¨çš„å­—æ®µID
                    value: item[field]  // å­—æ®µçš„åŸå§‹å€¼
                });
            }
        });
    });
    
    dom.replaceOneBtn.disabled = searchMatches.length === 0;
    dom.replaceAllBtn.disabled = searchMatches.length === 0;

    updateTable(); // åˆ·æ–°è¡¨æ ¼ä»¥æ˜¾ç¤ºæ‰€æœ‰é«˜äº®
    
    if (searchMatches.length > 0) {
        navigateMatch(1); // è‡ªåŠ¨èšç„¦åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹
    } else {
        dom.searchResultCount.textContent = 'æœªæ‰¾åˆ°åŒ¹é…é¡¹';
        updateCurrentMatchUI();
    }
}

/**
 * å¯¼èˆªåˆ°ä¸Šä¸€ä¸ª/ä¸‹ä¸€ä¸ªåŒ¹é…é¡¹
 * @param {number} direction - 1 (ä¸‹ä¸€ä¸ª) æˆ– -1 (ä¸Šä¸€ä¸ª)
 */
function navigateMatch(direction) {
    if (searchMatches.length === 0) return;
    
    currentMatchIndex += direction;
    
    // å¾ªç¯é€»è¾‘
    if (currentMatchIndex >= searchMatches.length) {
        currentMatchIndex = 0;
    } else if (currentMatchIndex < 0) {
        currentMatchIndex = searchMatches.length - 1;
    }
    
    updateCurrentMatchUI();
}

/**
 * æ›´æ–°å½“å‰åŒ¹é…é¡¹çš„ UI (é«˜äº®å’Œæ»šåŠ¨)
 */
function updateCurrentMatchUI() {
    // 1. æ›´æ–°è®¡æ•°å™¨
    dom.searchResultCount.textContent = `æ‰¾åˆ° ${searchMatches.length} ä¸ªåŒ¹é…é¡¹ (å½“å‰ ${currentMatchIndex === -1 ? 0 : currentMatchIndex + 1}/${searchMatches.length})`;
    
    // 2. æ¸…é™¤æ‰€æœ‰é«˜äº®å’Œå®šä½åˆ°å½“å‰é¡¹
    document.querySelectorAll('.current-match-highlight').forEach(el => el.classList.remove('current-match-highlight'));
    
    if (currentMatchIndex === -1 || searchMatches.length === 0) return;
    
    const currentMatch = searchMatches[currentMatchIndex];
    const rowElement = document.querySelector(`tbody tr[data-index="${currentMatch.index}"]`);
    
    if (rowElement) {
        const cell = rowElement.querySelector(`td[data-field="${currentMatch.field}"]`);
        
        if (cell) {
            cell.classList.add('current-match-highlight');
            
            // 3. æ»šåŠ¨åˆ°å½“å‰åŒ¹é…é¡¹
            const container = document.querySelector('.data-table-container');
            if (container) {
                const cellRect = cell.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();
                const scrollTop = container.scrollTop;
                const offset = cellRect.top - containerRect.top + scrollTop - (containerRect.height / 2) + (cellRect.height / 2);
                container.scrollTo({ top: offset, behavior: 'smooth' });
            }
        }
    }
}

/**
 * è¾…åŠ©å‡½æ•°ï¼šè½¬ä¹‰æ­£åˆ™è¡¨è¾¾å¼ç‰¹æ®Šå­—ç¬¦
 */
function escapeRegExp(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); 
}

/**
 * æ›¿æ¢å½“å‰çš„åŒ¹é…é¡¹
 */
function replaceOne() {
    if (currentMatchIndex === -1 || searchMatches.length === 0) {
        showSnackbar('æ²¡æœ‰é€‰ä¸­çš„åŒ¹é…é¡¹å¯æ›¿æ¢', 'warning');
        return;
    }
    
    const match = searchMatches[currentMatchIndex];
    const newText = dom.replaceQueryInput.value;
    const oldText = dom.searchInput.value.trim(); // ä½¿ç”¨ä¸»æœç´¢æ¡†çš„å†…å®¹
    
    if (!oldText) return; 

    // 1. æ‰§è¡Œæ›¿æ¢æ“ä½œ
    const rowIndex = match.index;
    const fieldId = match.field;
    const originalValue = tableData[rowIndex][fieldId] || '';
    
    // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œå…¨å±€æ›¿æ¢ï¼Œç¡®ä¿åªæ›¿æ¢æœç´¢å…³é”®å­—
    const regex = new RegExp(escapeRegExp(oldText), 'gi');
    let newValue = originalValue.replace(regex, newText);

    // 2. æ›´æ–°æ•°æ®å¹¶ä¿å­˜
    tableData[rowIndex][fieldId] = newValue;
    saveDataToLocalStorage();

    // 3. é‡æ–°æœç´¢å¹¶å¯¼èˆªåˆ°ä¸‹ä¸€ä¸ª
    showSnackbar(`å·²æ›¿æ¢ç¬¬ ${currentMatchIndex + 1} ä¸ªåŒ¹é…é¡¹`, 'success');

    // é‡æ–°æœç´¢
    startSearch(); 
    
    // ç”±äº startSearch ä¼šé‡æ–°ç”ŸæˆåŒ¹é…é¡¹ï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°å®šä½
    if (searchMatches.length > 0) {
        // ç»´æŒå½“å‰ç´¢å¼•ï¼Œå¦‚æœå½“å‰é¡¹å·²æ¶ˆå¤±ï¼Œåˆ™è‡ªåŠ¨è·³è½¬åˆ°ä¸‹ä¸€ä¸ª
        if (currentMatchIndex >= searchMatches.length) {
             currentMatchIndex = searchMatches.length - 1;
        }
        navigateMatch(1); // è‡ªåŠ¨å¯¼èˆªåˆ°ä¸‹ä¸€ä¸ª
    } else {
        dom.searchResultCount.textContent = 'æ›¿æ¢å®Œæˆï¼Œæœªæ‰¾åˆ°æ›´å¤šåŒ¹é…é¡¹';
    }
}

/**
 * ç¡®è®¤å¹¶æ‰§è¡Œæ›¿æ¢å…¨éƒ¨æ“ä½œ
 */
function confirmReplaceAll() {
    if (searchMatches.length === 0) {
        showSnackbar('æ²¡æœ‰åŒ¹é…é¡¹å¯æ›¿æ¢', 'warning');
        return;
    }
    
    const count = searchMatches.length;
    dom.confirmMessage.innerHTML = `æ‚¨ç¡®å®šè¦å°†æ‰€æœ‰ <strong style="color: var(--primary-color);">${dom.searchInput.value.trim()}</strong> æ›¿æ¢ä¸º <strong style="color: #f44336;">${dom.replaceQueryInput.value || 'ç©º'}</strong> å—ï¼Ÿ<br><br>å…±æ¶‰åŠ ${count} å¤„æ›¿æ¢ã€‚`;
    openCustomModal(dom.confirmModal); 
    
    dom.confirmActionBtn.onclick = () => {
      replaceAll();
      closeCustomModal(dom.confirmModal); 
      dom.confirmActionBtn.onclick = null;
    };
}

/**
 * æ‰§è¡Œæ›¿æ¢å…¨éƒ¨æ“ä½œ
 */
function replaceAll() {
    const oldText = dom.searchInput.value.trim();
    const newText = dom.replaceQueryInput.value;
    
    if (!oldText) return;

    let replaceCount = 0;
    const regex = new RegExp(escapeRegExp(oldText), 'gi');
    
    // éå†æ‰€æœ‰æ•°æ®ï¼Œé’ˆå¯¹æ¯ä¸ªå­—æ®µæ‰§è¡Œæ›¿æ¢
    tableData.forEach(item => {
        searchableFields.forEach(field => {
            const originalValue = (item[field] || '').toString();
            
            if (originalValue.toLowerCase().includes(oldText.toLowerCase())) {
                const newValue = originalValue.replace(regex, newText);
                if (newValue !== originalValue) {
                    item[field] = newValue;
                    replaceCount++; 
                }
            }
        });
    });
    
    if (replaceCount > 0) {
        saveDataToLocalStorage();
        // æ›¿æ¢å®Œæˆåï¼Œæ¸…é™¤æœç´¢çŠ¶æ€ï¼Œè®©è¡¨æ ¼å›åˆ°æ­£å¸¸æ˜¾ç¤º
        isSearchActive = false;
        searchMatches = [];
        currentMatchIndex = -1;
        updateTable();
        
        showSnackbar(`æˆåŠŸæ›¿æ¢ ${replaceCount} å¤„åŒ¹é…é¡¹ï¼`, 'success');
        toggleSearchReplaceVisibility(); // æ›¿æ¢å…¨éƒ¨åå…³é—­æœç´¢æ›¿æ¢åŒºåŸŸ
    } else {
        showSnackbar('æ²¡æœ‰åŒ¹é…é¡¹è¢«æ›¿æ¢', 'warning');
    }
}


/**
 * å…³é—­è™šæ‹Ÿé”®ç›˜ï¼Œä¿æŒè¾“å…¥æ¡†åªè¯»çŠ¶æ€
 */
function closeVirtualKeyboardAndKeepReadOnly() {
    dom.virtualKeyboard.style.display = 'none';
    currentInput = null;
}

/**
 * åŠ¨æ€ç”Ÿæˆè™šæ‹Ÿé”®ç›˜å¸ƒå±€
 */
function generateVirtualKeyboard() {
  dom.shortcutContainer.innerHTML = '';
  dom.keyboardRows.innerHTML = '';
  
  let keyRows = [];
  const isShifted = keyboardState.shiftState === 'on' || keyboardState.shiftState === 'lock';

  switch(keyboardState.inputType) {
    case 'number':
    case 'numeric-input':
      keyRows = [
        ['1', '2', '3','+', 'clear'],
        ['4', '5', '6', '-', 'backspace'],
        ['7', '8', '9','*', 'esc'], 
        ['.', '0', '/','ã€', 'done'] 
      ];
      break;
      
    case 'status':
      createShortcutKeys(statusOptions, 'status-key');
      keyRows = [
        ['clear', 'backspace', 'esc', 'done'] 
      ];
      break;
      
    case 'cardId':
      createShortcutKeys(cardIdOptions, 'shortcut-key');
      // Fallthrough to text keyboard
    case 'steelType':
      if (keyboardState.inputType === 'steelType') createShortcutKeys(steelTypeOptions, 'shortcut-key');
      // Fallthrough to text keyboard
    case 'productId':
      if (keyboardState.inputType === 'productId') createShortcutKeys(['TH'], 'shortcut-key'); 
      // Fallthrough to text keyboard
    case 'furnaceId':
      if (keyboardState.inputType === 'furnaceId') {
          const year = new Date().getFullYear().toString().slice(2);
          const lastyear = (parseInt(year) - 1).toString().slice(-2);
          const furnaceShortcuts = [`VD${year}/`, `VD${lastyear}/`,`${year}1`,`1${year}1`,`${lastyear}1`,`1${lastyear}1`];
          createShortcutKeys(furnaceShortcuts, 'shortcut-key');
      }
      // Fallthrough to text keyboard
    case 'text':
    default:
      keyRows = [
        ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'],
        ['Q', 'W', 'E', 'R', 'T', 'Y', 'U', 'I', 'O', 'P','+'],
        ['A', 'S', 'D', 'F', 'G', 'H', 'J', 'K', 'L','-'],
        ['shift', 'Z', 'X', 'C', 'V', 'B', 'N', 'M', ',', '.', 'backspace'],
        ['symbol', 'clear', 'space', 'esc', 'done'] 
      ];
      break;
      
    case 'position':
      createShortcutKeys(positionOptions, 'shortcut-key');
      keyRows = [
        ['1', '2', '3', 'A'],
        ['4', '5', '6', 'B'],
        ['7', '8', '9', 'C'],
        ['/','0', '-','D'],
        ['clear', 'backspace','esc' ,'done'] 
      ];
      break;
      
    case 'symbol':
      keyRows = [
        ['~', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')'],
        ['_', '+', '=', '|', '\\', ':', '"', '<', '>', '?', ','],
        ['`', '}', '[', ']', '{', '(', ')', '.', '/', ''],
        ['ABC', 'clear', 'space', 'esc', 'backspace', 'done'] 
      ];
      break;
  }
  
  // å­—æ¯å¤§å°å†™è½¬æ¢
  if (isShifted && keyboardState.inputType !== 'number' && keyboardState.inputType !== 'position' && keyboardState.inputType !== 'symbol' && keyboardState.inputType !== 'status') {
    keyRows = keyRows.map(row => 
      row.map(key => {
          if (key.length === 1 && /^[a-z]$/.test(key.toLowerCase())) {
              return key.toUpperCase();
          }
          return key;
      })
    );
  }
  
  // æ¸²æŸ“æŒ‰é”®
  keyRows.forEach(row => {
    const rowElement = document.createElement('div');
    rowElement.className = 'keyboard-row';
    row.forEach(key => {
      if (key) {
        rowElement.appendChild(createKeyElement(key));
      }
    });
    dom.keyboardRows.appendChild(rowElement);
  });
}

/**
 * åˆ›å»ºå¿«æ·é”®åŒºåŸŸ
 * @param {Array<string>} options - å¿«æ·é”®æ–‡æœ¬æ•°ç»„
 * @param {string} keyClass - CSS ç±»å
 */
function createShortcutKeys(options, keyClass) {
  const shortcutRow = document.createElement('div');
  shortcutRow.className = 'keyboard-row';
  
  options.forEach(option => {
    const keyElement = document.createElement('div');
    keyElement.className = `keyboard-key ${keyClass}`;
    keyElement.textContent = option;
    
    keyElement.addEventListener('click', () => {
      if (currentInput) {
        insertText(option);
        currentInput.focus();
      }
    });
    shortcutRow.appendChild(keyElement);
  });
  
  dom.shortcutContainer.appendChild(shortcutRow);
}

/**
 * åˆ›å»ºå•ä¸ªè™šæ‹Ÿé”®ç›˜æŒ‰é”®å…ƒç´ ï¼Œå¹¶ç»‘å®šäº‹ä»¶
 * @param {string} key - æŒ‰é”®å€¼æˆ–ç‰¹æ®Šæ“ä½œåç§°
 * @returns {HTMLElement}
 */
function createKeyElement(key) {
  const keyElement = document.createElement('div');
  keyElement.className = 'keyboard-key';
  
  if (key === 'shift') {
    keyElement.className += ' special wide';
    keyElement.innerHTML = keyboardState.shiftState === 'off' ? 'â‡§' : 'â‡ª'; // åˆ‡æ¢æ˜¾ç¤ºå›¾æ ‡
    keyElement.addEventListener('click', toggleShift);
  } else if (key === 'backspace') {
    keyElement.className += ' special wide';
    keyElement.innerHTML = 'â†';
    keyElement.addEventListener('click', handleBackspace);
  } else if (key === 'space') {
    keyElement.className += ' special extra-wide';
    keyElement.textContent = '';
    keyElement.addEventListener('click', () => insertText(' '));
  } else if (key === 'esc') {
    keyElement.className += ' system-keyboard wide'; 
    keyElement.textContent = 'å…³é—­'; 
    keyElement.addEventListener('click', closeVirtualKeyboardAndKeepReadOnly);
  } else if (key === 'done') {
    keyElement.className += ' special wide';
    keyElement.textContent = 'â–¼';
    keyElement.addEventListener('click', handleNextInput); // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªè¾“å…¥æ¡†
  } else if (key === 'clear') {
    keyElement.className += ' clear-key wide';
    keyElement.textContent = 'æ¸…ç©º';
    keyElement.addEventListener('click', clearInput);
  } else if (key === 'symbol') {
    keyElement.className += ' special wide';
    keyElement.textContent = 'ç¬¦';
    keyElement.addEventListener('click', () => {
      keyboardState.inputType = 'symbol';
      saveKeyboardState();
      generateVirtualKeyboard();
    });
  } else if (key === 'ABC') {
    keyElement.className += ' special wide';
    keyElement.textContent = 'ABC';
    keyElement.addEventListener('click', () => {
      keyboardState.inputType = 'text';
      saveKeyboardState();
      generateVirtualKeyboard();
    });
  } else {
    keyElement.textContent = key;
    keyElement.addEventListener('click', () => {
      insertText(key);
      
      // å•æ¬¡ Shift æ¨¡å¼ä¸‹ï¼Œè¾“å…¥åè‡ªåŠ¨åˆ‡æ¢å› Off
      if (keyboardState.shiftState === 'on') { 
        keyboardState.shiftState = 'off'; 
        keyboardState.mode = 'normal';
        saveKeyboardState();
        generateVirtualKeyboard();
      }
    });
  }
  
  return keyElement;
}

/**
 * å¤„ç† 'Done'ï¼ˆå®Œæˆï¼‰æŒ‰é’®ç‚¹å‡»ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªè¾“å…¥æ¡†
 */
function handleNextInput() {
  if (!currentInput) {
    dom.virtualKeyboard.style.display = 'none';
    return;
  }
  
  const currentId = currentInput.id;
  const isCalcInput = currentInput.closest('#calculatorForm');
  const isQuickEditInput = currentId === 'quickEditInput';
  
  if (isQuickEditInput) {
      saveQuickEdit(); 
      dom.virtualKeyboard.style.display = 'none';
      return;
  }
  
  let nextInput = null;
  let nextIndex = -1;

  // è®¡ç®—å™¨æ¨¡å¼ä¸‹çš„åˆ‡æ¢é€»è¾‘
  if (isCalcInput) {
      const calcInputs = [dom.calcDiameter1, dom.calcDiameter2, dom.calcLength, dom.calcDensity];
      const currentIndex = calcInputs.indexOf(currentInput);
      nextIndex = currentIndex === calcInputs.length - 1 ? 0 : currentIndex + 1;
      nextInput = calcInputs[nextIndex];
  } 
  // ä¸»è¡¨å•æ¨¡å¼ä¸‹çš„åˆ‡æ¢é€»è¾‘
  else {
      const currentIndex = inputFieldOrder.indexOf(currentId);
      nextIndex = currentIndex === inputFieldOrder.length - 1 ? 0 : currentIndex + 1;
      nextInput = formElements[inputFieldOrder[nextIndex]];
  }
  
  if (!nextInput) {
      dom.virtualKeyboard.style.display = 'none';
      return;
  }
  
  currentInput = nextInput;

  // å¤‡æ³¨å­—æ®µç‰¹æ®Šå¤„ç†ï¼šåˆ‡æ¢ä¸ºæ™®é€šè¾“å…¥
  if (currentInput.id === 'remarks' && !isCalcInput) {
    currentInput.removeAttribute('readonly');
    currentInput.classList.remove('readonly-input');
    dom.virtualKeyboard.style.display = 'none';
  } else {
    // å…¶ä»–å­—æ®µç»§ç»­åªè¯»ï¼Œæ˜¾ç¤ºå¯¹åº”é”®ç›˜
    currentInput.setAttribute('readonly', 'true');
    currentInput.classList.add('readonly-input');
    updateKeyboardForInput(currentInput);
    showVirtualKeyboard();
  }

  currentInput.focus();
  // æ»šåŠ¨åˆ°ä¸‹ä¸€ä¸ªè¾“å…¥æ¡†
  const modalContent = currentInput.closest('.modal-body-custom'); 
  if(modalContent) {
      setTimeout(() => {
          const inputRect = currentInput.getBoundingClientRect();
          const modalRect = modalContent.getBoundingClientRect();
          const offset = inputRect.top - modalRect.top + modalContent.scrollTop - modalRect.height * 0.3; 
          modalContent.scrollTo({ top: offset, behavior: 'smooth' });
      }, 50);
  }
}

/**
 * æ ¹æ®å½“å‰è¾“å…¥æ¡†çš„å­—æ®µç±»å‹æ›´æ–°è™šæ‹Ÿé”®ç›˜çŠ¶æ€å’Œå¸ƒå±€
 * @param {HTMLElement} input - å½“å‰èšç„¦çš„è¾“å…¥æ¡† DOM å…ƒç´ 
 * @param {string} [overrideId=null] - å¯é€‰ï¼Œå¼ºåˆ¶æŒ‡å®šå­—æ®µIDï¼Œç”¨äºå¿«é€Ÿç¼–è¾‘æ¡†
 */
function updateKeyboardForInput(input, overrideId = null) {
  if (!input) return;

  const numericFields = [
    'actualDiameter', 'diameter', 'length', 'weight', 'hardness',
    'calcDiameter1', 'calcDiameter2', 'calcLength', 'calcDensity'
  ];
  
  const currentId = overrideId || input.id; 
  const isNumeric = numericFields.includes(currentId);

  // ç¡®å®šè¾“å…¥ç±»å‹
  if (isNumeric) {
    keyboardState.inputType = 'number';
  } else if (currentId === 'productId') {
    keyboardState.inputType = 'productId';
  } else if (currentId === 'cardId') {
    keyboardState.inputType = 'cardId';
  } else if (currentId === 'steelType') {
    keyboardState.inputType = 'steelType';
  } else if (currentId === 'furnaceId') {
    keyboardState.inputType = 'furnaceId';
  } else if (currentId === 'position') {
    keyboardState.inputType = 'position';
  } else if (currentId === 'status') {
    keyboardState.inputType = 'status';
  } else {
    keyboardState.inputType = 'text';
  }
  
  // æ›´æ–°é”®ç›˜å¸ƒå±€
  keyboardState.mode = keyboardState.inputType;
  
  saveKeyboardState();
  generateVirtualKeyboard();
}

/**
 * åœ¨å½“å‰è¾“å…¥æ¡†çš„å…‰æ ‡ä½ç½®æ’å…¥æ–‡æœ¬
 * @param {string} text - è¦æ’å…¥çš„æ–‡æœ¬
 */
function insertText(text) {
  if (!currentInput) return;
  
  currentInput.focus(); 
  
  const startPos = currentInput.selectionStart;
  const endPos = currentInput.selectionEnd;
  const currentValue = currentInput.value;
  
  currentInput.value = currentValue.substring(0, startPos) + text + currentValue.substring(endPos);
  
  // ä¿æŒå…‰æ ‡ä½ç½®åœ¨æ’å…¥æ–‡æœ¬ä¹‹å
  currentInput.selectionStart = currentInput.selectionEnd = startPos + text.length;
  
  // è§¦å‘ input äº‹ä»¶ï¼Œç”¨äºæ•°æ®ç»‘å®šæˆ–è®¡ç®—ï¼ˆå¦‚é‡é‡è®¡ç®—ï¼‰
  const event = new Event('input', { bubbles: true });
  currentInput.dispatchEvent(event);

  if (currentInput.closest('#calculatorForm')) {
      calculateWeight();
  } else if (currentInput.id === 'searchInput' && isSearchReplaceVisible) {
      // å¦‚æœæ˜¯ä¸»æœç´¢æ¡†ï¼Œä¸”æœç´¢æ›¿æ¢å¯è§ï¼Œåˆ™é‡æ–°æ‰§è¡Œæœç´¢åŒ¹é…
      startSearch();
  }
}

/**
 * å¤„ç†é€€æ ¼é”®ï¼ˆBackspaceï¼‰æ“ä½œ
 */
function handleBackspace() {
  if (!currentInput) return;
  
  currentInput.focus();
  
  const startPos = currentInput.selectionStart;
  const endPos = currentInput.selectionEnd;
  const currentValue = currentInput.value;
  
  if (startPos === endPos && startPos > 0) {
    // æ— é€‰ä¸­çŠ¶æ€ï¼Œåˆ é™¤å…‰æ ‡å‰ä¸€ä¸ªå­—ç¬¦
    currentInput.value = currentValue.substring(0, startPos - 1) + currentValue.substring(endPos);
    currentInput.selectionStart = currentInput.selectionEnd = startPos - 1;
  } else if (startPos !== endPos) {
    // æœ‰é€‰ä¸­çŠ¶æ€ï¼Œåˆ é™¤é€‰ä¸­åŒºåŸŸ
    currentInput.value = currentValue.substring(0, startPos) + currentValue.substring(endPos);
    currentInput.selectionStart = currentInput.selectionEnd = startPos;
  }
  
  const event = new Event('input', { bubbles: true });
  currentInput.dispatchEvent(event);

  if (currentInput.closest('#calculatorForm')) {
      calculateWeight();
  } else if (currentInput.id === 'searchInput' && isSearchReplaceVisible) {
      // å¦‚æœæ˜¯ä¸»æœç´¢æ¡†ï¼Œä¸”æœç´¢æ›¿æ¢å¯è§ï¼Œåˆ™é‡æ–°æ‰§è¡Œæœç´¢åŒ¹é…
      startSearch();
  }
}

/**
 * æ¸…ç©ºå½“å‰è¾“å…¥æ¡†çš„å†…å®¹
 */
function clearInput() {
  if (currentInput) {
    currentInput.value = '';
    currentInput.focus();
    
    const event = new Event('input', { bubbles: true });
    currentInput.dispatchEvent(event);
    
    if (currentInput.closest('#calculatorForm')) {
        calculateWeight();
    }
  }
}

/**
 * åˆ‡æ¢ Shift çŠ¶æ€ï¼ˆOff -> On -> Lock -> Offï¼‰
 */
function toggleShift() {
  const allowedTypes = ['text', 'productId', 'furnaceId', 'cardId', 'steelType'];
  if (!allowedTypes.includes(keyboardState.inputType)) return;

  if (keyboardState.shiftState === 'off') {
    keyboardState.shiftState = 'on'; 
    keyboardState.mode = 'shift';
  } else if (keyboardState.shiftState === 'on') {
    keyboardState.shiftState = 'lock'; 
    keyboardState.mode = 'caps';
  } else if (keyboardState.shiftState === 'lock') {
    keyboardState.shiftState = 'off'; 
    keyboardState.mode = 'normal';
  }
  
  saveKeyboardState();
  generateVirtualKeyboard();
}

/**
 * æ˜¾ç¤ºè™šæ‹Ÿé”®ç›˜
 */
function showVirtualKeyboard() {
  generateVirtualKeyboard();
  dom.virtualKeyboard.style.display = 'block';
}

/**
 * å°†é”®ç›˜çŠ¶æ€ä¿å­˜åˆ° localStorage
 */
function saveKeyboardState() {
  localStorage.setItem('keyboardState', JSON.stringify(keyboardState));
}

/**
 * ä» localStorage åŠ è½½æ•°æ®åˆ° tableData
 */
function loadData() {
  const savedData = localStorage.getItem('roundBarData');
  if (savedData) {
    tableData = JSON.parse(savedData);
  }
}

/**
 * å°† tableData ä¿å­˜åˆ° localStorage
 */
function saveDataToLocalStorage() {
  localStorage.setItem('roundBarData', JSON.stringify(tableData));
}

/**
 * æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡å¹¶æ‰¾å‡ºå…³é”®å­—æ®µçš„å·®å¼‚
 * @param {Object} oldObj - ç°æœ‰æ•°æ®
 * @param {Object} newObj - æ–°æ•°æ®
 * @returns {Array<Object>} å·®å¼‚æ•°ç»„
 */
function getObjectDifferences(oldObj, newObj) {
  const differences = [];
  
  const trackableKeys = [
    'steelType', 'cardId', 'furnaceId', 'actualDiameter', 
    'diameter', 'length', 'weight', 'status', 'position', 
    'hardness', 'remarks'
  ];

  for (const key of trackableKeys) {
    const oldValue = (oldObj[key] ?? '').toString().trim();
    const newValue = (newObj[key] ?? '').toString().trim();

    if (String(oldValue) !== String(newValue)) {
      differences.push({
        field: fieldLabels[key],
        existingItem: oldObj,
        newValue: newValue,
        key: key
      });
    }
  }
  
  return differences;
}

/**
 * å®Œæˆ Excel å¯¼å…¥çš„æœ€ç»ˆæ­¥éª¤ï¼šåˆå¹¶æ–°æ•°æ®å’Œå¤„ç†é‡å¤é¡¹
 * @param {Array<Object>} newData - å¾…æ·»åŠ çš„æ–°æ•°æ®
 * @param {Array<Object>} duplicateEntries - å¾…å¤„ç†çš„é‡å¤æ•°æ®
 * @param {number} totalImported - æ€»å…±è¯»å–çš„è®°å½•æ•°
 */
function finalizeImport(newData, duplicateEntries, totalImported) {
  let actuallyAdded = newData.length;
  let actuallyOverridden = 0;
  let actuallySkipped = 0;

  // å¤„ç†é‡å¤é¡¹çš„è¦†ç›–æˆ–è·³è¿‡
  duplicateEntries.forEach(entry => {
    const action = entry.action;
    const index = tableData.findIndex(item => item.productId && item.productId.trim() !== '' && item.productId === entry.productId);
    
    if (action === 'override' && index !== -1) {
      tableData[index] = entry.newItem; // è¦†ç›–
      actuallyOverridden++;
    } else if (action === 'skip') {
      actuallySkipped++; // è·³è¿‡
    }
  });

  // æ·»åŠ æ–°æ•°æ®
  if (newData.length > 0) {
    tableData = [...tableData, ...newData];
  }
  
  if (actuallyAdded > 0 || actuallyOverridden > 0 || actuallySkipped > 0 || totalImported > 0) {
    saveDataToLocalStorage();
    updateTable();
  }

  let resultMessage = `å¯¼å…¥å®Œæˆï¼å…±è¯»å– ${totalImported} æ¡è®°å½•ã€‚`;
  if (actuallyAdded > 0) resultMessage += ` æˆåŠŸæ·»åŠ  ${actuallyAdded} æ¡æ–°æ•°æ®ã€‚`;
  if (actuallyOverridden > 0) resultMessage += ` è¦†ç›– ${actuallyOverridden} æ¡é‡å¤æ•°æ®ã€‚`;
  if (actuallySkipped > 0) resultMessage += ` è·³è¿‡ ${actuallySkipped} æ¡é‡å¤æ•°æ®ã€‚`;
  if (totalImported === 0) resultMessage = `å¯¼å…¥å®Œæˆï¼æ–‡ä»¶æœªåŒ…å«æœ‰æ•ˆæ•°æ®ã€‚`;
  
  showSnackbar(resultMessage, 'success');
}

/**
 * æ˜¾ç¤ºå¯¼å…¥é‡å¤æ•°æ®ç¡®è®¤æ¨¡æ€æ¡†
 * @param {Array<Object>} duplicateEntries - é‡å¤æ•°æ®åˆ—è¡¨
 * @param {Array<Object>} newData - æ–°æ•°æ®åˆ—è¡¨
 * @param {number} totalImported - æ€»å…±è¯»å–çš„è®°å½•æ•°
 */
function showDuplicateConfirmationModal(duplicateEntries, newData, totalImported) {
  const modalElement = dom.duplicateConfirmationModal;
  openCustomModal(modalElement); 
  
  const listContainer = modalElement.querySelector('#modal-duplicate-list');
  const totalCountEl = modalElement.querySelector('#modal-total-count');
  const newCountEl = modalElement.querySelector('#modal-new-count');
  const duplicateCountEl = modalElement.querySelector('#modal-duplicate-count');

  listContainer.innerHTML = '';
  totalCountEl.textContent = totalImported;
  newCountEl.textContent = newData.length;
  duplicateCountEl.textContent = duplicateEntries.length;

  const itemTemplateHtml = document.getElementById('duplicate-item-template').innerHTML;
  const differenceTemplateHtml = document.getElementById('difference-row-template').innerHTML;

  // æ¸²æŸ“é‡å¤é¡¹åˆ—è¡¨
  duplicateEntries.forEach((entry, itemIndex) => {
    let itemHtml = itemTemplateHtml.replace(/PRODUCT_ID/g, entry.productId || 'N/A');
    itemHtml = itemHtml.replace(/ITEM_INDEX/g, itemIndex);

    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = itemHtml;
    const differencesContainer = tempDiv.querySelector('.duplicate-differences tbody');
    
    const hasDiff = entry.differences.length > 0;

    if (hasDiff) {
      entry.differences.forEach(diff => {
        let rowHtml = differenceTemplateHtml
          .replace('FIELD_NAME', diff.field)
          .replace('OLD_VALUE', diff.existingItem[diff.key] || '-') 
          .replace('NEW_VALUE', diff.newValue);
        differencesContainer.innerHTML += rowHtml;
      });
    } else {
      differencesContainer.innerHTML = '<tr><td colspan="3" class="mdui-text-center" style="font-style: italic; color: #757575;">æ— å…³é”®å­—æ®µå·®å¼‚</td></tr>';
    }

    listContainer.appendChild(tempDiv.firstElementChild);
  });

  // ç»‘å®šæ‰¹é‡æ“ä½œæŒ‰é’®
  document.getElementById('modal-btn-select-all-skip').onclick = function() {
    modalElement.querySelectorAll('input[type="radio"][value="skip"]').forEach(radio => radio.checked = true);
  };

  document.getElementById('modal-btn-select-all-override').onclick = function() {
    modalElement.querySelectorAll('input[type="radio"][value="override"]').forEach(radio => radio.checked = true);
  };

  // ç»‘å®šç¡®è®¤å¯¼å…¥æŒ‰é’®
  document.getElementById('modal-btn-confirm').onclick = function() {
    const finalDuplicateData = duplicateEntries.map((entry, index) => {
      const selectedAction = modalElement.querySelector(`input[name="action-${index}"]:checked`).value;
      return {
        ...entry,
        action: selectedAction
      };
    });

    closeCustomModal(modalElement); 
    setTimeout(() => {
      finalizeImport(newData, finalDuplicateData, totalImported);
    }, 300);
  };
}

/**
 * å¤„ç† Excel æ–‡ä»¶å¯¼å…¥é€»è¾‘
 * @param {Event} e - æ–‡ä»¶è¾“å…¥äº‹ä»¶
 */
function handleFileImport(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  if (file.size > 10 * 1024 * 1024) {
    showSnackbar('å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB', 'error');
    dom.fileInput.value = '';
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const worksheet = workbook.Sheets[workbook.SheetNames[0]];
      const importedData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
      
      if (importedData.length < 2) {
        showSnackbar('å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶ä¸­æœªæ‰¾åˆ°æ•°æ®è¡Œã€‚', 'error');
        dom.fileInput.value = '';
        return;
      }
      
      const headers = importedData[0].map(h => String(h).trim());
      const dataRows = importedData.slice(1);
      
      // Excel åˆ—å¤´ä¸å†…éƒ¨å­—æ®µçš„æ˜ å°„
      const columnMapping = {
        'é’¢ç§': 'steelType', 'äº§å“å·': 'productId', 'å¡ç‰‡å·': 'cardId', 'ç‚‰å·': 'furnaceId',
        'å®é™…ç›´å¾„': 'actualDiameter', 'ç›´å¾„': 'diameter', 'é•¿åº¦': 'length', 'é•¿åº¦': 'length', 
        'é‡é‡': 'weight', 'é‡é‡': 'weight', 'çŠ¶æ€': 'status', 'ä½ç½®': 'position',
        'ç¡¬åº¦': 'hardness', 'å¤‡æ³¨': 'remarks'
      };
      
      const formattedData = dataRows.map(row => {
        const item = {};
        headers.forEach((header, index) => {
          const key = columnMapping[header];
          if (key) {
             item[key] = (row[index] !== undefined && row[index] !== null) ? String(row[index]).trim() : '';
          }
        });
        return item;
      }).filter(item => item.productId && item.productId.trim() !== ''); // è¿‡æ»¤æ‰æ— äº§å“å·çš„æ— æ•ˆè¡Œ

      const totalImported = formattedData.length;
      const newData = [];
      const duplicateEntries = [];

      // åŒºåˆ†æ–°æ•°æ®å’Œé‡å¤æ•°æ®
      formattedData.forEach(newItem => {
        const existingItem = tableData.find(item => item.productId && item.productId.trim() !== '' && item.productId === newItem.productId);
        
        if (!existingItem) {
          newData.push(newItem);
        } else {
          duplicateEntries.push({
            productId: newItem.productId,
            existingItem: existingItem,
            newItem: newItem,
            differences: getObjectDifferences(existingItem, newItem)
          });
        }
      });

      if (totalImported === 0) {
        showSnackbar('å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶ä¸­æœªåŒ…å«æœ‰æ•ˆäº§å“å·æ•°æ®ã€‚', 'error');
      } else if (duplicateEntries.length > 0) {
        showDuplicateConfirmationModal(duplicateEntries, newData, totalImported); // å‘ç°é‡å¤ï¼Œå¼¹å‡ºç¡®è®¤æ¡†
      } else {
        finalizeImport(newData, [], totalImported); // æ— é‡å¤ï¼Œç›´æ¥å¯¼å…¥
      }

    } catch (error) {
      console.error('å¯¼å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿä¸¥é‡é”™è¯¯:', error);
      showSnackbar('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æˆ–å†…å®¹æ˜¯å¦æ­£ç¡®ã€‚', 'error');
    } finally {
      dom.fileInput.value = '';
    }
  };
  
  reader.onerror = function(error) {
    console.error('FileReader è¯»å–æ–‡ä»¶å¤±è´¥:', error);
    showSnackbar('å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶è¯»å–é”™è¯¯ã€‚', 'error');
    dom.fileInput.value = '';
  };
  
  reader.readAsArrayBuffer(file);
}

/**
 * å°†å½“å‰ç­›é€‰åçš„æ•°æ®å¯¼å‡ºä¸º Excel æ–‡ä»¶
 */
function exportToExcel() {
  const exportData = getFilteredData();
  if (exportData.length === 0) {
    showSnackbar('æš‚æ— æ•°æ®å¯å¯¼å‡º', 'warning');
    return;
  }
  
  // æ ¼å¼åŒ–å¯¼å‡ºæ•°æ®ï¼Œæ·»åŠ ä¸­æ–‡è¡¨å¤´
  const formattedExportData = exportData.map((item, index) => ({
    'åºå·': index + 1,
    'é’¢ç§': item.steelType || '',
    'äº§å“å·': item.productId || '',
    'å¡ç‰‡å·': item.cardId || '',
    'ç‚‰å·': item.furnaceId || '',
    'å®é™…ç›´å¾„': item.actualDiameter || '',
    'ç›´å¾„': item.diameter || '',
    'é•¿åº¦': item.length || '', 
    'é‡é‡': item.weight || '', 
    'çŠ¶æ€': item.status || '',
    'ä½ç½®': item.position || '',
    'ç¡¬åº¦': item.hardness || '',
    'å¤‡æ³¨': item.remarks || ''
  }));
  
  const worksheet = XLSX.utils.json_to_sheet(formattedExportData);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, 'åœ†æ£’å…¥åº“æ•°æ®');
  
  const dateString = new Date().toLocaleDateString().replace(/\//g, '-');
  XLSX.writeFile(workbook, `åœ†æ£’å…¥åº“æ•°æ®_${dateString}.xlsx`);
}

/**
 * æ ¹æ®è®¡ç®—å™¨è¾“å…¥è®¡ç®—åœ†æ£’é‡é‡
 * å…¬å¼ï¼šé‡é‡ (Kg) = ç›´å¾„1 * ç›´å¾„2 * é•¿åº¦ * å¯†åº¦ / 1000
 * é‡‡ç”¨ $D_1 \cdot D_2 \cdot L \cdot \text{densityFactor} / 1000$ çš„è¿‘ä¼¼å…¬å¼
 */
function calculateWeight() {
  const diameter1 = parseFloat(dom.calcDiameter1.value) || 0;
  const diameter2 = parseFloat(dom.calcDiameter2.value) || 0;
  const length = parseFloat(dom.calcLength.value) || 0;
  // å¯†åº¦ï¼š0.00617ï¼Œè¿™é‡Œå‡è®¾å®ƒæ˜¯ä¸€ä¸ªå·²ç»ç®€åŒ–åçš„ç³»æ•°
  const densityFactor = parseFloat(dom.calcDensity.value) || 0.00617; 
  
  if (diameter1 <= 0 || diameter2 <= 0 || length <= 0) {
    dom.calcResult.value = '';
    return;
  }
  
  // é‡‡ç”¨è¿‘ä¼¼å…¬å¼ $D_1 \cdot D_2 \cdot L \cdot \text{densityFactor} / 1000$
  const crudeWeight = densityFactor * diameter1 * diameter2 * length / 1000;
  
  dom.calcResult.value = crudeWeight.toFixed(2);
}

/**
 * ç»‘å®šè®¡ç®—å™¨è¾“å…¥æ¡†çš„è¾“å…¥äº‹ä»¶ï¼Œå®ç°å®æ—¶è®¡ç®—
 */
function initAutoCalculate() {
  const calcInputs = [
    dom.calcDiameter1,
    dom.calcDiameter2,
    dom.calcLength
  ];
  
  calcInputs.forEach(input => {
    if (input) {
      input.addEventListener('input', calculateWeight);
      input.addEventListener('change', calculateWeight);
    }
  });
  
  // å…è®¸åŒå‡»ä¿®æ”¹å¯†åº¦ï¼Œä½†é»˜è®¤åªè¯»
  dom.calcDensity.addEventListener('dblclick', (e) => {
      e.stopPropagation();
      const densityInput = dom.calcDensity;
      if (densityInput.hasAttribute('readonly')) {
          densityInput.removeAttribute('readonly');
          densityInput.classList.remove('readonly-input');
          densityInput.focus();
      } else {
          densityInput.setAttribute('readonly', 'true');
          densityInput.classList.add('readonly-input');
          densityInput.blur();
      }
  });
  
  calculateWeight();
}

/**
 * æ‰§è¡Œé‡é‡è®¡ç®—å¹¶å°†ç»“æœå¡«å……åˆ°æ–°å¢æ•°æ®æ¨¡æ€æ¡†
 */
function calculateAndAddData() {
    const diameter1 = parseFloat(dom.calcDiameter1.value);
    const diameter2 = parseFloat(dom.calcDiameter2.value);
    const length = parseFloat(dom.calcLength.value);
    const weight = parseFloat(dom.calcResult.value);

    if (isNaN(diameter1) || isNaN(diameter2) || isNaN(length) || 
        diameter1 <= 0 || diameter2 <= 0 || length <= 0) {
      showSnackbar('è¯·è¾“å…¥æœ‰æ•ˆçš„è®¡ç®—å‚æ•°', 'error');
      return;
    }

    const minDiameter = Math.min(diameter1, diameter2);
    const maxDiameter = Math.max(diameter1, diameter2);
    const actualDiameter = `${minDiameter.toFixed(2)}-${maxDiameter.toFixed(2)}`;
    const averageDiameter = ((minDiameter + maxDiameter) / 2).toFixed(2);

    const preFilledData = {
      actualDiameter: actualDiameter,
      diameter: averageDiameter, 
      length: length.toFixed(2),
      weight: weight.toFixed(2)
    };

    closeCustomModal(dom.calculatorModal); 
    dom.virtualKeyboard.style.display = 'none'; 
    openAddModalWithData(preFilledData);
}

/**
 * åˆ‡æ¢å¤šé€‰æ¨¡å¼ (Multi-Select Mode)
 */
function toggleMultiSelectMode() {
  isMultiSelectMode = !isMultiSelectMode;
  selectedRows.clear(); // åˆ‡æ¢æ¨¡å¼æ—¶æ¸…ç©ºé€‰ä¸­é¡¹
  
  // æ›´æ–°èœå•æ–‡æœ¬
  const menuText = dom.multiSelectMenuText;
  if (isMultiSelectMode) {
    menuText.textContent = 'é€€å‡ºå¤šé€‰æ¨¡å¼';
    dom.multiSelectMenuItem.icon = 'check_box';
  } else {
    menuText.textContent = 'è¿›å…¥å¤šé€‰æ¨¡å¼';
    dom.multiSelectMenuItem.icon = 'check_box_outline_blank';
  }
  
  updateTable();
}

/**
 * åˆå§‹åŒ–è®¡ç®—å™¨è¾“å…¥æ¡†çš„åªè¯»å’Œé”®ç›˜äº‹ä»¶
 */
function initCalculatorKeyboard() {
  const calcInputs = [
    dom.calcDiameter1,
    dom.calcDiameter2,
    dom.calcLength
  ]; // calcDensity å·²åœ¨ initAutoCalculate ä¸­å•ç‹¬å¤„ç†

  calcInputs.forEach(input => {
    if (input) {
      input.setAttribute('readonly', 'true');
      input.classList.add('readonly-input');
      
      input.addEventListener('click', (e) => {
          if (input.hasAttribute('readonly')) {
            e.stopPropagation();
            currentInput = e.target;
            updateKeyboardForInput(currentInput);
            showVirtualKeyboard();
            currentInput.focus();
            
            // æ»šåŠ¨åˆ°è¾“å…¥æ¡†
            const modalContent = document.getElementById('calculatorContent');
            if(modalContent) {
                setTimeout(() => {
                    const inputRect = currentInput.getBoundingClientRect();
                    const modalRect = modalContent.getBoundingClientRect();
                    const offset = inputRect.top - modalRect.top + modalContent.scrollTop - modalRect.height * 0.3; 
                    modalContent.scrollTo({ top: offset, behavior: 'smooth' });
                }, 50);
            }
          }
      });
      
      // åŒå‡»è§£é™¤åªè¯»
      input.addEventListener('dblclick', (e) => {
          e.stopPropagation();
          if (dom.calculatorModal.style.display !== 'block') return;
          
          if (input.hasAttribute('readonly')) {
            input.removeAttribute('readonly');
            input.classList.remove('readonly-input');
            dom.virtualKeyboard.style.display = 'none';
            input.focus();
          } else {
            input.setAttribute('readonly', 'true');
            input.classList.add('readonly-input');
            currentInput = input;
            updateKeyboardForInput(currentInput);
            showVirtualKeyboard();
          }
      });
    }
  });
}

/**
 * æ‰“å¼€æ’åºæ¨¡æ€æ¡†
 */
function openSortModal() {
    dom.drawer.open = false;
    openCustomModal(dom.sortModal);
    
    // åˆå§‹åŒ–é€‰æ‹©æ¡†ä¸ºé»˜è®¤å€¼
    dom.sortField.value = 'productId'; 
    dom.sortOrder.value = 'asc';
}

/**
 * åº”ç”¨æ’åºé€»è¾‘
 */
function applySort() {
    const field = dom.sortField.value;
    const order = dom.sortOrder.value; // 'asc' æˆ– 'desc'

    if (tableData.length === 0) {
        showSnackbar('æ²¡æœ‰æ•°æ®å¯æ’åº', 'warning');
        closeCustomModal(dom.sortModal);
        return;
    }

    const isNumeric = ['actualDiameter', 'diameter', 'length', 'weight', 'hardness'].includes(field);

    tableData.sort((a, b) => {
        const aValue = a[field] ?? '';
        const bValue = b[field] ?? '';

        if (isNumeric) {
            const aNum = parseFloat(aValue) || 0;
            const bNum = parseFloat(bValue) || 0;
            
            if (order === 'asc') {
                return aNum - bNum;
            } else {
                return bNum - aNum;
            }
        } else {
            // å­—ç¬¦ä¸²æ’åº
            const comparison = String(aValue).localeCompare(String(bValue), 'zh-CN', { numeric: true, sensitivity: 'base' });
            if (order === 'asc') {
                return comparison;
            } else {
                return -comparison;
            }
        }
    });

    saveDataToLocalStorage();
    updateTable();
    closeCustomModal(dom.sortModal);
    showSnackbar(`å·²æŒ‰ã€${fieldLabels[field]}ã€‘è¿›è¡Œã€${order === 'asc' ? 'å‡åº' : 'é™åº'}ã€‘æ’åº`, 'success');
}

/**
 * ğŸ” è¡¨æ ¼æ‰‹åŠ¿ç¼©æ”¾ï¼šåŒæŒ‡æåˆæ•´ä½“ç¼©æ”¾è¡¨æ ¼ï¼ˆåŒ…æ‹¬è¡Œé«˜ã€æŒ‰é’®ç­‰ï¼‰
 */
function initTableZoom() {
    const container = document.querySelector('.data-table-container');
    if (!container) return;

    let initialDistance = 0;
    let initialScale = 1;

    const getDistance = (touches) => {
        const dx = touches[0].clientX - touches[1].clientX;
        const dy = touches[0].clientY - touches[1].clientY;
        return Math.sqrt(dx * dx + dy * dy);
    };

    const applyScale = (scale) => {
    scale = Math.min(Math.max(0.5, scale), 3.0);

    container.style.width = `${100 / scale}%`;
    container.style.height = `${100 / scale}%`;  // å¯é€‰ï¼Œå¦‚æœä½ å¸Œæœ›å‚ç›´ä¹Ÿè‡ªé€‚åº”
    
    container.style.transform = `scale(${scale})`;
};

    // è·å–å½“å‰ç¼©æ”¾å€¼
    const getCurrentScale = () => {
        const match = container.style.transform.match(/scale\(([^)]+)\)/);
        return match ? parseFloat(match[1]) : 1;
    };

    container.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
            e.preventDefault();
            initialDistance = getDistance(e.touches);
            initialScale = getCurrentScale();
        }
    }, { passive: false });

    container.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2 && initialDistance > 0) {
            e.preventDefault();
            const currentDistance = getDistance(e.touches);
            const ratio = currentDistance / initialDistance;
            const newScale = initialScale * ratio;
            applyScale(newScale);
        }
    }, { passive: false });

    container.addEventListener('touchend', (e) => {
        if (e.touches.length < 2) {
            initialDistance = 0;
        }
    });

    // åŒå‡»è¡¨å¤´æ¢å¤åŸå§‹å¤§å°
    const tableHeader = document.querySelector('#dataTable thead');
    if (tableHeader) {
        let lastTap = 0;
        tableHeader.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTap < 300) {
                container.style.transform = 'scale(1)';
                e.preventDefault();
            }
            lastTap = now;
        });
    }
}

/**
 * é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–å…¥å£å‡½æ•°
 */
document.addEventListener('DOMContentLoaded', () => {
  initTheme();
  initEventListeners();
  loadData();
  updateTable();
  initAutoCalculate();
  initCalculatorKeyboard(); 
  dom.calcDensity.value = 0.00617;
  
  // ğŸ” æ–°å¢ï¼šåˆå§‹åŒ–è¡¨æ ¼ç¼©æ”¾
  initTableZoom(); 
});
</script>

</body>
</html>
