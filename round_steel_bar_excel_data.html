<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no,viewport-fit=cover">
    <title>圆棒入库数据管理-Gemini生成</title>
    <link rel="stylesheet" href="https://unpkg.com/mdui@2/mdui.css">
    
    <script src="https://unpkg.com/mdui@2.0.3/mdui.global.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<style>
    /* 🎨 全局样式与黑暗模式 */
    :root {
        --primary-color: #00796b;
        --background-color: #f5f5f5;
        --surface-color: #ffffff;
        --text-color: #212121;
        --border-color: #e0e0e0;
        --drawer-icon-size: 24px;
    }

    body.dark-mode {
        --primary-color: #80cbc4; 
        --background-color: #121212; 
        --surface-color: #1e1e1e; 
        --text-color: #ffffff;
        --border-color: #333333;
    }

    body.mdui-theme-dark {
        --mdui-theme-color-surface: var(--surface-color);
        --mdui-theme-color-background: var(--background-color);
        --mdui-theme-color-primary: var(--primary-color);
        --mdui-top-app-bar-background-color: var(--surface-color);
    }
    
    .data-form input, .data-form select, .search-bar input {
        background-color: var(--background-color);
        color: var(--text-color);
    }
    
    .search-bar {
        background-color: var(--background-color); 
    }

    body {
        font-family: 'Roboto', 'Helvetica', 'Arial', sans-serif;
        margin: 0;
        padding-bottom: 0; 
        background-color: var(--background-color);
        color: var(--text-color);
        transition: background-color 0.3s, color 0.3s;
    }
    
    /* 🌟 顶部固定区域样式 🌟 */
    .top-fixed-area {
        position: sticky;
        top: 0;
        z-index: 100;
        background-color: var(--surface-color);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 8px 16px 0 16px;
    }
    
    .action-bar {
        display: flex;
        align-items: center; 
        justify-content: flex-start;
        gap: 8px;
        flex-wrap: nowrap; 
        background-color: var(--surface-color);
        padding-bottom: 8px;
    }

    .search-bar {
        display: flex;
        align-items: center;
        border-radius: 8px;
        padding: 4px 8px;
        flex-grow: 1;
        width: 50%;
        max-width: 400px;
        border: 1px solid var(--border-color);
    }

    .search-bar input {
        border: none;
        outline: none;
        background: none;
        padding: 8px;
        flex-grow: 1;
        min-width: 0;
    }
    
    /* 搜索替换容器 */
    .search-replace-container {
        padding: 8px 0;
        margin-bottom: 8px;
        border-top: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .search-replace-row {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .search-replace-row input {
        flex-grow: 1;
        padding: 8px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        box-sizing: border-box;
        background-color: var(--background-color);
        color: var(--text-color);
    }
    
    .search-replace-row mdui-button {
        flex-shrink: 0;
    }

    .search-clear-btn {
        display: none;
        cursor: pointer;
        color: #757575;
    }

    .search-clear-btn.active {
        display: inline-block;
    }
    
    .batch-action-container {
        width: 100%;
        padding: 0 0 8px 0;
        background-color: var(--surface-color);
        border-top: 1px solid var(--border-color);
        margin-top: -1px; 
    }

    .item-count {
        padding: 8px 16px;
        font-size: 0.9rem;
        color: #757575;
        background-color: var(--surface-color);
        border-top: 1px solid var(--border-color);
    }
    
    /* 表单输入框样式 */
    .data-form {
        padding: 16px;
    }
    .data-form input, .data-form select {
        width: 100%;
        padding: 10px;
        margin-bottom: 12px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        box-sizing: border-box;
    }

    .data-form label {
        display: block;
        margin-bottom: 4px;
        font-size: 0.9rem;
        color: #757575;
    }
    
    #remarks {
        height: 200px; 
        font-size: 16px; 
    }
    
    .readonly-input {
         cursor: pointer !important;
         background-color: #e0e0e0 !important;
    }
    
    .dark-mode .readonly-input {
         background-color: #333333 !important;
    }

    /* 修复空状态元素占位和越界问题 */
    .empty-state {
        text-align: center;
        padding: 50px 20px; 
        color: #757575;
        position: absolute; 
        top: 0; 
        left: 0;
        width: 100%; 
        height: 100%;
        display: none;
        z-index: 50;
        background-color: var(--background-color);
        box-sizing: border-box;
    }

    .empty-state p {
        word-break: break-word; 
        overflow-wrap: break-word; 
        max-width: 90%; 
        margin: 10px auto 0 auto;
    }
    
    /* 虚拟键盘样式 */
    #virtualKeyboard {
        position: fixed;
        bottom: 0; 
        left: 0;
        width: 100%;
        background-color: var(--surface-color);
        border-top: 1px solid var(--border-color);
        padding: 0px;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
        z-index: 2000; 
        display: none;
        box-sizing: border-box;
    }
    
    .keyboard-row {
        display: flex;
        justify-content: center;
        margin-bottom: 5px;
    }

    .keyboard-key {
        background-color: var(--background-color);
        color: var(--text-color);
        flex: 1;
        margin: 3px;
        padding: 10px 5px;
        border-radius: 8px;
        text-align: center;
        font-size: 1rem;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.1s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .keyboard-key:active {
        background-color: var(--primary-color);
        color: #ffffff;
    }

    .special {
        background-color: #bdbdbd;
        color: #212121;
    }

    .dark-mode .special {
        background-color: #424242;
        color: #ffffff;
    }

    .wide { flex: 1.5; }
    .extra-wide { flex: 5; }
    
    #shortcutContainer {
        padding: 5px 0;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 5px;
        overflow-x: auto;
        white-space: nowrap;
    }
    
    #shortcutContainer .keyboard-row {
        flex-wrap: nowrap;
        justify-content: flex-start;
    }

    .shortcut-key, .status-key {
        flex: none;
        padding: 8px 12px;
        margin: 3px;
    }

    .clear-key { background-color: #f44336 !important; color: white !important; }
    .system-keyboard { background-color: #2196f3 !important; color: white !important; }
    
    /* 修复表格容器高度和溢出问题 */
    .data-table-container-div {
        padding: 0 6px;
        width: 100%;
        height: calc(100vh - 100px); 
        box-sizing: border-box;
        position: relative; 
    }
    
    .data-table-container {
        overflow: auto; 
        box-sizing: border-box;
        min-width: 100%;
        width: 100%;
        max-height: calc(160vh - 100px);
        height: calc(100vh - 100px);
        margin-top: 0;
        
        -webkit-overflow-scrolling: touch;
        transform-origin: top left;
        transition: transform 0.2s ease-out;
        transform: none; 
    }

    #dataTable {
        min-width: 100%; 
        border-collapse: collapse;
        table-layout: auto;
    }

    
    /* 冻结表头 */
    #dataTable th {
        position: sticky;
        top: 0; 
        z-index: 50; 
        background-color: var(--surface-color);
        box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1); 
        font-weight: 500;
        border-bottom: 2px solid var(--border-color);
    }

    /* 单元格 */
    #dataTable th, #dataTable td {
        padding: 12px 8px; 
        border: 1px solid var(--border-color);
        text-align: center;
        white-space: normal;
        word-break: break-word;
        font-size: 1rem; 
        /* 🌟 核心修正：恢复基础最小宽度，防止过度压缩 🌟 */
        min-width: 80px; 
        overflow: visible;
    }
    
    /* 🌟 修正列宽样式 - 固定列 🌟 */
    .action-col   { min-width: 100px; width: 100px; max-width: 100px; } 
    .seq-col      { min-width: 60px; width: 60px; position: relative; } 
    .checkbox-col { min-width: 50px; width: 50px; } 
    /* 🌟 修正列宽样式 - 内容可变长列 🌟 */
    /* 移除备注列的固定宽度限制，它现在默认继承 min-width: 80px */
    .remark-col   { min-width: 150px; } /* 备注列通常需要更大的最小宽度 */

    /* * 钢种、产品号、炉号、状态、位置、直径、长度、重量等列 
    * 它们将继承 #dataTable th, #dataTable td 中的 min-width: 80px，
    * 并在内容较长时自动加宽，确保不会过度换行。
    */
    
    .delete-btn { color: #f44336; }

    .selected {
        background-color: rgba(0, 121, 107, 0.1) !important;
    }
    .dark-mode .selected {
        background-color: rgba(128, 203, 196, 0.2) !important;
    }

    .highlight {
        background-color: rgba(255, 193, 7, 0.3) !important;
        transition: background-color 0.5s ease-out;
    }
    
    /* 搜索替换高亮 */
    .search-match-highlight {
        background-color: #ffc107; 
        font-weight: bold;
        color: #212121;
    }
    .dark-mode .search-match-highlight {
        background-color: #ffd54f; 
        color: #212121;
    }
    .current-match-highlight {
        outline: 2px solid var(--primary-color);
        outline-offset: -2px;
    }
    
    /* 移动按钮 */
    .move-buttons {
        display: none;
        flex-direction: column;
        position: absolute;
        left: 0; top: 0;
        height: 100%;
        justify-content: center;
        z-index: 10;
        background-color: rgba(255, 255, 255, 0.8);
        border-right: 1px solid var(--border-color);
        padding: 0 4px;
    }
    .dark-mode .move-buttons { background-color: rgba(30, 30, 30, 0.8); }
    #dataTable tr:hover .move-buttons { display: flex; }
    
    .move-btn {
        background: none;
        border: none;
        padding: 2px;
        cursor: pointer;
        margin: 1px 0;
        color: var(--primary-color);
        transition: color 0.1s;
    }
    .move-btn:hover { color: #f44336; }
    
    #dataTable td, #dataTable th { position: relative; }
    
    /* 自定义 Modal/Sheet 样式 */
    .modal-custom {
        display: none; 
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.4);
        z-index: 1050; 
    }
    
    .modal-content-custom {
        background-color: var(--surface-color);
        margin: 15% auto; 
        padding: 0;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        width: 90%; 
        max-width: 500px; 
        display: flex;
        flex-direction: column;
        max-height: 90vh; 
    }

    .full-height-custom .modal-content-custom {
        width: 100%;
        max-width: 100%;
        height: 100%;
        margin: 0;
        border-radius: 0; 
    }

    .modal-header-custom {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        height: 56px; /* 固定高度 */
        border-bottom: 1px solid var(--border-color);
        position: sticky; 
        top: 0; 
        background-color: var(--surface-color);
        z-index: 10;
        flex-shrink: 0;
    }
    
    .modal-header-custom h2 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 500;
    }

    .modal-body-custom {
        padding: 16px; 
        overflow-y: auto; 
        flex-grow: 1; 
    }
    
    /* 修正全屏模态框主体高度 */
    .full-height-custom .modal-body-custom {
        max-height: calc(100vh - 56px - 64px); 
        height: calc(100vh - 56px - 64px);
        padding: 0; 
        box-sizing: border-box;
    }
    
    #calculatorModalCustom .modal-body-custom {
        max-height: calc(100vh - 370px); 
        height: auto;
        overflow-y: auto; 
        padding: 0; 
    }
    
    #sortModalCustom .modal-body-custom { padding: 16px; }

    .modal-footer-custom {
        padding: 8px 16px; 
        display: flex; 
        justify-content: flex-end; 
        gap: 8px; 
        position: sticky; 
        bottom: 0; 
        background-color: var(--surface-color); 
        z-index: 10;
        box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
        height: 64px; /* 固定高度 */
        box-sizing: border-box;
        flex-shrink: 0; 
    }

    .modal-custom:not(.full-height-custom) .modal-content-custom {
        position: absolute; 
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%; 
        max-width: 450px;
        max-height: 90vh;
    }
    
    #confirmModalCustom .modal-body-custom { padding: 16px; }
    
    /* 重复数据确认模态框 */
    #duplicateConfirmationModalCustom .modal-body-custom {
        max-height: calc(100vh - 56px - 64px); 
        padding: 16px;
        overflow-y: auto;
    }
    
    .duplicate-item {
        border: 1px solid var(--border-color);
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
        background-color: var(--background-color);
    }
    .dark-mode .duplicate-item { background-color: #282828; }
    
    .duplicate-actions label { margin-right: 15px; font-size: 0.9rem; }
    
    .duplicate-item table { width: 100%; margin: 10px 0 15px; border-collapse: collapse; }
    .duplicate-item table th, .duplicate-item table td { padding: 8px; border: 1px solid var(--border-color); text-align: center; }
    .duplicate-item table th { background-color: var(--surface-color); }

    #drawerList mdui-icon { font-size: var(--drawer-icon-size); }

    .checkbox-col {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 !important; 
    }
    
    .checkbox-col > mdui-checkbox {
        margin: 0; 
        padding: 12px 8px; 
    }
    
    .top-action-buttons {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-shrink: 0; 
    }
    
    #mainFab {
        position: fixed;
        right: 16px;
        bottom: 16px;
        z-index: 1000; 
    }
    
    /* 快速编辑弹窗 */
    #quickEditDialog .modal-content-custom {
        max-width: 400px;
        top: 30%; 
        transform: translate(-50%, -50%); 
    }
    
    #quickEditDialog .modal-body-custom { padding: 20px; }
    
    #quickEditDialog label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--primary-color);
    }
    
    #quickEditInput {
        font-size: 1.2rem;
        padding: 12px;
        border: 2px solid var(--primary-color);
        border-radius: 4px;
        width: 100%;
        box-sizing: border-box;
        background-color: var(--background-color);
        color: var(--text-color);
    }
</style>



</head>
<body>

    <mdui-navigation-drawer id="drawer" close-on-overlay-click placement="left" close-on-esc>
        <mdui-top-app-bar slot="header">
            <mdui-top-app-bar-title>功能菜单</mdui-top-app-bar-title>
        </mdui-top-app-bar>
        
        <mdui-list id="drawerList">
            <mdui-collapse>
                <mdui-collapse-item id="themeCollapse">
                    <mdui-list-item slot="header" icon="dark_mode" headline="主题模式 (当前: 自动)"></mdui-list-item>
                    <mdui-list id="themeCollapseContent">
                        <mdui-list-item class="theme-option" data-theme="auto" icon="brightness_auto" headline="自动 (跟随系统)"></mdui-list-item>
                        <mdui-list-item class="theme-option" data-theme="light" icon="light_mode" headline="日间模式"></mdui-list-item>
                        <mdui-list-item class="theme-option" data-theme="dark" icon="dark_mode" headline="夜间模式"></mdui-list-item>
                    </mdui-list>
                </mdui-collapse-item>
            </mdui-collapse>
            
            <mdui-list-item id="importItem" icon="file_upload" headline="导入 Excel"></mdui-list-item>
            <mdui-list-item id="exportItem" icon="file_download" headline="导出 Excel"></mdui-list-item>
            <mdui-list-item id="calculatorBtn" icon="calculate" headline="计算重量"></mdui-list-item>
            
            <mdui-divider></mdui-divider>
            <mdui-list-item id="sortItem" icon="sort" headline="数据排序"></mdui-list-item>
        </mdui-list>
    </mdui-navigation-drawer>

    <div class="top-fixed-area">
        <div class="action-bar">
            <mdui-button-icon icon="menu" id="openDrawerBtn"></mdui-button-icon>
            
            <div class="search-bar">
                <span class="material-icons" style="color:#757575;">search</span>
                <input type="text" id="searchInput" placeholder="搜索所有字段...">
                <span class="material-icons search-clear-btn" id="searchClearBtn">clear</span>
            </div>
            
            <div class="top-action-buttons">
                 <mdui-button-icon icon="find_replace" id="toggleSearchReplaceBtn" style="margin-right: -8px;"></mdui-button-icon>
                <mdui-dropdown placement="bottom-end">
                    <mdui-button-icon slot="trigger" icon="more_vert" id="topMenuBtn"></mdui-button-icon>
                    <mdui-menu>
                        <mdui-menu-item id="multiSelectMenuItem" icon="check_box_outline_blank">
                            <span id="multiSelectMenuText">进入多选模式</span>
                        </mdui-menu-item>
                        <mdui-menu-item id="aboutItem" icon="info">关于</mdui-menu-item>
                    </mdui-menu>
                </mdui-dropdown>
            </div>
        </div>
        
        <div class="search-replace-container" id="searchReplaceContainer" style="display: none;">
             <div class="search-replace-row">
                <input type="text" id="replaceQuery" placeholder="替换为">
                <mdui-button variant="filled" id="replaceOneBtn" disabled style="width: 80px;">替换</mdui-button>
                <mdui-button variant="outlined" id="replaceAllBtn" color="error" disabled style="width: 80px;">替换全部</mdui-button>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; margin-top: -5px;">
                <span id="searchResultCount" style="font-size: 0.9rem; color: #757575;"></span>
                <div style="display: flex; gap: 8px;">
                    <mdui-button-icon icon="arrow_upward" id="prevMatchBtn"></mdui-button-icon>
                    <mdui-button-icon icon="arrow_downward" id="nextMatchBtn"></mdui-button-icon>
                </div>
            </div>
        </div>
        <div class="batch-action-container">
             <mdui-button variant="outlined" color="error" id="deleteSelectedBtn" style="display: none; margin-Top:10px; width: 100%;">
                <mdui-icon name="delete"></mdui-icon>
                批量删除 (<span id="selectedCount">0</span>)
            </mdui-button>
        </div>

        <div class="item-count" id="itemCount"></div>
    </div>
    
    
    <div class="data-table-container-div">
        <div class="data-table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th class="seq-col">序号</th>
                        <th class="checkbox-col" style="display: none;">
                            <mdui-checkbox id="selectAllCheckbox">全选</mdui-checkbox>
                        </th>
                        <th>钢种</th>
                        <th>产品号</th>
                        <th>卡片号</th>
                        <th>炉号</th>
                        <th>实际直径</th>
                        <th>直径</th>
                        <th>长度</th>
                        <th>重量</th>
                        <th>状态</th>
                        <th>位置</th>
                        <th>硬度</th>
                        <th class="remark-col">备注</th>
                        <th class="action-col">操作</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    </tbody>
            </table>
        </div>
    
        <div class="empty-state" id="emptyState">
            <span class="material-icons" style="font-size: 48px;">inbox</span>
            <p>暂无数据，点击右下角“添加”按钮开始录入。</p>
        </div>
    </div>
    

    <input type="file" id="fileInput" accept=".xlsx, .xls" style="display: none;">

    <div id="dataSheetCustom" class="modal-custom full-height-custom"> 
        <div class="modal-content-custom">
            <div id="dataSheetHeader" class="modal-header-custom">
                <h2 id="modalTitle">添加数据</h2>
                <mdui-button-icon icon="close" id="closeDataModal"></mdui-button-icon>
            </div>

            <div id="dataSheetContent" class="modal-body-custom">
                 <form id="dataForm" class="data-form">
                    <input type="hidden" id="editIndex" value="-1">
                    
                    <label for="steelType">钢种</label>
                    <input type="text" id="steelType" class="readonly-input">

                    <label for="productId">产品号</label>
                    <input type="text" id="productId" class="readonly-input">

                    <label for="cardId">卡片号</label>
                    <input type="text" id="cardId" class="readonly-input">

                    <label for="furnaceId">炉号</label>
                    <input type="text" id="furnaceId" class="readonly-input">
                    
                    <mdui-divider style="margin-bottom:10px"></mdui-divider>
                    
                    <label for="actualDiameter">实际直径</label>
                    <input type="text" id="actualDiameter" class="numeric-input readonly-input">

                    <label for="diameter">直径</label>
                    <input type="text" id="diameter" class="numeric-input readonly-input">

                    <label for="length">长度</label>
                    <input type="text" id="length" class="numeric-input readonly-input">

                    <label for="weight">重量</label>
                    <input type="text" id="weight" class="numeric-input readonly-input">
                    
                    <mdui-divider style="margin-bottom:10px"></mdui-divider>

                    <label for="status">状态</label>
                    <input type="text" id="status" class="readonly-input">
                    
                    <label for="position">位置</label>
                    <input type="text" id="position" class="readonly-input">

                    <label for="hardness">硬度</label>
                    <input type="text" id="hardness" class="numeric-input readonly-input">

                    <label for="remarks">备注</label>
                    <input type="text" rows="5" cols="30" id="remarks">
                </form>
            </div>
            
            <div id="dataSheetFooter" class="modal-footer-custom">
                <mdui-button variant="text" id="cancelBtn">取消</mdui-button>
                <mdui-button variant="filled" id="saveBtn">保存</mdui-button>
            </div>
        </div>
    </div>
    
    <div id="quickEditDialog" class="modal-custom">
        <div class="modal-content-custom">
            <div class="modal-header-custom">
                <h2 id="quickEditTitle">快速编辑</h2>
                <mdui-button-icon icon="close" id="closeQuickEdit"></mdui-button-icon>
            </div>
            <div class="modal-body-custom">
                <label id="quickEditLabel">字段名</label>
                <input type="text" id="quickEditInput" class="readonly-input">
                <input type="hidden" id="quickEditIndex">
                <input type="hidden" id="quickEditField">
            </div>
            <div class="modal-footer-custom" style="justify-content: space-between;">
                <mdui-button variant="text" id="openFullEditBtn">打开完整编辑界面</mdui-button>
                <mdui-button variant="filled" id="saveQuickEditBtn">保存</mdui-button>
            </div>
        </div>
    </div>
    
    <div id="virtualKeyboard">
        <div id="shortcutContainer"></div>
        <div id="keyboardRows"></div>
    </div>
    
    <div id="confirmModalCustom" class="modal-custom">
        <div class="modal-content-custom">
            <div class="modal-header-custom">
                <h2 class="modal-title">操作确认</h2>
                <mdui-button-icon icon="close" id="closeConfirmModal"></mdui-button-icon>
            </div>
            
            <div class="modal-body-custom">
                <p id="confirmMessage">您确定要执行此操作吗？</p>
            </div>
            
            <div class="modal-footer-custom">
                <mdui-button variant="text" id="cancelConfirmBtn">取消</mdui-button>
                <mdui-button variant="filled" color="error" id="confirmActionBtn">确定</mdui-button>
            </div>
        </div>
    </div>

    <div id="calculatorModalCustom" class="modal-custom full-height-custom">
        <div class="modal-content-custom">
            <div class="modal-header-custom">
                <h2 class="modal-title">圆棒重量计算</h2>
                <mdui-button-icon icon="close" id="closeCalculatorModal"></mdui-button-icon>
            </div>
            
            <div id="calculatorContent" class="modal-body-custom">
                <form id="calculatorForm" class="data-form" style="padding: 16px;">
                    <label for="calcDiameter1">直径 1 (mm)</label>
                    <input type="text" id="calcDiameter1" class="numeric-input readonly-input">

                    <label for="calcDiameter2">直径 2 (mm)</label>
                    <input type="text" id="calcDiameter2" class="numeric-input readonly-input">

                    <label for="calcLength">长度 (mm)</label>
                    <input type="text" id="calcLength" class="numeric-input readonly-input">

                    <label for="calcDensity">密度 (Kg/mm³, 默认 0.00617)</label>
                    <input type="text" id="calcDensity" readonly>
                    
                    <label for="calcResult">计算结果 (Kg)</label>
                    <input type="text" id="calcResult" readonly style="font-weight: bold; font-size: 1.2em;">
                </form>
            </div>
            
            <div class="modal-footer-custom">
                <mdui-button variant="text" id="clearCalcBtn" color="error">清空全部</mdui-button>
                <mdui-button variant="text" id="cancelCalcBtn">取消</mdui-button>
                <mdui-button variant="filled" id="calculateAndAddBtn">计算并填充</mdui-button>
            </div>
        </div>
    </div>
    
    <div id="duplicateConfirmationModalCustom" class="modal-custom full-height-custom">
        <div class="modal-content-custom">
            <div class="modal-header-custom">
                <h2 class="modal-title">导入重复数据确认</h2>
                <mdui-button-icon icon="close" id="closeDuplicateModal"></mdui-button-icon>
            </div>
            
            <div class="modal-body-custom">
                <p>总共导入 <span id="modal-total-count" style="font-weight: bold;">0</span> 条记录。其中：</p>
                <ul>
                    <li>新数据 <span id="modal-new-count" style="font-weight: bold; color: var(--primary-color);">0</span> 条（将直接添加）</li>
                    <li>重复数据 <span id="modal-duplicate-count" style="font-weight: bold; color: #f44336;">0</span> 条（请选择处理方式）</li>
                </ul>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <mdui-button variant="outlined" id="modal-btn-select-all-skip">全部跳过 (保留现有)</mdui-button>
                    <mdui-button variant="outlined" id="modal-btn-select-all-override">全部覆盖 (使用新值)</mdui-button>
                </div>
                
                <div id="modal-duplicate-list">
                </div>
            </div>
            
            <div class="modal-footer-custom">
                <mdui-button variant="text" id="modal-btn-cancel-import">取消导入</mdui-button>
                <mdui-button variant="filled" id="modal-btn-confirm">确认处理并完成导入</mdui-button>
            </div>
        </div>
    </div>
    
    <div id="sortModalCustom" class="modal-custom">
        <div class="modal-content-custom">
            <div class="modal-header-custom">
                <h2 class="modal-title">数据排序</h2>
                <mdui-button-icon icon="close" id="closeSortModal"></mdui-button-icon>
            </div>
            
            <div class="modal-body-custom">
                <div class="data-form">
                    <label for="sortField">排序字段</label>
                    <select id="sortField">
                        <option value="productId">产品号</option>
                        <option value="steelType">钢种</option>
                        <option value="actualDiameter">实际直径</option>
                        <option value="diameter">直径</option>
                        <option value="length">长度</option>
                        <option value="weight">重量</option>
                        <option value="status">状态</option>
                        <option value="position">位置</option>
                        <option value="hardness">硬度</option>
                        <option value="furnaceId">炉号</option>
                    </select>
                    
                    <label for="sortOrder" style="margin-top: 10px;">排序方式</label>
                    <select id="sortOrder">
                        <option value="asc">从小到大 (升序)</option>
                        <option value="desc">从大到小 (降序)</option>
                    </select>
                </div>
            </div>
            
            <div class="modal-footer-custom">
                <mdui-button variant="text" id="cancelSortBtn">取消</mdui-button>
                <mdui-button variant="filled" id="applySortBtn">确定排序</mdui-button>
            </div>
        </div>
    </div>
    <mdui-fab icon="add" id="mainFab"></mdui-fab>
    
    <script type="text/template" id="duplicate-item-template">
        <div class="duplicate-item">
            <h4>产品号：PRODUCT_ID</h4>
            <div class="duplicate-differences">
                <table>
                    <thead>
                        <tr>
                            <th>字段</th>
                            <th>现有值</th>
                            <th>新值</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
            <div class="duplicate-actions">
                <label><input type="radio" name="action-ITEM_INDEX" value="skip" checked> 跳过 (保留现有值)</label>
                <label><input type="radio" name="action-ITEM_INDEX" value="override"> 覆盖 (使用新值)</label>
            </div>
        </div>
    </script>
    
    <script type="text/template" id="difference-row-template">
        <tr>
            <th>FIELD_NAME</th>
            <td>OLD_VALUE</td>
            <td style="color: #f44336; font-weight: bold;">NEW_VALUE</td>
        </tr>
    </script>
    
    <mdui-dialog
      id="aboutDialog"
      headline="关于"
      description="HTML Made with Gemini.
      Version: 0.9.7 Hotfix"
      close-on-overlay-click
    >
        <div slot="body">
            <p style="text-align: center; margin-bottom: 15px;">圆棒入库数据管理</p>
            <p style="text-align: center; color: #757575; font-size: 0.9rem;">Made by XXX with Gemini</p>
        </div>
        <mdui-button slot="action" variant="text" onclick="document.getElementById('aboutDialog').open = false;">关闭</mdui-button>
    </mdui-dialog>


    <mdui-snackbar id="general-snackbar" placement="bottom-center" closeable>
        </mdui-snackbar>

        
<script>
/**
 * =========================================================================
 * 圆棒入库数据管理系统 - JavaScript 核心逻辑
 * Based on MDUI v2
 * =========================================================================
 */

// 核心数据存储
let tableData = [];             // 存储所有圆棒数据的数组
let currentInput = null;        // 当前激活的输入框 DOM 元素
let keyboardState = JSON.parse(localStorage.getItem('keyboardState')) || {
  mode: 'normal',               // 键盘模式：normal, shift, caps, number, symbol, etc.
  shiftState: 'off',            // Shift 状态：off, on (一次性), lock (锁定)
  inputType: 'text'             // 绑定的输入字段类型，用于决定键盘布局
};
let currentEditIndex = -1;      // 当前正在编辑的数据项在 tableData 中的索引，-1 表示新增
let isMultiSelectMode = false;  // 是否处于多选模式
let selectedRows = new Set();   // 存储选中的行在 tableData 中的原始索引
let selectedTheme = localStorage.getItem('theme') || 'auto'; // 当前主题模式
let searchTerm = '';            // 当前搜索关键字
let isSearchReplaceVisible = false; // 新增：搜索替换区域是否可见

// 新增核心搜索/替换变量
let searchMatches = [];         // 存储所有匹配项的数组：[{index: row_index, field: field_id, value: matched_value}]
let currentMatchIndex = -1;     // 当前聚焦的匹配项在 searchMatches 中的索引
let isSearchActive = false;     // 搜索功能是否激活
const searchableFields = [
    'steelType', 'productId', 'cardId', 'furnaceId', 'actualDiameter', 
    'diameter', 'length', 'weight', 'status', 'position', 'hardness', 'remarks'
];

// 数据表单字段顺序，用于虚拟键盘的 Tab 切换逻辑
const inputFieldOrder = [
  'steelType', 'productId', 'cardId', 'furnaceId',
  'actualDiameter', 'diameter', 'length', 'weight',
  'status', 'position', 'hardness', 'remarks'
];

// 字段中文标签映射
const fieldLabels = {
    'steelType': '钢种',
    'productId': '产品号',
    'cardId': '卡片号',
    'furnaceId': '炉号',
    'actualDiameter': '实际直径',
    'diameter': '直径',
    'length': '长度',
    'weight': '重量',
    'status': '状态',
    'position': '位置',
    'hardness': '硬度',
    'remarks': '备注'
};

// DOM 元素引用
const dom = {
  themeCollapse: document.getElementById('themeCollapse'),
  themeCollapseContent: document.getElementById('themeCollapseContent'),
  tableBody: document.getElementById('tableBody'),
  emptyState: document.getElementById('emptyState'),
  itemCount: document.getElementById('itemCount'),
  addBtn: document.getElementById('mainFab'), 
  importItem: document.getElementById('importItem'),
  exportItem: document.getElementById('exportItem'),
  fileInput: document.getElementById('fileInput'),
  multiSelectBtn: document.getElementById('multiSelectBtn'),
  deleteSelectedBtn: document.getElementById('deleteSelectedBtn'),
  selectedCount: document.getElementById('selectedCount'),
  selectAllCheckbox: document.getElementById('selectAllCheckbox'),
  drawer: document.getElementById('drawer'),
  openDrawerBtn: document.getElementById('openDrawerBtn'),
  dataSheet: document.getElementById('dataSheetCustom'), 
  closeDataModal: document.getElementById('closeDataModal'),
  saveBtn: document.getElementById('saveBtn'),
  cancelBtn: document.getElementById('cancelBtn'),
  dataForm: document.getElementById('dataForm'),
  modalTitle: document.getElementById('modalTitle'),
  editIndex: document.getElementById('editIndex'),
  quickEditDialog: document.getElementById('quickEditDialog'),
  closeQuickEdit: document.getElementById('closeQuickEdit'),
  quickEditLabel: document.getElementById('quickEditLabel'),
  quickEditInput: document.getElementById('quickEditInput'),
  quickEditIndex: document.getElementById('quickEditIndex'),
  quickEditField: document.getElementById('quickEditField'),
  saveQuickEditBtn: document.getElementById('saveQuickEditBtn'),
  openFullEditBtn: document.getElementById('openFullEditBtn'),
  confirmModal: document.getElementById('confirmModalCustom'), 
  closeConfirmModal: document.getElementById('closeConfirmModal'),
  confirmMessage: document.getElementById('confirmMessage'),
  cancelConfirmBtn: document.getElementById('cancelConfirmBtn'),
  confirmActionBtn: document.getElementById('confirmActionBtn'),
  virtualKeyboard: document.getElementById('virtualKeyboard'),
  keyboardRows: document.getElementById('keyboardRows'),
  shortcutContainer: document.getElementById('shortcutContainer'),
  searchInput: document.getElementById('searchInput'),
  searchClearBtn: document.getElementById('searchClearBtn'),
  calculatorModal: document.getElementById('calculatorModalCustom'), 
  calculatorBtn: document.getElementById('calculatorBtn'),
  closeCalculatorModal: document.getElementById('closeCalculatorModal'),
  calculatorForm: document.getElementById('calculatorForm'),
  calcDiameter1: document.getElementById('calcDiameter1'),
  calcDiameter2: document.getElementById('calcDiameter2'),
  calcLength: document.getElementById('calcLength'),
  calcDensity: document.getElementById('calcDensity'),
  calcResult: document.getElementById('calcResult'),
  calculateAndAddBtn: document.getElementById('calculateAndAddBtn'),
  cancelCalcBtn: document.getElementById('cancelCalcBtn'),
  clearCalcBtn: document.getElementById('clearCalcBtn'),
  duplicateConfirmationModal: document.getElementById('duplicateConfirmationModalCustom'), 
  closeDuplicateModal: document.getElementById('closeDuplicateModal'),
  generalSnackbar: document.getElementById('general-snackbar'),
  
  // 搜索替换和多选菜单引用
  multiSelectMenuText: document.getElementById('multiSelectMenuText'), 
  multiSelectMenuItem: document.getElementById('multiSelectMenuItem'), 
  
  // 顶部搜索替换区域的新增引用
  toggleSearchReplaceBtn: document.getElementById('toggleSearchReplaceBtn'),
  searchReplaceContainer: document.getElementById('searchReplaceContainer'),
  replaceQueryInput: document.getElementById('replaceQuery'),       
  searchResultCount: document.getElementById('searchResultCount'), 
  prevMatchBtn: document.getElementById('prevMatchBtn'),           
  nextMatchBtn: document.getElementById('nextMatchBtn'),           
  replaceOneBtn: document.getElementById('replaceOneBtn'),         
  replaceAllBtn: document.getElementById('replaceAllBtn'),
  
  // 排序模态框引用
  sortItem: document.getElementById('sortItem'),
  sortModal: document.getElementById('sortModalCustom'),
  closeSortModal: document.getElementById('closeSortModal'),
  cancelSortBtn: document.getElementById('cancelSortBtn'),
  applySortBtn: document.getElementById('applySortBtn'),
  sortField: document.getElementById('sortField'),
  sortOrder: document.getElementById('sortOrder'),
  
  // 关于信息对话框引用
  aboutDialog: document.getElementById('aboutDialog'),
  aboutItem: document.getElementById('aboutItem') 
};

// 表单输入字段 DOM 引用
const formElements = {
  steelType: document.getElementById('steelType'),
  productId: document.getElementById('productId'),
  cardId: document.getElementById('cardId'),
  furnaceId: document.getElementById('furnaceId'),
  actualDiameter: document.getElementById('actualDiameter'),
  diameter: document.getElementById('diameter'),
  length: document.getElementById('length'),
  weight: document.getElementById('weight'),
  status: document.getElementById('status'),
  position: document.getElementById('position'),
  hardness: document.getElementById('hardness'),
  remarks: document.getElementById('remarks')
};
// 将表单元素存入数组方便遍历
const inputFields = Object.values(formElements); 

// 虚拟键盘的快捷选项常量
const statusOptions = ['车光', '调车', '花皮', '黑皮', '黑调', '花调'];
const positionOptions = ['外', '过', '立车', '打卡机'];
const steelTypeOptions = [
    '42CrMo4',
    'C45E',
    'S355J2G3',
    '1.2714',
    '16/20MnCrS5',
    'C45',
    'C45R+N',
    'S355J2+N',
    'S355J2-P RE',
    'C45-P RE',
    '708M40T',
    '4145',
    'LF2',
    'A105/LF2',
    '34NiCrMo6 T-RE',
];
const cardIdOptions = [
    '无备',
    'AUSA',
    'V2526',
    'V15P',
    'SA504',
    'V2523',
    'SA503',
    'V25',
    '备库',
    'TS',
    'TH',
    'V4',
    'VT'
];
const furnaceIdOptions = [
    '1251',
    'VD25/',
    '1250',
    '251050',
    '25D0',
    '123',
    '25C0',
    'VD24/'
];


/**
 * 辅助函数：显示底部通知栏（Snackbar）
 * @param {string} message - 要显示的消息
 * @param {string} color - 可选，MDUI 主题色，如 'error', 'success', 'warning'
 */
function showSnackbar(message, color) {
  const snackbar = dom.generalSnackbar;
  if (!snackbar) return;
  
  snackbar.innerHTML = message;
  
  if (color) {
      snackbar.color = color;
  } else {
      snackbar.removeAttribute('color');
  }
  
  snackbar.open = true;
}

/**
 * 检查系统是否处于黑暗模式
 * @returns {boolean}
 */
function isSystemDarkMode() {
    return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
}

/**
 * 初始化应用主题
 * 根据 localStorage 或系统设置应用 'dark-mode' 类和 MDUI 的主题类
 */
function initTheme() {
  let mode;
  if (selectedTheme === 'auto') {
    mode = isSystemDarkMode() ? 'dark' : 'light';
  } else {
    mode = selectedTheme;
  }
  
  const body = document.body;

  if (mode === 'dark') {
    body.classList.add('dark-mode');
    body.classList.add('mdui-theme-dark'); 
  } else {
    body.classList.remove('dark-mode');
    body.classList.remove('mdui-theme-dark');
  }
  
  updateThemeSelectionInDrawer();
}

/**
 * 切换应用主题模式并保存到 localStorage
 * @param {string} theme - 'auto', 'light', 或 'dark'
 */
function changeTheme(theme) {
  selectedTheme = theme;
  localStorage.setItem('theme', selectedTheme);
  initTheme();
  dom.drawer.open = false; 
}

/**
 * 更新抽屉中主题选项的选中状态和头部描述
 * **核心变更：使用 MDUI 标准的 `selected` 属性来触发 MDUI 组件的内置样式。**
 */
function updateThemeSelectionInDrawer() {
    const themeOptions = dom.themeCollapseContent.querySelectorAll('.theme-option');
    const headerItem = dom.themeCollapse.querySelector('mdui-list-item[slot="header"]');
    
    themeOptions.forEach(item => {
        // 移除所有选中状态
        item.removeAttribute('selected'); 
    });
    
    const currentSelection = dom.themeCollapseContent.querySelector(`.theme-option[data-theme="${selectedTheme}"]`);
    if (currentSelection) {
        // 仅设置 selected 属性，让 MDUI 组件的内置样式接管
        currentSelection.setAttribute('selected', 'true');
    }
    
    let headlineText = "主题模式 (当前: 自动)";
    let iconName = "brightness_auto";
    
    // 根据当前选中的主题更新抽屉头部的文本和图标
    if (selectedTheme === 'light') {
        headlineText = "主题模式 (当前: 日间)";
        iconName = "light_mode";
    } else if (selectedTheme === 'dark') {
        headlineText = "主题模式 (当前: 夜间)";
        iconName = "dark_mode";
    }
    
    if (headerItem) {
        headerItem.setAttribute('headline', headlineText);
        headerItem.setAttribute('icon', iconName);
    }
}

/**
 * 显示自定义 Modal/Dialog
 * @param {HTMLElement} modalElement 
 */
function openCustomModal(modalElement) {
    if (modalElement) modalElement.style.display = 'block';
}

/**
 * 隐藏自定义 Modal/Dialog
 * @param {HTMLElement} modalElement 
 */
function closeCustomModal(modalElement) {
    if (modalElement) modalElement.style.display = 'none';
}

/**
 * 绑定所有 DOM 元素的事件监听器
 */
function initEventListeners() {
  dom.openDrawerBtn.addEventListener('click', () => { dom.drawer.open = true; });
  dom.themeCollapseContent.querySelectorAll('.theme-option').forEach(item => {
      item.addEventListener('click', (e) => {
          const theme = e.currentTarget.getAttribute('data-theme');
          changeTheme(theme);
      });
  });

  dom.closeDataModal.addEventListener('click', () => { closeCustomModal(dom.dataSheet); dom.virtualKeyboard.style.display = 'none'; });
  dom.cancelBtn.addEventListener('click', () => { closeCustomModal(dom.dataSheet); dom.virtualKeyboard.style.display = 'none'; });
  
  dom.closeQuickEdit.addEventListener('click', () => { closeCustomModal(dom.quickEditDialog); dom.virtualKeyboard.style.display = 'none'; });
  dom.saveQuickEditBtn.addEventListener('click', saveQuickEdit);
  dom.openFullEditBtn.addEventListener('click', () => {
      const index = parseInt(dom.quickEditIndex.value);
      closeCustomModal(dom.quickEditDialog);
      setTimeout(() => { openEditModal(index); }, 100);
  });
  
  // 快速编辑输入框点击事件：绑定虚拟键盘
  dom.quickEditInput.addEventListener('click', (e) => {
      e.stopPropagation();
      currentInput = e.target;
      const realFieldId = dom.quickEditField.value; // 获取真实字段ID
      updateKeyboardForInput(currentInput, realFieldId); 
      showVirtualKeyboard();
  });
  
  dom.closeConfirmModal.addEventListener('click', () => closeCustomModal(dom.confirmModal));
  dom.cancelConfirmBtn.addEventListener('click', () => closeCustomModal(dom.confirmModal));
  dom.closeCalculatorModal.addEventListener('click', () => { closeCustomModal(dom.calculatorModal); dom.virtualKeyboard.style.display = 'none'; });
  dom.cancelCalcBtn.addEventListener('click', () => { closeCustomModal(dom.calculatorModal); dom.virtualKeyboard.style.display = 'none'; });
  dom.clearCalcBtn.addEventListener('click', clearCalculatorInputs);
  dom.closeDuplicateModal.addEventListener('click', () => closeCustomModal(dom.duplicateConfirmationModal));
  document.getElementById('modal-btn-cancel-import').addEventListener('click', () => {
      closeCustomModal(dom.duplicateConfirmationModal);
      showSnackbar('导入操作已取消', 'warning');
  });
  
  // **新增：排序模态框事件**
  dom.sortItem.addEventListener('click', openSortModal);
  dom.closeSortModal.addEventListener('click', () => closeCustomModal(dom.sortModal));
  dom.cancelSortBtn.addEventListener('click', () => closeCustomModal(dom.sortModal));
  dom.applySortBtn.addEventListener('click', applySort);
  
  // 新增：搜索替换区域切换按钮事件
  dom.toggleSearchReplaceBtn.addEventListener('click', toggleSearchReplaceVisibility);
  
  dom.multiSelectMenuItem.addEventListener('click', () => { 
      dom.drawer.open = false; 
      toggleMultiSelectMode(); 
  });
  
  // **新增关于按钮事件绑定**
  if (dom.aboutItem && dom.aboutDialog) {
      dom.aboutItem.addEventListener('click', () => {
          dom.aboutDialog.open = true;
          dom.drawer.open = false; // 关闭抽屉
      });
  }
  
  // 搜索/替换输入框事件
  // 主搜索框输入时，触发全局搜索
  dom.searchInput.addEventListener('input', (e) => {
    searchTerm = e.target.value.trim().toLowerCase();
    updateTable(); // 实时搜索
    
    // 如果搜索替换区域可见，也触发其中的匹配项更新
    if (isSearchReplaceVisible) {
        startSearch();
    }
  });
  
  // 替换输入框输入时，更新按钮状态
  dom.replaceQueryInput.addEventListener('input', () => {
    // 即使替换内容为空，只要有搜索匹配项，替换按钮也应该启用
    dom.replaceOneBtn.disabled = searchMatches.length === 0;
    dom.replaceAllBtn.disabled = searchMatches.length === 0;
  });
  
  dom.prevMatchBtn.addEventListener('click', () => navigateMatch(-1));
  dom.nextMatchBtn.addEventListener('click', () => navigateMatch(1));
  dom.replaceOneBtn.addEventListener('click', replaceOne);
  dom.replaceAllBtn.addEventListener('click', confirmReplaceAll);

  // 主表单输入框点击事件：绑定虚拟键盘和只读逻辑
  inputFields.forEach(field => {
    field.addEventListener('click', (e) => {
      e.stopPropagation();
      currentInput = e.target;
      
      if (currentInput.id === 'remarks') {
        // 备注字段解除只读并隐藏键盘
        currentInput.removeAttribute('readonly');
        currentInput.classList.remove('readonly-input');
        dom.virtualKeyboard.style.display = 'none';
        currentInput.focus();
        return; 
      }
      
      currentInput.setAttribute('readonly', 'true');
      currentInput.classList.add('readonly-input');
      updateKeyboardForInput(currentInput);
      showVirtualKeyboard();
      
      // 优化模态框滚动，使当前输入框可见
      setTimeout(() => {
        const modalContent = document.getElementById('dataSheetContent');
        if(modalContent) {
            const inputRect = currentInput.getBoundingClientRect();
            const modalRect = modalContent.getBoundingClientRect();
            const offset = inputRect.top - modalRect.top + modalContent.scrollTop - modalRect.height * 0.3; 
            modalContent.scrollTo({ top: offset, behavior: 'smooth' });
        }
      }, 100);
    });
    
    // 双击输入框事件：切换只读状态（允许使用系统键盘）
    field.addEventListener('dblclick', (e) => {
      e.stopPropagation();
      currentInput = e.target;
      if (currentInput.id === 'remarks') return; 
      
      if (currentInput.hasAttribute('readonly')) {
        currentInput.removeAttribute('readonly');
        currentInput.classList.remove('readonly-input');
        dom.virtualKeyboard.style.display = 'none';
        currentInput.focus();
      } else {
        currentInput.setAttribute('readonly', 'true');
        currentInput.classList.add('readonly-input');
        updateKeyboardForInput(currentInput);
        showVirtualKeyboard();
      }
    });
  });
  
  dom.importItem.addEventListener('click', () => { dom.drawer.open = false; dom.fileInput.click(); });
  dom.exportItem.addEventListener('click', () => { dom.drawer.open = false; exportToExcel(); });
  dom.addBtn.addEventListener('click', openAddModal); 
  dom.fileInput.addEventListener('change', handleFileImport);
  dom.selectAllCheckbox.addEventListener('change', handleSelectAll);
  dom.deleteSelectedBtn.addEventListener('click', confirmDeleteSelected);
  dom.saveBtn.addEventListener('click', saveData);

  dom.searchClearBtn.addEventListener('click', () => {
    dom.searchInput.value = '';
    searchTerm = '';
    updateTable();
  });

  dom.calculatorBtn.addEventListener('click', openCalculatorModal);
  dom.calculateAndAddBtn.addEventListener('click', calculateAndAddData);
  
  // 表格主体点击事件：实现快速编辑或完整编辑
  dom.tableBody.addEventListener('click', (e) => {
    if (isMultiSelectMode) return;
    
    // 忽略操作按钮和复选框的点击
    if (e.target.closest('mdui-button-icon') || e.target.closest('mdui-checkbox')) {
      return;
    }
    
    const row = e.target.closest('tr');
    if (!row) return;
    
    const index = parseInt(row.getAttribute('data-index'));
    const cell = e.target.closest('td');
    const targetFieldId = cell ? cell.getAttribute('data-field') : null;
    
    if (targetFieldId) {
        if (targetFieldId === 'remarks') {
            openEditModal(index, targetFieldId); // 备注字段直接打开完整编辑
        } else {
            openQuickEdit(index, targetFieldId); // 其他字段打开快速编辑
        }
    } else {
        openEditModal(index); // 点击非字段区域，打开完整编辑
    }
  });
}

/**
 * 切换顶部搜索和替换区域的可见性
 */
function toggleSearchReplaceVisibility() {
    isSearchReplaceVisible = !isSearchReplaceVisible;
    const container = dom.searchReplaceContainer;
    
    if (isSearchReplaceVisible) {
        container.style.display = 'flex';
        dom.toggleSearchReplaceBtn.icon = 'expand_less';
        // 切换后，立即根据主搜索框的内容进行搜索匹配
        startSearch();
    } else {
        container.style.display = 'none';
        dom.toggleSearchReplaceBtn.icon = 'find_replace';
        // 清除搜索状态和高亮
        isSearchActive = false;
        searchMatches = [];
        currentMatchIndex = -1;
        updateTable();
    }
}

/**
 * 处理全选/全不选复选框的逻辑
 */
function handleSelectAll() {
    if (!isMultiSelectMode) return;
    
    selectedRows.clear();
    const filteredData = getFilteredData();
    if (dom.selectAllCheckbox.checked) {
      filteredData.forEach(item => {
          const originalIndex = tableData.indexOf(item);
          if (originalIndex !== -1) selectedRows.add(originalIndex);
      });
    }
    updateTable();
}

/**
 * 打开重量计算器模态框并初始化键盘
 */
function openCalculatorModal() {
    dom.drawer.open = false;
    openCustomModal(dom.calculatorModal); 
    dom.calcDiameter1.value = '';
    dom.calcDiameter2.value = '';
    dom.calcLength.value = '';
    dom.calcResult.value = '';
    
    // 聚焦第一个输入框并显示键盘
    currentInput = dom.calcDiameter1;
    updateKeyboardForInput(currentInput);
    showVirtualKeyboard();
    currentInput.focus();
}

/**
 * 清空重量计算器所有输入字段
 */
function clearCalculatorInputs() {
    dom.calcDiameter1.value = '';
    dom.calcDiameter2.value = '';
    dom.calcLength.value = '';
    dom.calcResult.value = '';
    calculateWeight(); 
    
    dom.calcDiameter1.focus();
    currentInput = dom.calcDiameter1;
    updateKeyboardForInput(currentInput);
}

/**
 * 根据搜索关键字过滤数据
 * @returns {Array<Object>} 过滤后的数据数组
 */
function getFilteredData() {
  if (!searchTerm) {
    return [...tableData];
  }
  return tableData.filter(item => {
    return Object.values(item).some(value => 
      value !== null && value !== undefined && value.toString().toLowerCase().includes(searchTerm)
    );
  });
}

/**
 * 刷新数据表格 UI，包括筛选、多选模式切换、行渲染和事件绑定
 */
function updateTable() {
  const filteredData = getFilteredData();

  dom.itemCount.textContent = `共 ${tableData.length} 条数据，筛选出 ${filteredData.length} 条`;
  dom.emptyState.style.display = tableData.length === 0 ? 'block' : 'none';
  dom.searchClearBtn.classList.toggle('active', !!searchTerm);
  dom.selectedCount.textContent = selectedRows.size;

  const checkboxColHeader = document.querySelector('#dataTable th.checkbox-col');
  // 注意：需要使用 DOM API 来查找单元格，因为它们是动态生成的
  const allCheckboxColCells = document.querySelectorAll('#dataTable td.checkbox-col'); 
  
  // 控制多选相关元素的显示/隐藏
  const displayStyle = isMultiSelectMode ? 'table-cell' : 'none';
  dom.deleteSelectedBtn.style.display = isMultiSelectMode ? 'inline-flex' : 'none';
  if(checkboxColHeader) checkboxColHeader.style.display = displayStyle;
  dom.selectAllCheckbox.style.display = isMultiSelectMode ? 'block' : 'none'; 
  allCheckboxColCells.forEach(cell => cell.style.display = displayStyle);

  // 更新全选框状态
  dom.selectAllCheckbox.checked = filteredData.length > 0 && selectedRows.size === filteredData.length;

  dom.tableBody.innerHTML = '';
  
  // 清除所有高亮和定位到当前项 (在重新渲染之前)
  document.querySelectorAll('.search-match-highlight').forEach(el => el.classList.remove('search-match-highlight'));
  document.querySelectorAll('.current-match-highlight').forEach(el => el.classList.remove('current-match-highlight'));

  // 渲染表格行
  filteredData.forEach((item, displayIndex) => {
    const row = document.createElement('tr');
    const originalIndex = tableData.indexOf(item);
    row.setAttribute('data-index', originalIndex);
    
    if (isMultiSelectMode && selectedRows.has(originalIndex)) {
      row.classList.add('selected');
    }

    if (searchTerm) {
      row.classList.add('highlight'); // 搜索结果高亮
    }
    
    row.innerHTML = `
      <td class="seq-col">
        ${displayIndex + 1}
        <div class="move-buttons">
            <button class="move-btn up-btn" data-index="${originalIndex}" ${originalIndex === 0 ? 'disabled' : ''}>
              <i class="material-icons" style="font-size: 14px;">arrow_upward</i>
            </button>
            <button class="move-btn down-btn" data-index="${originalIndex}" ${originalIndex === tableData.length - 1 ? 'disabled' : ''}>
              <i class="material-icons" style="font-size: 14px;">arrow_downward</i>
            </button>
        </div>
      </td>
      <td class="checkbox-col" style="display:${displayStyle};">
        <mdui-checkbox class="row-checkbox" data-index="${originalIndex}" ${isMultiSelectMode && selectedRows.has(originalIndex) ? 'checked' : ''}></mdui-checkbox>
      </td>
      <td data-field="steelType">${item.steelType || '-'}</td>
      <td data-field="productId">${item.productId || '-'}</td>
      <td data-field="cardId">${item.cardId || '-'}</td>
      <td data-field="furnaceId">${item.furnaceId || '-'}</td>
      <td data-field="actualDiameter">${item.actualDiameter || '-'}</td>
      <td data-field="diameter">${item.diameter || '-'}</td>
      <td data-field="length">${item.length || '-'}</td>
      <td data-field="weight">${item.weight || '-'}</td>
      <td data-field="status">${item.status || '-'}</td>
      <td data-field="position">${item.position || '-'}</td>
      <td data-field="hardness">${item.hardness || '-'}</td>
      <td class="remark-col" data-field="remarks">${item.remarks || '-'}</td>
      <td class="action-col">
        <mdui-button-icon icon="edit" class="edit-btn" data-index="${originalIndex}"></mdui-button-icon>
        <mdui-button-icon icon="delete" class="delete-btn" data-index="${originalIndex}"></mdui-button-icon>
      </td>
    `;
    
    dom.tableBody.appendChild(row);
    
    // 搜索和替换高亮逻辑 (仅在搜索/替换区域可见时)
    if (isSearchActive && isSearchReplaceVisible) {
        searchableFields.forEach(field => {
            const cell = row.querySelector(`td[data-field="${field}"]`);
            if (!cell) return;
            
            const query = dom.searchInput.value.trim().toLowerCase(); // 使用主搜索框的内容进行替换搜索
            const cellValue = (item[field] || '').toString();
            
            if (query && cellValue.toLowerCase().includes(query)) {
                // 添加所有匹配项的通用高亮
                cell.classList.add('search-match-highlight');

                // 检查是否是当前聚焦的匹配项
                const isCurrentMatch = searchMatches.some((match, idx) => 
                    idx === currentMatchIndex && match.index === originalIndex && match.field === field
                );
                
                if (isCurrentMatch) {
                    cell.classList.add('current-match-highlight');
                    
                    // 滚动到当前匹配项 (如果当前匹配项在筛选后的数据中)
                    if (currentMatchIndex !== -1) {
                         // 3. 滚动到当前匹配项
                        const container = document.querySelector('.data-table-container');
                        if (container) {
                            const cellRect = cell.getBoundingClientRect();
                            const containerRect = container.getBoundingClientRect();
                            const scrollTop = container.scrollTop;
                            const offset = cellRect.top - containerRect.top + scrollTop - (containerRect.height / 2) + (cellRect.height / 2);
                            container.scrollTo({ top: offset, behavior: 'smooth' });
                        }
                    }
                }
            }
        });
    }
  });
  
  bindRowEvents(); // 重新绑定事件
}

/**
 * 绑定表格行内的所有动态事件，如编辑、删除、复选框和移动按钮
 */
function bindRowEvents() {
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const index = parseInt(e.currentTarget.getAttribute('data-index'));
      openEditModal(index);
    });
  });
  
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const index = parseInt(e.currentTarget.getAttribute('data-index'));
      confirmDeleteRow(index);
    });
  });
  
  document.querySelectorAll('.row-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', (e) => {
      e.stopPropagation();
      const index = parseInt(e.target.getAttribute('data-index'));
      const row = e.target.closest('tr');
      
      // 更新选中状态集合
      e.target.checked ? selectedRows.add(index) : selectedRows.delete(index);
      
      const filteredData = getFilteredData();
      dom.selectAllCheckbox.checked = selectedRows.size === filteredData.length && filteredData.length > 0;
      dom.selectedCount.textContent = selectedRows.size;
      row.classList.toggle('selected', e.target.checked);
    });
  });
  
  document.querySelectorAll('.up-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      moveRow(parseInt(e.currentTarget.getAttribute('data-index')), 'up');
    });
  });
  
  document.querySelectorAll('.down-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      moveRow(parseInt(e.currentTarget.getAttribute('data-index')), 'down');
    });
  });
}

/**
 * 确认并删除单行数据
 * @param {number} index - 待删除数据在 tableData 中的索引
 */
function confirmDeleteRow(index) {
    const itemToDelete = tableData[index];
    const message = `您确定要删除以下数据吗？<br><br>` +
                    `产品号: <strong style="color: var(--primary-color);">${itemToDelete.productId || 'N/A'}</strong><br>` +
                    `钢种: ${itemToDelete.steelType || 'N/A'}<br>` +
                    `重量: ${itemToDelete.weight || 'N/A'}`;
    dom.confirmMessage.innerHTML = message;
    openCustomModal(dom.confirmModal); 
    
    dom.confirmActionBtn.onclick = () => {
      tableData.splice(index, 1); // 从数组中移除
      selectedRows.clear(); // 清空选中状态
      saveDataToLocalStorage();
      updateTable();
      closeCustomModal(dom.confirmModal); 
      dom.confirmActionBtn.onclick = null;
      showSnackbar('数据已删除', 'success');
    };
}

/**
 * 上下移动表格行数据
 * @param {number} index - 目标数据在 tableData 中的索引
 * @param {string} direction - 'up' 或 'down'
 */
function moveRow(index, direction) {
  if (direction === 'up' && index > 0) {
    [tableData[index - 1], tableData[index]] = [tableData[index], tableData[index - 1]];
  } else if (direction === 'down' && index < tableData.length - 1) {
    [tableData[index], tableData[index + 1]] = [tableData[index + 1], tableData[index]];
  }
  
  saveDataToLocalStorage();
  updateTable();
}

/**
 * 确认并执行批量删除操作
 */
function confirmDeleteSelected() {
    if (selectedRows.size > 0) {
      dom.confirmMessage.innerHTML = `您确定要删除选中的 <strong style="color: #f44336;">${selectedRows.size}</strong> 条数据吗？`;
      openCustomModal(dom.confirmModal); 
      dom.confirmActionBtn.onclick = () => {
        deleteSelected();
        closeCustomModal(dom.confirmModal); 
        dom.confirmActionBtn.onclick = null;
      };
    }
}

/**
 * 执行批量删除已选中的数据
 */
function deleteSelected() {
  // 倒序排列索引，避免删除时影响后续索引
  const sortedIndexes = Array.from(selectedRows).sort((a, b) => b - a);
  sortedIndexes.forEach(index => {
    tableData.splice(index, 1);
  });
  
  const deletedCount = sortedIndexes.length;
  selectedRows.clear();
  dom.selectAllCheckbox.checked = false;
  
  saveDataToLocalStorage();
  updateTable();
  showSnackbar(`成功删除 ${deletedCount} 条数据`, 'success');
}

/**
 * 打开新增数据模态框（不带预填充数据）
 */
function openAddModal() {
  openAddModalWithData({});
}

/**
 * 打开新增数据模态框，并使用预填充数据（如计算器结果）
 * @param {Object} preFilledData - 预填充的字段键值对
 */
function openAddModalWithData(preFilledData) {
  if(dom.dataForm) dom.dataForm.reset();
  if(dom.modalTitle) dom.modalTitle.textContent = '添加数据';
  if(dom.editIndex) dom.editIndex.value = '-1';
  
  currentEditIndex = -1;
  
  // 填充预设数据
  for(const key in preFilledData) {
    if (preFilledData.hasOwnProperty(key) && formElements[key]) {
      formElements[key].value = preFilledData[key];
    }
  }

  // 设置字段只读状态和聚焦逻辑
  let inputToFocus = formElements.steelType;
  inputFields.forEach(field => {
    if(field.id !== 'remarks') {
        field.setAttribute('readonly', 'true');
        field.classList.add('readonly-input');
    } else {
        field.removeAttribute('readonly'); 
        field.classList.remove('readonly-input');
    }
    if(field.id === 'steelType') inputToFocus = field;
  });
  
  openCustomModal(dom.dataSheet);
  currentInput = inputToFocus;
  
  // 如果聚焦到备注字段，则不弹出虚拟键盘
  if (currentInput.id === 'remarks') {
      dom.virtualKeyboard.style.display = 'none';
  } else {
      updateKeyboardForInput(currentInput);
      showVirtualKeyboard();
  }
  
  currentInput.focus();
}

/**
 * 查找是否有产品号重复的数据
 * @param {Object} newItem - 待添加/修改的新数据
 * @returns {Array<Object>} 重复项的数组
 */
function findDuplicates(newItem) {
  const duplicates = [];
  if(!tableData || !Array.isArray(tableData)) return duplicates;

  tableData.forEach((existingItem, index) => {
    const isPrimaryDuplicate = (newItem.productId && newItem.productId.trim() !== '' && newItem.productId === existingItem.productId);

    if (isPrimaryDuplicate) {
      duplicates.push({ 
        index, 
        reason: '产品号重复', 
        existingItem: existingItem,
        newItem: newItem,
        productId: newItem.productId,
        differences: getObjectDifferences(existingItem, newItem)
      });
      return;
    }
  });

  return duplicates;
}

/**
 * 突出显示并滚动到指定的表格行
 * @param {number} index - 要高亮显示的行在 tableData 中的索引
 */
function highlightAndScrollToRow(index) {
  setTimeout(() => {
    const row = document.querySelector(`tbody tr[data-index="${index}"]`);
    
    if (row) {
      // 移除旧的高亮，添加新高亮
      document.querySelectorAll('#dataTable .highlight').forEach(r => r.classList.remove('highlight'));
      row.classList.add('highlight');
      setTimeout(() => {
        if(row.classList.contains('highlight')) row.classList.remove('highlight');
      }, 2000);
      
      // 滚动视图居中
      const container = document.querySelector('.data-table-container');
      if (container) {
          const rowRect = row.getBoundingClientRect();
          const containerRect = container.getBoundingClientRect();
          const scrollTop = container.scrollTop;
          const offset = rowRect.top - containerRect.top + scrollTop - (containerRect.height / 2) + (rowRect.height / 2);
          container.scrollTo({ top: offset, behavior: 'smooth' });
      } else {
        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
  }, 100);
}

/**
 * 保存表单数据（新增或编辑），包含重复数据检查
 */
function saveData() {
  const formData = {};
  for(const key in formElements) {
    if (formElements.hasOwnProperty(key)) {
      formData[key] = formElements[key] ? formElements[key].value.trim() : '';
    }
  }

  // 基础校验：产品号、卡片号、炉号至少填写一项
  if (!formData.productId && !formData.cardId && !formData.furnaceId) {
    showSnackbar('产品号、卡片号、炉号至少填写一项！', 'warning');
    return;
  }

  const isEditMode = currentEditIndex !== -1;
  const isProductIdChanged = isEditMode && tableData[currentEditIndex].productId !== formData.productId;

  if (!isEditMode || isProductIdChanged) {
      // 查重逻辑
      const duplicateItems = findDuplicates(formData);
      const realDuplicates = duplicateItems.filter(dup => dup.index !== currentEditIndex); // 排除自身
      
      if (realDuplicates.length > 0) {
        let message = `发现 ${realDuplicates.length} 条产品号重复的数据！`;
        message += `\n您正在${isEditMode ? '修改为' : '添加产品号'}：${formData.productId || 'N/A'}\n确定要继续添加吗？点击取消可以查看重复项`;

        if (!window.confirm(message)) { 
          const firstDuplicateIndex = realDuplicates[0].index;
          closeCustomModal(dom.dataSheet);
          dom.virtualKeyboard.style.display = 'none';
          highlightAndScrollToRow(firstDuplicateIndex);
          return;
        }
      }
  }

  // 执行保存操作
  if (!isEditMode) {
    if(!tableData) tableData = [];
    tableData.push(formData); // 新增
  } else {
    if(tableData && tableData[currentEditIndex] !== undefined) {
      tableData[currentEditIndex] = formData; // 编辑
    }
  }

  saveDataToLocalStorage();
  updateTable();
  closeCustomModal(dom.dataSheet);
  dom.virtualKeyboard.style.display = 'none';

  showSnackbar(isEditMode ? '数据修改成功' : '数据添加成功', 'success');
}

/**
 * 打开编辑数据模态框并填充数据
 * @param {number} index - 待编辑数据在 tableData 中的索引
 * @param {string} [targetFieldId=null] - 可选，指定打开后应聚焦的字段ID
 */
function openEditModal(index, targetFieldId = null) {
  currentEditIndex = index;
  if (dom.editIndex) dom.editIndex.value = index;

  const item = tableData[index];
  
  // 填充表单
  for (const key in formElements) {
    if (formElements.hasOwnProperty(key)) {
      formElements[key].value = item[key] || '';
    }
  }
  
  // 设置字段只读状态和聚焦逻辑
  let inputToFocus = formElements.steelType;
  inputFields.forEach(field => {
    if(field.id !== 'remarks') {
        field.setAttribute('readonly', 'true');
        field.classList.add('readonly-input');
    } else {
        field.removeAttribute('readonly'); 
        field.classList.remove('readonly-input');
    }
    if(field.id === 'steelType') inputToFocus = field;
  });
  
  dom.modalTitle.textContent = '编辑数据';
  openCustomModal(dom.dataSheet); 
  
  // 如果指定了聚焦字段
  if (targetFieldId && formElements[targetFieldId]) {
      inputToFocus = formElements[targetFieldId];
  }
  
  currentInput = inputToFocus;
  
  // 聚焦并处理键盘显示/隐藏
  if (currentInput.id === 'remarks') {
      dom.virtualKeyboard.style.display = 'none';
  } else {
      updateKeyboardForInput(currentInput);
      showVirtualKeyboard();
  }

  currentInput.focus();
  
  // 优化滚动
  const modalContent = document.getElementById('dataSheetContent');
  if(modalContent) {
      setTimeout(() => {
          const inputRect = currentInput.getBoundingClientRect();
          const modalRect = modalContent.getBoundingClientRect();
          const offset = inputRect.top - modalRect.top + modalContent.scrollTop - modalRect.height * 0.3; 
          modalContent.scrollTo({ top: offset, behavior: 'smooth' });
      }, 50);
  }
}

/**
 * 打开快速编辑弹窗
 * @param {number} index - 待编辑数据在 tableData 中的索引
 * @param {string} fieldId - 待编辑的字段ID
 */
function openQuickEdit(index, fieldId) {
    const item = tableData[index];
    const fieldName = fieldLabels[fieldId] || fieldId;
    
    dom.quickEditLabel.textContent = fieldName;
    dom.quickEditInput.value = item[fieldId] || '';
    dom.quickEditIndex.value = index;
    dom.quickEditField.value = fieldId;
    
    dom.quickEditInput.setAttribute('readonly', 'true');
    dom.quickEditInput.classList.add('readonly-input');
    
    openCustomModal(dom.quickEditDialog);
    
    // 自动聚焦并弹出键盘
    currentInput = dom.quickEditInput;
    updateKeyboardForInput(currentInput, fieldId); 
    showVirtualKeyboard();
    currentInput.focus();
}

/**
 * 保存快速编辑的修改
 */
function saveQuickEdit() {
    const index = parseInt(dom.quickEditIndex.value);
    const fieldId = dom.quickEditField.value;
    const newValue = dom.quickEditInput.value.trim();
    
    if (index >= 0 && index < tableData.length) {
        // 校验数字字段
        if (['actualDiameter', 'diameter', 'length', 'weight', 'hardness'].includes(fieldId) && isNaN(parseFloat(newValue)) && newValue.length > 0) {
            showSnackbar('请输入有效的数字或留空', 'error');
            return;
        }
        
        tableData[index][fieldId] = newValue;
        saveDataToLocalStorage();
        updateTable();
        closeCustomModal(dom.quickEditDialog);
        dom.virtualKeyboard.style.display = 'none';
        showSnackbar('快速修改已保存', 'success');
    }
}

/**
 * 开始执行搜索，找到所有匹配项
 */
function startSearch() {
    // 始终使用主搜索框的内容进行匹配
    const query = dom.searchInput.value.trim().toLowerCase(); 
    searchMatches = [];
    currentMatchIndex = -1;
    isSearchActive = !!query;
    
    if (!isSearchActive || !isSearchReplaceVisible) {
        dom.searchResultCount.textContent = '';
        dom.replaceOneBtn.disabled = true;
        dom.replaceAllBtn.disabled = true;
        updateTable();
        return;
    }
    
    // 遍历所有数据和可搜索字段，找到匹配项
    tableData.forEach((item, index) => {
        searchableFields.forEach(field => {
            const value = (item[field] || '').toString().toLowerCase();
            if (value.includes(query)) {
                searchMatches.push({
                    index: index,       // 匹配项所在行的原始索引
                    field: field,       // 匹配项所在的字段ID
                    value: item[field]  // 字段的原始值
                });
            }
        });
    });
    
    dom.replaceOneBtn.disabled = searchMatches.length === 0;
    dom.replaceAllBtn.disabled = searchMatches.length === 0;

    updateTable(); // 刷新表格以显示所有高亮
    
    if (searchMatches.length > 0) {
        navigateMatch(1); // 自动聚焦到第一个匹配项
    } else {
        dom.searchResultCount.textContent = '未找到匹配项';
        updateCurrentMatchUI();
    }
}

/**
 * 导航到上一个/下一个匹配项
 * @param {number} direction - 1 (下一个) 或 -1 (上一个)
 */
function navigateMatch(direction) {
    if (searchMatches.length === 0) return;
    
    currentMatchIndex += direction;
    
    // 循环逻辑
    if (currentMatchIndex >= searchMatches.length) {
        currentMatchIndex = 0;
    } else if (currentMatchIndex < 0) {
        currentMatchIndex = searchMatches.length - 1;
    }
    
    updateCurrentMatchUI();
}

/**
 * 更新当前匹配项的 UI (高亮和滚动)
 */
function updateCurrentMatchUI() {
    // 1. 更新计数器
    dom.searchResultCount.textContent = `找到 ${searchMatches.length} 个匹配项 (当前 ${currentMatchIndex === -1 ? 0 : currentMatchIndex + 1}/${searchMatches.length})`;
    
    // 2. 清除所有高亮和定位到当前项
    document.querySelectorAll('.current-match-highlight').forEach(el => el.classList.remove('current-match-highlight'));
    
    if (currentMatchIndex === -1 || searchMatches.length === 0) return;
    
    const currentMatch = searchMatches[currentMatchIndex];
    const rowElement = document.querySelector(`tbody tr[data-index="${currentMatch.index}"]`);
    
    if (rowElement) {
        const cell = rowElement.querySelector(`td[data-field="${currentMatch.field}"]`);
        
        if (cell) {
            cell.classList.add('current-match-highlight');
            
            // 3. 滚动到当前匹配项
            const container = document.querySelector('.data-table-container');
            if (container) {
                const cellRect = cell.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();
                const scrollTop = container.scrollTop;
                const offset = cellRect.top - containerRect.top + scrollTop - (containerRect.height / 2) + (cellRect.height / 2);
                container.scrollTo({ top: offset, behavior: 'smooth' });
            }
        }
    }
}

/**
 * 辅助函数：转义正则表达式特殊字符
 */
function escapeRegExp(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); 
}

/**
 * 替换当前的匹配项
 */
function replaceOne() {
    if (currentMatchIndex === -1 || searchMatches.length === 0) {
        showSnackbar('没有选中的匹配项可替换', 'warning');
        return;
    }
    
    const match = searchMatches[currentMatchIndex];
    const newText = dom.replaceQueryInput.value;
    const oldText = dom.searchInput.value.trim(); // 使用主搜索框的内容
    
    if (!oldText) return; 

    // 1. 执行替换操作
    const rowIndex = match.index;
    const fieldId = match.field;
    const originalValue = tableData[rowIndex][fieldId] || '';
    
    // 使用正则表达式进行全局替换，确保只替换搜索关键字
    const regex = new RegExp(escapeRegExp(oldText), 'gi');
    let newValue = originalValue.replace(regex, newText);

    // 2. 更新数据并保存
    tableData[rowIndex][fieldId] = newValue;
    saveDataToLocalStorage();

    // 3. 重新搜索并导航到下一个
    showSnackbar(`已替换第 ${currentMatchIndex + 1} 个匹配项`, 'success');

    // 重新搜索
    startSearch(); 
    
    // 由于 startSearch 会重新生成匹配项，我们需要重新定位
    if (searchMatches.length > 0) {
        // 维持当前索引，如果当前项已消失，则自动跳转到下一个
        if (currentMatchIndex >= searchMatches.length) {
             currentMatchIndex = searchMatches.length - 1;
        }
        navigateMatch(1); // 自动导航到下一个
    } else {
        dom.searchResultCount.textContent = '替换完成，未找到更多匹配项';
    }
}

/**
 * 确认并执行替换全部操作
 */
function confirmReplaceAll() {
    if (searchMatches.length === 0) {
        showSnackbar('没有匹配项可替换', 'warning');
        return;
    }
    
    const count = searchMatches.length;
    dom.confirmMessage.innerHTML = `您确定要将所有 <strong style="color: var(--primary-color);">${dom.searchInput.value.trim()}</strong> 替换为 <strong style="color: #f44336;">${dom.replaceQueryInput.value || '空'}</strong> 吗？<br><br>共涉及 ${count} 处替换。`;
    openCustomModal(dom.confirmModal); 
    
    dom.confirmActionBtn.onclick = () => {
      replaceAll();
      closeCustomModal(dom.confirmModal); 
      dom.confirmActionBtn.onclick = null;
    };
}

/**
 * 执行替换全部操作
 */
function replaceAll() {
    const oldText = dom.searchInput.value.trim();
    const newText = dom.replaceQueryInput.value;
    
    if (!oldText) return;

    let replaceCount = 0;
    const regex = new RegExp(escapeRegExp(oldText), 'gi');
    
    // 遍历所有数据，针对每个字段执行替换
    tableData.forEach(item => {
        searchableFields.forEach(field => {
            const originalValue = (item[field] || '').toString();
            
            if (originalValue.toLowerCase().includes(oldText.toLowerCase())) {
                const newValue = originalValue.replace(regex, newText);
                if (newValue !== originalValue) {
                    item[field] = newValue;
                    replaceCount++; 
                }
            }
        });
    });
    
    if (replaceCount > 0) {
        saveDataToLocalStorage();
        // 替换完成后，清除搜索状态，让表格回到正常显示
        isSearchActive = false;
        searchMatches = [];
        currentMatchIndex = -1;
        updateTable();
        
        showSnackbar(`成功替换 ${replaceCount} 处匹配项！`, 'success');
        toggleSearchReplaceVisibility(); // 替换全部后关闭搜索替换区域
    } else {
        showSnackbar('没有匹配项被替换', 'warning');
    }
}


/**
 * 关闭虚拟键盘，保持输入框只读状态
 */
function closeVirtualKeyboardAndKeepReadOnly() {
    dom.virtualKeyboard.style.display = 'none';
    currentInput = null;
}

/**
 * 动态生成虚拟键盘布局
 */
function generateVirtualKeyboard() {
  dom.shortcutContainer.innerHTML = '';
  dom.keyboardRows.innerHTML = '';
  
  let keyRows = [];
  const isShifted = keyboardState.shiftState === 'on' || keyboardState.shiftState === 'lock';

  switch(keyboardState.inputType) {
    case 'number':
    case 'numeric-input':
      keyRows = [
        ['1', '2', '3','+', 'clear'],
        ['4', '5', '6', '-', 'backspace'],
        ['7', '8', '9','*', 'esc'], 
        ['.', '0', '/','、', 'done'] 
      ];
      break;
      
    case 'status':
      createShortcutKeys(statusOptions, 'status-key');
      keyRows = [
        ['clear', 'backspace', 'esc', 'done'] 
      ];
      break;
      
    case 'cardId':
      createShortcutKeys(cardIdOptions, 'shortcut-key');
      // Fallthrough to text keyboard
    case 'steelType':
      if (keyboardState.inputType === 'steelType') createShortcutKeys(steelTypeOptions, 'shortcut-key');
      // Fallthrough to text keyboard
    case 'productId':
      if (keyboardState.inputType === 'productId') createShortcutKeys(['TH'], 'shortcut-key'); 
      // Fallthrough to text keyboard
    case 'furnaceId':
      if (keyboardState.inputType === 'furnaceId') {
          const year = new Date().getFullYear().toString().slice(2);
          const lastyear = (parseInt(year) - 1).toString().slice(-2);
          const furnaceShortcuts = [`VD${year}/`, `VD${lastyear}/`,`${year}1`,`1${year}1`,`${lastyear}1`,`1${lastyear}1`];
          createShortcutKeys(furnaceShortcuts, 'shortcut-key');
      }
      // Fallthrough to text keyboard
    case 'text':
    default:
      keyRows = [
        ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'],
        ['Q', 'W', 'E', 'R', 'T', 'Y', 'U', 'I', 'O', 'P','+'],
        ['A', 'S', 'D', 'F', 'G', 'H', 'J', 'K', 'L','-'],
        ['shift', 'Z', 'X', 'C', 'V', 'B', 'N', 'M', ',', '.', 'backspace'],
        ['symbol', 'clear', 'space', 'esc', 'done'] 
      ];
      break;
      
    case 'position':
      createShortcutKeys(positionOptions, 'shortcut-key');
      keyRows = [
        ['1', '2', '3', 'A'],
        ['4', '5', '6', 'B'],
        ['7', '8', '9', 'C'],
        ['/','0', '-','D'],
        ['clear', 'backspace','esc' ,'done'] 
      ];
      break;
      
    case 'symbol':
      keyRows = [
        ['~', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')'],
        ['_', '+', '=', '|', '\\', ':', '"', '<', '>', '?', ','],
        ['`', '}', '[', ']', '{', '(', ')', '.', '/', ''],
        ['ABC', 'clear', 'space', 'esc', 'backspace', 'done'] 
      ];
      break;
  }
  
  // 字母大小写转换
  if (isShifted && keyboardState.inputType !== 'number' && keyboardState.inputType !== 'position' && keyboardState.inputType !== 'symbol' && keyboardState.inputType !== 'status') {
    keyRows = keyRows.map(row => 
      row.map(key => {
          if (key.length === 1 && /^[a-z]$/.test(key.toLowerCase())) {
              return key.toUpperCase();
          }
          return key;
      })
    );
  }
  
  // 渲染按键
  keyRows.forEach(row => {
    const rowElement = document.createElement('div');
    rowElement.className = 'keyboard-row';
    row.forEach(key => {
      if (key) {
        rowElement.appendChild(createKeyElement(key));
      }
    });
    dom.keyboardRows.appendChild(rowElement);
  });
}

/**
 * 创建快捷键区域
 * @param {Array<string>} options - 快捷键文本数组
 * @param {string} keyClass - CSS 类名
 */
function createShortcutKeys(options, keyClass) {
  const shortcutRow = document.createElement('div');
  shortcutRow.className = 'keyboard-row';
  
  options.forEach(option => {
    const keyElement = document.createElement('div');
    keyElement.className = `keyboard-key ${keyClass}`;
    keyElement.textContent = option;
    
    keyElement.addEventListener('click', () => {
      if (currentInput) {
        insertText(option);
        currentInput.focus();
      }
    });
    shortcutRow.appendChild(keyElement);
  });
  
  dom.shortcutContainer.appendChild(shortcutRow);
}

/**
 * 创建单个虚拟键盘按键元素，并绑定事件
 * @param {string} key - 按键值或特殊操作名称
 * @returns {HTMLElement}
 */
function createKeyElement(key) {
  const keyElement = document.createElement('div');
  keyElement.className = 'keyboard-key';
  
  if (key === 'shift') {
    keyElement.className += ' special wide';
    keyElement.innerHTML = keyboardState.shiftState === 'off' ? '⇧' : '⇪'; // 切换显示图标
    keyElement.addEventListener('click', toggleShift);
  } else if (key === 'backspace') {
    keyElement.className += ' special wide';
    keyElement.innerHTML = '←';
    keyElement.addEventListener('click', handleBackspace);
  } else if (key === 'space') {
    keyElement.className += ' special extra-wide';
    keyElement.textContent = '';
    keyElement.addEventListener('click', () => insertText(' '));
  } else if (key === 'esc') {
    keyElement.className += ' system-keyboard wide'; 
    keyElement.textContent = '关闭'; 
    keyElement.addEventListener('click', closeVirtualKeyboardAndKeepReadOnly);
  } else if (key === 'done') {
    keyElement.className += ' special wide';
    keyElement.textContent = '▼';
    keyElement.addEventListener('click', handleNextInput); // 切换到下一个输入框
  } else if (key === 'clear') {
    keyElement.className += ' clear-key wide';
    keyElement.textContent = '清空';
    keyElement.addEventListener('click', clearInput);
  } else if (key === 'symbol') {
    keyElement.className += ' special wide';
    keyElement.textContent = '符';
    keyElement.addEventListener('click', () => {
      keyboardState.inputType = 'symbol';
      saveKeyboardState();
      generateVirtualKeyboard();
    });
  } else if (key === 'ABC') {
    keyElement.className += ' special wide';
    keyElement.textContent = 'ABC';
    keyElement.addEventListener('click', () => {
      keyboardState.inputType = 'text';
      saveKeyboardState();
      generateVirtualKeyboard();
    });
  } else {
    keyElement.textContent = key;
    keyElement.addEventListener('click', () => {
      insertText(key);
      
      // 单次 Shift 模式下，输入后自动切换回 Off
      if (keyboardState.shiftState === 'on') { 
        keyboardState.shiftState = 'off'; 
        keyboardState.mode = 'normal';
        saveKeyboardState();
        generateVirtualKeyboard();
      }
    });
  }
  
  return keyElement;
}

/**
 * 处理 'Done'（完成）按钮点击，切换到下一个输入框
 */
function handleNextInput() {
  if (!currentInput) {
    dom.virtualKeyboard.style.display = 'none';
    return;
  }
  
  const currentId = currentInput.id;
  const isCalcInput = currentInput.closest('#calculatorForm');
  const isQuickEditInput = currentId === 'quickEditInput';
  
  if (isQuickEditInput) {
      saveQuickEdit(); 
      dom.virtualKeyboard.style.display = 'none';
      return;
  }
  
  let nextInput = null;
  let nextIndex = -1;

  // 计算器模式下的切换逻辑
  if (isCalcInput) {
      const calcInputs = [dom.calcDiameter1, dom.calcDiameter2, dom.calcLength, dom.calcDensity];
      const currentIndex = calcInputs.indexOf(currentInput);
      nextIndex = currentIndex === calcInputs.length - 1 ? 0 : currentIndex + 1;
      nextInput = calcInputs[nextIndex];
  } 
  // 主表单模式下的切换逻辑
  else {
      const currentIndex = inputFieldOrder.indexOf(currentId);
      nextIndex = currentIndex === inputFieldOrder.length - 1 ? 0 : currentIndex + 1;
      nextInput = formElements[inputFieldOrder[nextIndex]];
  }
  
  if (!nextInput) {
      dom.virtualKeyboard.style.display = 'none';
      return;
  }
  
  currentInput = nextInput;

  // 备注字段特殊处理：切换为普通输入
  if (currentInput.id === 'remarks' && !isCalcInput) {
    currentInput.removeAttribute('readonly');
    currentInput.classList.remove('readonly-input');
    dom.virtualKeyboard.style.display = 'none';
  } else {
    // 其他字段继续只读，显示对应键盘
    currentInput.setAttribute('readonly', 'true');
    currentInput.classList.add('readonly-input');
    updateKeyboardForInput(currentInput);
    showVirtualKeyboard();
  }

  currentInput.focus();
  // 滚动到下一个输入框
  const modalContent = currentInput.closest('.modal-body-custom'); 
  if(modalContent) {
      setTimeout(() => {
          const inputRect = currentInput.getBoundingClientRect();
          const modalRect = modalContent.getBoundingClientRect();
          const offset = inputRect.top - modalRect.top + modalContent.scrollTop - modalRect.height * 0.3; 
          modalContent.scrollTo({ top: offset, behavior: 'smooth' });
      }, 50);
  }
}

/**
 * 根据当前输入框的字段类型更新虚拟键盘状态和布局
 * @param {HTMLElement} input - 当前聚焦的输入框 DOM 元素
 * @param {string} [overrideId=null] - 可选，强制指定字段ID，用于快速编辑框
 */
function updateKeyboardForInput(input, overrideId = null) {
  if (!input) return;

  const numericFields = [
    'actualDiameter', 'diameter', 'length', 'weight', 'hardness',
    'calcDiameter1', 'calcDiameter2', 'calcLength', 'calcDensity'
  ];
  
  const currentId = overrideId || input.id; 
  const isNumeric = numericFields.includes(currentId);

  // 确定输入类型
  if (isNumeric) {
    keyboardState.inputType = 'number';
  } else if (currentId === 'productId') {
    keyboardState.inputType = 'productId';
  } else if (currentId === 'cardId') {
    keyboardState.inputType = 'cardId';
  } else if (currentId === 'steelType') {
    keyboardState.inputType = 'steelType';
  } else if (currentId === 'furnaceId') {
    keyboardState.inputType = 'furnaceId';
  } else if (currentId === 'position') {
    keyboardState.inputType = 'position';
  } else if (currentId === 'status') {
    keyboardState.inputType = 'status';
  } else {
    keyboardState.inputType = 'text';
  }
  
  // 更新键盘布局
  keyboardState.mode = keyboardState.inputType;
  
  saveKeyboardState();
  generateVirtualKeyboard();
}

/**
 * 在当前输入框的光标位置插入文本
 * @param {string} text - 要插入的文本
 */
function insertText(text) {
  if (!currentInput) return;
  
  currentInput.focus(); 
  
  const startPos = currentInput.selectionStart;
  const endPos = currentInput.selectionEnd;
  const currentValue = currentInput.value;
  
  currentInput.value = currentValue.substring(0, startPos) + text + currentValue.substring(endPos);
  
  // 保持光标位置在插入文本之后
  currentInput.selectionStart = currentInput.selectionEnd = startPos + text.length;
  
  // 触发 input 事件，用于数据绑定或计算（如重量计算）
  const event = new Event('input', { bubbles: true });
  currentInput.dispatchEvent(event);

  if (currentInput.closest('#calculatorForm')) {
      calculateWeight();
  } else if (currentInput.id === 'searchInput' && isSearchReplaceVisible) {
      // 如果是主搜索框，且搜索替换可见，则重新执行搜索匹配
      startSearch();
  }
}

/**
 * 处理退格键（Backspace）操作
 */
function handleBackspace() {
  if (!currentInput) return;
  
  currentInput.focus();
  
  const startPos = currentInput.selectionStart;
  const endPos = currentInput.selectionEnd;
  const currentValue = currentInput.value;
  
  if (startPos === endPos && startPos > 0) {
    // 无选中状态，删除光标前一个字符
    currentInput.value = currentValue.substring(0, startPos - 1) + currentValue.substring(endPos);
    currentInput.selectionStart = currentInput.selectionEnd = startPos - 1;
  } else if (startPos !== endPos) {
    // 有选中状态，删除选中区域
    currentInput.value = currentValue.substring(0, startPos) + currentValue.substring(endPos);
    currentInput.selectionStart = currentInput.selectionEnd = startPos;
  }
  
  const event = new Event('input', { bubbles: true });
  currentInput.dispatchEvent(event);

  if (currentInput.closest('#calculatorForm')) {
      calculateWeight();
  } else if (currentInput.id === 'searchInput' && isSearchReplaceVisible) {
      // 如果是主搜索框，且搜索替换可见，则重新执行搜索匹配
      startSearch();
  }
}

/**
 * 清空当前输入框的内容
 */
function clearInput() {
  if (currentInput) {
    currentInput.value = '';
    currentInput.focus();
    
    const event = new Event('input', { bubbles: true });
    currentInput.dispatchEvent(event);
    
    if (currentInput.closest('#calculatorForm')) {
        calculateWeight();
    }
  }
}

/**
 * 切换 Shift 状态（Off -> On -> Lock -> Off）
 */
function toggleShift() {
  const allowedTypes = ['text', 'productId', 'furnaceId', 'cardId', 'steelType'];
  if (!allowedTypes.includes(keyboardState.inputType)) return;

  if (keyboardState.shiftState === 'off') {
    keyboardState.shiftState = 'on'; 
    keyboardState.mode = 'shift';
  } else if (keyboardState.shiftState === 'on') {
    keyboardState.shiftState = 'lock'; 
    keyboardState.mode = 'caps';
  } else if (keyboardState.shiftState === 'lock') {
    keyboardState.shiftState = 'off'; 
    keyboardState.mode = 'normal';
  }
  
  saveKeyboardState();
  generateVirtualKeyboard();
}

/**
 * 显示虚拟键盘
 */
function showVirtualKeyboard() {
  generateVirtualKeyboard();
  dom.virtualKeyboard.style.display = 'block';
}

/**
 * 将键盘状态保存到 localStorage
 */
function saveKeyboardState() {
  localStorage.setItem('keyboardState', JSON.stringify(keyboardState));
}

/**
 * 从 localStorage 加载数据到 tableData
 */
function loadData() {
  const savedData = localStorage.getItem('roundBarData');
  if (savedData) {
    tableData = JSON.parse(savedData);
  }
}

/**
 * 将 tableData 保存到 localStorage
 */
function saveDataToLocalStorage() {
  localStorage.setItem('roundBarData', JSON.stringify(tableData));
}

/**
 * 比较两个对象并找出关键字段的差异
 * @param {Object} oldObj - 现有数据
 * @param {Object} newObj - 新数据
 * @returns {Array<Object>} 差异数组
 */
function getObjectDifferences(oldObj, newObj) {
  const differences = [];
  
  const trackableKeys = [
    'steelType', 'cardId', 'furnaceId', 'actualDiameter', 
    'diameter', 'length', 'weight', 'status', 'position', 
    'hardness', 'remarks'
  ];

  for (const key of trackableKeys) {
    const oldValue = (oldObj[key] ?? '').toString().trim();
    const newValue = (newObj[key] ?? '').toString().trim();

    if (String(oldValue) !== String(newValue)) {
      differences.push({
        field: fieldLabels[key],
        existingItem: oldObj,
        newValue: newValue,
        key: key
      });
    }
  }
  
  return differences;
}

/**
 * 完成 Excel 导入的最终步骤：合并新数据和处理重复项
 * @param {Array<Object>} newData - 待添加的新数据
 * @param {Array<Object>} duplicateEntries - 待处理的重复数据
 * @param {number} totalImported - 总共读取的记录数
 */
function finalizeImport(newData, duplicateEntries, totalImported) {
  let actuallyAdded = newData.length;
  let actuallyOverridden = 0;
  let actuallySkipped = 0;

  // 处理重复项的覆盖或跳过
  duplicateEntries.forEach(entry => {
    const action = entry.action;
    const index = tableData.findIndex(item => item.productId && item.productId.trim() !== '' && item.productId === entry.productId);
    
    if (action === 'override' && index !== -1) {
      tableData[index] = entry.newItem; // 覆盖
      actuallyOverridden++;
    } else if (action === 'skip') {
      actuallySkipped++; // 跳过
    }
  });

  // 添加新数据
  if (newData.length > 0) {
    tableData = [...tableData, ...newData];
  }
  
  if (actuallyAdded > 0 || actuallyOverridden > 0 || actuallySkipped > 0 || totalImported > 0) {
    saveDataToLocalStorage();
    updateTable();
  }

  let resultMessage = `导入完成！共读取 ${totalImported} 条记录。`;
  if (actuallyAdded > 0) resultMessage += ` 成功添加 ${actuallyAdded} 条新数据。`;
  if (actuallyOverridden > 0) resultMessage += ` 覆盖 ${actuallyOverridden} 条重复数据。`;
  if (actuallySkipped > 0) resultMessage += ` 跳过 ${actuallySkipped} 条重复数据。`;
  if (totalImported === 0) resultMessage = `导入完成！文件未包含有效数据。`;
  
  showSnackbar(resultMessage, 'success');
}

/**
 * 显示导入重复数据确认模态框
 * @param {Array<Object>} duplicateEntries - 重复数据列表
 * @param {Array<Object>} newData - 新数据列表
 * @param {number} totalImported - 总共读取的记录数
 */
function showDuplicateConfirmationModal(duplicateEntries, newData, totalImported) {
  const modalElement = dom.duplicateConfirmationModal;
  openCustomModal(modalElement); 
  
  const listContainer = modalElement.querySelector('#modal-duplicate-list');
  const totalCountEl = modalElement.querySelector('#modal-total-count');
  const newCountEl = modalElement.querySelector('#modal-new-count');
  const duplicateCountEl = modalElement.querySelector('#modal-duplicate-count');

  listContainer.innerHTML = '';
  totalCountEl.textContent = totalImported;
  newCountEl.textContent = newData.length;
  duplicateCountEl.textContent = duplicateEntries.length;

  const itemTemplateHtml = document.getElementById('duplicate-item-template').innerHTML;
  const differenceTemplateHtml = document.getElementById('difference-row-template').innerHTML;

  // 渲染重复项列表
  duplicateEntries.forEach((entry, itemIndex) => {
    let itemHtml = itemTemplateHtml.replace(/PRODUCT_ID/g, entry.productId || 'N/A');
    itemHtml = itemHtml.replace(/ITEM_INDEX/g, itemIndex);

    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = itemHtml;
    const differencesContainer = tempDiv.querySelector('.duplicate-differences tbody');
    
    const hasDiff = entry.differences.length > 0;

    if (hasDiff) {
      entry.differences.forEach(diff => {
        let rowHtml = differenceTemplateHtml
          .replace('FIELD_NAME', diff.field)
          .replace('OLD_VALUE', diff.existingItem[diff.key] || '-') 
          .replace('NEW_VALUE', diff.newValue);
        differencesContainer.innerHTML += rowHtml;
      });
    } else {
      differencesContainer.innerHTML = '<tr><td colspan="3" class="mdui-text-center" style="font-style: italic; color: #757575;">无关键字段差异</td></tr>';
    }

    listContainer.appendChild(tempDiv.firstElementChild);
  });

  // 绑定批量操作按钮
  document.getElementById('modal-btn-select-all-skip').onclick = function() {
    modalElement.querySelectorAll('input[type="radio"][value="skip"]').forEach(radio => radio.checked = true);
  };

  document.getElementById('modal-btn-select-all-override').onclick = function() {
    modalElement.querySelectorAll('input[type="radio"][value="override"]').forEach(radio => radio.checked = true);
  };

  // 绑定确认导入按钮
  document.getElementById('modal-btn-confirm').onclick = function() {
    const finalDuplicateData = duplicateEntries.map((entry, index) => {
      const selectedAction = modalElement.querySelector(`input[name="action-${index}"]:checked`).value;
      return {
        ...entry,
        action: selectedAction
      };
    });

    closeCustomModal(modalElement); 
    setTimeout(() => {
      finalizeImport(newData, finalDuplicateData, totalImported);
    }, 300);
  };
}

/**
 * 处理 Excel 文件导入逻辑
 * @param {Event} e - 文件输入事件
 */
function handleFileImport(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  if (file.size > 10 * 1024 * 1024) {
    showSnackbar('导入失败，文件大小不能超过10MB', 'error');
    dom.fileInput.value = '';
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const worksheet = workbook.Sheets[workbook.SheetNames[0]];
      const importedData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
      
      if (importedData.length < 2) {
        showSnackbar('导入失败，文件中未找到数据行。', 'error');
        dom.fileInput.value = '';
        return;
      }
      
      const headers = importedData[0].map(h => String(h).trim());
      const dataRows = importedData.slice(1);
      
      // Excel 列头与内部字段的映射
      const columnMapping = {
        '钢种': 'steelType', '产品号': 'productId', '卡片号': 'cardId', '炉号': 'furnaceId',
        '实际直径': 'actualDiameter', '直径': 'diameter', '长度': 'length', '长度': 'length', 
        '重量': 'weight', '重量': 'weight', '状态': 'status', '位置': 'position',
        '硬度': 'hardness', '备注': 'remarks'
      };
      
      const formattedData = dataRows.map(row => {
        const item = {};
        headers.forEach((header, index) => {
          const key = columnMapping[header];
          if (key) {
             item[key] = (row[index] !== undefined && row[index] !== null) ? String(row[index]).trim() : '';
          }
        });
        return item;
      }).filter(item => item.productId && item.productId.trim() !== ''); // 过滤掉无产品号的无效行

      const totalImported = formattedData.length;
      const newData = [];
      const duplicateEntries = [];

      // 区分新数据和重复数据
      formattedData.forEach(newItem => {
        const existingItem = tableData.find(item => item.productId && item.productId.trim() !== '' && item.productId === newItem.productId);
        
        if (!existingItem) {
          newData.push(newItem);
        } else {
          duplicateEntries.push({
            productId: newItem.productId,
            existingItem: existingItem,
            newItem: newItem,
            differences: getObjectDifferences(existingItem, newItem)
          });
        }
      });

      if (totalImported === 0) {
        showSnackbar('导入失败，文件中未包含有效产品号数据。', 'error');
      } else if (duplicateEntries.length > 0) {
        showDuplicateConfirmationModal(duplicateEntries, newData, totalImported); // 发现重复，弹出确认框
      } else {
        finalizeImport(newData, [], totalImported); // 无重复，直接导入
      }

    } catch (error) {
      console.error('导入过程中发生严重错误:', error);
      showSnackbar('导入失败，请检查文件格式或内容是否正确。', 'error');
    } finally {
      dom.fileInput.value = '';
    }
  };
  
  reader.onerror = function(error) {
    console.error('FileReader 读取文件失败:', error);
    showSnackbar('导入失败，文件读取错误。', 'error');
    dom.fileInput.value = '';
  };
  
  reader.readAsArrayBuffer(file);
}

/**
 * 将当前筛选后的数据导出为 Excel 文件
 */
function exportToExcel() {
  const exportData = getFilteredData();
  if (exportData.length === 0) {
    showSnackbar('暂无数据可导出', 'warning');
    return;
  }
  
  // 格式化导出数据，添加中文表头
  const formattedExportData = exportData.map((item, index) => ({
    '序号': index + 1,
    '钢种': item.steelType || '',
    '产品号': item.productId || '',
    '卡片号': item.cardId || '',
    '炉号': item.furnaceId || '',
    '实际直径': item.actualDiameter || '',
    '直径': item.diameter || '',
    '长度': item.length || '', 
    '重量': item.weight || '', 
    '状态': item.status || '',
    '位置': item.position || '',
    '硬度': item.hardness || '',
    '备注': item.remarks || ''
  }));
  
  const worksheet = XLSX.utils.json_to_sheet(formattedExportData);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, '圆棒入库数据');
  
  const dateString = new Date().toLocaleDateString().replace(/\//g, '-');
  XLSX.writeFile(workbook, `圆棒入库数据_${dateString}.xlsx`);
}

/**
 * 根据计算器输入计算圆棒重量
 * 公式：重量 (Kg) = 直径1 * 直径2 * 长度 * 密度 / 1000
 * 采用 $D_1 \cdot D_2 \cdot L \cdot \text{densityFactor} / 1000$ 的近似公式
 */
function calculateWeight() {
  const diameter1 = parseFloat(dom.calcDiameter1.value) || 0;
  const diameter2 = parseFloat(dom.calcDiameter2.value) || 0;
  const length = parseFloat(dom.calcLength.value) || 0;
  // 密度：0.00617，这里假设它是一个已经简化后的系数
  const densityFactor = parseFloat(dom.calcDensity.value) || 0.00617; 
  
  if (diameter1 <= 0 || diameter2 <= 0 || length <= 0) {
    dom.calcResult.value = '';
    return;
  }
  
  // 采用近似公式 $D_1 \cdot D_2 \cdot L \cdot \text{densityFactor} / 1000$
  const crudeWeight = densityFactor * diameter1 * diameter2 * length / 1000;
  
  dom.calcResult.value = crudeWeight.toFixed(2);
}

/**
 * 绑定计算器输入框的输入事件，实现实时计算
 */
function initAutoCalculate() {
  const calcInputs = [
    dom.calcDiameter1,
    dom.calcDiameter2,
    dom.calcLength
  ];
  
  calcInputs.forEach(input => {
    if (input) {
      input.addEventListener('input', calculateWeight);
      input.addEventListener('change', calculateWeight);
    }
  });
  
  // 允许双击修改密度，但默认只读
  dom.calcDensity.addEventListener('dblclick', (e) => {
      e.stopPropagation();
      const densityInput = dom.calcDensity;
      if (densityInput.hasAttribute('readonly')) {
          densityInput.removeAttribute('readonly');
          densityInput.classList.remove('readonly-input');
          densityInput.focus();
      } else {
          densityInput.setAttribute('readonly', 'true');
          densityInput.classList.add('readonly-input');
          densityInput.blur();
      }
  });
  
  calculateWeight();
}

/**
 * 执行重量计算并将结果填充到新增数据模态框
 */
function calculateAndAddData() {
    const diameter1 = parseFloat(dom.calcDiameter1.value);
    const diameter2 = parseFloat(dom.calcDiameter2.value);
    const length = parseFloat(dom.calcLength.value);
    const weight = parseFloat(dom.calcResult.value);

    if (isNaN(diameter1) || isNaN(diameter2) || isNaN(length) || 
        diameter1 <= 0 || diameter2 <= 0 || length <= 0) {
      showSnackbar('请输入有效的计算参数', 'error');
      return;
    }

    const minDiameter = Math.min(diameter1, diameter2);
    const maxDiameter = Math.max(diameter1, diameter2);
    const actualDiameter = `${minDiameter.toFixed(2)}-${maxDiameter.toFixed(2)}`;
    const averageDiameter = ((minDiameter + maxDiameter) / 2).toFixed(2);

    const preFilledData = {
      actualDiameter: actualDiameter,
      diameter: averageDiameter, 
      length: length.toFixed(2),
      weight: weight.toFixed(2)
    };

    closeCustomModal(dom.calculatorModal); 
    dom.virtualKeyboard.style.display = 'none'; 
    openAddModalWithData(preFilledData);
}

/**
 * 切换多选模式 (Multi-Select Mode)
 */
function toggleMultiSelectMode() {
  isMultiSelectMode = !isMultiSelectMode;
  selectedRows.clear(); // 切换模式时清空选中项
  
  // 更新菜单文本
  const menuText = dom.multiSelectMenuText;
  if (isMultiSelectMode) {
    menuText.textContent = '退出多选模式';
    dom.multiSelectMenuItem.icon = 'check_box';
  } else {
    menuText.textContent = '进入多选模式';
    dom.multiSelectMenuItem.icon = 'check_box_outline_blank';
  }
  
  updateTable();
}

/**
 * 初始化计算器输入框的只读和键盘事件
 */
function initCalculatorKeyboard() {
  const calcInputs = [
    dom.calcDiameter1,
    dom.calcDiameter2,
    dom.calcLength
  ]; // calcDensity 已在 initAutoCalculate 中单独处理

  calcInputs.forEach(input => {
    if (input) {
      input.setAttribute('readonly', 'true');
      input.classList.add('readonly-input');
      
      input.addEventListener('click', (e) => {
          if (input.hasAttribute('readonly')) {
            e.stopPropagation();
            currentInput = e.target;
            updateKeyboardForInput(currentInput);
            showVirtualKeyboard();
            currentInput.focus();
            
            // 滚动到输入框
            const modalContent = document.getElementById('calculatorContent');
            if(modalContent) {
                setTimeout(() => {
                    const inputRect = currentInput.getBoundingClientRect();
                    const modalRect = modalContent.getBoundingClientRect();
                    const offset = inputRect.top - modalRect.top + modalContent.scrollTop - modalRect.height * 0.3; 
                    modalContent.scrollTo({ top: offset, behavior: 'smooth' });
                }, 50);
            }
          }
      });
      
      // 双击解除只读
      input.addEventListener('dblclick', (e) => {
          e.stopPropagation();
          if (dom.calculatorModal.style.display !== 'block') return;
          
          if (input.hasAttribute('readonly')) {
            input.removeAttribute('readonly');
            input.classList.remove('readonly-input');
            dom.virtualKeyboard.style.display = 'none';
            input.focus();
          } else {
            input.setAttribute('readonly', 'true');
            input.classList.add('readonly-input');
            currentInput = input;
            updateKeyboardForInput(currentInput);
            showVirtualKeyboard();
          }
      });
    }
  });
}

/**
 * 打开排序模态框
 */
function openSortModal() {
    dom.drawer.open = false;
    openCustomModal(dom.sortModal);
    
    // 初始化选择框为默认值
    dom.sortField.value = 'productId'; 
    dom.sortOrder.value = 'asc';
}

/**
 * 应用排序逻辑
 */
function applySort() {
    const field = dom.sortField.value;
    const order = dom.sortOrder.value; // 'asc' 或 'desc'

    if (tableData.length === 0) {
        showSnackbar('没有数据可排序', 'warning');
        closeCustomModal(dom.sortModal);
        return;
    }

    const isNumeric = ['actualDiameter', 'diameter', 'length', 'weight', 'hardness'].includes(field);

    tableData.sort((a, b) => {
        const aValue = a[field] ?? '';
        const bValue = b[field] ?? '';

        if (isNumeric) {
            const aNum = parseFloat(aValue) || 0;
            const bNum = parseFloat(bValue) || 0;
            
            if (order === 'asc') {
                return aNum - bNum;
            } else {
                return bNum - aNum;
            }
        } else {
            // 字符串排序
            const comparison = String(aValue).localeCompare(String(bValue), 'zh-CN', { numeric: true, sensitivity: 'base' });
            if (order === 'asc') {
                return comparison;
            } else {
                return -comparison;
            }
        }
    });

    saveDataToLocalStorage();
    updateTable();
    closeCustomModal(dom.sortModal);
    showSnackbar(`已按【${fieldLabels[field]}】进行【${order === 'asc' ? '升序' : '降序'}】排序`, 'success');
}

/**
 * 🔍 表格手势缩放：双指捏合整体缩放表格（包括行高、按钮等）
 */
function initTableZoom() {
    const container = document.querySelector('.data-table-container');
    if (!container) return;

    let initialDistance = 0;
    let initialScale = 1;

    const getDistance = (touches) => {
        const dx = touches[0].clientX - touches[1].clientX;
        const dy = touches[0].clientY - touches[1].clientY;
        return Math.sqrt(dx * dx + dy * dy);
    };

    const applyScale = (scale) => {
    scale = Math.min(Math.max(0.5, scale), 3.0);

    container.style.width = `${100 / scale}%`;
    container.style.height = `${100 / scale}%`;  // 可选，如果你希望垂直也自适应
    
    container.style.transform = `scale(${scale})`;
};

    // 获取当前缩放值
    const getCurrentScale = () => {
        const match = container.style.transform.match(/scale\(([^)]+)\)/);
        return match ? parseFloat(match[1]) : 1;
    };

    container.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
            e.preventDefault();
            initialDistance = getDistance(e.touches);
            initialScale = getCurrentScale();
        }
    }, { passive: false });

    container.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2 && initialDistance > 0) {
            e.preventDefault();
            const currentDistance = getDistance(e.touches);
            const ratio = currentDistance / initialDistance;
            const newScale = initialScale * ratio;
            applyScale(newScale);
        }
    }, { passive: false });

    container.addEventListener('touchend', (e) => {
        if (e.touches.length < 2) {
            initialDistance = 0;
        }
    });

    // 双击表头恢复原始大小
    const tableHeader = document.querySelector('#dataTable thead');
    if (tableHeader) {
        let lastTap = 0;
        tableHeader.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTap < 300) {
                container.style.transform = 'scale(1)';
                e.preventDefault();
            }
            lastTap = now;
        });
    }
}

/**
 * 页面加载完成后的初始化入口函数
 */
document.addEventListener('DOMContentLoaded', () => {
  initTheme();
  initEventListeners();
  loadData();
  updateTable();
  initAutoCalculate();
  initCalculatorKeyboard(); 
  dom.calcDensity.value = 0.00617;
  
  // 🔍 新增：初始化表格缩放
  initTableZoom(); 
});
</script>

</body>
</html>
