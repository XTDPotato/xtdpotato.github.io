<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>锻钢圆棒重量计算器</title>
  <!-- 引入MDUI CSS -->
  <link rel="stylesheet" href="https://unpkg.com/mdui@2/mdui.css">
  <!-- 引入MDUI JS -->
  <script src="https://unpkg.com/mdui@2/mdui.js"></script>
  <!-- 引入Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- 引入xlsx.js库 -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    /* 基础样式设置，确保页面不超出屏幕 */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: 'Roboto', sans-serif;
      transition: background-color 0.3s ease;
    }
    
    /* 日间模式颜色 */
    body {
      --bg-color: #f8f9fa;
      --surface-color: #ffffff;
      --surface-container: #f1f3f5;
      --surface-container-high: #e9ecef;
      --on-background: #212529;
      --on-surface: #212529;
      --on-surface-variant: #6c757d;
      --outline: #adb5bd;
      --primary: #2b6cb0;
      --primary-container: #dbeafe;
      --on-primary: #ffffff;
      --on-primary-container: #1e40af;
      --error-container: #fee2e2;
      --on-error-container: #b42318;
      --warning-container: #fff3bf;
      --on-warning-container: #94400c;
    }
    
    /* 夜间模式颜色 */
    body.dark-mode {
      --bg-color: #121212;
      --surface-color: #1e1e1e;
      --surface-container: #2d2d2d;
      --surface-container-high: #3d3d3d;
      --on-background: #e0e0e0;
      --on-surface: #e0e0e0;
      --on-surface-variant: #bbbbbb;
      --outline: #4a4a4a;
      --primary: #93c5fd;
      --primary-container: #1e40af;
      --on-primary: #1e3a8a;
      --on-primary-container: #dbeafe;
      --error-container: #420000;
      --on-error-container: #ffdad6;
      --warning-container: #5c4100;
      --on-warning-container: #fff3bf;
    }
    
    body {
      background-color: var(--bg-color);
      color: var(--on-background);
    }
    
    .container {
      height: 100%;
      display: flex;
      flex-direction: column;
      max-width: 500px;
      margin: 0 auto;
      width: 100%;
    }
    
    .app-bar {
      background-color: var(--primary);
      color: var(--on-primary);
      padding: 12px 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .app-title {
      font-size: 18px;
      font-weight: 500;
      margin: 0;
    }
    
    .theme-toggle {
      background: none;
      border: none;
      color: var(--on-primary);
      cursor: pointer;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
    }
    
    .theme-toggle:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .content-area {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      box-sizing: border-box;
    }
    
    .input-group {
      margin-bottom: 16px;
    }
    
    .input-label {
      margin-bottom: 6px;
      color: var(--on-surface-variant);
      font-size: 14px;
      font-weight: 500;
      display: block;
    }
    
    .input-field {
      background-color: var(--surface-container);
      border: 1px solid var(--outline);
      border-radius: 8px;
      padding: 12px;
      font-size: 18px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      width: calc(100% - 26px);
      color: var(--on-surface);
    }
    
    /* 高亮当前选中的输入框 */
    .input-field.active {
      border-color: var(--primary);
      background-color: var(--primary-container);
      color: var(--on-primary-container);
      box-shadow: 0 0 0 2px rgba(43, 108, 176, 0.2);
    }
    
    .diameter-container {
      display: flex;
      gap: 12px;
    }
    
    .diameter-item {
      flex: 1;
    }
    
    .result-section {
      margin-top: 12px;
      padding: 14px;
      background-color: var(--surface-container);
      border-radius: 8px;
    }
    
    .result-display {
      text-align: center;
      font-size: 18px;
      color: var(--on-surface);
      font-weight: 500;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }
    
    .record-btn {
      background-color: var(--primary);
      color: var(--on-primary);
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    
    .record-btn:hover {
      background-color: var(--primary-container);
      color: var(--on-primary-container);
    }
    
    /* 记录管理按钮区域 */
    .record-controls {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .record-control-btn {
      flex: 1;
      background-color: var(--surface-container);
      border: 1px solid var(--outline);
      border-radius: 8px;
      padding: 10px;
      font-size: 14px;
      color: var(--on-surface);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .record-control-btn:hover {
      background-color: var(--surface-container-high);
    }
    
    /* 数字键盘样式 - 固定在底部 */
    .number-pad {
      background-color: var(--surface-color);
      border-top: 1px solid var(--outline);
      padding: 10px;
      box-sizing: border-box;
    }
    
    .pad-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    
    .pad-bottom-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 8px;
    }
    
    .pad-btn {
      height: 45px;
      border-radius: 10px;
      background-color: var(--surface-container);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      color: var(--on-surface);
    }
    
    .pad-btn:hover {
      background-color: var(--surface-container-high);
    }
    
    .pad-btn.del {
      background-color: var(--error-container);
      color: var(--on-error-container);
    }
    
    .pad-btn.clear {
      background-color: var(--warning-container);
      color: var(--on-warning-container);
    }
    
    .pad-btn.clear-all {
      background-color: var(--primary-container);
      color: var(--on-primary-container);
      font-size: 16px;
    }
    
    /* 记录列表弹窗 */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal {
      background-color: var(--surface-color);
      border-radius: 12px;
      width: 90%;
      max-width: 450px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }
    
    .modal-header {
      padding: 16px;
      border-bottom: 1px solid var(--outline);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 500;
      margin: 0;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: var(--on-surface);
      cursor: pointer;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-body {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
    }
    
    .modal-footer {
      padding: 16px;
      border-top: 1px solid var(--outline);
      display: flex;
      gap: 8px;
    }
    
    .modal-btn {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      flex: 1;
    }
    
    .modal-btn.primary {
      background-color: var(--primary);
      color: var(--on-primary);
    }
    
    .modal-btn.danger {
      background-color: var(--error-container);
      color: var(--on-error-container);
    }
    
    .modal-btn.cancel {
      background-color: var(--surface-container);
      color: var(--on-surface);
    }
    
    /* 记录列表样式 */
    .record-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .record-item {
      background-color: var(--surface-container);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
    }
    
    .record-item.selected {
      background-color: var(--primary-container);
      border: 1px solid var(--primary);
    }
    
    .record-item:hover {
      background-color: var(--surface-container-high);
    }
    
    .record-checkbox {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 2px solid var(--outline);
      display: none;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      flex-shrink: 0;
    }
    
    .record-checkbox.visible {
      display: flex;
    }
    
    .record-checkbox.checked {
      background-color: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    .record-content {
      flex: 1;
    }
    
    .record-summary {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
    }
    
    .record-time {
      font-size: 12px;
      color: var(--on-surface-variant);
      margin-top: 4px;
    }
    
    /* 滑动操作按钮 */
    .slide-actions {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
      display: flex;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    
    .record-item.slide-active .slide-actions {
      transform: translateX(0);
    }
    
    .slide-action {
      width: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      border: none;
      cursor: pointer;
    }
    
    .slide-action.edit {
      background-color: var(--primary);
    }
    
    .slide-action.delete {
      background-color: var(--error-container);
      color: var(--on-error-container);
    }
    
    /* 多选工具栏 */
    .multi-select-toolbar {
      display: none;
      padding: 12px 16px;
      border-bottom: 1px solid var(--outline);
      background-color: var(--surface-container);
      align-items: center;
      justify-content: space-between;
    }
    
    .multi-select-toolbar.active {
      display: flex;
    }
    
    .selected-count {
      font-size: 16px;
      font-weight: 500;
    }
    
    /* 详情弹窗样式 */
    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 16px;
    }
    
    .detail-item {
      background-color: var(--surface-container);
      padding: 8px;
      border-radius: 6px;
    }
    
    .detail-label {
      font-size: 12px;
      color: var(--on-surface-variant);
    }
    
    .detail-value {
      font-size: 14px;
      font-weight: 500;
    }
    
    /* 编辑表单样式 */
    .edit-input {
      width: 100%;
      background-color: var(--surface-container);
      border: 1px solid var(--outline);
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 12px;
      box-sizing: border-box;
      color: var(--on-surface);
    }
    
    .import-export-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 顶部导航栏 -->
    <header class="app-bar">
      <h1 class="app-title">锻钢圆棒重量计算器</h1>
      <button class="theme-toggle" id="themeToggle">
        <span class="material-icons">light_mode</span>
      </button>
    </header>

    <!-- 主内容区 -->
    <main class="content-area">
      <!-- 密度系数输入 -->
      <div class="input-group">
        <label class="input-label">密度系数 (默认: 0.00617/1000)</label>
        <div id="density" class="input-field">0.00617</div>
      </div>
      
      <!-- 直径输入 -->
      <div class="input-group">
        <label class="input-label">直径 (mm)</label>
        <div class="diameter-container">
          <div class="diameter-item">
            <div id="diameter1" class="input-field">0.00</div>
          </div>
          <div class="diameter-item">
            <div id="diameter2" class="input-field">0.00</div>
          </div>
        </div>
      </div>
      
      <!-- 长度输入 -->
      <div class="input-group">
        <label class="input-label">长度 (mm)</label>
        <div id="length" class="input-field">0.00</div>
      </div>
      
      <!-- 结果显示和记录按钮 -->
      <div class="result-section">
        <div class="result-display">
          重量: <span id="resultValue">0.0000</span> KG
          <button class="record-btn" id="addRecordBtn">
            <span class="material-icons">add</span>
          </button>
        </div>
        
        <!-- 记录管理按钮 -->
        <div class="record-controls">
          <button class="record-control-btn" id="showRecordsBtn">
            <span class="material-icons">list</span>
            记录列表
          </button>
        </div>
      </div>
    </main>
    
    <!-- 数字键盘 - 固定在底部 -->
    <div class="number-pad" id="numberPad">
      <div class="pad-grid">
        <button class="pad-btn" data-num="1">1</button>
        <button class="pad-btn" data-num="2">2</button>
        <button class="pad-btn" data-num="3">3</button>
        <button class="pad-btn" data-num="4">4</button>
        <button class="pad-btn" data-num="5">5</button>
        <button class="pad-btn" data-num="6">6</button>
        <button class="pad-btn" data-num="7">7</button>
        <button class="pad-btn" data-num="8">8</button>
        <button class="pad-btn" data-num="9">9</button>
        <button class="pad-btn" data-num=".">.</button>
        <button class="pad-btn" data-num="0">0</button>
        <button class="pad-btn del" id="deleteBtn">
          <span class="material-icons">backspace</span>
        </button>
      </div>
      <div class="pad-bottom-row">
        <button class="pad-btn clear" id="clearBtn">清空当前</button>
        <button class="pad-btn clear-all" id="clearAllBtn">清空直径和长度</button>
      </div>
    </div>
  </div>
  
  <!-- 记录列表弹窗 -->
  <div class="modal-overlay" id="recordsModal">
    <div class="modal">
      <!-- 多选工具栏 -->
      <div class="multi-select-toolbar" id="multiSelectToolbar">
        <span class="selected-count" id="selectedCount">已选择 0 项</span>
        <button class="modal-btn danger" id="deleteSelectedBtn">删除所选</button>
        <button class="modal-btn cancel" id="exitMultiSelectBtn">取消</button>
      </div>
      
      <div class="modal-header">
        <h2 class="modal-title">记录列表</h2>
        <div>
          <button class="modal-btn" id="multiSelectBtn">
            <span class="material-icons">select_all</span>
          </button>
          <button class="modal-close" id="closeRecordsModal">
            <span class="material-icons">close</span>
          </button>
        </div>
      </div>
      
      <div class="modal-body">
        <div class="import-export-buttons">
          <button class="modal-btn primary" id="exportRecordsBtn">导出记录</button>
          <button class="modal-btn primary" id="importRecordsBtn">导入记录</button>
          <input type="file" id="importFileInput" accept=".xlsx, .xls" style="display: none;">
        </div>
        <ul class="record-list" id="recordList">
          <!-- 记录列表将通过JS动态生成 -->
        </ul>
      </div>
      
      <div class="modal-footer">
        <button class="modal-btn danger" id="deleteAllRecordsBtn">删除所有记录</button>
      </div>
    </div>
  </div>
  
  <!-- 记录详情弹窗 -->
  <div class="modal-overlay" id="detailModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">记录详情</h2>
        <button class="modal-close" id="closeDetailModal">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="modal-body" id="detailContent">
        <!-- 详情内容将通过JS动态生成 -->
      </div>
      <div class="modal-footer">
        <button class="modal-btn cancel" id="closeDetailBtn">关闭</button>
      </div>
    </div>
  </div>
  
  <!-- 编辑记录弹窗 -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">编辑记录</h2>
        <button class="modal-close" id="closeEditModal">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editRecordId">
        <div class="input-group">
          <label class="input-label">密度系数</label>
          <input type="text" class="edit-input" id="editDensity">
        </div>
        <div class="input-group">
          <label class="input-label">直径1 (mm)</label>
          <input type="text" class="edit-input" id="editDiameter1">
        </div>
        <div class="input-group">
          <label class="input-label">直径2 (mm)</label>
          <input type="text" class="edit-input" id="editDiameter2">
        </div>
        <div class="input-group">
          <label class="input-label">长度 (mm)</label>
          <input type="text" class="edit-input" id="editLength">
        </div>
        <div class="input-group">
          <label class="input-label">重量 (KG)</label>
          <input type="text" class="edit-input" id="editWeight" readonly>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn cancel" id="cancelEditBtn">取消</button>
        <button class="modal-btn primary" id="saveEditBtn">保存</button>
      </div>
    </div>
  </div>
  
  <!-- 确认弹窗 -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="confirmTitle">确认操作</h2>
      </div>
      <div class="modal-body" id="confirmMessage">
        您确定要执行此操作吗？
      </div>
      <div class="modal-footer">
        <button class="modal-btn cancel" id="cancelConfirmBtn">取消</button>
        <button class="modal-btn danger" id="confirmActionBtn">确认</button>
      </div>
    </div>
  </div>

  <script>
    // 获取DOM元素
    const densityEl = document.getElementById('density');
    const diameter1El = document.getElementById('diameter1');
    const diameter2El = document.getElementById('diameter2');
    const lengthEl = document.getElementById('length');
    const resultValueEl = document.getElementById('resultValue');
    const resultEl = document.querySelector('.result-display');
    const deleteBtn = document.getElementById('deleteBtn');
    const clearBtn = document.getElementById('clearBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const numButtons = document.querySelectorAll('.pad-btn[data-num]');
    const themeToggle = document.getElementById('themeToggle');
    const addRecordBtn = document.getElementById('addRecordBtn');
    const showRecordsBtn = document.getElementById('showRecordsBtn');
    const recordsModal = document.getElementById('recordsModal');
    const closeRecordsModal = document.getElementById('closeRecordsModal');
    const recordList = document.getElementById('recordList');
    const deleteAllRecordsBtn = document.getElementById('deleteAllRecordsBtn');
    const detailModal = document.getElementById('detailModal');
    const closeDetailModal = document.getElementById('closeDetailModal');
    const closeDetailBtn = document.getElementById('closeDetailBtn');
    const detailContent = document.getElementById('detailContent');
    const editModal = document.getElementById('editModal');
    const closeEditModal = document.getElementById('closeEditModal');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const saveEditBtn = document.getElementById('saveEditBtn');
    const editRecordId = document.getElementById('editRecordId');
    const editDensity = document.getElementById('editDensity');
    const editDiameter1 = document.getElementById('editDiameter1');
    const editDiameter2 = document.getElementById('editDiameter2');
    const editLength = document.getElementById('editLength');
    const editWeight = document.getElementById('editWeight');
    const confirmModal = document.getElementById('confirmModal');
    const confirmTitle = document.getElementById('confirmTitle');
    const confirmMessage = document.getElementById('confirmMessage');
    const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
    const confirmActionBtn = document.getElementById('confirmActionBtn');
    const exportRecordsBtn = document.getElementById('exportRecordsBtn');
    const importRecordsBtn = document.getElementById('importRecordsBtn');
    const importFileInput = document.getElementById('importFileInput');
    const multiSelectBtn = document.getElementById('multiSelectBtn');
    const multiSelectToolbar = document.getElementById('multiSelectToolbar');
    const selectedCount = document.getElementById('selectedCount');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    const exitMultiSelectBtn = document.getElementById('exitMultiSelectBtn');
    
    // 所有输入框元素
    const inputElements = [densityEl, diameter1El, diameter2El, lengthEl];
    const diameterAndLengthInputs = [diameter1El, diameter2El, lengthEl];
    
    // 当前激活的输入框
    let activeInput = densityEl;
    let isInitialValue = true; // 标记是否为初始值
    
    // 记录相关变量
    let records = [];
    let currentEditId = null;
    let currentConfirmAction = null;
    let selectedRecords = [];
    let isMultiSelectMode = false;
    
    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      setActiveInput(densityEl);
      initTheme();
      loadRecords();
      updateRecordList();
      
      // 监听系统主题变化
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', initTheme);
    });
    
    // 主题相关函数
    function initTheme() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
        document.body.classList.add('dark-mode');
        themeToggle.innerHTML = '<span class="material-icons">dark_mode</span>';
      } else {
        document.body.classList.remove('dark-mode');
        themeToggle.innerHTML = '<span class="material-icons">light_mode</span>';
      }
    }
    
    function toggleTheme() {
      const isDark = document.body.classList.toggle('dark-mode');
      
      if (isDark) {
        localStorage.setItem('theme', 'dark');
        themeToggle.innerHTML = '<span class="material-icons">dark_mode</span>';
      } else {
        localStorage.setItem('theme', 'light');
        themeToggle.innerHTML = '<span class="material-icons">light_mode</span>';
      }
    }
    
    // 输入框激活状态管理
    function setActiveInput(inputEl) {
      inputElements.forEach(el => {
        el.classList.remove('active');
      });
      
      activeInput = inputEl;
      activeInput.classList.add('active');
      
      isInitialValue = (activeInput.textContent === '0.00' || 
                       (activeInput === densityEl && activeInput.textContent === '0.00617'));
    }
    
    // 数字输入处理
    function inputNumber(num) {
      if (!activeInput) return;
      
      let currentValue = activeInput.textContent.trim();
      
      if (isInitialValue) {
        if (num === '.') {
          currentValue = '0.';
          isInitialValue = false;
        } else if (num === '0') {
          currentValue = '0';
          isInitialValue = false;
        } else {
          currentValue = num;
          isInitialValue = false;
        }
      } else {
        if (num === '.') {
          if (currentValue.includes('.')) {
            return;
          }
          currentValue += '.';
        } else {
          if (currentValue === '0' && num === '0') {
            return;
          }
          currentValue += num;
        }
      }
      
      activeInput.textContent = currentValue;
      calculateWeight();
    }
    
    // 删除最后一个字符
    function deleteNumber() {
      if (!activeInput || isInitialValue) return;
      
      let currentValue = activeInput.textContent.trim();
      currentValue = currentValue.slice(0, -1);
      
      if (currentValue === '' || currentValue === '.') {
        if (activeInput === densityEl) {
          currentValue = '0.00617';
        } else {
          currentValue = '0.00';
        }
        isInitialValue = true;
      }
      
      activeInput.textContent = currentValue;
      calculateWeight();
    }
    
    // 清空当前输入
    function clearInput() {
      if (!activeInput) return;
      
      if (activeInput === densityEl) {
        activeInput.textContent = '0.00617';
      } else {
        activeInput.textContent = '0.00';
      }
      isInitialValue = true;
      calculateWeight();
    }
    
    // 清空直径和长度
    function clearDiameterAndLength() {
      diameterAndLengthInputs.forEach(input => {
        input.textContent = '0.00';
      });
      setActiveInput(activeInput);
      calculateWeight();
    }
    
    // 计算重量
    function calculateWeight() {
      const density = parseFloat(densityEl.textContent) || 0;
      const diameter1 = parseFloat(diameter1El.textContent) || 0;
      const diameter2 = parseFloat(diameter2El.textContent) || 0;
      const length = parseFloat(lengthEl.textContent) || 0;
      
      const avgDiameter = (diameter1 + diameter2) / 2;
      const weight = density * avgDiameter * avgDiameter * length / 1000;
      
      resultValueEl.textContent = weight.toFixed(4);
      return weight;
    }
    
    // 记录管理相关函数
    function loadRecords() {
      const savedRecords = localStorage.getItem('steelBarRecords');
      if (savedRecords) {
        records = JSON.parse(savedRecords);
      } else {
        records = [];
      }
    }
    
    function saveRecords() {
      localStorage.setItem('steelBarRecords', JSON.stringify(records));
    }
    
    function addRecord() {
      const density = parseFloat(densityEl.textContent) || 0;
      const diameter1 = parseFloat(diameter1El.textContent) || 0;
      const diameter2 = parseFloat(diameter2El.textContent) || 0;
      const length = parseFloat(lengthEl.textContent) || 0;
      const weight = calculateWeight();
      
      // 检查是否为重复记录
      const isDuplicate = records.some(record => 
        record.density === density &&
        record.diameter1 === diameter1 &&
        record.diameter2 === diameter2 &&
        record.length === length &&
        record.weight === weight
      );
      
      if (isDuplicate) {
        showConfirm('重复记录', '此记录已存在，是否仍要添加？', () => {
          saveNewRecord(density, diameter1, diameter2, length, weight);
        });
        return;
      }
      
      saveNewRecord(density, diameter1, diameter2, length, weight);
    }
    
    function saveNewRecord(density, diameter1, diameter2, length, weight) {
      const newRecord = {
        id: Date.now().toString(),
        time: new Date().toLocaleString(),
        density,
        diameter1,
        diameter2,
        length,
        weight
      };
      
      records.unshift(newRecord); // 添加到数组开头
      saveRecords();
      updateRecordList();
      
      // 显示添加成功的提示
      const originalText = addRecordBtn.innerHTML;
      addRecordBtn.innerHTML = '<span class="material-icons">check</span>';
      setTimeout(() => {
        addRecordBtn.innerHTML = originalText;
      }, 1000);
    }
    
    function updateRecordList() {
      recordList.innerHTML = '';
      
      if (records.length === 0) {
        recordList.innerHTML = '<li style="text-align: center; padding: 16px;">暂无记录</li>';
        return;
      }
      
      records.forEach(record => {
        const li = document.createElement('li');
        li.className = 'record-item';
        li.dataset.id = record.id;
        
        // 多选框
        const checkbox = document.createElement('div');
        checkbox.className = 'record-checkbox';
        checkbox.innerHTML = '<span class="material-icons" style="font-size: 16px;">check</span>';
        if (isMultiSelectMode) {
          checkbox.classList.add('visible');
        }
        if (selectedRecords.includes(record.id)) {
          checkbox.classList.add('checked');
        }
        
        // 记录内容
        const content = document.createElement('div');
        content.className = 'record-content';
        content.innerHTML = `
          <div class="record-summary">
            <span>直径: ${record.diameter1.toFixed(2)}/${record.diameter2.toFixed(2)}mm</span>
            <span>重量: ${record.weight.toFixed(4)}kg</span>
          </div>
          <div class="record-summary">
            <span>长度: ${record.length.toFixed(2)}mm</span>
          </div>
          <div class="record-time">${record.time}</div>
        `;
        
        // 滑动操作按钮
        const slideActions = document.createElement('div');
        slideActions.className = 'slide-actions';
        slideActions.innerHTML = `
          <button class="slide-action edit" data-id="${record.id}">
            <span class="material-icons">edit</span>
          </button>
          <button class="slide-action delete" data-id="${record.id}">
            <span class="material-icons">delete</span>
          </button>
        `;
        
        li.appendChild(checkbox);
        li.appendChild(content);
        li.appendChild(slideActions);
        recordList.appendChild(li);
        
        // 添加事件监听
        setupRecordItemEvents(li);
      });
    }
    
    function setupRecordItemEvents(item) {
      const recordId = item.dataset.id;
      const checkbox = item.querySelector('.record-checkbox');
      const editBtn = item.querySelector('.slide-action.edit');
      const deleteBtn = item.querySelector('.slide-action.delete');
      
      // 点击记录项
      item.addEventListener('click', (e) => {
        // 如果点击的是操作按钮，不触发选择
        if (e.target.closest('.slide-action')) return;
        
        if (isMultiSelectMode) {
          // 在多选模式下点击记录项切换选择状态
          toggleRecordSelection(recordId);
        } else {
          // 非多选模式下点击查看详情
          showRecordDetail(recordId);
        }
      });
      
      // 编辑记录
      editBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        editRecord(recordId);
        resetSlideState();
      });
      
      // 删除记录
      deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        showConfirm('删除记录', '您确定要删除这条记录吗？', () => {
          deleteRecord(recordId);
        });
        resetSlideState();
      });
      
      // 滑动操作
      let startX, moveX, isSwiping = false;
      
      item.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        isSwiping = true;
      });
      
      item.addEventListener('touchmove', (e) => {
        if (!isSwiping) return;
        moveX = e.touches[0].clientX;
      });
      
      item.addEventListener('touchend', () => {
        if (!isSwiping || isMultiSelectMode) return;
        
        const diffX = startX - moveX;
        if (diffX > 50) { // 向左滑动超过50px
          resetSlideState();
          item.classList.add('slide-active');
        } else if (diffX < -30) { // 向右滑动超过30px
          item.classList.remove('slide-active');
        }
        
        isSwiping = false;
      });
      
      // 点击其他地方关闭滑动状态
      document.addEventListener('click', (e) => {
        if (!item.contains(e.target) && !e.target.closest('.slide-action') && !isMultiSelectMode) {
          item.classList.remove('slide-active');
        }
      });
    }
    
    function resetSlideState() {
      document.querySelectorAll('.record-item.slide-active').forEach(item => {
        item.classList.remove('slide-active');
      });
    }
    
    function showRecordDetail(recordId) {
      const record = records.find(r => r.id === recordId);
      if (!record) return;
      
      detailContent.innerHTML = `
        <div class="detail-grid">
          <div class="detail-item">
            <div class="detail-label">直径1 (mm)</div>
            <div class="detail-value">${record.diameter1.toFixed(2)}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">直径2 (mm)</div>
            <div class="detail-value">${record.diameter2.toFixed(2)}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">长度 (mm)</div>
            <div class="detail-value">${record.length.toFixed(2)}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">重量 (KG)</div>
            <div class="detail-value">${record.weight.toFixed(4)}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">密度系数</div>
            <div class="detail-value">${record.density.toFixed(5)}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">记录时间</div>
            <div class="detail-value">${record.time}</div>
          </div>
        </div>
      `;
      
      detailModal.classList.add('active');
    }
    
    function editRecord(recordId) {
      const record = records.find(r => r.id === recordId);
      if (!record) return;
      
      currentEditId = recordId;
      editRecordId.value = recordId;
      editDensity.value = record.density;
      editDiameter1.value = record.diameter1;
      editDiameter2.value = record.diameter2;
      editLength.value = record.length;
      editWeight.value = record.weight.toFixed(4);
      
      editModal.classList.add('active');
    }
    
    function saveEditedRecord() {
      if (!currentEditId) return;
      
      const index = records.findIndex(r => r.id === currentEditId);
      if (index === -1) return;
      
      const density = parseFloat(editDensity.value) || 0;
      const diameter1 = parseFloat(editDiameter1.value) || 0;
      const diameter2 = parseFloat(editDiameter2.value) || 0;
      const length = parseFloat(editLength.value) || 0;
      const avgDiameter = (diameter1 + diameter2) / 2;
      const weight = density * avgDiameter * avgDiameter * length / 1000;
      
      // 更新记录
      records[index] = {
        ...records[index],
        density,
        diameter1,
        diameter2,
        length,
        weight,
        time: new Date().toLocaleString() // 更新时间为编辑时间
      };
      
      saveRecords();
      updateRecordList();
      editModal.classList.remove('active');
      currentEditId = null;
    }
    
    function deleteRecord(recordId) {
      const initialLength = records.length;
      records = records.filter(r => r.id !== recordId);
      
      if (records.length < initialLength) {
        saveRecords();
        updateRecordList();
      }
    }
    
    function deleteAllRecords() {
      if (records.length === 0) return;
      
      showConfirm('删除所有记录', '您确定要删除所有记录吗？此操作不可恢复。', () => {
        records = [];
        saveRecords();
        updateRecordList();
        recordsModal.classList.remove('active');
      });
    }
    
    function showConfirm(title, message, action) {
      confirmTitle.textContent = title;
      confirmMessage.textContent = message;
      currentConfirmAction = action;
      confirmModal.classList.add('active');
    }
    
    // 导出为XLSX文件
    function exportRecords() {
      if (records.length === 0) {
        showConfirm('导出记录', '没有记录可导出', () => {});
        return;
      }
      
      // 准备导出的数据，合并直径并确保小值在前
      const exportData = records.map(record => {
        const minDiameter = Math.min(record.diameter1, record.diameter2);
        const maxDiameter = Math.max(record.diameter1, record.diameter2);
        return {
          '记录时间': record.time,
          '实际直径(mm)': `${minDiameter.toFixed(2)}-${maxDiameter.toFixed(2)}`,
          '长度(mm)': record.length.toFixed(2),
          '密度系数': record.density.toFixed(5),
          '重量(KG)': record.weight.toFixed(4)
        };
      });
      
      // 创建工作簿和工作表
      const worksheet = XLSX.utils.json_to_sheet(exportData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, '锻钢圆棒记录');
      
      // 导出文件
      const exportFileName = `锻钢圆棒记录_${new Date().toLocaleDateString()}.xlsx`;
      XLSX.writeFile(workbook, exportFileName);
    }
    
    // 导入XLSX文件
    function importRecords() {
      importFileInput.click();
    }
    
    function handleImportedFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          // 读取Excel文件
          const workbook = XLSX.read(e.target.result, { type: 'array' });
          
          // 获取第一个工作表
          const worksheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[worksheetName];
          
          // 转换为JSON
          const importedData = XLSX.utils.sheet_to_json(worksheet);
          
          if (!Array.isArray(importedData) || importedData.length === 0) {
            throw new Error('导入的文件中没有有效数据');
          }
          
          let newRecordsCount = 0;
          
          // 处理导入的数据
          importedData.forEach(item => {
            // 解析实际直径（支持两种格式：合并的和分开的）
            let diameter1 = 0, diameter2 = 0;
            const diameterStr = item['实际直径(mm)'] || item['直径1(mm)'];
            
            if (diameterStr && typeof diameterStr === 'string' && diameterStr.includes('-')) {
              // 处理合并格式：251-252.2
              const diameterParts = diameterStr.split('-').map(Number);
              if (diameterParts.length === 2 && !isNaN(diameterParts[0]) && !isNaN(diameterParts[1])) {
                diameter1 = diameterParts[0];
                diameter2 = diameterParts[1];
              }
            } else if (item['直径1(mm)'] && item['直径2(mm)']) {
              // 处理分开的格式
              diameter1 = parseFloat(item['直径1(mm)']) || 0;
              diameter2 = parseFloat(item['直径2(mm)']) || 0;
            } else if (!isNaN(parseFloat(diameterStr))) {
              // 如果只有一个直径值，两个直径都用这个值
              diameter1 = parseFloat(diameterStr) || 0;
              diameter2 = parseFloat(diameterStr) || 0;
            }
            
            // 解析其他字段
            const length = parseFloat(item['长度(mm)']) || 0;
            const density = parseFloat(item['密度系数']) || 0.00617; // 默认值
            const weight = parseFloat(item['重量(KG)']) || 0;
            const time = item['记录时间'] || new Date().toLocaleString();
            
            // 验证数据有效性
            if (diameter1 <= 0 && diameter2 <= 0) {
              console.warn('跳过无效记录：直径必须大于0', item);
              return;
            }
            
            if (length <= 0) {
              console.warn('跳过无效记录：长度必须大于0', item);
              return;
            }
            
            // 检查是否为重复记录
            const isDuplicate = records.some(record => 
              Math.abs(record.density - density) < 0.00001 &&
              Math.abs(record.diameter1 - diameter1) < 0.001 &&
              Math.abs(record.diameter2 - diameter2) < 0.001 &&
              Math.abs(record.length - length) < 0.001
            );
            
            if (!isDuplicate) {
              // 添加新记录
              records.unshift({
                id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                time,
                density,
                diameter1,
                diameter2,
                length,
                weight
              });
              newRecordsCount++;
            }
          });
          
          // 保存并更新列表
          if (newRecordsCount > 0) {
            saveRecords();
            updateRecordList();
            showConfirm('导入成功', `成功导入 ${newRecordsCount} 条新记录`, () => {});
          } else {
            showConfirm('导入结果', '没有找到新的有效记录或所有记录都已存在', () => {});
          }
          
        } catch (error) {
          console.error('导入失败', error);
          showConfirm('导入失败', `导入过程中出现错误: ${error.message}`, () => {});
        }
      };
      
      reader.readAsArrayBuffer(file);
      
      // 重置文件输入，以便可以重复选择同一个文件
      importFileInput.value = '';
    }
    
    // 多选功能
    function enterMultiSelectMode() {
      isMultiSelectMode = true;
      multiSelectToolbar.classList.add('active');
      selectedRecords = [];
      updateSelectedCount();
      updateRecordList(); // 刷新列表以显示复选框
    }
    
    function exitMultiSelectMode() {
      isMultiSelectMode = false;
      multiSelectToolbar.classList.remove('active');
      selectedRecords = [];
      updateSelectedCount();
      updateRecordList(); // 刷新列表以隐藏复选框
      resetSlideState();
    }
    
    function toggleRecordSelection(recordId) {
      const index = selectedRecords.indexOf(recordId);
      
      if (index === -1) {
        selectedRecords.push(recordId);
      } else {
        selectedRecords.splice(index, 1);
      }
      
      updateSelectedCount();
      updateRecordList(); // 刷新列表以更新复选框状态
    }
    
    function updateSelectedCount() {
      selectedCount.textContent = `已选择 ${selectedRecords.length} 项`;
    }
    
    function deleteSelectedRecords() {
      if (selectedRecords.length === 0) return;
      
      showConfirm('删除所选记录', `您确定要删除选中的 ${selectedRecords.length} 条记录吗？`, () => {
        records = records.filter(r => !selectedRecords.includes(r.id));
        saveRecords();
        updateRecordList();
        exitMultiSelectMode();
      });
    }
    
    // 事件监听
    densityEl.addEventListener('click', () => setActiveInput(densityEl));
    diameter1El.addEventListener('click', () => setActiveInput(diameter1El));
    diameter2El.addEventListener('click', () => setActiveInput(diameter2El));
    lengthEl.addEventListener('click', () => setActiveInput(lengthEl));
    
    deleteBtn.addEventListener('click', deleteNumber);
    clearBtn.addEventListener('click', clearInput);
    clearAllBtn.addEventListener('click', clearDiameterAndLength);
    themeToggle.addEventListener('click', toggleTheme);
    
    numButtons.forEach(btn => {
      btn.addEventListener('click', () => inputNumber(btn.dataset.num));
    });
    
    // 记录相关事件
    addRecordBtn.addEventListener('click', addRecord);
    showRecordsBtn.addEventListener('click', () => {
      recordsModal.classList.add('active');
      exitMultiSelectMode(); // 确保打开时不是多选模式
    });
    
    closeRecordsModal.addEventListener('click', () => {
      recordsModal.classList.remove('active');
      exitMultiSelectMode();
    });
    
    closeDetailModal.addEventListener('click', () => detailModal.classList.remove('active'));
    closeDetailBtn.addEventListener('click', () => detailModal.classList.remove('active'));
    
    closeEditModal.addEventListener('click', () => editModal.classList.remove('active'));
    cancelEditBtn.addEventListener('click', () => editModal.classList.remove('active'));
    saveEditBtn.addEventListener('click', saveEditedRecord);
    
    deleteAllRecordsBtn.addEventListener('click', deleteAllRecords);
    
    cancelConfirmBtn.addEventListener('click', () => confirmModal.classList.remove('active'));
    confirmActionBtn.addEventListener('click', () => {
      if (currentConfirmAction) {
        currentConfirmAction();
      }
      confirmModal.classList.remove('active');
      currentConfirmAction = null;
    });
    
    exportRecordsBtn.addEventListener('click', exportRecords);
    importRecordsBtn.addEventListener('click', importRecords);
    importFileInput.addEventListener('change', handleImportedFile);
    
    // 编辑框输入时重新计算重量
    editDensity.addEventListener('input', updateEditedWeight);
    editDiameter1.addEventListener('input', updateEditedWeight);
    editDiameter2.addEventListener('input', updateEditedWeight);
    editLength.addEventListener('input', updateEditedWeight);
    
    function updateEditedWeight() {
      const density = parseFloat(editDensity.value) || 0;
      const diameter1 = parseFloat(editDiameter1.value) || 0;
      const diameter2 = parseFloat(editDiameter2.value) || 0;
      const length = parseFloat(editLength.value) || 0;
      
      const avgDiameter = (diameter1 + diameter2) / 2;
      const weight = density * avgDiameter * avgDiameter * length / 1000;
      
      editWeight.value = weight.toFixed(4);
    }
    
    // 多选相关事件
    multiSelectBtn.addEventListener('click', enterMultiSelectMode);
    deleteSelectedBtn.addEventListener('click', deleteSelectedRecords);
    exitMultiSelectBtn.addEventListener('click', exitMultiSelectMode);
  </script>
</body>
</html>