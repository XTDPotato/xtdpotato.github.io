<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no,viewport-fit=cover">
	<title>圆棒入库数据管理</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Google+Sans+Text:wght@400;500&family=Google+Sans+Display:wght@400;500&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://unpkg.com/mdui@2/mdui.css">
	<script src="https://unpkg.com/mdui@2.0.3/mdui.global.js"></script>
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

 
	<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
	<style>
		/* 🎨 全局样式与黑暗模式 */
		:root {
		    --primary-color: #00796b;
		    --background-color: #f5f5f5;
		    --surface-color: #ffffff;
		    --text-color: #212121;
		    --border-color: #e0e0e0;
		    --drawer-icon-size: 24px;
		}

        /* 修复：确保背景色覆盖全屏，防止主题切换底部留白 */
        html {
            min-height: 100%;
            background-color: var(--background-color);
            transition: background-color 0.3s;
        }
		
		body.dark-mode {
		    --primary-color: #80cbc4; 
		    --background-color: #121212; 
		    --surface-color: #1e1e1e; 
		    --text-color: #ffffff;
		    --border-color: #333333;
		}
		
		body.mdui-theme-dark {
		    --mdui-theme-color-surface: var(--surface-color);
		    --mdui-theme-color-background: var(--background-color);
		    --mdui-theme-color-primary: var(--primary-color);
		    --mdui-top-app-bar-background-color: var(--surface-color);
		}
		
		.data-form input, .data-form select, .search-bar input {
		    background-color: var(--background-color);
		    color: var(--text-color);
		}
		
		.search-bar {
		    background-color: var(--background-color); 
		}
		
		body {
		    font-family: 'Roboto', 'Helvetica', 'Arial', sans-serif;
		    margin: 0;
		    padding-bottom: 80px; /* 预留空间 */
		    background-color: var(--background-color);
		    color: var(--text-color);
		    transition: background-color 0.3s, color 0.3s;
		}
		
		/* 🌟 顶部固定区域样式 🌟 */
		.top-fixed-area {
		    position: sticky;
		    top: 0;
		    z-index: 100;
		    background-color: var(--surface-color);
		    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		    padding: 8px 16px 0 16px;
		}
		
		.action-bar {
		    display: flex;
		    align-items: center; 
		    justify-content: flex-start;
		    gap: 8px;
		    flex-wrap: nowrap; 
		    background-color: var(--surface-color);
		    padding-bottom: 8px;
		}
		
		.search-bar {
		    display: flex;
		    align-items: center;
		    border-radius: 8px;
		    padding: 4px 8px;
		    flex-grow: 1;
		    width: 50%;
		    max-width: 400px;
		    border: 1px solid var(--border-color);
		}
		
		.search-bar input {
		    border: none;
		    outline: none;
		    background: none;
		    padding: 8px;
		    flex-grow: 1;
		    min-width: 0;
		}
		
		/* 搜索替换容器 - 紧凑布局，上下按钮紧贴右侧 */
		.search-replace-container {
		    background-color: var(--surface-color);
		    padding: 2px 2px 2px 2px !important; /* 改为2dp边距 */
		    box-sizing: border-box;
		    width: 100%;
		    max-width: 100%;
		    border-top: 1px solid var(--border-color);
		    margin: 0;
		}
		
		.search-replace-main {
		    display: flex;
		    flex-direction: column;
		    gap: 2px; /* 改为2dp间距 */
		}
		
		.search-replace-top-row {
		    display: flex;
		    align-items: center;
		    gap: 2px; /* 改为2dp间距 */
		    width: 100%; /* 确保行容器占满宽度 */
		}
		
		.search-replace-top-row input {
		    flex: none; /* 取消弹性伸缩，固定宽度 */
		    height: 40px;
		    max-height: 80px;
		    width: 80vw; 
		    max-width: 80vw; 
		    padding: 4px 4px; 
		    border: 1px solid var(--border-color);
		    border-radius: 8px;
		    background-color: var(--background-color);
		    color: var(--text-color);
		    font-size: 1rem;
		    min-width: 0;
		    box-sizing: border-box; /* 确保内边距不影响宽度计算 */
		}
		
		.search-replace-nav-buttons {
		    display: flex;
		    flex-direction: column;
		    gap: 2px; /* 改为2dp间距 */
		}
		
		/* 修复：限制搜索替换按钮宽度 */
		.search-replace-button-row {
		    display: flex;
		    gap: 2px; /* 改为2dp间距 */
		    justify-content: flex-start;
		    width: 100%; /* 占满父容器 */
		}
		
		#replaceOneBtn, #replaceAllBtn {
		    flex: 1; /* 按钮等分宽度 */
		    max-width: 200px; /* 限制最大宽度 */
		    min-width: 120px; /* 限制最小宽度 */
		    width: 100%;
		    padding: 2px; /* 按钮内边距改为2dp */
		    margin: 2px 0; /* 按钮上下边距改为2dp */
		}
		
		.search-replace-bottom-row {
		    display: flex;
		    justify-content: space-between;
		    align-items: center;
		    flex-wrap: wrap;
		    gap: 2px; /* 改为2dp间距 */
		    font-size: 0.9rem;
		    color: #757575;
		    padding: 2px 0; /* 上下内边距改为2dp */
		}
		
		@media (min-width: 600px) {
		    .search-replace-main { gap: 2px; } /* 保持2dp间距 */
		    .search-replace-top-row { gap: 2px; } /* 保持2dp间距 */
		    .search-replace-top-row input { 
		        border-radius: 8px 0 0 8px; 
		        width: 60vw; /* 大屏仍保持60%屏幕宽度 */
		    }
		    .search-replace-nav-buttons mdui-button-icon { 
		        border-radius: 0; 
		        margin: 2px 0; /* 按钮图标上下边距2dp */
		    }
		    .search-replace-nav-buttons mdui-button-icon:first-child { border-radius: 0 8px 0 0; }
		    .search-replace-nav-buttons mdui-button-icon:last-child { border-radius: 0 0 8px 0; }
		    .search-replace-bottom-row { flex-wrap: nowrap; }
		}
		
		.search-clear-btn {
		    display: none;
		    cursor: pointer;
		    color: #757575;
		    margin: 2px; /* 改为2dp边距 */
		}
		
		.search-clear-btn.active {
		    display: inline-block;
		}
		
		.batch-action-container {
		    width: 100%;
		    padding: 0 0 8px 0;
		    background-color: var(--surface-color);
		    margin-top: -1px; 
		}
		
		/* 底部常驻信息栏 */
		.bottom-data-summary {
		    position: fixed;
		    bottom: 0;
		    left: 0;
		    right: 0;
		    padding: 10px 16px;
		    background-color: var(--surface-color);
		    color: #757575;
		    font-size: 0.9rem;
		    z-index: 900;
		    box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.08);
		    border-top: 1px solid var(--border-color);
		   
		    display: flex;
		    flex-direction: column;
		    gap: 8px;
		    align-items: center;
		}
		
		.bottom-summary-content {
		    display: flex;
		    justify-content: space-between;
		    align-items: center;
		    width: 100%;
		    flex-wrap: wrap;
		    gap: 12px;
		}
		
		.bottom-summary-left {
		    font-weight: 500;
		}
		
		.bottom-summary-right {
		    display: flex;
		    align-items: center;
		    gap: 12px;
		    flex-shrink: 0;
		}
		
		.page-info-container {
		    display: flex;
		    align-items: center;
		    gap: 6px;
		}
		
		.page-info-text {
		    cursor: pointer;
		    user-select: none;
		    white-space: nowrap;
		}
		
		.page-input {
		    width: 60px;
		    padding: 4px 8px;
		    font-size: 0.9rem;
		    border: 1px solid var(--border-color);
		    border-radius: 4px;
		    text-align: center;
		    background-color: var(--background-color);
		    color: var(--text-color);
		    display: none;
		}
		
		
		
		.dark-mode .bottom-data-summary {
		    background-color: rgba(30, 30, 30, 0.95);
		}
		
		@media (min-width: 600px) {
		    .bottom-data-summary {
		        flex-direction: row;
		        padding: 10px 24px;
		    }
		    .bottom-summary-content {
		        flex-wrap: nowrap;
		    }
		    .bottom-summary-right {
		        gap: 16px;
		    }
		}
		
		/* 表单输入框样式 */
		.data-form {
		    padding: 16px;
		    max-width: 100%; /* 修复：防止表单溢出 */
		    box-sizing: border-box;
		    overflow-x: hidden; /* 隐藏横向溢出 */
		}
		
		.data-form input, .data-form select {
		    width: 100%;
		    padding: 10px;
		    margin-bottom: 12px;
		    border: 1px solid var(--border-color);
		    border-radius: 4px;
		    box-sizing: border-box;
		    max-width: 100% !important; /* 修复：限制输入框最大宽度 */
		}
		
		/* 修复：备注文本框宽度溢出问题 */
		#remarks {
		    height: 200px; 
		    font-size: 16px; 
		    width: 100% !important; /* 强制100%宽度 */
		    max-width: 100%; /* 限制最大宽度 */
		    box-sizing: border-box; /* 包含内边距/边框 */
		    padding: 10px; /* 统一内边距 */
		}
		
		.data-form label {
		    display: block;
		    margin-bottom: 4px;
		    font-size: 0.9rem;
		    color: #757575;
		}
		
		.readonly-input {
		     cursor: pointer !important;
		     background-color: #e0e0e0 !important;
		}
		
		.dark-mode .readonly-input {
		     background-color: #333333 !important;
		}
		
		/* 修复空状态元素占位和越界问题 */
		.empty-state {
		    text-align: center;
		    padding: 50px 20px; 
		    color: #757575;
		    position: absolute; 
		    top: 0; 
		    left: 0;
		    width: 100%; 
		    height: 100%;
		    display: none;
		    z-index: 50;
		    background-color: var(--background-color);
		    box-sizing: border-box;
		}
		
		.empty-state p {
		    word-break: break-word; 
		    overflow-wrap: break-word; 
		    max-width: 90%; 
		    margin: 10px auto 0 auto;
		}
		
		/* 虚拟键盘样式 */
		#virtualKeyboard {
		    position: fixed;
		    bottom: 0; 
		    padding-bottom: 2px;
		    left: 0;
		    width: 100%;
		    background-color: var(--surface-color);
		    border-top: 1px solid var(--border-color);
		    box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
		    z-index: 10000; /* Ensure it is above MDUI dialogs */
		    display: none;
		    box-sizing: border-box;
		}
		
		.keyboard-row {
		    display: flex;
		    padding: 0; /* Remove padding completely to eliminate dead zones */
		    justify-content: center;
		    margin: 0;
		    gap: 0; /* No gap */
		    width: 100%; /* Stretch full width */
		}
		
		.keyboard-key {
		    /* Make container transparent and full size */
		    background-color: transparent; 
		    color: var(--text-color);
		    flex: 1 1 0;
		    min-width: 0;
		    /* Remove padding/margin that causes dead space */
		    padding: 0; 
		    margin: 0;
		    border-radius: 0;
		    box-shadow: none;
		    
		    /* Height control - reduced */
		    height: 40px; 
		    
		    text-align: center;
		    font-size: 16px;
		    cursor: pointer;
		    user-select: none;
		    
		    display: flex;
		    align-items: center;
		    justify-content: center;
		    
		    position: relative;
		    z-index: 1; /* Ensure text is above background */
		}
		
		/* The visual key background */
		.keyboard-key::before {
		    content: '';
		    position: absolute;
		    /* Create the visual gap here - clickable area is full */
		    top: 2px;
		    bottom: 2px;
		    left: 2px;
		    right: 2px;
		    
		    background-color: var(--background-color);
		    border-radius: 4px; /* Slightly smaller radius */
		    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
		    transition: background-color 0.1s, transform 0.1s;
		    z-index: -1; /* Behind text */
		}
		
		.keyboard-key:active {
		    color: #ffffff;
		    /* Remove transform from container so it doesn't shrink click area */
		    transform: none; 
		}
		
		.keyboard-key:active::before {
		    background-color: var(--primary-color);
		    transform: scale(0.95);
		}
		
		.special {
		    /* Reset container style just in case */
		    background-color: transparent;
		    color: #212121;
		}
		
		.special::before {
		    background-color: #bdbdbd;
		}
		
		.dark-mode .special {
		    background-color: transparent;
		    color: #ffffff;
		}
		
		.dark-mode .special::before {
		    background-color: #424242;
		}
		
		.wide { flex: 1.6 1 0; }
		.extra-wide { flex: 3 1 0; }
		
		.keyboard-key.empty {
		    cursor: default;
		    /* Empty keys also transparent */
		}
		
		.keyboard-key.empty::before {
		    background: none;
		    box-shadow: none;
		}
		
		.clear-key { color: white !important; background-color: transparent !important; }
		.clear-key::before { background-color: #f44336 !important; }
		
		.system-keyboard { color: white !important; background-color: transparent !important; }
		.system-keyboard::before { background-color: #2196f3 !important; }
		
		#shortcutContainer {
		    padding: 0;
		    height: 44px; /* Fixed height for shortcuts */
		    border-bottom: 1px solid var(--border-color);
		    margin-bottom: 0;
		    overflow-x: auto;
		    white-space: nowrap;
		    display: flex;
		    align-items: center;
		}
		
		#shortcutContainer .keyboard-row {
		    flex-wrap: nowrap;
		    justify-content: flex-start;
		    gap: 0; 
		    padding: 0;
		    width: auto; /* Let it grow naturally */
		}
		
		/* Shortcut keys specific styles */
		.shortcut-key, .status-key {
		    /* Override default keyboard key styles for shortcuts */
		    flex: none; /* Don't stretch */
		    width: auto;
		    min-width: 40px;
		    height: 40px; /* Match container height */
		    padding: 0 12px; /* Add horizontal padding for adaptive text width */
		}
		
		/* Shortcut visuals */
		.shortcut-key::before, .status-key::before {
		    top: 4px;
		    bottom: 4px;
		    left: 4px;
		    right: 4px;
		    border-radius: 16px; /* Pill shape for shortcuts */
		}
		
		
		/* 父容器：固定高度 + 底部固定 80px 留白 */
	/* 滚动容器：必须有 overflow: auto / scroll */
.data-table-container-div {
    overflow: auto;
    height: calc(100vh - 200px);  /* 根据你的布局调整 */
    position: relative;
    -webkit-overflow-scrolling: touch;  /* iOS 平滑滚动 */
}

/* 表头冻结：核心 */
#dataTable thead th {
    position: sticky;
    top: 0;
    z-index: 100;  /* 必须大于其他元素，确保不被盖住 */
    background-color: var(--surface-color);  /* 背景色防止透明 */
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);  /* 可选：加阴影增加立体感 */
}

/* 增强：表头第一行整体背景（防列错位） */
#dataTable thead {
    background-color: var(--surface-color);
    position: sticky;
    top: 0;
    z-index: 99;
}

/* 防止 transform 干扰（如果还有缩放需求） */
.data-table-container-div table {
    transform: none !important;  /* 强制移除可能残留的 transform */
}
		
		/* 子容器：宽度/高度实时随 scale 变化（关键！） */
		.data-table-container {
		    width: max-content;                     /* 初始 = 内容总宽 */
		    height: auto;
		    min-height: 100%;                       /* 至少撑满高度 */
		    transform-origin: top left;
		    will-change: transform, width, height;
		    transition: transform 0.12s ease-out, width 0.12s ease-out, height 0.12s ease-out;
		}
		
		/* 表格：严格跟随内容宽度 */
		#dataTable {
		    width: max-content !important;
		    min-width: max-content;
		    table-layout: auto;
		    border-collapse: collapse;
		}
		
	
		
		/* 其他单元格、选中、高亮等样式保持不变 */
		#dataTable th, #dataTable td {
		    padding: 12px 8px;
		    border: 1px solid var(--border-color);
		    text-align: center;
		    white-space: normal;
		    word-break: break-word;
		    font-size: 1rem;
		    min-width: 80px;
		    overflow: visible;
		}
		
		.action-col   { min-width: 100px; width: 100px; max-width: 100px; }
		.seq-col      { min-width: 60px; width: 60px; position: relative; }
		.checkbox-col { min-width: 50px; width: 50px; }
		.remark-col   { min-width: 150px; }
		
		.delete-btn { color: #f44336; }
		.selected { background-color: rgba(0,121,107,0.1) !important; }
		.dark-mode .selected { background-color: rgba(128,203,196,0.2) !important; }
		.highlight { background-color: rgba(255,193,7,0.3) !important; transition: background-color 0.5s ease-out; }
		
		.empty-state {
		    position: absolute;
		    inset: 0;
		    display: none;
		    flex-direction: column;
		    align-items: center;
		    justify-content: center;
		    background: var(--background-color);
		    z-index: 10;
		    color: #757575;
		}
		
		
		
		/* 搜索替换高亮 */
		.search-match-highlight {
		    background-color: #ffc107; 
		    font-weight: bold;
		    color: #212121;
		}
		.dark-mode .search-match-highlight {
		    background-color: #ffd54f; 
		    color: #212121;
		}
		.current-match-highlight {
		    outline: 2px solid var(--primary-color);
		    outline-offset: -2px;
		}
		
		/* 移动按钮 */
		/* 表格行移动按钮样式优化 */
.move-buttons {
  display: flex;
  flex-direction: column;
  gap: 2px;
  margin-left: 8px;
}
/* 手机+电脑 移动按钮样式 + 弹窗选中高亮样式 (必加) */
.move-btn {
  -webkit-tap-highlight-color: transparent !important;
  touch-action: manipulation !important;
  pointer-events: auto !important;
  cursor: pointer !important;
  user-select: none !important;
  border: none;
  background: #e0e0e0;
  border-radius: 2px;
	padding: 2px 4px;
}
.move-btn:hover {background: #2196f3;color: white;}
.move-btn:disabled {
  pointer-events: none !important;
  cursor: not-allowed !important;
  opacity: 0.5;
  background: #f5f5f5;
}
/* ✅ 弹窗选项-选中高亮样式（醒目，必生效） */
.row-option-item {
  -webkit-tap-highlight-color: transparent !important;
  touch-action: manipulation !important;
  user-select: none !important;
  pointer-events: auto !important;
  cursor: pointer !important;
}
.row-option-item:hover {
  background: #f0f7ff !important;
  color: #333 !important;
}
/* 选中后的高亮样式，背景色用你的主题色，白色文字，超级醒目 */
.row-option-item:active, .row-option-item:focus {
  background: var(--primary-color) !important;
  color: #ffffff !important;
}
		#dataTable td, #dataTable th { position: relative; }
		
		/* 自定义 Modal/Sheet 样式 */
		.modal-custom {
		    display: none; 
		    position: fixed;
		    top: 0; left: 0;
		    width: 100%; height: 100%;
		    background-color: rgba(0, 0, 0, 0.4);
		    z-index: 1050; 
		}
		
		.modal-content-custom {
		    background-color: var(--surface-color);
		    margin: 15% auto; 
		    padding: 0;
		    border-radius: 8px;
		    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
		    width: 90%; 
		    max-width: 500px; 
		    display: flex;
		    flex-direction: column;
		    max-height: 90vh; 
		    overflow: hidden;
		}
		
		.full-height-custom .modal-content-custom {
		    width: 100%;
		    max-width: 100%;
		    height: 100%;
		    margin: 0;
		    border-radius: 0; 
		}
		
		.modal-header-custom {
		    display: flex;
		    align-items: center;
		    justify-content: space-between;
		    padding: 0 16px;
		    height: 56px;
		    border-bottom: 1px solid var(--border-color);
		    position: sticky; 
		    top: 0; 
		    background-color: var(--surface-color);
		    z-index: 10;
		    flex-shrink: 0;
		}
		
		.modal-header-custom h2 {
		    margin: 0;
		    font-size: 1.1rem;
		    font-weight: 500;
		}
		
		.modal-body-custom {
		    padding: 16px; 
		    overflow-y: auto; 
		    flex-grow: 1; 
		    box-sizing: border-box;
		    padding-bottom: 80px !important; 
		    margin-bottom: -64px;
		}
		
		.full-height-custom .modal-body-custom {
		    max-height: calc(100vh - 56px - 80px); 
		    height: calc(100vh - 56px - 80px);
		    padding: 0; 
		    box-sizing: border-box;
		    padding-bottom: 80px !important;
		}
		
		#calculatorModalCustom .modal-body-custom {
		    max-height: calc(100vh - 370px); 
		    height: auto;
		    overflow-y: auto; 
		    padding: 0; 
		}
		
		/* 防止 dropdown 菜单被 modal 裁剪 */
		#sortModalCustom mdui-select::part(menu) {
		    max-height: 300px !important;
		    overflow-y: auto;
		}
		
		.modal-footer-custom {
		    padding: 16px 16px 24px 16px;
		    display: flex; 
		    justify-content: flex-end; 
		    gap: 12px;
		    position: sticky; 
		    bottom: 0; 
		    background-color: var(--surface-color); 
		    z-index: 10;
		    box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.08);
		    border-top: 1px solid var(--border-color);
		    box-sizing: border-box;
		    flex-shrink: 0; 
		    align-items: center;
		}
		
		.modal-custom:not(.full-height-custom) .modal-content-custom {
		    position: absolute; 
		    top: 50%;
		    left: 50%;
		    transform: translate(-50%, -50%);
		    width: 90%; 
		    max-width: 450px;
		    max-height: 90vh;
		}
		
		/* 排序规则项样式 */
#sortRulesContainer .sort-rule {
    background-color: var(--background-color);
    padding: 6px 14px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

/* Quick Edit Dialog Top Positioning */
.quick-edit-dialog-top::part(panel) {
    align-self: center; /* Center horizontally */
    margin-top: 48px;
    margin-bottom: auto; /* Push to top */
    margin-left: auto;
    margin-right: auto;
}
		
		#sortRulesContainer mdui-button-icon[icon="delete"] {
		    color: #f44336;
		}
		
		#confirmModalCustom .modal-body-custom { padding: 16px; }
		
		/* 重复数据确认模态框 */
		#duplicateConfirmationModalCustom .modal-body-custom {
		    max-height: calc(100vh - 56px - 64px); 
		    padding: 16px;
		    overflow-y: auto;
		}
		
		.duplicate-item {
		    border: 1px solid var(--border-color);
		    padding: 10px;
		    margin-bottom: 10px;
		    border-radius: 4px;
		    background-color: var(--background-color);
		}
		.dark-mode .duplicate-item { background-color: #282828; }
		
		.duplicate-actions label { margin-right: 15px; font-size: 0.9rem; }
		
		.duplicate-item table { width: 100%; margin: 10px 0 15px; border-collapse: collapse; }
		.duplicate-item table th, .duplicate-item table td { padding: 8px; border: 1px solid var(--border-color); text-align: center; }
		.duplicate-item table th { background-color: var(--surface-color); }
		
		#drawerList mdui-icon { font-size: var(--drawer-icon-size); }
		
		.checkbox-col {
		    display: flex;
		    align-items: center;
		    justify-content: center;
		    padding: 0 !important; 
		}
		
		.checkbox-col > mdui-checkbox {
		    margin: 0; 
		    padding: 12px 8px; 
		}
		
		.top-action-buttons {
		    display: flex;
		    gap: 8px;
		    align-items: center;
		    flex-shrink: 0; 
		}
		
		/* 顶部菜单开关样式适配 */
		#filterMatchRowsMenuItem {
		    display: none; /* 默认隐藏，搜索替换激活时显示 */
		    align-items: center;
		    justify-content: space-between;
		    padding: 0 16px;
		}
		
		#mainFab {
		    position: fixed;
		    right: 16px;
		    bottom: 76px; /* 避开底部常驻栏 */
		    z-index: 1000; 
		}
		
		/* 快速编辑弹窗 */
		#quickEditDialog .modal-content-custom {
		    max-width: 400px;
		    top: 30%; 
		    transform: translate(-50%, -50%); 
		}
		
		#quickEditDialog .modal-body-custom { padding: 20px; }
		
		#quickEditDialog label {
		    display: block;
		    margin-bottom: 8px;
		    font-weight: 500;
		    color: var(--primary-color);
		}
		
		#quickEditInput {
		    font-size: 1.2rem;
		    padding: 12px;
		    border: 2px solid var(--primary-color);
		    border-radius: 4px;
		    width: 100%;
		    box-sizing: border-box;
		    background-color: var(--background-color);
		    color: var(--text-color);
		}
		
		
		.image-col {
		    min-width: 100px;
		    width: 100px;
		    max-width: 100px;
		    height: 80px;
		    padding: 0 !important;
		    vertical-align: middle;
		}
		
		.image-col > div {
		    width: 100%;
		    height: 100%;
		}
		
		/* === 强制全局使用 Google Sans === */
		*,
		*::before,
		*::after,
		body, input, button, textarea, select,
		.mdui-typography,
		.mdui-button,
		.mdui-list-item,
		.mdui-top-app-bar,
		.mdui-dialog,
		.mdui-text-field-input,
		#dataTable,
		#dataTable th,
		#dataTable td,
		.data-form input,
		.data-form select,
		.virtualKeyboard * {
		    font-family: 'Google Sans Text', 'Google Sans Display', system-ui, -apple-system, sans-serif !important;
		}
		
		/* 加粗文字使用 Medium 字重 */
		h1, h2, h3, h4, h5, h6,
		.mdui-top-app-bar-title,
		.mdui-button,
		.mdui-list-item-headline,
		.mdui-dialog-headline {
		    font-family: 'Google Sans Text', 'Google Sans Display', system-ui, sans-serif !important;
		    font-weight: 500 !important;
		}
		
		/* 虚拟键盘键也强制使用 */
		.keyboard-key {
		    font-family: 'Google Sans Text', system-ui, sans-serif !important;
		    font-weight: 500 !important;
		}
		
		/* === 终极修复：保护 Material Icons 不被覆盖 === */
		/* 1. 最高优先级兜底 */
		#app mdui-button .mdui-icon,
		body mdui-button .mdui-icon {
		    font-family: 'Material Icons' !important;
		    font-weight: normal !important;
		    font-style: normal !important;
		}
		
		/* 2. 覆盖所有 mdui 图标元素 */
		.mdui-icon,
		.material-icons,
		.mdui-icon--material,
		[mdui-icon],
		mdui-icon {
		    font-family: 'Material Icons' !important;
		    font-weight: 400 !important;
		    font-style: normal !important;
		    letter-spacing: normal;
		    text-transform: none;
		    display: inline-block;
		    white-space: nowrap;
		    word-wrap: normal;
		    direction: ltr;
		    -webkit-font-feature-settings: 'liga';
		    -webkit-font-smoothing: antialiased;
		}
		
		/* 3. 明确针对所有变体按钮的图标 */
		mdui-button[variant="elevated"] .mdui-icon,
		mdui-button[variant="filled"] .mdui-icon,
		mdui-button[variant="tonal"] .mdui-icon,
		mdui-button[variant="outlined"] .mdui-icon,
		mdui-button[variant="text"] .mdui-icon,
		mdui-button > mdui-icon,
		mdui-button > span[class*="material-icons"],
		mdui-button > i[class*="material-icons"] {
		    font-family: 'Material Icons' !important;
		    font-weight: normal !important;
		}
		
		/* 4. 修复 mdui 组件内置图标样式被覆盖 */
		:host(mdui-button) .mdui-icon,
		mdui-button::part(icon),
		mdui-icon::part(root) {
		    font-family: 'Material Icons' !important;
		}
		
		
	</style>
<body>
	<mdui-navigation-drawer id="drawer" close-on-overlay-click placement="left" close-on-esc>
		<mdui-top-app-bar slot="header">
			<mdui-top-app-bar-title>功能菜单</mdui-top-app-bar-title>
		</mdui-top-app-bar>
		<mdui-list id="drawerList">
			<mdui-collapse>
				<mdui-collapse-item id="themeCollapse">
					<mdui-list-item slot="header" icon="dark_mode" headline="主题模式 (当前: 自动)"></mdui-list-item>
					<mdui-list id="themeCollapseContent">
						<mdui-list-item class="theme-option" data-theme="auto" icon="brightness_auto" headline="自动 (跟随系统)"></mdui-list-item>
						<mdui-list-item class="theme-option" data-theme="light" icon="light_mode" headline="日间模式"></mdui-list-item>
						<mdui-list-item class="theme-option" data-theme="dark" icon="dark_mode" headline="夜间模式"></mdui-list-item>
					</mdui-list>
				</mdui-collapse-item>
			</mdui-collapse>
			<mdui-divider></mdui-divider>
			<mdui-list-item id="importItem" icon="file_upload" rounded headline="导入 Excel"></mdui-list-item>
			<mdui-list-item id="exportItem" icon="file_download" rounded headline="导出 Excel"></mdui-list-item>
			<mdui-list-item id="calculatorBtn" icon="calculate" rounded headline="计算重量"></mdui-list-item>
		
			<mdui-list-item id="sortItem" icon="sort" rounded headline="数据排序"></mdui-list-item>
			
			<mdui-list-item id="openKeyboardSettingsBtn" rounded icon="keyboard" headline="虚拟键盘设置"></mdui-list-item>
		</mdui-list>
	</mdui-navigation-drawer>
	<div class="top-fixed-area">
		<div class="action-bar">
			<mdui-button-icon icon="menu" id="openDrawerBtn"></mdui-button-icon>
			<div class="search-bar">
				<span class="material-icons" style="color:#757575;">search</span>
				<input type="text" id="searchInput" placeholder="搜索所有字段...">
				<span class="material-icons search-clear-btn" id="searchClearBtn">clear</span>
			</div>
			<div class="top-action-buttons">
			<mdui-tooltip content="替换">
				<mdui-button-icon icon="find_replace" id="toggleSearchReplaceBtn" style="margin-right: -8px;"></mdui-button-icon>
			</mdui-tooltip>
				<mdui-dropdown placement="bottom-end">
					<mdui-button-icon slot="trigger" icon="more_vert" id="topMenuBtn"></mdui-button-icon>
					<mdui-menu>
						<mdui-menu-item id="multiSelectMenuItem" icon="check_box_outline_blank">
							<span id="multiSelectMenuText">进入多选模式</span>
						</mdui-menu-item>
						<!-- 新增：只显示匹配行开关（移至顶部菜单） -->
						<mdui-menu-item id="filterMatchRowsMenuItem" style="text-align: center;display: flex; align-items: center; justify-content: space-between;">
							<span>只显示匹配行</span>
							<mdui-switch id="filterMatchRowsSwitch"></mdui-switch>
						</mdui-menu-item>
						<mdui-menu-item id="aboutItem" icon="info">关于</mdui-menu-item>
					</mdui-menu>
				</mdui-dropdown>
			</div>
		</div>
		<div class="search-replace-container" id="searchReplaceContainer" style="display: none;">
			<div class="search-replace-main">
				<div class="search-replace-top-row">
					<input type="text" id="replaceQuery" placeholder="替换为">
					<div class="search-replace-nav-buttons">
					<mdui-tooltip content="上一个">
						<mdui-button-icon icon="arrow_upward" id="prevMatchBtn"></mdui-button-icon>
						</mdui-tooltip>
						<mdui-tooltip content="下一个">
						<mdui-button-icon icon="arrow_downward" id="nextMatchBtn"></mdui-button-icon>
						</mdui-tooltip>
					</div>
				</div>
				<div class="search-replace-button-row">
					<mdui-button variant="filled" id="replaceOneBtn" disabled>替换当前</mdui-button>
					<mdui-button variant="outlined" id="replaceAllBtn" color="error" disabled>替换全部</mdui-button>
				</div>
				<div class="search-replace-bottom-row">
					<span id="searchResultCount">找到 0 个匹配项</span>
					<!-- 已删除：原位置的 filterMatchRowsSwitch 开关 -->
				</div>
			</div>
		</div>
		<div class="batch-action-container">
			<mdui-button variant="outlined" color="error" id="deleteSelectedBtn" style="display: none; width: 100%;">
				<mdui-icon name="delete"></mdui-icon> 批量删除 (<span id="selectedCount">0</span>) </mdui-button>
		</div>
	</div>
	<div class="data-table-container-div">
		<div class="data-table-container">
			<table id="dataTable">
				<thead>
					<tr>
						<th class="seq-col">序号</th>
						<th class="checkbox-col" style="display: none;">
							<mdui-checkbox id="selectAllCheckbox">全选</mdui-checkbox>
						</th>
						<th>钢种</th>
						<th>产品号</th>
						<th>卡片号</th>
						<th>炉号</th>
						<th>实际直径</th>
						<th>直径</th>
						<th>长度</th>
						<th>重量</th>
						<th>状态</th>
						<th>位置</th>
						<th>硬度</th>
						<th class="remark-col">备注</th>
						<th class="image-col">卡片图片</th>
						<th class="action-col">操作</th>
					</tr>
				</thead>
				<tbody id="tableBody"></tbody>
			</table>
		</div>
		<div class="bottom-data-summary">
			<div class="bottom-summary-content">
				<div class="bottom-summary-left" id="totalCountText">共 0 条数据</div>
				<div class="bottom-summary-right">
					<div class="page-info-container">
						<span class="page-info-text" id="pageInfoText">第 1 / 1 页</span>
						<input type="number" class="page-input" id="pageJumpInput" min="1" value="1">
					</div>
					<div style="display: flex; gap: 8px;">
						<mdui-button-icon icon="navigate_before" id="bottomPrevBtn"></mdui-button-icon>
						<mdui-button-icon icon="navigate_next" id="bottomNextBtn"></mdui-button-icon>
					</div>
				</div>
			</div>
		</div>
		<div class="empty-state" id="emptyState">
			<span class="material-icons" style="font-size: 48px;margin-Top: 120px">inbox</span>
			<p>暂无数据，点击右下角“添加”按钮开始录入。</p>
		</div>
	</div>
	<input type="file" id="fileInput" accept=".xlsx,.xls,.zip,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/zip" style="display:none;">
	<!-- 添加/编辑数据弹窗 -->
	<div id="dataSheetCustom" class="modal-custom full-height-custom">
		<div class="modal-content-custom">
			<div id="dataSheetHeader" class="modal-header-custom">
				<h2 id="modalTitle">添加数据</h2>
				<mdui-button-icon icon="close" id="closeDataModal"></mdui-button-icon>
			</div>
			<div id="dataSheetContent" class="modal-body-custom">
				<form id="dataForm" class="data-form">
					<input type="hidden" id="editIndex" value="-1">
					<label for="steelType">钢种</label>
					<input type="text" id="steelType" class="readonly-input">
					<label for="productId">产品号</label>
					<input type="text" id="productId" class="readonly-input">
					<label for="cardId">卡片号</label>
					<input type="text" id="cardId" class="readonly-input">
					<label for="furnaceId">炉号</label>
					<input type="text" id="furnaceId" class="readonly-input">
					<mdui-divider style="margin-bottom:10px"></mdui-divider>
					<label for="actualDiameter">实际直径</label>
					<input type="text" id="actualDiameter" class="numeric-input readonly-input">
					<label for="diameter">直径</label>
					<input type="text" id="diameter" class="numeric-input readonly-input">
					<label for="length">长度</label>
					<input type="text" id="length" class="numeric-input readonly-input">
					<label for="weight">重量</label>
					<input type="text" id="weight" class="numeric-input readonly-input">
					<mdui-divider style="margin-bottom:10px"></mdui-divider>
					<label for="status">状态</label>
					<input type="text" id="status" class="readonly-input">
					<label for="position">位置</label>
					<input type="text" id="position" class="readonly-input">
					<label for="hardness">硬度</label>
					<input type="text" id="hardness" class="numeric-input readonly-input">
					<label for="remarks">备注</label>
					<textarea rows="5" cols="30" id="remarks"></textarea>
					<!-- 图片上传与管理区域 -->
					<mdui-divider style="margin:20px 0 10px 0"></mdui-divider>
					<div style="text-align:center;margin-bottom:16px;">
						<label style="font-weight:500;color:var(--primary-color);font-size:1.1rem;">卡片图片（可选）</label>
					</div>
					<!-- 有图片时的预览 + 三个按钮 -->
					<div id="cardImagePreview" style="text-align:center;margin-bottom:20px;display:none;">
						<img id="previewImg" style="max-height:300px;max-width:100%;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.2);cursor:pointer;" onclick="showFullImage(this.src)">
						<div style="margin-top:16px;display:flex;justify-content:center;gap:12px;flex-wrap:wrap;">
							<mdui-button variant="tonal" id="takePhotoInEditBtn">
								<mdui-icon name="photo_camera"></mdui-icon> 拍照 </mdui-button>
							<mdui-button variant="tonal" id="selectFromGalleryInEditBtn">
								<mdui-icon name="photo_library"></mdui-icon> 从相册选择 </mdui-button>
							<mdui-button variant="outlined" color="error" id="deleteImageInEditBtn">
								<mdui-icon name="delete"></mdui-icon> 删除图片 </mdui-button>
						</div>
					</div>
					<!-- 无图片时的上传区域（只有两个按钮） -->
					<div id="noImageUploadArea" style="text-align:center;">
						<input type="file" id="cardImageInput" accept="image/*" style="display:none;">
						<div id="dragDropArea" style="border:2px dashed var(--border-color);border-radius:12px;padding:40px;margin:20px;background:var(--background-color);cursor:pointer;transition:background 0.3s;">
							<mdui-icon name="cloud_upload" style="font-size:48px;color:var(--primary-color);opacity:0.6;display:block;margin-bottom:16px;"></mdui-icon>
							<div style="font-size:1.1rem;color:var(--text-color);">点击下方按钮或拖拽图片到此处</div>
							<div style="font-size:0.9rem;color:#757575;margin-top:8px;">支持拍照、相册选择、文件拖入</div>
						</div>
						<div style="display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin-top:16px;">
							<mdui-button variant="tonal" id="takePhotoBtn">
								<mdui-icon name="photo_camera"></mdui-icon> 拍照 </mdui-button>
							<mdui-button variant="tonal" id="selectFromGalleryBtn">
								<mdui-icon name="photo_library"></mdui-icon> 从相册选择 </mdui-button>
						</div>
					</div>
				</form>
			</div>
			<div id="dataSheetFooter" class="modal-footer-custom">
				<mdui-button variant="text" id="cancelBtn">取消</mdui-button>
				<mdui-button variant="filled" id="saveBtn">保存</mdui-button>
			</div>
		</div>
	</div>
	<!-- 快速编辑弹窗 (Top Aligned) -->
	<mdui-dialog id="quickEditDialog" close-on-esc close-on-overlay-click class="quick-edit-dialog-top">
		
		<mdui-top-app-bar slot="header" style="padding: 16px;">
            <mdui-top-app-bar-title id="quickEditLabel" style="color:var(--primary-color);"></mdui-top-app-bar-title>
            <mdui-button-icon icon="close" id="closeQuickEdit"></mdui-button-icon>
        </mdui-top-app-bar>
	
		
		<div style="padding: 16px; margin-top: 8px;">
			
			<input type="text" id="quickEditInput" class="readonly-input" style="width:100%; padding:12px; font-size:1.2rem; border:2px solid var(--primary-color); border-radius:4px; box-sizing:border-box; background:var(--surface-color); color:var(--text-color);">
			<input type="hidden" id="quickEditIndex">
			<input type="hidden" id="quickEditField">
		</div>
		<div slot="action">
			<mdui-button variant="text" id="openFullEditBtn">完整编辑</mdui-button>
			<mdui-button variant="filled" id="saveQuickEditBtn">保存</mdui-button>
		</div>
	</mdui-dialog>
	<!-- 虚拟键盘 -->
	<div id="virtualKeyboard">
		<div id="shortcutContainer"></div>
		<div id="keyboardRows"></div>
	</div>
	<!-- 确认弹窗 -->
	<div id="confirmModalCustom" class="modal-custom full-height-custom">
		<div class="modal-content-custom">
			<div class="modal-header-custom">
				<h2 class="modal-title">操作确认</h2>
				<mdui-button-icon icon="close" id="closeConfirmModal"></mdui-button-icon>
			</div>
			<div class="modal-body-custom">
				<div id="confirmMessage"></div>
			</div>
			<div class="modal-footer-custom">
				<mdui-button variant="text" id="cancelConfirmBtn">取消</mdui-button>
				<mdui-button variant="filled" color="error" id="confirmActionBtn">确定</mdui-button>
			</div>
		</div>
	</div>
	<!-- 重量计算弹窗 -->
	<div id="calculatorModalCustom" class="modal-custom full-height-custom">
		<div class="modal-content-custom">
			<div class="modal-header-custom">
				<h2 class="modal-title">圆棒重量计算</h2>
				<mdui-button-icon icon="close" id="closeCalculatorModal"></mdui-button-icon>
			</div>
			<div id="calculatorContent" class="modal-body-custom">
				<form id="calculatorForm" class="data-form" style="padding: 16px;">
					<label for="calcDiameter1">直径 1 (mm)</label>
					<input type="text" id="calcDiameter1" class="numeric-input readonly-input">
					<label for="calcDiameter2">直径 2 (mm)</label>
					<input type="text" id="calcDiameter2" class="numeric-input readonly-input">
					<label for="calcLength">长度 (mm)</label>
					<input type="text" id="calcLength" class="numeric-input readonly-input">
					<label for="calcDensity">密度 (Kg/mm³, 默认 0.00617)</label>
					<input type="text" id="calcDensity" readonly>
					<label for="calcResult">计算结果 (Kg)</label>
					<input type="text" id="calcResult" readonly style="font-weight: bold; font-size: 1.2em;">
				</form>
			</div>
			<div class="modal-footer-custom">
				<mdui-button variant="text" id="clearCalcBtn" color="error">清空全部</mdui-button>
				<mdui-button variant="text" id="cancelCalcBtn">取消</mdui-button>
				<mdui-button variant="filled" id="calculateAndAddBtn">计算并填充</mdui-button>
			</div>
		</div>
	</div>
	<!-- 重复数据确认弹窗 -->
	<div id="duplicateConfirmationModalCustom" class="modal-custom full-height-custom">
		<div class="modal-content-custom">
			<div class="modal-header-custom">
				<h2 class="modal-title">导入重复数据确认</h2>
				<mdui-button-icon icon="close" id="closeDuplicateModal"></mdui-button-icon>
			</div>
			<div class="modal-body-custom">
				<p>总共导入 <span id="modal-total-count" style="font-weight: bold;">0</span> 条记录。其中：</p>
				<ul>
					<li>新数据 <span id="modal-new-count" style="font-weight: bold; color: var(--primary-color);">0</span> 条（将直接添加）</li>
					<li>重复数据 <span id="modal-duplicate-count" style="font-weight: bold; color: #f44336;">0</span> 条（请选择处理方式）</li>
				</ul>
				<div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
					<mdui-button variant="outlined" id="modal-btn-select-all-skip">全部跳过 (保留现有)</mdui-button>
					<mdui-button variant="outlined" id="modal-btn-select-all-override">全部覆盖 (使用新值)</mdui-button>
				</div>
				<div id="modal-duplicate-list"></div>
			</div>
			
		<!-- 固定页码区域（sticky） -->
<div id="duplicatePagination" style="position: sticky; top: 0; background: var(--surface-color); padding: 12px 0; border-bottom: 1px solid var(--border-color); z-index: 10; display: flex; align-items: center; justify-content: center; gap: 16px;">
  <mdui-button-icon id="duplicatePrevPage" icon="navigate_before"></mdui-button-icon>
  <span id="duplicatePageInfo">第 1 / 1 页（共 0 条有差异重复）</span>
  <input type="number" id="duplicatePageJump" min="1" style="width:60px; padding:4px; text-align:center;" placeholder="跳转">
  <mdui-button-icon id="duplicateNextPage" icon="navigate_next"></mdui-button-icon>
</div>

<!-- 原有重复列表容器 -->
<div id="modal-duplicate-list" style="max-height: calc(60vh - 60px); overflow-y: auto;"></div>
			<div class="modal-footer-custom">
				<mdui-button variant="text" id="modal-btn-cancel-import">取消导入</mdui-button>
				<mdui-button variant="filled" id="modal-btn-confirm">确认处理并完成导入</mdui-button>
			</div>
			
			
		</div>
	</div>
	<!-- 数据排序弹窗 -->
	<div id="sortModalCustom" class="full-height-custom modal-custom">
		<div class="modal-content-custom">
			<div class="modal-header-custom">
				<h2 class="modal-title">数据排序</h2>
				<mdui-button-icon icon="close" id="closeSortModal"></mdui-button-icon>
			</div>
			<div class="modal-body-custom">
				<div class="data-form" style="padding: 0 16px;">
					<p style="color: #757575; font-size: 0.9rem; margin-bottom: 16px;">从上到下优先级依次降低（先按第一条，再按第二条，以此类推）</p>
					<mdui-button variant="outlined" id="addSortRuleBtn" style="width: 100%; margin-top: 12px;">
						<mdui-icon name="add"></mdui-icon> 添加排序规则 </mdui-button>
					<div id="sortRulesContainer"></div>
				</div>
			</div>
			<div class="modal-footer-custom">
				<mdui-button variant="text" id="cancelSortBtn">取消</mdui-button>
				<mdui-button variant="filled" id="applySortBtn">应用排序</mdui-button>
			</div>
		</div>
	</div>
	<!-- 底部添加按钮 -->
	<mdui-fab icon="add" id="mainFab"></mdui-fab>
	<!-- 重复数据项模板 -->
	<script type="text/template" id="duplicate-item-template"> <div class="duplicate-item">
        <h4>产品号：PRODUCT_ID</h4>
        <div class="duplicate-differences">
            <table>
                <thead>
                    <tr>
                        <th>字段</th>
                        <th>现有值</th>
                        <th>新值</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="duplicate-actions">
            <label><input type="radio" name="action-ITEM_INDEX" value="skip" checked> 跳过 (保留现有值)</label>
            <label><input type="radio" name="action-ITEM_INDEX" value="override"> 覆盖 (使用新值)</label>
        </div>
    </div>
</script>
	<!-- 差异行模板 -->
	<script type="text/template" id="difference-row-template"> <tr>
        <th>FIELD_NAME</th>
        <td>OLD_VALUE</td>
        <td style="color: #f44336; font-weight: bold;">NEW_VALUE</td>
    </tr>
</script>
	<!-- 关于弹窗 -->

<!-- 关于弹窗（极致紧凑版：无多余边距+完善所有功能+版本更新+修正描述） -->
<mdui-dialog id="aboutDialog" fullscreen headline="关于 & 操作指南" close-on-overlay-click class="full-height-custom">
  <div style="padding: 16px 20px; font-size: 15px; line-height: 1.65; color: var(--mdui-color-on-surface, #212121);">
    <!-- 标题 + 版本（紧贴顶部，版本更新为今日） -->
    <div style="text-align: center; margin: 0 0 12px 0;">
      <div style="font-size: 1.45rem; font-weight: 600; color: var(--mdui-color-primary, #00796b);">
        圆棒入库数据管理
      </div>
      <div style="font-size: 0.9rem; color: var(--mdui-color-on-surface-variant, #757575); margin-top: 4px;">
        版本：2026.01.13 【最新版】
      </div>
    </div>

    <!-- 制作者信息（极简） -->
    <div style="text-align: center; font-size: 0.85rem; color: var(--mdui-color-on-surface-variant, #757575); margin: 0 0 16px 0;">
      制作：Gemini + Doubao + Grok　持续优化中 | 功能全覆盖·双端适配
    </div>

    <mdui-divider style="margin: 12px 0;"></mdui-divider>

    <!-- 操作指南（极致紧凑，补齐所有功能+修正错误描述，间距不变） -->
    <div style="display: grid; gap: 20px;">
      <!-- 基础操作 -->
      <div>
        <div style="font-size: 1.18rem; font-weight: 600; color: var(--mdui-color-primary, #00796b); margin-bottom: 6px;">
          基础操作
        </div>
        <ul style="margin: 0; padding-left: 18px; list-style: none; color: var(--mdui-color-on-surface, #212121);">
          <li style="margin-bottom: 4px;">• 添加/编辑：右下 + 按钮，或点击表格行快速编辑</li>
          <li style="margin-bottom: 4px;">• 单元格直编：点击表格单元格，直接修改数据</li>
          <li>• 批量删除：右上 ⋮ → 开启多选模式 → 勾选删除 → 底部批量删除</li>
        </ul>
      </div>

      <!-- 数据处理（最全，补齐搜索替换/导入导出/计算排序所有细节） -->
      <div>
        <div style="font-size: 1.18rem; font-weight: 600; color: var(--mdui-color-primary, #00796b); margin-bottom: 6px;">
          数据处理
        </div>
        <ul style="margin: 0; padding-left: 18px; list-style: none; color: var(--mdui-color-on-surface, #212121);">
          <li style="margin-bottom: 4px;">• 导入导出：抽屉菜单 → 一键导入/导出 Excel 表格</li>
          <li style="margin-bottom: 4px;">• 全局搜索：顶部搜索框，支持所有字段模糊匹配</li>
          <li style="margin-bottom: 4px;">• 搜索替换：点击顶部 🔍↔️ → 打开替换面板，支持单条/全部替换</li>
          <li style="margin-bottom: 4px;">• 重量计算：抽屉菜单 → 计算重量 → 自动填充单支/总重数据</li>
          <li>• 数据排序：抽屉菜单 → 数据排序 → 自定义规则一键应用</li>
        </ul>
      </div>

      <!-- 行序移动（重中之重✅ 补齐你最新的【短按+长按】移动行功能，手机/电脑双端完整说明，修正原错误描述） -->
      <div>
        <div style="font-size: 1.18rem; font-weight: 600; color: var(--mdui-color-primary, #00796b); margin-bottom: 6px;">
          行序移动 【核心功能】
        </div>
        <ul style="margin: 0; padding-left: 18px; list-style: none; color: var(--mdui-color-on-surface, #212121);">
          <li style="margin-bottom: 4px;">• 电脑端：表格首列 ↑↓ 按钮，<strong style="color:var(--mdui-color-primary);">单击</strong> = 上/下移一行</li>
          <li style="margin-bottom: 4px;">• 电脑端：表格首列 ↑↓ 按钮，<strong style="color:var(--mdui-color-primary);">长按≥0.5秒</strong> = 弹窗选择指定行，精准移动到目标行「上/下方」</li>
          <li style="margin-bottom: 4px;">• 手机端：表格首列 ↑↓ 按钮，<strong style="color:var(--mdui-color-primary);">轻触</strong> = 上/下移一行</li>
          <li style="margin-bottom: 4px;">• 手机端：表格首列 ↑↓ 按钮，<strong style="color:var(--mdui-color-primary);">长按≥0.5秒</strong> = 弹窗选择指定行，精准移动位置</li>
          <li>• 移动兼容：支持分页/搜索过滤，移动后自动跳转对应页码，行序永久保存</li>
        </ul>
      </div>

      <!-- 手势与显示（优化描述，补充双端适配细节） -->
      <div>
        <div style="font-size: 1.18rem; font-weight: 600; color: var(--mdui-color-primary, #00796b); margin-bottom: 6px;">
          手势与显示适配
        </div>
        <ul style="margin: 0; padding-left: 18px; list-style: none; color: var(--mdui-color-on-surface, #212121);">
          <li style="margin-bottom: 4px;">• 表格缩放：电脑滚轮/手机双指捏合/张开，自由缩放表格宽度</li>
          <li>• 适配显示：自动兼容电脑/手机屏幕，表格自适应排版无遮挡</li>
        </ul>
      </div>

      <!-- 虚拟键盘（补齐所有快捷键细节，最完整） -->
      <div>
        <div style="font-size: 1.18rem; font-weight: 600; color: var(--mdui-color-primary, #00796b); margin-bottom: 6px;">
          虚拟键盘 【快捷录入】
        </div>
        <ul style="margin: 0; padding-left: 18px; list-style: none; color: var(--mdui-color-on-surface, #212121);">
          <li style="margin-bottom: 4px;">• 自动唤出：点击单元格输入框，虚拟键盘自动弹出</li>
          <li style="margin-bottom: 4px;">• 字段跳转：点击键盘右下 ▼ 键，一键跳转下一个输入项</li>
          <li style="margin-bottom: 4px;">• 快速关闭：长按 ▼ 键 或 快编模式点击 ✔ 完成按钮</li>
          <li style="margin-bottom: 4px;">• 快捷删除：←✘ 一键清空内容 | ← 单删前一字符</li>
          <li>• 批量填充：首行快捷按钮，一键填入钢种/状态/库位等公共数据</li>
        </ul>
      </div>
    </div>

    <!-- 结尾语（紧凑，补充温馨提示） -->
    <div style="margin-top: 20px; text-align: center; font-size: 0.9rem; color: var(--mdui-color-on-surface-variant, #757575);">
      所有操作自动本地保存，数据永不丢失 | 如有建议，欢迎反馈 · 感谢使用！
    </div>
  </div>

  <!-- 关闭按钮 -->
  <mdui-button slot="action" variant="text" onclick="document.getElementById('aboutDialog').open = false;">
    关闭
  </mdui-button>
</mdui-dialog>

	<!-- 删除图片确认对话框 -->
	<mdui-dialog id="deleteImageConfirmDialog" headline="确认删除" close-on-overlay-click close-on-esc>
		<div style="padding:16px 0;font-size:1rem;">确定要删除这张卡片图片吗？删除后不可恢复。</div>
		<mdui-button slot="action" variant="text" id="cancelDeleteImageBtn">取消</mdui-button>
		<mdui-button slot="action" variant="filled" color="error" id="confirmDeleteImageBtn">删除</mdui-button>
	</mdui-dialog>
	<!-- 取消编辑确认对话框 -->
	<mdui-dialog id="cancelEditConfirmDialog" headline="确认取消" close-on-overlay-click close-on-esc>
		<div style="padding:16px 0;font-size:1rem;">确定要取消操作吗？取消后当前输入的内容可能会丢失。</div>
		<mdui-button slot="action" variant="text" id="cancelCancelBtn">返回继续编辑</mdui-button>
		<mdui-button slot="action" variant="filled" color="error" id="confirmCancelBtn">确认取消</mdui-button>
	</mdui-dialog>
	
	
	<!-- 重复产品号警告弹窗（mdui-dialog） -->
<mdui-dialog id="duplicateWarnDialog" fullscreen headline="检测到重复产品号" close-on-overlay-click close-on-esc>
  <div style="padding: 0 24px 24px; font-size: 0.95rem; line-height: 1.6;">
    <p id="duplicateWarnMessage" style="margin-bottom: 16px;"></p>
    <p style="color: #f44336; font-weight: 500;">
      是否要<strong>覆盖现有数据</strong>？<br>
      （覆盖后原数据将被替换，不可恢复）
    </p>
  </div>
  
  <mdui-button slot="action" variant="text" id="duplicateWarnCancelBtn">取消添加</mdui-button>
  <mdui-button slot="action" variant="filled" color="error" id="duplicateWarnOverrideBtn">覆盖保存</mdui-button>
</mdui-dialog>
	
	
	
	<!-- 图片过大提示弹窗 -->
<mdui-dialog id="largeImageWarnDialog" headline="图片过大" close-on-overlay-click close-on-esc fullscreen>
  <div style="padding: 0 24px 24px; font-size: 0.95rem; line-height: 1.6;">
    <p>当前图片大小超过 <strong>5MB</strong>，可能导致加载缓慢或存储空间占用过多。</p>
    <p>建议<strong>压缩</strong>后上传（质量损失较小，体积大幅减小）。</p>
  </div>
  
  <mdui-button slot="action" variant="text" id="largeImageCancelBtn">取消上传</mdui-button>
  <mdui-button slot="action" variant="outlined" id="largeImageForceBtn">直接上传（不压缩）</mdui-button>
  <mdui-button slot="action" variant="filled" id="largeImageCompressBtn">压缩后上传</mdui-button>
</mdui-dialog>
	
	
	<!-- 单条添加时的重复警告弹窗（简单提示） -->
<mdui-dialog id="singleDuplicateWarnDialog" headline="检测到重复产品号" close-on-overlay-click close-on-esc>
  <div style="padding: 0 24px 24px; font-size: 0.95rem; line-height: 1.6;">
    <p id="singleDuplicateMessage"></p>
    <p style="color: #f44336; font-weight: 500; margin-top: 16px;">
      是否要<strong>覆盖现有数据</strong>？（覆盖后原数据将被替换，不可恢复）
    </p>
  </div>
  
  <mdui-button slot="action" variant="text" id="singleDuplicateCancelBtn">取消添加</mdui-button>
  <mdui-button slot="action" variant="filled" color="error" id="singleDuplicateOverrideBtn">覆盖保存</mdui-button>
</mdui-dialog>

<!-- 批量导入时的重复确认弹窗（完整列表 + 差异对比） -->
<mdui-dialog id="bulkDuplicateConfirmDialog" headline="检测到重复产品号" close-on-overlay-click close-on-esc>
  <div style="padding: 0 24px 24px; font-size: 0.95rem; line-height: 1.6;">
    <p>总共导入 <span id="modal-total-count">0</span> 条记录。其中：</p>
    <ul>
      <li>新数据 <span id="modal-new-count">0</span> 条（将直接添加）</li>
      <li>重复数据 <span id="modal-duplicate-count">0</span> 条（请处理）</li>
    </ul>
    
    <div style="margin: 16px 0;">
      <mdui-button variant="outlined" id="modal-btn-select-all-skip">全部跳过</mdui-button>
      <mdui-button variant="outlined" id="modal-btn-select-all-override">全部覆盖</mdui-button>
    </div>
    
    <div id="modal-duplicate-list" style="max-height: 50vh; overflow-y: auto;"></div>
  </div>
  
  <mdui-button slot="action" variant="text" id="modal-btn-cancel-import">取消导入</mdui-button>
  <mdui-button slot="action" variant="filled" id="modal-btn-confirm">确认处理并完成</mdui-button>
</mdui-dialog>
	
	
	<mdui-snackbar id="general-snackbar" placement="bottom-center" closeable></mdui-snackbar>
	<!-- 新增：开关显隐逻辑 JS -->
	
	
<!-- 第二步：新增 - 产品号不匹配提示对话框 -->
<mdui-dialog id="productIdMismatchDialog" headline="产品号不匹配" close-on-overlay-click>
  <div id="mismatchMessage" style="padding:16px 0; line-height:1.6; font-size:0.95rem;"></div>
  <mdui-button slot="action" variant="text" id="keepCurrentProductBtn">保持当前值</mdui-button>
  <mdui-button slot="action" variant="filled" color="primary" id="useRecognizedProductBtn">
    使用图片识别的产品号
  </mdui-button>
</mdui-dialog>

<!-- 第二步：新增 - 新旧数据对比编辑对话框（全屏） -->
<mdui-dialog id="compareEditDialog" fullscreen headline="新旧数据对比编辑" close-on-overlay-click>
  <div style="padding:16px 16px 100px; font-size:0.95rem;">
    <p style="color:#757575; margin:0 0 16px 0; line-height:1.5;">
      左侧：您当前填写的数据（只读参考）<br>
      右侧：图片智能识别建议（可直接编辑，最终以此保存）
    </p>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
      <!-- 左侧 - 当前数据（只读） -->
      <div>
        <div style="font-weight:500; color:#757575; margin-bottom:12px; padding-bottom:8px; border-bottom:1px solid #e0e0e0;">
          当前数据（只读）
        </div>
        <div id="oldDataContainer" class="data-form"></div>
      </div>

      <!-- 右侧 - 识别建议（可编辑） -->
      <div>
        <div style="font-weight:500; color:var(--primary-color); margin-bottom:12px; padding-bottom:8px; border-bottom:1px solid var(--primary-color);">
          图片识别建议（可编辑）
        </div>
        <div id="newDataContainer" class="data-form"></div>
      </div>
    </div>
  </div>

  <mdui-button slot="action" variant="text" id="cancelCompareEditBtn">取消</mdui-button>
  <mdui-button slot="action" variant="filled" id="confirmCompareEditBtn">使用右侧数据保存</mdui-button>
</mdui-dialog>
	
	
	
	

    <!-- 虚拟键盘设置模态框 (Fullscreen) -->
    <mdui-dialog id="keyboardSettingsModal" fullscreen close-on-esc close-on-overlay-click>
        <mdui-top-app-bar slot="header">
            <mdui-top-app-bar-title>虚拟键盘设置</mdui-top-app-bar-title>
            <mdui-button-icon icon="close" id="closeKeyboardSettingsModal"></mdui-button-icon>
        </mdui-top-app-bar>
        <div style="padding: 0px; overflow-y: auto; height: 100%; box-sizing: border-box;">
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 16px;">
                在此编辑快捷短语。每行一个。<br>
                可用变量：<code>${year}</code> (如24), <code>${lastYear}</code> (如23)
            </p>

            <div class="input-group" style="margin-bottom: 16px;">
                <label style="display:block; margin-bottom:8px; font-weight:500;">炉号 (Furnace ID)</label>
                <mdui-text-field id="furnaceIdConfigInput" rows="5" autosize style="width:100%;"></mdui-text-field>
            </div>

            <div class="input-group" style="margin-bottom: 16px;">
                <label style="display:block; margin-bottom:8px; font-weight:500;">产品号 (Product ID)</label>
                <mdui-text-field id="productIdConfigInput" rows="3" autosize style="width:100%;"></mdui-text-field>
            </div>

            <div class="input-group" style="margin-bottom: 16px;">
                <label style="display:block; margin-bottom:8px; font-weight:500;">卡片号 (Card ID)</label>
                <mdui-text-field id="cardIdConfigInput" rows="5" autosize style="width:100%;"></mdui-text-field>
            </div>

            <div class="input-group" style="margin-bottom: 16px;">
                <label style="display:block; margin-bottom:8px; font-weight:500;">钢种 (Steel Type)</label>
                <mdui-text-field id="steelTypeConfigInput" rows="5" autosize style="width:100%;"></mdui-text-field>
            </div>
            
            <div class="input-group" style="margin-bottom: 16px;">
                <label style="display:block; margin-bottom:8px; font-weight:500;">状态 (Status)</label>
                <mdui-text-field id="statusConfigInput" rows="3" autosize style="width:100%;"></mdui-text-field>
            </div>
            
            <div class="input-group" style="margin-bottom: 16px;">
                <label style="display:block; margin-bottom:8px; font-weight:500;">位置 (Position)</label>
                <mdui-text-field id="positionConfigInput" rows="3" autosize style="width:100%;"></mdui-text-field>
            </div>
        </div>
        <div slot="action">
            
            <mdui-button variant="tonal" id="cancelKeyboardConfigBtn">取消</mdui-button>
            <mdui-button variant="text" id="resetKeyboardConfigBtn">恢复默认</mdui-button>
            <mdui-button variant="filled" id="saveKeyboardConfigBtn">保存</mdui-button>
        </div>
    </mdui-dialog>

	<script>

		let tableData = [];              
		let currentInput = null;         
		let keyboardState = JSON.parse(localStorage.getItem('keyboardState')) || {
		    shiftState: 'locked-on',     
		    inputType: 'text'            
		};
		let suppressVirtualKeyboard = false;   
		let currentEditIndex = -1;       
		let isMultiSelectMode = false;   
		let selectedRows = new Set();    
		let selectedTheme = localStorage.getItem('theme') || 'auto';  
		let searchTerm = '';             
		let isSearchReplaceVisible = false;  
		let currentPage = 1;
		        const PAGE_SIZE = 50;  
		        let totalPages = 1;

		let searchMatches = [];         
		let currentMatchIndex = -1;     
		let isSearchActive = false;     
		const searchableFields = [
		    'steelType', 'productId', 'cardId', 'furnaceId', 'actualDiameter', 
		    'diameter', 'length', 'weight', 'status', 'position', 'hardness', 'remarks'
		];
		let duplicateCurrentPage = 1;
		        const DUPLICATE_PAGE_SIZE = 10;  
		        let duplicateTotalPages = 1;
		        let isFilterMatchRows = false;  

		const inputFieldOrder = [
		  'steelType', 'productId', 'cardId', 'furnaceId',
		  'actualDiameter', 'diameter', 'length', 'weight',
		  'status', 'position', 'hardness', 'remarks'
		];

		const fieldLabels = {
		    'steelType': '钢种',
		    'productId': '产品号',
		    'cardId': '卡片号',
		    'furnaceId': '炉号',
		    'actualDiameter': '实际直径',
		    'diameter': '直径',
		    'length': '长度',
		    'weight': '重量',
		    'status': '状态',
		    'position': '位置',
		    'hardness': '硬度',
		    'remarks': '备注'
		};

		const sortFieldOptions = [
		    { value: 'cardId', label: '卡片号' },
		    { value: 'productId', label: '产品号' },
		    { value: 'steelType', label: '钢种' },
		    { value: 'furnaceId', label: '炉号' },
		    { value: 'actualDiameter', label: '实际直径' },
		    { value: 'diameter', label: '直径' },
		    { value: 'length', label: '长度' },
		    { value: 'weight', label: '重量' },
		    { value: 'status', label: '状态' },
		    { value: 'position', label: '位置' },
		    { value: 'hardness', label: '硬度' }
		];

		const numericSortFields = ['actualDiameter', 'diameter', 'length', 'weight', 'hardness'];

// ==========================================
// === UI Helpers & DOM Elements ===
// ==========================================
		const dom = {
		  themeCollapse: document.getElementById('themeCollapse'),
		  themeCollapseContent: document.getElementById('themeCollapseContent'),
		  tableBody: document.getElementById('tableBody'),
		  emptyState: document.getElementById('emptyState'),
		  itemCount: document.getElementById('itemCount'),
		  addBtn: document.getElementById('mainFab'), 
		  importItem: document.getElementById('importItem'),
		  exportItem: document.getElementById('exportItem'),
		  fileInput: document.getElementById('fileInput'),
		  deleteSelectedBtn: document.getElementById('deleteSelectedBtn'),
		  selectedCount: document.getElementById('selectedCount'),
		  selectAllCheckbox: document.getElementById('selectAllCheckbox'),
		  drawer: document.getElementById('drawer'),
		  openDrawerBtn: document.getElementById('openDrawerBtn'),
		  dataSheet: document.getElementById('dataSheetCustom'), 
		  closeDataModal: document.getElementById('closeDataModal'),
		  saveBtn: document.getElementById('saveBtn'),
		  cancelBtn: document.getElementById('cancelBtn'),
		  dataForm: document.getElementById('dataForm'),
		  modalTitle: document.getElementById('modalTitle'),
		  editIndex: document.getElementById('editIndex'),
		  quickEditDialog: document.getElementById('quickEditDialog'),
		  closeQuickEdit: document.getElementById('closeQuickEdit'),
		  quickEditLabel: document.getElementById('quickEditLabel'),
		  quickEditInput: document.getElementById('quickEditInput'),
		  quickEditIndex: document.getElementById('quickEditIndex'),
		  quickEditField: document.getElementById('quickEditField'),
		  saveQuickEditBtn: document.getElementById('saveQuickEditBtn'),
		  openFullEditBtn: document.getElementById('openFullEditBtn'),
		  confirmModal: document.getElementById('confirmModalCustom'), 
		  closeConfirmModal: document.getElementById('closeConfirmModal'),
		  confirmMessage: document.getElementById('confirmMessage'),
		  cancelConfirmBtn: document.getElementById('cancelConfirmBtn'),
		  confirmActionBtn: document.getElementById('confirmActionBtn'),
		  virtualKeyboard: document.getElementById('virtualKeyboard'),
		  keyboardRows: document.getElementById('keyboardRows'),
		  shortcutContainer: document.getElementById('shortcutContainer'),
		  searchInput: document.getElementById('searchInput'),
		  searchClearBtn: document.getElementById('searchClearBtn'),
		  calculatorModal: document.getElementById('calculatorModalCustom'), 
		  calculatorBtn: document.getElementById('calculatorBtn'),
		  closeCalculatorModal: document.getElementById('closeCalculatorModal'),
		  calculatorForm: document.getElementById('calculatorForm'),
		  calcDiameter1: document.getElementById('calcDiameter1'),
		  calcDiameter2: document.getElementById('calcDiameter2'),
		  calcLength: document.getElementById('calcLength'),
		  calcDensity: document.getElementById('calcDensity'),
		  calcResult: document.getElementById('calcResult'),
		  calculateAndAddBtn: document.getElementById('calculateAndAddBtn'),
		  cancelCalcBtn: document.getElementById('cancelCalcBtn'),
		  clearCalcBtn: document.getElementById('clearCalcBtn'),
		  duplicateConfirmationModal: document.getElementById('duplicateConfirmationModalCustom'), 
		  closeDuplicateModal: document.getElementById('closeDuplicateModal'),
		  generalSnackbar: document.getElementById('general-snackbar'),
		  filterMatchRowsSwitch: document.getElementById('filterMatchRowsSwitch'),

		  cardImageInput: document.getElementById('cardImageInput'),
		uploadImageBtn: document.getElementById('uploadImageBtn'),
		cardImagePreview: document.getElementById('cardImagePreview'),
		previewImg: document.getElementById('previewImg'),
		changeImageBtn: document.getElementById('changeImageBtn'),
		deleteImageBtn: document.getElementById('deleteImageBtn'),

		  multiSelectMenuText: document.getElementById('multiSelectMenuText'), 
		  multiSelectMenuItem: document.getElementById('multiSelectMenuItem'), 

		  toggleSearchReplaceBtn: document.getElementById('toggleSearchReplaceBtn'),
		  searchReplaceContainer: document.getElementById('searchReplaceContainer'),
		  replaceQueryInput: document.getElementById('replaceQuery'),       
		  searchResultCount: document.getElementById('searchResultCount'), 
		  prevMatchBtn: document.getElementById('prevMatchBtn'),           
		  nextMatchBtn: document.getElementById('nextMatchBtn'),           
		  replaceOneBtn: document.getElementById('replaceOneBtn'),         
		  replaceAllBtn: document.getElementById('replaceAllBtn'),

		  sortItem: document.getElementById('sortItem'),
		  sortModal: document.getElementById('sortModalCustom'),
		  closeSortModal: document.getElementById('closeSortModal'),
		  cancelSortBtn: document.getElementById('cancelSortBtn'),
		  applySortBtn: document.getElementById('applySortBtn'),
		  sortRulesContainer: document.getElementById('sortRulesContainer'),
		  addSortRuleBtn: document.getElementById('addSortRuleBtn'),

		  aboutDialog: document.getElementById('aboutDialog'),
		  aboutItem: document.getElementById('aboutItem'),
		  totalCountText: document.getElementById('totalCountText'),
		  bottomPrevBtn: document.getElementById('bottomPrevBtn'),    
		            bottomNextBtn: document.getElementById('bottomNextBtn'),     
		            pageInfoText: document.getElementById('pageInfoText'),       
		            pageJumpInput:document.getElementById('pageJumpInput')    
		};

// ==========================================
// === Zoom Manager (View Logic) ===
// ==========================================
const ZoomManager = {
    currentScale: 1,
    minScale: 0.5,
    maxScale: 2.0,
    container: null,
    naturalWidth: 0,
    naturalHeight: 0,
    
    init() {
        this.container = document.querySelector('.data-table-container');
        if (!this.container) return;
        this.measureNaturalSize();
        this.bindEvents();
        this.applyScale(this.currentScale);
    },

    measureNaturalSize() {
        if (!this.container) return;
        const oldTransform = this.container.style.transform;
        this.container.style.transform = 'none';
        this.naturalWidth = this.container.scrollWidth;
        this.naturalHeight = this.container.scrollHeight;
        this.container.style.transform = oldTransform || `scale(${this.currentScale})`;
    },

    applyScale(scale) {
        if (!this.container) return;
        this.currentScale = Math.max(this.minScale, Math.min(this.maxScale, scale));
        this.container.style.width = `${this.naturalWidth * this.currentScale}px`;
        this.container.style.height = `${this.naturalHeight * this.currentScale}px`;
        this.container.style.transform = `scale(${this.currentScale})`;
        this.container.style.transformOrigin = 'top left';
    },

    onTableUpdate() {
        setTimeout(() => {
            this.measureNaturalSize();
            this.applyScale(this.currentScale);
        }, 150);
    },

    bindEvents() {
        let startDistance = 0;
        let startScale = 1;

        const getDistance = (t1, t2) => Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);

        const handlePinch = (e) => {
            if (e.touches.length !== 2) {
                if (e.type === 'touchend' || e.type === 'touchcancel') startDistance = 0;
                return;
            }
            e.preventDefault();
            const currentDist = getDistance(e.touches[0], e.touches[1]);
            if (e.type === 'touchstart') {
                startDistance = currentDist;
                startScale = this.currentScale;
            } else if (startDistance > 0) {
                const ratio = currentDist / startDistance;
                this.applyScale(startScale * ratio);
            }
        };

        ['touchstart', 'touchmove', 'touchend', 'touchcancel'].forEach(ev => {
            this.container.removeEventListener(ev, handlePinch, { passive: false });
            this.container.addEventListener(ev, handlePinch, { passive: false });
        });
        
        // Header double-tap reset
        const thead = document.querySelector('#dataTable thead');
        if (thead) {
            let lastTap = 0;
            thead.addEventListener('touchend', (e) => {
                const now = Date.now();
                if (now - lastTap < 300) {
                    e.preventDefault();
                    this.applyScale(1);
                }
                lastTap = now;
            });
        }
    }
};

		const formElements = {
		  steelType: document.getElementById('steelType'),
		  productId: document.getElementById('productId'),
		  cardId: document.getElementById('cardId'),
		  furnaceId: document.getElementById('furnaceId'),
		  actualDiameter: document.getElementById('actualDiameter'),
		  diameter: document.getElementById('diameter'),
		  length: document.getElementById('length'),
		  weight: document.getElementById('weight'),
		  status: document.getElementById('status'),
		  position: document.getElementById('position'),
		  hardness: document.getElementById('hardness'),
		  remarks: document.getElementById('remarks')
		};
		const inputFields = Object.values(formElements); 



		function showSnackbar(message, color) {
		  const snackbar = dom.generalSnackbar;
		  if (!snackbar) return;
		  snackbar.innerHTML = message;
		  if (color) snackbar.color = color;
		  else snackbar.removeAttribute('color');
		  snackbar.open = true;
		}

		function isSystemDarkMode() {
		    return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
		}

		function initTheme() {
		  let mode = selectedTheme === 'auto' ? (isSystemDarkMode() ? 'dark' : 'light') : selectedTheme;
		  const body = document.body;
		  if (mode === 'dark') {
		    body.classList.add('dark-mode', 'mdui-theme-dark');
		  } else {
		    body.classList.remove('dark-mode', 'mdui-theme-dark');
		  }
		  updateThemeSelectionInDrawer();
		}

		function changeTheme(theme) {
		  selectedTheme = theme;
		  localStorage.setItem('theme', selectedTheme);
		  initTheme();
		  dom.drawer.open = false; 
		}

		function updateThemeSelectionInDrawer() {
		    const themeOptions = dom.themeCollapseContent.querySelectorAll('.theme-option');
		    themeOptions.forEach(item => item.removeAttribute('selected'));
		    const current = dom.themeCollapseContent.querySelector(`.theme-option[data-theme="${selectedTheme}"]`);
		    if (current) current.setAttribute('selected', 'true');

		    const headerItem = dom.themeCollapse.querySelector('mdui-list-item[slot="header"]');
		    let headlineText = "主题模式 (当前: 自动)";
		    let iconName = "brightness_auto";
		    if (selectedTheme === 'light') { headlineText = "主题模式 (当前: 日间)"; iconName = "light_mode"; }
		    else if (selectedTheme === 'dark') { headlineText = "主题模式 (当前: 夜间)"; iconName = "dark_mode"; }
		    if (headerItem) {
		        headerItem.setAttribute('headline', headlineText);
		        headerItem.setAttribute('icon', iconName);
		    }
		}

		function openCustomModal(modalElement) {
		    if (modalElement) modalElement.style.display = 'block';
		}

		function closeCustomModal(modalElement) {
		    if (modalElement) modalElement.style.display = 'none';
		}

function openCompareEditDialog(suggestedFields) {
    const dialog = document.getElementById('compareEditDialog');
    if (!dialog) {
        console.error('未找到对比编辑对话框，请检查HTML');
        return;
    }

    const oldContainer = document.getElementById('oldDataContainer');
    const newContainer = document.getElementById('newDataContainer');

    if (!oldContainer || !newContainer) return;

    oldContainer.innerHTML = '';
    newContainer.innerHTML = '';

    const currentData = currentEditIndex !== -1
        ? { ...tableData[currentEditIndex] }
        : { ...window.tempNewCardImage || {} };

    const displayFields = [
        { key: 'productId', label: '产品号' },
        { key: 'cardId',    label: '卡片号' },
        { key: 'furnaceId', label: '炉号' },
        { key: 'diameter',  label: '直径（规格）' },
        { key: 'status',    label: '交货状态' }
    ];

    displayFields.forEach(field => {

        const oldLabel = document.createElement('label');
        oldLabel.textContent = field.label;
        oldLabel.style.display = 'block';
        oldLabel.style.marginBottom = '4px';
        oldLabel.style.color = '#757575';

        const oldInput = document.createElement('input');
        oldInput.value = currentData[field.key] || '';
        oldInput.readOnly = true;
        oldInput.className = 'readonly-input';
        oldInput.style.width = '100%';
        oldInput.style.boxSizing = 'border-box';

        const oldWrapper = document.createElement('div');
        oldWrapper.style.marginBottom = '16px';
        oldWrapper.appendChild(oldLabel);
        oldWrapper.appendChild(oldInput);
        oldContainer.appendChild(oldWrapper);

        const newLabel = document.createElement('label');
        newLabel.textContent = field.label;
        newLabel.style.display = 'block';
        newLabel.style.marginBottom = '4px';
        newLabel.style.color = 'var(--primary-color)';

        const newInput = document.createElement('input');
        newInput.value = suggestedFields[field.key] ?? currentData[field.key] ?? '';
        newInput.dataset.field = field.key;
        newInput.style.width = '100%';
        newInput.style.boxSizing = 'border-box';

        newInput.addEventListener('dblclick', () => {
            newInput.removeAttribute('readonly');
            newInput.classList.remove('readonly-input');
            newInput.focus();
            dom.virtualKeyboard.style.display = 'none';
        });

        newInput.addEventListener('click', (e) => {
            e.stopPropagation();
            currentInput = newInput;
            updateKeyboardForInput(newInput, field.key);
            showVirtualKeyboard();
            newInput.setAttribute('readonly', 'true');
            newInput.classList.add('readonly-input');
        });

        const newWrapper = document.createElement('div');
        newWrapper.style.marginBottom = '16px';
        newWrapper.appendChild(newLabel);
        newWrapper.appendChild(newInput);
        newContainer.appendChild(newWrapper);
    });

    document.getElementById('confirmCompareEditBtn').onclick = () => {
        const updatedData = {};
        newContainer.querySelectorAll('[data-field]').forEach(input => {
            updatedData[input.dataset.field] = input.value.trim();
        });

        if (currentEditIndex !== -1) {
            tableData[currentEditIndex] = { ...tableData[currentEditIndex], ...updatedData };
        } else {
            window.tempNewCardImage = { ...window.tempNewCardImage, ...updatedData };
        }

        saveDataToIndexedDB();
        updateTable();
        dialog.open = false;
        closeCustomModal(dom.dataSheet);
        showSnackbar('已使用图片识别数据保存', 'success');
    };

    document.getElementById('cancelCompareEditBtn').onclick = () => {
        dialog.open = false;
    };

    dialog.open = true;
}

function initEventListeners() {

    const selectGalleryBtn = document.getElementById('selectFromGalleryBtn');
    const takePhotoBtn = document.getElementById('takePhotoBtn');
    const dragDropArea = document.getElementById('dragDropArea');
    const fileInput = document.getElementById('cardImageInput');

    if (selectGalleryBtn) {
        selectGalleryBtn.addEventListener('click', () => {
            fileInput.removeAttribute('capture');
            fileInput.click();
        });
    }

    if (takePhotoBtn) {
        takePhotoBtn.addEventListener('click', () => {
            fileInput.setAttribute('capture', 'environment');  
            fileInput.click();
        });
    }

    if (dragDropArea) {
        dragDropArea.addEventListener('click', () => {
            fileInput.removeAttribute('capture');
            fileInput.click();
        });

        dragDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                handleImageSelect({ target: { files: [file] } });
                showSnackbar('图片拖入成功', 'success');
            } else {
                showSnackbar('请拖入图片文件', 'warning');
            }
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dragDropArea.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
                dragDropArea.style.background = 'rgba(var(--primary-color-rgb), 0.1)';
                dragDropArea.style.borderColor = 'var(--primary-color)';
            });
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dragDropArea.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
                dragDropArea.style.background = '';
                dragDropArea.style.borderColor = 'var(--border-color)';
            });
        });
    }

    fileInput.addEventListener('change', handleImageSelect);

    const cancelDeleteBtn = document.getElementById('cancelDeleteImageBtn');
    if (cancelDeleteBtn) {
        cancelDeleteBtn.addEventListener('click', () => {
            const dialog = document.getElementById('deleteImageConfirmDialog');
            if (dialog) dialog.open = false;
        });
    }

    const confirmDeleteImageBtn = document.getElementById('confirmDeleteImageBtn');
    if (confirmDeleteImageBtn) {
        confirmDeleteImageBtn.onclick = () => {
            const index = window.tempDeleteImageIndex;
            if (index !== undefined && tableData[index]) {
                tableData[index].cardImage = '';
                saveDataToIndexedDB();
                updateTable();

                const previewContainer = document.getElementById('cardImagePreview');
                const noImageArea = document.getElementById('noImageUploadArea');
                if (previewContainer && noImageArea) {
                    previewContainer.style.display = 'none';
                    noImageArea.style.display = 'block';
                }

                showSnackbar('图片已删除', 'success');
            }
            const dialog = document.getElementById('deleteImageConfirmDialog');
            if (dialog) dialog.open = false;
            delete window.tempDeleteImageIndex;
        };
    }

    dom.openDrawerBtn.addEventListener('click', () => { dom.drawer.open = true; });

    dom.themeCollapseContent.querySelectorAll('.theme-option').forEach(item => {
        item.addEventListener('click', (e) => {
            const theme = e.currentTarget.getAttribute('data-theme');
            changeTheme(theme);
        });
    });

    dom.closeDataModal.addEventListener('click', () => {
        const dialog = document.getElementById('cancelEditConfirmDialog');
        if (dialog) dialog.open = true;
    });

    dom.cancelBtn.addEventListener('click', () => {
        const dialog = document.getElementById('cancelEditConfirmDialog');
        if (dialog) dialog.open = true;
    });

    document.getElementById('confirmCancelBtn')?.addEventListener('click', () => {
        closeCustomModal(dom.dataSheet);
        dom.virtualKeyboard.style.display = 'none';
        const dialog = document.getElementById('cancelEditConfirmDialog');
        if (dialog) dialog.open = false;
    });

    document.getElementById('cancelCancelBtn')?.addEventListener('click', () => {
        const dialog = document.getElementById('cancelEditConfirmDialog');
        if (dialog) dialog.open = false;
    });

    dom.closeQuickEdit.addEventListener('click', () => { 
        closeCustomModal(dom.quickEditDialog); 
        dom.virtualKeyboard.style.display = 'none'; 
        keyboardState.isQuickEdit = false;
        saveKeyboardState();
    });

    dom.saveQuickEditBtn.addEventListener('click', saveQuickEdit);

    dom.openFullEditBtn.addEventListener('click', () => {
        keyboardState.isQuickEdit = false;
        saveKeyboardState();
        const index = parseInt(dom.quickEditIndex.value);
        const targetFieldId = dom.quickEditField.value;
        closeCustomModal(dom.quickEditDialog);
        dom.virtualKeyboard.style.display = 'none';
        setTimeout(() => {
            openEditModal(index, targetFieldId);
        }, 150);
    });

document.getElementById('filterMatchRowsSwitch').addEventListener('change', (e) => {
    isFilterMatchRows = e.target.checked;

    localStorage.setItem('filterMatchRows', isFilterMatchRows);

    currentPage = 1;            
    updateTable();              
    console.log('过滤开关状态：', isFilterMatchRows ? '开启（只显示匹配行）' : '关闭（显示全部）');
});

    dom.quickEditInput.addEventListener('click', (e) => {
        e.stopPropagation();
        currentInput = e.target;
        const realFieldId = dom.quickEditField.value;
        updateKeyboardForInput(currentInput, realFieldId);
        showVirtualKeyboard();
    });

    dom.closeConfirmModal.addEventListener('click', () => closeCustomModal(dom.confirmModal));
    dom.cancelConfirmBtn.addEventListener('click', () => closeCustomModal(dom.confirmModal));

    dom.closeCalculatorModal.addEventListener('click', () => { 
        closeCustomModal(dom.calculatorModal); 
        dom.virtualKeyboard.style.display = 'none'; 
    });

    dom.cancelCalcBtn.addEventListener('click', () => { 
        closeCustomModal(dom.calculatorModal); 
        dom.virtualKeyboard.style.display = 'none'; 
    });

    dom.clearCalcBtn.addEventListener('click', clearCalculatorInputs);

    dom.closeDuplicateModal.addEventListener('click', () => closeCustomModal(dom.duplicateConfirmationModal));

    document.getElementById('modal-btn-cancel-import')?.addEventListener('click', () => {
        closeCustomModal(dom.duplicateConfirmationModal);
        showSnackbar('导入操作已取消', 'warning');
    });

    dom.sortItem.addEventListener('click', openSortModal);
    dom.closeSortModal.addEventListener('click', () => closeCustomModal(dom.sortModal));
    dom.cancelSortBtn.addEventListener('click', () => closeCustomModal(dom.sortModal));
    dom.applySortBtn.addEventListener('click', applySort);
    dom.addSortRuleBtn.addEventListener('click', () => addSortRule());

    dom.toggleSearchReplaceBtn.addEventListener('click', toggleSearchReplaceVisibility);

    dom.multiSelectMenuItem.addEventListener('click', () => { 
        dom.drawer.open = false; 
        toggleMultiSelectMode(); 
    });

    if (dom.aboutItem && dom.aboutDialog) {
        dom.aboutItem.addEventListener('click', () => {
            dom.aboutDialog.open = true;
            dom.drawer.open = false;
        });
    }

    dom.searchInput.addEventListener('input', (e) => {
        const newQuery = e.target.value.trim();
        if (newQuery !== dom.searchInput.value.trim()) return;
        startSearch();
        updateTable();
    });

    dom.replaceQueryInput.addEventListener('input', () => {
        dom.replaceOneBtn.disabled = searchMatches.length === 0;
        dom.replaceAllBtn.disabled = searchMatches.length === 0;
    });

    dom.prevMatchBtn.addEventListener('click', () => navigateMatch(-1));
    dom.nextMatchBtn.addEventListener('click', () => navigateMatch(1));
    dom.replaceOneBtn.addEventListener('click', replaceOne);
    dom.replaceAllBtn.addEventListener('click', confirmReplaceAll);

    inputFields.forEach(field => {
        field.addEventListener('click', (e) => {
            e.stopPropagation();
            currentInput = e.target;

            if (currentInput.id === 'remarks') {
                currentInput.removeAttribute('readonly');
                currentInput.classList.remove('readonly-input');
                dom.virtualKeyboard.style.display = 'none';
                currentInput.focus();
                return; 
            }

            currentInput.setAttribute('readonly', 'true');
            currentInput.classList.add('readonly-input');
            updateKeyboardForInput(currentInput);
            showVirtualKeyboard();

            setTimeout(() => {
                const modalContent = document.getElementById('dataSheetContent');
                if (modalContent) {
                    const inputRect = currentInput.getBoundingClientRect();
                    const modalRect = modalContent.getBoundingClientRect();
                    const offset = inputRect.top - modalRect.top + modalContent.scrollTop - modalRect.height * 0.3;
                    modalContent.scrollTo({ top: offset, behavior: 'smooth' });
                }
            }, 100);
        });

        field.addEventListener('dblclick', (e) => {
            e.stopPropagation();
            currentInput = e.target;
            if (currentInput.id === 'remarks') return;

            if (currentInput.hasAttribute('readonly')) {
                currentInput.removeAttribute('readonly');
                currentInput.classList.remove('readonly-input');
                dom.virtualKeyboard.style.display = 'none';
                currentInput.focus();
            } else {
                currentInput.setAttribute('readonly', 'true');
                currentInput.classList.add('readonly-input');
                updateKeyboardForInput(currentInput);
                showVirtualKeyboard();
            }
        });
    });

    dom.importItem.addEventListener('click', () => { dom.drawer.open = false; dom.fileInput.click(); });
    dom.exportItem.addEventListener('click', () => { dom.drawer.open = false; exportToExcel(); });
    dom.addBtn.addEventListener('click', openAddModal);
    dom.fileInput.addEventListener('change', handleFileImport);
    dom.selectAllCheckbox.addEventListener('change', handleSelectAll);
    dom.deleteSelectedBtn.addEventListener('click', confirmDeleteSelected);
    dom.saveBtn.addEventListener('click', saveData);

    dom.searchClearBtn.addEventListener('click', () => {
        dom.searchInput.value = '';
        searchTerm = '';
        updateTable();
    });

    dom.calculatorBtn.addEventListener('click', openCalculatorModal);
    dom.calculateAndAddBtn.addEventListener('click', calculateAndAddData);

dom.tableBody.addEventListener('dblclick', (e) => {
    if (isMultiSelectMode) return;

    const row = e.target.closest('tr');
    if (!row) return;

    const index = parseInt(row.getAttribute('data-index'));
    const cell = e.target.closest('td');
    const targetFieldId = cell ? cell.getAttribute('data-field') : null;

    openEditModal(index, targetFieldId);
});

 dom.tableBody.addEventListener('click', (e) => {

    if (isMultiSelectMode) return;

    e.stopPropagation();

    const row = e.target.closest('tr');
    if (!row) return;

    const index = parseInt(row.getAttribute('data-index'));
    const cell = e.target.closest('td');
    const targetFieldId = cell ? cell.getAttribute('data-field') : null;

    if (!targetFieldId || 
        targetFieldId === 'cardImage' || 
        targetFieldId === 'seq' || 
        cell.classList.contains('action-col') || 
        cell.classList.contains('image-col') || 
        cell.classList.contains('checkbox-col')) {
        return;
    }

    if (targetFieldId) {
        if (targetFieldId === 'remarks') {

            openEditModal(index, targetFieldId);
        } else {

            openQuickEdit(index, targetFieldId);
        }
        return;   
    }

});

    dom.bottomPrevBtn.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            updateTable();
        }
    });

    dom.bottomNextBtn.addEventListener('click', () => {
        if (currentPage < totalPages) {
            currentPage++;
            updateTable();
        }
    });

    dom.pageInfoText.addEventListener('click', () => {
        dom.pageInfoText.style.display = 'none';
        dom.pageJumpInput.style.display = 'inline-block';
        dom.pageJumpInput.focus();
        dom.pageJumpInput.select();
    });

    dom.pageJumpInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            jumpToPage();
        }
    });

    dom.pageJumpInput.addEventListener('blur', jumpToPage);
}

function confirmDeleteSelected() {

    if (selectedRows.size === 0 || !isMultiSelectMode) {
        showSnackbar('请先勾选要删除的行', 'warning');
        return;
    }

    const deleteCount = selectedRows.size;
    dom.confirmMessage.innerHTML = `
        <div style="text-align:center; padding:8px 0;">
            <p style="font-size:1rem; margin:0;">确定要删除选中的 <strong style="color:#f44336; font-size:1.1rem;">${deleteCount} 条数据</strong> 吗？</p>
            <p style="margin:12px 0 0; color:#757575; font-size:0.9rem;">此操作不可逆，删除后数据将永久丢失！</p>
        </div>
    `;

    openCustomModal(dom.confirmModal);

    dom.confirmActionBtn.onclick = () => {

        const sortedIndexes = Array.from(selectedRows).sort((a, b) => b - a);
        sortedIndexes.forEach(index => {
            tableData.splice(index, 1);
        });

        saveDataToIndexedDB();  
        selectedRows.clear();   
        isMultiSelectMode = false;  
        showSnackbar(`成功删除 ${deleteCount} 条数据`, 'success');

        updateTable();
        closeCustomModal(dom.confirmModal);  
        dom.confirmActionBtn.onclick = null;  
    };
}

function bindEditImageButtons() {
    const fileInput = document.getElementById('cardImageInput');

    const takePhotoInEdit = document.getElementById('takePhotoInEditBtn');
    if (takePhotoInEdit) {
        takePhotoInEdit.onclick = () => {
            fileInput.setAttribute('capture', 'environment');
            fileInput.click();
        };
    }

    const selectGalleryInEdit = document.getElementById('selectFromGalleryInEditBtn');
    if (selectGalleryInEdit) {
        selectGalleryInEdit.onclick = () => {
            fileInput.removeAttribute('capture');
            fileInput.click();
        };
    }

    const deleteInEdit = document.getElementById('deleteImageInEditBtn');
    if (deleteInEdit) {
        deleteInEdit.onclick = () => {
            window.tempDeleteImageIndex = currentEditIndex;
            document.getElementById('deleteImageConfirmDialog').open = true;
        };
    }
}

		function jumpToPage() {
		        let target = parseInt(dom.pageJumpInput.value);
		        target = Math.max(1, Math.min(totalPages, isNaN(target) ? currentPage : target));
		        if (target !== currentPage) {
		            currentPage = target;
		            updateTable();
		        }
		        dom.pageJumpInput.style.display = 'none';
		        dom.pageInfoText.style.display = 'inline-block';
		    }
function toggleSearchReplaceVisibility() {
    isSearchReplaceVisible = !isSearchReplaceVisible;
    const container = document.getElementById('searchReplaceContainer');
    const menuItem = document.getElementById('filterMatchRowsMenuItem');
    const switchEl = document.getElementById('filterMatchRowsSwitch');

    if (isSearchReplaceVisible) {
        container.style.display = 'block';
        document.getElementById('toggleSearchReplaceBtn').icon = 'expand_less';

        const savedFilter = localStorage.getItem('filterMatchRows') === 'true';
        isFilterMatchRows = savedFilter;
        switchEl.checked = savedFilter;
        menuItem.style.display = 'flex';   

        startSearch();   
    } else {
        container.style.display = 'none';
        document.getElementById('toggleSearchReplaceBtn').icon = 'find_replace';
        menuItem.style.display = 'none';

        updateTable();   
    }
}
		function handleSelectAll() {
		    if (!isMultiSelectMode) return;
		    selectedRows.clear();
		    const filteredData = getFilteredData();
		    if (dom.selectAllCheckbox.checked) {
		      filteredData.forEach(item => {
		          const originalIndex = tableData.indexOf(item);
		          if (originalIndex !== -1) selectedRows.add(originalIndex);
		      });
		    }
		    updateTable();
		}

		function openCalculatorModal() {
		    dom.drawer.open = false;
		    openCustomModal(dom.calculatorModal); 
		    dom.calcDiameter1.value = '';
		    dom.calcDiameter2.value = '';
		    dom.calcLength.value = '';
		    dom.calcResult.value = '';

		    currentInput = dom.calcDiameter1;
		    updateKeyboardForInput(currentInput);
		    showVirtualKeyboard();
		    currentInput.focus();
		}

		function clearCalculatorInputs() {
		    dom.calcDiameter1.value = '';
		    dom.calcDiameter2.value = '';
		    dom.calcLength.value = '';
		    dom.calcResult.value = '';
		    calculateWeight(); 

		    dom.calcDiameter1.focus();
		    currentInput = dom.calcDiameter1;
		    updateKeyboardForInput(currentInput);
		}

function getFilteredData() {
    if (!isSearchActive || !dom.searchInput.value.trim()) {
        return [...tableData];  
    }

    if (isFilterMatchRows) {

        const matchedRows = new Set(searchMatches.map(m => m.rowIndex));
        return tableData.filter((_, index) => matchedRows.has(index));
    } else {

        return [...tableData];
    }
}

function updateTable() {
    const displayData = getFilteredData();

    totalPages = Math.max(1, Math.ceil(displayData.length / PAGE_SIZE));
    currentPage = Math.min(currentPage, totalPages);

    const start = (currentPage - 1) * PAGE_SIZE;
    const pageData = displayData.slice(start, start + PAGE_SIZE);

    dom.totalCountText.textContent = displayData.length === tableData.length
        ? `共 ${tableData.length} 条数据`
        : `共 ${displayData.length} 条匹配数据（原 ${tableData.length} 条）`;

    dom.pageInfoText.textContent = `第 ${currentPage} / ${totalPages} 页`;
    dom.pageJumpInput.value = currentPage;
    dom.pageJumpInput.max = totalPages;
    dom.bottomPrevBtn.disabled = currentPage === 1;
    dom.bottomNextBtn.disabled = currentPage === totalPages;

    dom.searchClearBtn.classList.toggle('active', !!searchTerm);
    dom.selectedCount.textContent = selectedRows.size;

    const displayStyle = isMultiSelectMode ? 'table-cell' : 'none';

    const checkboxHeader = document.querySelector('#dataTable thead th.checkbox-col');
    if (checkboxHeader) {
        checkboxHeader.style.display = displayStyle;
    }

    const deleteBtn = document.getElementById('deleteSelectedBtn');
    if (deleteBtn) {
        deleteBtn.style.display = (isMultiSelectMode && selectedRows.size > 0) ? 'block' : 'none';
    }

    const tableHead = document.querySelector('#dataTable thead');
    const tbody = dom.tableBody;
    const emptyState = document.getElementById('emptyState');

    tbody.innerHTML = '';

    if (displayData.length === 0) {
        if (tableHead) tableHead.style.display = 'none';
        emptyState.style.display = 'flex';
        document.querySelector('.bottom-data-summary').style.display = 'none';
        if (deleteBtn) deleteBtn.style.display = 'none';
        return;
    }

    if (tableHead) tableHead.style.display = 'table-header-group';
    emptyState.style.display = 'none';
    document.querySelector('.bottom-data-summary').style.display = 'flex';

    if (isFilterMatchRows && isSearchActive) {
        tbody.innerHTML = `
            <tr style="background: #fff3e0;">
                <th colspan="16" style="text-align:center; font-size:1.1rem; padding:12px;">
                    匹配结果（共 ${displayData.length} 条）
                </th>
            </tr>
        `;
    }

    pageData.forEach((item, displayIdx) => {
        const originalIndex = item.__index || tableData.findIndex(row => row === item);
        const globalSeq = originalIndex + 1;

        const row = document.createElement('tr');
        row.setAttribute('data-index', originalIndex);

        if (isMultiSelectMode && selectedRows.has(originalIndex)) {
            row.classList.add('selected');
        }

        const escapeHtml = (str) => {
            if (!str) return '-';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;')
                .replace(/\\/g, '&#92;');
        }

        const cardImageSrc = item.cardImage ? escapeHtml(item.cardImage) : '';

        row.innerHTML = `
            <td class="seq-col">
    ${globalSeq}
    <div class="move-buttons">
        <button class="move-btn up-btn" data-index="${originalIndex}" ${originalIndex === 0 ? 'disabled' : ''} title="上移">
            <i class="material-icons" style="font-size:14px;">arrow_upward</i>
        </button>
        <button class="move-btn down-btn" data-index="${originalIndex}" ${originalIndex >= tableData.length - 1 ? 'disabled' : ''} title="下移">
            <i class="material-icons" style="font-size:14px;">arrow_downward</i>
        </button>
    </div>
</td>
            <td class="checkbox-col" style="display:${displayStyle};">
                <mdui-checkbox class="row-checkbox" data-index="${originalIndex}" ${selectedRows.has(originalIndex) ? 'checked' : ''}></mdui-checkbox>
            </td>
            <td data-field="steelType">${escapeHtml(item.steelType)}</td>
            <td data-field="productId">${escapeHtml(item.productId)}</td>
            <td data-field="cardId">${escapeHtml(item.cardId)}</td>
            <td data-field="furnaceId">${escapeHtml(item.furnaceId)}</td>
            <td data-field="actualDiameter">${escapeHtml(item.actualDiameter)}</td>
            <td data-field="diameter">${escapeHtml(item.diameter)}</td>
            <td data-field="length">${escapeHtml(item.length)}</td>
            <td data-field="weight">${escapeHtml(item.weight)}</td>
            <td data-field="status">${escapeHtml(item.status)}</td>
            <td data-field="position">${escapeHtml(item.position)}</td>
            <td data-field="hardness">${escapeHtml(item.hardness)}</td>
            <td class="remark-col" data-field="remarks">${escapeHtml(item.remarks)}</td>
            <td class="image-col" style="text-align:center;padding:0;height:80px;width:100px;cursor:pointer;">
                ${item.cardImage ? 
                  `<div style="width:100%;height:100%;overflow:hidden;border-radius:4px;" onclick="showImagePreviewByIndex(${originalIndex});event.stopPropagation();">
                     <img src="${cardImageSrc}" style="width:100%;height:100%;object-fit:cover;" alt="卡片图片">
                   </div>`
                  : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:var(--background-color);border:2px dashed var(--border-color);border-radius:4px;" onclick="startDirectTakePhoto(${originalIndex});event.stopPropagation();">
                       <mdui-icon name="add_a_photo" style="font-size:36px;color:var(--primary-color);opacity:0.6;"></mdui-icon>
                     </div>`
                }
            </td>

<td class="action-col">
    <mdui-button-icon icon="edit" class="edit-btn" data-index="${originalIndex}"></mdui-button-icon>
    <mdui-button-icon icon="delete" class="delete-row-btn" data-index="${originalIndex}"></mdui-button-icon>
</td>
        `;

        tbody.appendChild(row);
    });

    applySearchHighlight();
    bindRowEvents(); // 渲染完必绑事件
};
		/**
		 * 更新搜索结果计数显示（修复占位符暴露问题）
		 */
		function updateSearchResultCount() {
		  const resultCountEl = document.getElementById('searchResultCount');
		  if (!resultCountEl) return; // 防DOM元素不存在

		  const matchCount = searchMatches.length;
		  let countText = `找到 ${matchCount} 个匹配项`;

		  // 只有存在匹配项时，才显示当前匹配位置
		  if (matchCount > 0 && currentMatchIndex >= 0) {
		    const currentPos = currentMatchIndex + 1;
		    countText += ` (当前 ${currentPos}/${matchCount})`;
		  }

		  // 安全设置文本（核心修复：避免语法占位符暴露）
		  resultCountEl.textContent = countText;
		}
		// 新增：统一的高亮函数，便于在翻页或替换后调用
		function applySearchHighlight() {
		    const query = dom.searchInput.value.trim().toLowerCase();

		    // 如果没有搜索词，清除所有高亮和计数
		    if (!query || !isSearchActive) {
		        document.querySelectorAll('.search-match-highlight, .current-match-highlight').forEach(el => {
		            el.classList.remove('search-match-highlight', 'current-match-highlight');
		        });
		        dom.searchResultCount.textContent = '';
		        return;
		    }

		    // 清除旧高亮
		    document.querySelectorAll('.search-match-highlight, .current-match-highlight').forEach(el => {
		        el.classList.remove('search-match-highlight', 'current-match-highlight');
		    });

		    // 高亮当前页所有包含搜索词的单元格（无论替换面板是否打开）
		    document.querySelectorAll('#dataTable tbody tr').forEach(row => {
		        const rowIndex = parseInt(row.getAttribute('data-index'));
		        searchableFields.forEach(field => {
		            const cell = row.querySelector(`td[data-field="${field}"]`);
		            if (!cell) return;
		            const cellValue = (tableData[rowIndex][field] || '').toString().toLowerCase();
		            if (cellValue.includes(query)) {
		                cell.classList.add('search-match-highlight');
		            }
		        });
		    });

		    // 更新搜索结果计数（仅在替换面板打开时显示详细计数）
		    if (isSearchReplaceVisible) {
		        if (searchMatches.length === 0) {
		            dom.searchResultCount.textContent = '未找到匹配项';
		        } else {
		            // 防止越界
		            if (currentMatchIndex < 0) currentMatchIndex = 0;
		            if (currentMatchIndex >= searchMatches.length) currentMatchIndex = searchMatches.length - 1;

		            dom.searchResultCount.textContent = 
		                `找到 ${searchMatches.length} 个匹配项 (当前 \( {currentMatchIndex + 1}/ \){searchMatches.length})`;
		        }
		    } else {
		        // 替换面板关闭时，只显示找到多少个（不显示当前第几个）
		        dom.searchResultCount.textContent = searchMatches.length > 0 
		            ? `找到 ${searchMatches.length} 个匹配项` 
		            : '';
		    }

		    // 如果有当前匹配项，高亮边框并滚动（仅在替换面板打开时）
		    if (isSearchReplaceVisible && currentMatchIndex !== -1 && searchMatches.length > 0) {
		        highlightAndScrollToCurrentMatch();
		    }

            // Zoom Manager Update Hook
            ZoomManager.onTableUpdate();
		}

		// 高亮当前匹配项并滚动
		function highlightAndScrollToCurrentMatch() {
		    // 先清除旧高亮
		    document.querySelectorAll('.search-match-highlight, .current-match-highlight').forEach(el => {
		        el.classList.remove('search-match-highlight', 'current-match-highlight');
		    });

		    const match = searchMatches[currentMatchIndex];
		    const targetRow = document.querySelector(`tbody tr[data-index="${match.rowIndex}"]`);
		    if (!targetRow) return;

		    // 高亮该行所有匹配字段
		    searchableFields.forEach(field => {
		        const cell = targetRow.querySelector(`td[data-field="${field}"]`);
		        if (!cell) return;
		        const cellValue = (tableData[match.rowIndex][field] || '').toString().toLowerCase();
		        const query = dom.searchInput.value.trim().toLowerCase();
		        if (query && cellValue.includes(query)) {
		            cell.classList.add('search-match-highlight');
		        }
		    });

		    // 当前匹配字段加边框高亮
		    const currentCell = targetRow.querySelector(`td[data-field="${match.field}"]`);
		    if (currentCell) {
		        currentCell.classList.add('current-match-highlight');

		        // 平滑滚动到单元格
		        const container = document.querySelector('.data-table-container');
		        if (container) {
		            const cellRect = currentCell.getBoundingClientRect();
		            const containerRect = container.getBoundingClientRect();

		            const offsetTop = container.scrollTop + cellRect.top - containerRect.top - (containerRect.height / 2) + (cellRect.height / 2);
		            const offsetLeft = container.scrollLeft + cellRect.left - containerRect.left - (containerRect.width / 3);

		            container.scrollTo({
		                top: offsetTop,
		                left: Math.max(0, offsetLeft),
		                behavior: 'smooth'
		            });
		        }
		    }
		}

		
// ==========================================
// === Search & Replace Logic ===
// ==========================================
// 匹配项导航(上一个/下一个) - 修复边界计算冗余+逻辑优化
function navigateMatch(direction) {
    if (searchMatches.length === 0) return;

    currentMatchIndex += direction;
    // ✅ 优化：极简循环边界处理，替代原有的两个if判断，逻辑不变更简洁
    currentMatchIndex = (currentMatchIndex + searchMatches.length) % searchMatches.length;

    updateCurrentMatchUI();
}

// 更新匹配UI+计数+高亮+翻页 - 核心修复 所有显示/高亮BUG
function updateCurrentMatchUI() {
    // ✅ 修复1：空匹配时 计数文本兜底优化，永不显示占位符
    dom.searchResultCount.textContent = searchMatches.length === 0 
        ? `找到 0 个匹配项` 
        : `找到 ${searchMatches.length} 个匹配项 (当前 ${currentMatchIndex + 1}/${searchMatches.length})`;

    // 先清除所有旧高亮 - 保留原逻辑
    document.querySelectorAll('.search-match-highlight').forEach(el => 
        el.classList.remove('search-match-highlight'));
    document.querySelectorAll('.current-match-highlight').forEach(el => 
        el.classList.remove('current-match-highlight'));

    if (searchMatches.length === 0) return;

    const match = searchMatches[currentMatchIndex];
    const rowIndex = match.rowIndex;

    // === 关键：自动翻到包含该行的页面 ===
    const filteredData = getFilteredData();
    const displayIndex = filteredData.indexOf(tableData[rowIndex]);
    if (displayIndex !== -1) {
        const targetPage = Math.floor(displayIndex / PAGE_SIZE) + 1;
        if (currentPage !== targetPage) {
            currentPage = targetPage;
            updateTable(); 
            // ✅ 修复2：延长延迟时间+加容错，解决翻页后DOM未渲染完成导致高亮丢失的问题
            setTimeout(highlightCurrentMatchCell, 200); 
        } else {
            highlightCurrentMatchCell();
        }
    } else {
        highlightCurrentMatchCell();
    }
}

// 高亮当前匹配单元格+平滑滚动 - 保留原逻辑 无改动
function highlightCurrentMatchCell() {
    const match = searchMatches[currentMatchIndex];
    const row = document.querySelector(`tbody tr[data-index="${match.rowIndex}"]`);
    if (!row) return;

    // 高亮该行所有包含搜索词的单元格
    searchableFields.forEach(field => {
        const cell = row.querySelector(`td[data-field="${field}"]`);
        if (cell) {
            const query = dom.searchInput.value.trim().toLowerCase();
            const cellValue = (tableData[match.rowIndex][field] || '').toString().toLowerCase();
            if (query && cellValue.includes(query)) {
                cell.classList.add('search-match-highlight');
            }
        }
    });

    // 当前匹配字段加粗边框高亮
    const currentCell = row.querySelector(`td[data-field="${match.field}"]`);
    if (currentCell) {
        currentCell.classList.add('current-match-highlight');

        // 平滑滚动到当前单元格
        const container = document.querySelector('.data-table-container');
        if (container) {
            const cellRect = currentCell.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            const offset = container.scrollTop + cellRect.top - containerRect.top - (containerRect.height / 2) + (cellRect.height / 2);
            container.scrollTo({ top: offset, behavior: 'smooth' });
        }
    }
}

// 替换当前匹配项 - ✅ 核心修复3：替换后自动跳转下一个+保留匹配列表+计数同步+不丢失搜索状态
function replaceOne() {
    if (currentMatchIndex === -1 || searchMatches.length === 0) {
        showSnackbar('没有选中的匹配项可替换', 'warning');
        return;
    }

    const match = searchMatches[currentMatchIndex];
    const newText = dom.replaceQueryInput.value.trim();
    const oldText = dom.searchInput.value.trim();

    if (!oldText) {
        showSnackbar('搜索词不能为空', 'warning');
        return;
    }

    const rowIndex = match.rowIndex;
    const fieldId = match.field;
    const originalValue = tableData[rowIndex][fieldId] || '';

    const regex = new RegExp(escapeRegExp(oldText), 'gi');
    const newValue = originalValue.replace(regex, newText);

    let isReplaced = false;
    if (newValue !== originalValue) {
        tableData[rowIndex][fieldId] = newValue;
        saveDataToIndexedDB();
        showSnackbar(`已替换当前匹配项`, 'success');
        isReplaced = true;
    } else {
        showSnackbar('当前匹配项无需替换', 'info');
    }

    // ✅ 修复4：替换后核心逻辑重构 - 原有startSearch会重置所有状态，改为「保留搜索+跳转到下一个」
    if (isReplaced && searchMatches.length > 0) {
        // 删除当前已替换的匹配项，避免重复匹配
        searchMatches.splice(currentMatchIndex, 1);
        // 如果还有匹配项，自动定位到下一个，否则重置状态
        if (searchMatches.length > 0) {
            // 边界处理：如果删到最后一项，回到第一项
            currentMatchIndex = currentMatchIndex >= searchMatches.length ? 0 : currentMatchIndex;
            updateTable();
            setTimeout(() => {
                updateCurrentMatchUI(); // 同步更新计数+高亮下一个
            }, 200);
        } else {
            // 无匹配项了，清空搜索状态
            currentMatchIndex = -1;
            isSearchActive = false;
            updateTable();
            updateCurrentMatchUI();
            showSnackbar('所有匹配项已替换完成', 'success');
        }
    } else {
        // 未替换则跳转到下一个匹配项
        navigateMatch(1);
    }
}

// 替换全部的确认弹窗 - ✅ 修复5：替换后计数/高亮/搜索状态完全清空，无残留
function confirmReplaceAll() {
    const oldText = dom.searchInput.value.trim();
    const newText = dom.replaceQueryInput.value.trim();

    if (!oldText) {
        showSnackbar('搜索词不能为空', 'warning');
        return;
    }

    if (searchMatches.length === 0) {
        showSnackbar('没有匹配项可替换', 'warning');
        return;
    }

    dom.confirmMessage.innerHTML = `
        <div style="text-align:center;">
            <p>确定将所有 <strong style="color:var(--primary-color);">${escapeHtml(oldText)}</strong> 
               替换为 <strong style="color:#f44336;">${escapeHtml(newText || '(空)')}</strong> 吗？</p>
            <p style="margin-top:12px;color:#757575;">共将影响 ${searchMatches.length} 处</p>
        </div>
    `;

    openCustomModal(dom.confirmModal);

    dom.confirmActionBtn.onclick = () => {
        let replaceCount = 0;
        const regex = new RegExp(escapeRegExp(oldText), 'gi');

        tableData.forEach(item => {
            searchableFields.forEach(field => {
                const val = (item[field] || '').toString();
                if (val.toLowerCase().includes(oldText.toLowerCase())) {
                    const newVal = val.replace(regex, newText);
                    if (newVal !== val) {
                        item[field] = newVal;
                        replaceCount++;
                    }
                }
            });
        });

        saveDataToIndexedDB();

        if (replaceCount > 0) {
            showSnackbar(`成功替换 ${replaceCount} 处！`, 'success');
        } else {
            showSnackbar('没有发生实际替换', 'info');
        }

        // ✅ 修复6：替换全部后 彻底清空所有搜索相关状态 + 更新计数UI
        updateTable();
        dom.searchInput.value = '';
        dom.replaceQueryInput.value = '';
        searchTerm = '';
        isSearchActive = false;
        searchMatches = [];
        currentMatchIndex = -1;
        updateCurrentMatchUI(); // 同步清空计数文本
        toggleSearchReplaceVisibility();

        closeCustomModal(dom.confirmModal);
        dom.confirmActionBtn.onclick = null;
    };
}

// 辅助函数：HTML转义和正则转义 - 保留原逻辑 无改动
function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ✅ 修复7：删除重复定义的replaceAll函数（你代码里写了2次replaceAll，此处保留确认弹窗版本即可，删除冗余的）
		function jumpToMatch(matchIndex) {
		    if (matchIndex < 0 || matchIndex >= searchMatches.length) return;

		    currentMatchIndex = matchIndex;
		    const match = searchMatches[currentMatchIndex];
		    const targetRowIndex = match.rowIndex; // 这是全局 tableData 中的索引

		    // 计算目标页面
		    const targetPage = Math.floor(targetRowIndex / PAGE_SIZE) + 1;

		    // 如果不在当前页，先翻页
		    if (currentPage !== targetPage) {
		        currentPage = targetPage;
		        updateTable(); // 渲染新页面

		        // 等待 DOM 更新完成后高亮并滚动
		        requestAnimationFrame(() => {
		            setTimeout(highlightAndScrollToCurrentMatch, 100);
		        });
		    } else {
		        // 同页直接高亮滚动
		        highlightAndScrollToCurrentMatch();
		    }

		    // 更新计数显示
		    dom.searchResultCount.textContent = 
		        `找到 ${searchMatches.length} 个匹配项 (当前 \( {currentMatchIndex + 1}/ \){searchMatches.length})`;
		}

		
// ==========================================
// === Pagination & Table Rendering ===
// ==========================================
function renderPaginationControls(totalFiltered) {
		    // 移除旧的分页控件
		    const oldPagination = document.getElementById('paginationControls');
		    if (oldPagination) oldPagination.remove();

		    if (totalPages <= 1) return;

		    const paginationDiv = document.createElement('div');
		    paginationDiv.id = 'paginationControls';
		    paginationDiv.style.cssText = `
		        display: flex; 
		        justify-content: center; 
		        align-items: center; 
		        gap: 8px; 
		        padding: 16px; 
		        background-color: var(--surface-color);

		    `;

		    // ==================== 上一页按钮 ====================
		    const prevBtn = document.createElement('mdui-button-icon');
		    prevBtn.icon = 'navigate_before';
		    prevBtn.disabled = currentPage === 1;

		    let prevLongPressTimer = null;
		    const LONG_PRESS_DELAY = 500;

		    prevBtn.addEventListener('click', (e) => {
		        e.stopPropagation();
		        if (currentPage > 1) {
		            currentPage--;
		            updateTable();
		            scrollToTopSmooth();
		            updatePageInfoDisplay();
		            prevBtn.disabled = currentPage === 1;
		            nextBtn.disabled = currentPage === totalPages;
		        }
		    });

		    // 长按跳到第一页
		    prevBtn.addEventListener('pointerdown', (e) => {
		        if (currentPage === 1) return;
		        prevLongPressTimer = setTimeout(() => {
		            currentPage = 1;
		            updateTable();
		            scrollToTopSmooth();
		            updatePageInfoDisplay();
		            prevBtn.disabled = true;
		            nextBtn.disabled = currentPage === totalPages;
		        }, LONG_PRESS_DELAY);
		    });

		    prevBtn.addEventListener('pointerup', () => clearTimeout(prevLongPressTimer));
		    prevBtn.addEventListener('pointercancel', () => clearTimeout(prevLongPressTimer));
		    prevBtn.addEventListener('pointerleave', () => clearTimeout(prevLongPressTimer));

		    // ==================== 下一页按钮 ====================
		    const nextBtn = document.createElement('mdui-button-icon');
		    nextBtn.icon = 'navigate_next';
		    nextBtn.disabled = currentPage === totalPages;

		    let nextLongPressTimer = null;

		    nextBtn.addEventListener('click', (e) => {
		        e.stopPropagation();
		        if (currentPage < totalPages) {
		            currentPage++;
		            updateTable();
		            scrollToTopSmooth();
		            updatePageInfoDisplay();
		            prevBtn.disabled = currentPage === 1;
		            nextBtn.disabled = currentPage === totalPages;
		        }
		    });

		    // 长按跳到最后一页
		    nextBtn.addEventListener('pointerdown', (e) => {
		        if (currentPage === totalPages) return;
		        nextLongPressTimer = setTimeout(() => {
		            currentPage = totalPages;
		            updateTable();
		            scrollToTopSmooth();
		            updatePageInfoDisplay();
		            nextBtn.disabled = true;
		            prevBtn.disabled = currentPage === 1;
		        }, LONG_PRESS_DELAY);
		    });

		    nextBtn.addEventListener('pointerup', () => clearTimeout(nextLongPressTimer));
		    nextBtn.addEventListener('pointercancel', () => clearTimeout(nextLongPressTimer));
		    nextBtn.addEventListener('pointerleave', () => clearTimeout(nextLongPressTimer));

		    // ==================== 页码显示与输入 ====================
		    const pageInfoContainer = document.createElement('div');
		    pageInfoContainer.style.display = 'flex';
		    pageInfoContainer.style.alignItems = 'center';
		    pageInfoContainer.style.minWidth = '80px';
		    pageInfoContainer.style.justifyContent = 'center';

		    const pageInfoText = document.createElement('span');
		    pageInfoText.textContent = `第 ${currentPage} / ${totalPages} 页`;
		    pageInfoText.style.fontSize = '0.95rem';
		    pageInfoText.style.color = '#757575';
		    pageInfoText.style.cursor = 'pointer';
		    pageInfoText.style.userSelect = 'none';

		    const pageInput = document.createElement('input');
		    pageInput.type = 'number';
		    pageInput.value = currentPage;
		    pageInput.style.width = '60px';
		    pageInput.style.padding = '4px 8px';
		    pageInput.style.fontSize = '0.95rem';
		    pageInput.style.border = '1px solid var(--border-color)';
		    pageInput.style.borderRadius = '4px';
		    pageInput.style.textAlign = 'center';
		    pageInput.style.display = 'none';
		    pageInput.min = 1;
		    pageInput.max = totalPages;

		    pageInfoContainer.appendChild(pageInfoText);
		    pageInfoContainer.appendChild(pageInput);

		    pageInfoText.addEventListener('click', () => {
		        pageInfoText.style.display = 'none';
		        pageInput.style.display = 'inline-block';
		        pageInput.focus();
		        pageInput.select();
		    });

		    function confirmPageJump() {
		        let targetPage = parseInt(pageInput.value);
		        targetPage = Math.max(1, Math.min(totalPages, isNaN(targetPage) ? currentPage : targetPage));
		        if (targetPage !== currentPage) {
		            currentPage = targetPage;
		            updateTable();
		            scrollToTopSmooth();
		        }
		        prevBtn.disabled = currentPage === 1;
		        nextBtn.disabled = currentPage === totalPages;
		        updatePageInfoDisplay();
		    }

		    pageInput.addEventListener('keydown', (e) => {
		        if (e.key === 'Enter') {
		            e.preventDefault();
		            confirmPageJump();
		        }
		    });

		    pageInput.addEventListener('blur', confirmPageJump);

		    function updatePageInfoDisplay() {
		        pageInfoText.textContent = `第 ${currentPage} / ${totalPages} 页`;
		        pageInput.value = currentPage;
		        pageInput.max = totalPages;
		        pageInput.style.display = 'none';
		        pageInfoText.style.display = 'inline-block';
		    }

		    paginationDiv.appendChild(prevBtn);
		    paginationDiv.appendChild(pageInfoContainer);
		    paginationDiv.appendChild(nextBtn);

		    const tableContainerDiv = document.querySelector('.data-table-container-div');
		    tableContainerDiv.parentNode.insertBefore(paginationDiv, tableContainerDiv.nextSibling);
		}

		function scrollToTopSmooth() {
		    const container = document.querySelector('.data-table-container');
		    if (container) {
		        container.scrollTo({ top: 0, behavior: 'smooth' });
		    }
		}

// ==============================================
// 绑定表格行所有事件 - 完整修复版 (包含上移/下移按钮点击事件，必替换)
// ==============================================
function bindRowEvents() {
    // 解绑所有原有事件，防止重复绑定导致多次执行
    document.querySelectorAll('#dataTable tbody tr').forEach(row => {
        row.onclick = null;
    });

    // 绑定行点击事件
    document.querySelectorAll('#dataTable tbody tr').forEach(row => {
        const idx = parseInt(row.getAttribute('data-index'));
        row.onclick = (e) => {
            // 如果点击的是【按钮/复选框/图片】，阻止行事件冒泡，避免冲突
            if (e.target.closest('.edit-btn, .delete-btn, .move-btn, .row-checkbox, .image-col, .up-btn, .down-btn')) {
                return;
            }
            // 多选模式：点击行选中/取消选中
            if (isMultiSelectMode) {
                const checkbox = row.querySelector('.row-checkbox');
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                }
                return;
            }
            // 普通模式：点击行打开编辑弹窗
            //openEditModal(idx);
        };

        // ✅ 复选框勾选事件 (原有保留)
        const rowCheckbox = row.querySelector('.row-checkbox');
        if (rowCheckbox) {
            rowCheckbox.onchange = (e) => {
                e.stopPropagation();
                const isChecked = rowCheckbox.checked;
                const index = parseInt(rowCheckbox.getAttribute('data-index'));
                if (isChecked) {
                    selectedRows.add(index);
                    row.classList.add('selected');
                } else {
                    selectedRows.delete(index);
                    row.classList.remove('selected');
                }
                updateTable();
            };
        }

        // ✅ 编辑按钮事件 (原有保留)
        const editBtn = row.querySelector('.edit-btn');
        if (editBtn) {
            editBtn.onclick = (e) => {
                e.stopPropagation();
                openEditModal(idx);
            };
        }

document.querySelectorAll('.delete-row-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const index = parseInt(e.currentTarget.getAttribute('data-index'));

        // 调用你的原有确认删除整行函数
        confirmDeleteRow(index);

        // 确保在 confirmDeleteRow 内部处理弹窗关闭
        // （见下面第3步的 confirmDeleteRow 修改）
    });
});

        // ✅ 删除按钮事件 (原有保留)
        const deleteBtn = row.querySelector('.delete-btn');
        if (deleteBtn) {
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                window.tempDeleteImageIndex = idx;

                document.getElementById('deleteImageConfirmDialog').open = true;
            };
        }

// ========== 上移按钮 【手机+电脑通用】纯按压长按检测 (无鼠标事件，保留不变) ==========
const upBtn = row.querySelector('.up-btn');
if (upBtn) {
    let pressTimer = null;
    let isLongPress = false;
    let isPressed = false;
    const moveIdx = parseInt(upBtn.getAttribute('data-index'));
    const handleStart = (e) => {
        e.stopPropagation();
        e.preventDefault();
        isPressed = true;
        isLongPress = false;
        pressTimer = setTimeout(() => {
            if (isPressed) {
                isLongPress = true;
                moveRowToAssignPosition(moveIdx, -1);
            }
        }, 500);
    };
    const handleEnd = (e) => {
        e.stopPropagation();
        e.preventDefault();
        isPressed = false;
        clearTimeout(pressTimer);
        if (!isLongPress) {
            moveRow(moveIdx, -1);
        }
        isLongPress = false;
    };
    upBtn.addEventListener('touchstart', handleStart);
    upBtn.addEventListener('mousedown', handleStart);
    upBtn.addEventListener('touchend', handleEnd);
    upBtn.addEventListener('mouseup', handleEnd);
    upBtn.addEventListener('touchcancel', handleEnd);
    upBtn.addEventListener('mouseleave', handleEnd);
}

// ========== 下移按钮 【手机+电脑通用】纯按压长按检测 (无鼠标事件，保留不变) ==========
const downBtn = row.querySelector('.down-btn');
if (downBtn) {
    let pressTimer = null;
    let isLongPress = false;
    let isPressed = false;
    const moveIdx = parseInt(downBtn.getAttribute('data-index'));
    const handleStart = (e) => {
        e.stopPropagation();
        e.preventDefault();
        isPressed = true;
        isLongPress = false;
        pressTimer = setTimeout(() => {
            if (isPressed) {
                isLongPress = true;
                moveRowToAssignPosition(moveIdx, 1);
            }
        }, 500);
    };
    const handleEnd = (e) => {
        e.stopPropagation();
        e.preventDefault();
        isPressed = false;
        clearTimeout(pressTimer);
        if (!isLongPress) {
            moveRow(moveIdx, 1);
        }
        isLongPress = false;
    };
    downBtn.addEventListener('touchstart', handleStart);
    downBtn.addEventListener('mousedown', handleStart);
    downBtn.addEventListener('touchend', handleEnd);
    downBtn.addEventListener('mouseup', handleEnd);
    downBtn.addEventListener('touchcancel', handleEnd);
    downBtn.addEventListener('mouseleave', handleEnd);
}
    });

    // 表头全选复选框事件 (原有保留)
    const headerCheckbox = document.querySelector('#dataTable thead th.checkbox-col mdui-checkbox');
    if (headerCheckbox && isMultiSelectMode) {
        headerCheckbox.onchange = (e) => {
            e.stopPropagation();
            const isChecked = headerCheckbox.checked;
            const currentPageRows = document.querySelectorAll('#dataTable tbody tr');
            currentPageRows.forEach(row => {
                const idx = parseInt(row.getAttribute('data-index'));
                const cb = row.querySelector('.row-checkbox');
                if (cb) cb.checked = isChecked;
                if (isChecked) {
                    selectedRows.add(idx);
                    row.classList.add('selected');
                } else {
                    selectedRows.delete(idx);
                    row.classList.remove('selected');
                }
            });
            updateTable();
        };
    }
};

		function confirmDeleteRow(index) {
    // 使用深拷贝备份整条数据（确保图片等复杂字段完整）
    const itemToDelete = structuredClone(tableData[index]); // 现代浏览器原生深拷贝
    // 如果浏览器不支持 structuredClone，可替换为：JSON.parse(JSON.stringify(tableData[index]))

    const deletedIndex = index;

    // 增强版确认消息：显示更多字段 + 二次确认复选框
    const message = `
        <div style="text-align: left; font-size: 1rem; line-height: 1.8;">
            <div style="margin-bottom: 6px; font-weight: 500;">
                您确定要删除以下数据吗？（此操作不可逆）
            </div>

            <div style="padding: 4px; background-color: var(--background-color); border-radius: 8px; border: 1px solid var(--border-color);">
                <div style="display: grid; grid-template-columns: max-content 1fr; gap: 6px 10px; align-items: center;">
                    <strong style="color: #757575;">产品号：</strong>
                    <strong style="color: var(--primary-color); font-size: 1.1em; word-break: break-all;">
                        ${itemToDelete.productId || 'N/A'}
                    </strong>

                    <strong style="color: #757575;">钢种：</strong>
                    <span>${itemToDelete.steelType || 'N/A'}</span>

                    <strong style="color: #757575;">卡片号：</strong>
                    <span>${itemToDelete.cardId || 'N/A'}</span>

                    <strong style="color: #757575;">炉号：</strong>
                    <span>${itemToDelete.furnaceId || 'N/A'}</span>

                    <strong style="color: #757575;">实际直径：</strong>
                    <span>${itemToDelete.actualDiameter || 'N/A'}</span>

                    <strong style="color: #757575;">直径：</strong>
                    <span>${itemToDelete.diameter || 'N/A'}</span>

                    <strong style="color: #757575;">长度：</strong>
                    <span>${itemToDelete.length || 'N/A'} mm</span>

                    <strong style="color: #757575;">重量：</strong>
                    <span style="font-weight: 600;">${itemToDelete.weight || 'N/A'} Kg</span>

                    <strong style="color: #757575;">状态：</strong>
                    <span>${itemToDelete.status || 'N/A'}</span>

                    <strong style="color: #757575;">位置：</strong>
                    <span>${itemToDelete.position || 'N/A'}</span>

                    <strong style="color: #757575;">硬度：</strong>
                    <span>${itemToDelete.hardness || 'N/A'}</span>

                    ${itemToDelete.remarks ? 
                        `<strong style="color: #757575; grid-column: 1;">备注：</strong>
                         <span style="grid-column: 2; word-break: break-all; color: #e91e63;">${itemToDelete.remarks}</span>` 
                        : ''
                    }
                </div>
            </div>

            <!-- 二次确认复选框 -->
            <div style="margin-top: 16px; padding: 12px; background: rgba(var(--primary-color-rgb), 0.08); border-radius: 8px;">
                <mdui-checkbox id="confirmDeleteCheck">
                    我确认要永久删除这条数据（不可恢复）
                </mdui-checkbox>
            </div>
        </div>
    `;

    dom.confirmMessage.innerHTML = message;
    openCustomModal(dom.confirmModal);

    // 确认按钮逻辑
    document.getElementById('confirmActionBtn').onclick = () => {
        const check = document.getElementById('confirmDeleteCheck');
        if (!check || !check.checked) {
            showSnackbar('滑动到底部勾选“我确认要永久删除”再确认', 'warning');
            return;
        }

        // 执行删除
        tableData.splice(index, 1);
        selectedRows.clear();
        saveDataToIndexedDB();
        updateTable();

        // 关闭确认弹窗
        closeCustomModal(dom.confirmModal);

        // 清空复选框状态，防止下次误勾
        if (check) check.checked = false;

        // 显示带“撤销”按钮的 Snackbar
        const snackbar = document.getElementById('general-snackbar');
        snackbar.innerHTML = `
            已删除 <strong>${itemToDelete.productId || '未知'}</strong>
            <mdui-button variant="text" style="margin-left:16px; color: var(--primary-color);" id="undoDeleteBtn">
                撤销
            </mdui-button>
        `;
        snackbar.open = true;

        // 8秒后自动关闭（时间更宽容，可自行调整）
        setTimeout(() => {
            snackbar.open = false;
        }, 8000);

        // 撤销按钮：使用深拷贝恢复（图片也会回来）
        document.getElementById('undoDeleteBtn')?.addEventListener('click', () => {
            // 插入回原位置，使用深拷贝确保完整
            tableData.splice(deletedIndex, 0, structuredClone(itemToDelete));
            saveDataToIndexedDB();
            updateTable();
            showSnackbar('已撤销删除，数据（含图片）已恢复', 'success');
            //snackbar.open = false;
        }, { once: true }); // 只监听一次，避免重复绑定
    };

    // 取消按钮：直接关闭弹窗
    document.getElementById('cancelConfirmBtn').onclick = () => {
        closeCustomModal(dom.confirmModal);
        const check = document.getElementById('confirmDeleteCheck');
        if (check) check.checked = false;
    };
}

// ========== 表格行【短按】上移/下移核心函数 (无提示，保留不变) ==========
function moveRow(rowIndex, direction) {
  if (tableData.length <= 1) return; 
  const targetIndex = rowIndex + direction;
  if (targetIndex < 0 || targetIndex >= tableData.length) return;
  [tableData[rowIndex], tableData[targetIndex]] = [tableData[targetIndex], tableData[rowIndex]];
  saveDataToIndexedDB(); 
  updateTable(); 
}

// ========== 表格行【长按】指定位置移动核心函数 (✅修复：弹窗高亮+完美兼容分页+搜索过滤) ==========
function moveRowToAssignPosition(sourceIndex, direction) {
  if (tableData.length <= 1) return;
  let rowOptionsHtml = '';
  // 遍历【全部数据】tableData，兼容分页/搜索，显示所有行的真实序号
  tableData.forEach((item, idx) => {
    if (idx !== sourceIndex) { // 排除当前行，禁止移动到自己位置
      // ✅ 新增：当前行的原始序号+分页兼容的显示文本
      const rowLabel = `第 ${idx+1} 行 (${item.productId || '无编号'})(${item.cardId || '无卡片号'})(${item.steelType || '无钢种'})`;
      rowOptionsHtml += `
        <div class="row-option-item" data-target-index="${idx}" style="padding:8px 12px; cursor:pointer; border-radius:6px; margin:2px 0; transition:all 0.2s;">
          <span style="font-weight:500; font-size:0.95rem;">${rowLabel}</span>
        </div>
      `;
    }
  });

  // 弹窗文案不变，精准对应需求：上移=目标行上方，下移=目标行下方
  const titleText = direction === -1 ? '移动到指定行【上方】' : '移动到指定行【下方】';
  const descText = direction === -1 ? '选择目标行，当前行会插入到该行上方' : '选择目标行，当前行会插入到该行下方';
  dom.confirmMessage.innerHTML = `
    <div style="width:340px; max-height:420px; overflow-y:auto; padding:4px 0;">
      <h4 style="margin:0 0 10px 0; font-size:1rem; text-align:center; color:#333;">${titleText}</h4>
      <p style="margin:0 0 14px 0; color:#757575; font-size:0.9rem; text-align:center;">${descText}</p>
      <div class="row-options-list" style="display:flex; flex-direction:column;">
        ${rowOptionsHtml}
      </div>
    </div>
  `;

  openCustomModal(dom.confirmModal);
  let targetIndex = -1;
  const allOptions = document.querySelectorAll('.row-option-item');

  // ✅ 修复核心1：弹窗渲染完成后立即绑定点击事件，确保100%生效+高亮反馈
  allOptions.forEach(item => {
    // 点击选中：高亮+赋值目标索引，必生效
    item.addEventListener('click', (e) => {
      e.stopPropagation();
      targetIndex = parseInt(e.currentTarget.getAttribute('data-target-index'));
      // 清除所有旧高亮，只高亮当前选中行
      allOptions.forEach(el => {
        el.style.background = '';
        el.style.color = '';
      });
      // ✅ 醒目高亮样式，选中后一眼能看到
      e.currentTarget.style.background = 'var(--primary-color)';
      e.currentTarget.style.color = '#ffffff';
    });
    // 手机端兼容：触摸也触发高亮
    item.addEventListener('touchend', (e) => {
      e.stopPropagation();
      item.click();
    });
  });

  // ✅ 确认移动按钮事件 (✅修复核心2：分页自动跳转逻辑+精准移动)
  dom.confirmActionBtn.onclick = () => {
    if (targetIndex === -1 || targetIndex === sourceIndex) {
      showSnackbar('请选择有效的目标行', 'warning');
      closeCustomModal(dom.confirmModal);
      dom.confirmActionBtn.onclick = null;
      return;
    }

    // ✅ 核心：移动逻辑 - 区分【上方】和【下方】
    const movedItem = tableData.splice(sourceIndex, 1)[0];
    if (direction === -1) {
      // 长按上 → 插入到目标行的【上方】
      tableData.splice(targetIndex, 0, movedItem);
      showSnackbar(`已移动至${targetIndex}`, 'warning');
    } else {
      // 长按下 → 插入到目标行的【下方】
      tableData.splice(targetIndex + 1, 0, movedItem);
      showSnackbar(`已移动至${targetIndex + 1}`, 'warning');
    }

    // 移动完成：持久化+刷新表格

    saveDataToIndexedDB();
    updateTable();
    closeCustomModal(dom.confirmModal);
    dom.confirmActionBtn.onclick = null;
  };
}

		// 兼容你的分页/搜索场景：如果有置顶/置底需求，可追加这两个函数（可选）
function moveRowToTop(rowIndex) {
  if (rowIndex === 0) return;
  const movedItem = tableData.splice(rowIndex, 1)[0];
  tableData.unshift(movedItem);
  saveDataToIndexedDB();
  updateTable();
  showSnackbar('行已置顶', 'success');
}
function moveRowToBottom(rowIndex) {
  if (rowIndex === tableData.length -1) return;
  const movedItem = tableData.splice(rowIndex, 1)[0];
  tableData.push(movedItem);
  saveDataToIndexedDB();
  updateTable();
  showSnackbar('行已置底', 'success');
}

		function deleteSelected() {
		  const sortedIndexes = Array.from(selectedRows).sort((a, b) => b - a);
		  sortedIndexes.forEach(index => tableData.splice(index, 1));
		  const deletedCount = sortedIndexes.length;
		  selectedRows.clear();
		  dom.selectAllCheckbox.checked = false;
		  saveDataToIndexedDB();
		  updateTable();
		  showSnackbar(`成功删除 ${deletedCount} 条数据`, 'success');
		}

		function openAddModal() {
		  openAddModalWithData({});
		}

			function openAddModalWithData(preFilledData) {
    if (dom.dataForm) dom.dataForm.reset();
    if (dom.modalTitle) dom.modalTitle.textContent = '添加数据';
    if (dom.editIndex) dom.editIndex.value = '-1';

    currentEditIndex = -1;

    // ★★★ 新增：彻底清理所有图片相关状态 ★★★
    const previewImg = document.getElementById('previewImg');
    if (previewImg) {
        previewImg.src = '';                    // 清空 src，防止闪现
        previewImg.removeAttribute('src');      // 双保险
    }

    const previewContainer = document.getElementById('cardImagePreview');
    const noImageArea = document.getElementById('noImageUploadArea');
    if (previewContainer && noImageArea) {
        previewContainer.style.display = 'none';
        noImageArea.style.display = 'block';
    }

    // 清理临时图片变量（防止保存时带入旧图）
    delete window.tempNewCardImage;

    // 填充预设数据（如果有）
    for (const key in preFilledData) {
        if (preFilledData.hasOwnProperty(key) && formElements[key]) {
            formElements[key].value = preFilledData[key];
        }
    }

    openCustomModal(dom.dataSheet);

    setTimeout(() => {
        // 再次确保图片区干净（防止 DOM 渲染延迟导致闪现）
        if (previewImg) {
            previewImg.src = '';
            previewImg.removeAttribute('src');
        }
        if (previewContainer && noImageArea) {
            previewContainer.style.display = 'none';
            noImageArea.style.display = 'block';
        }

        // 键盘逻辑保持不变...
        let inputToFocus = formElements.steelType;
        inputFields.forEach(field => {
            if (field.id !== 'remarks') {
                field.setAttribute('readonly', 'true');
                field.classList.add('readonly-input');
            }
            if (field.id === 'steelType') inputToFocus = field;
        });

        currentInput = inputToFocus;
        if (currentInput.id !== 'remarks') {
            updateKeyboardForInput(currentInput);
            showVirtualKeyboard();
        }
        currentInput.focus();
    }, 350);
}

function findDuplicates(newItem) {
    const duplicates = [];
    tableData.forEach((existingItem, index) => {
        if (newItem.productId && newItem.productId.trim() !== '' &&
            existingItem.productId && existingItem.productId.trim() === newItem.productId.trim()) {
            duplicates.push({
                index,
                productId: newItem.productId,
                existingItem,
                newItem,
                differences: getObjectDifferences(existingItem, newItem)
            });
        }
    });
    return duplicates;
}

		function highlightAndScrollToRow(index) {
		  setTimeout(() => {
		    const row = document.querySelector(`tbody tr[data-index="${index}"]`);
		    if (row) {
		      document.querySelectorAll('#dataTable .highlight').forEach(r => r.classList.remove('highlight'));
		      row.classList.add('highlight');
		      setTimeout(() => row.classList.remove('highlight'), 2000);
		      const container = document.querySelector('.data-table-container');
		      if (container) {
		          const rowRect = row.getBoundingClientRect();
		          const containerRect = container.getBoundingClientRect();
		          const scrollTop = container.scrollTop;
		          const offset = rowRect.top - containerRect.top + scrollTop - (containerRect.height / 2) + (rowRect.height / 2);
		          container.scrollTo({ top: offset, behavior: 'smooth' });
		      } else {
		        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
		      }
		    }
		  }, 100);
		}

		function openQuickEdit(index, fieldId) {
		    const item = tableData[index];
		    const fieldName = fieldLabels[fieldId] || fieldId;

		    dom.quickEditLabel.textContent = fieldName;
		    dom.quickEditInput.value = item[fieldId] || '';
		    dom.quickEditIndex.value = index;
		    dom.quickEditField.value = fieldId;

		    dom.quickEditInput.setAttribute('readonly', 'true');
		    dom.quickEditInput.classList.add('readonly-input');

		    openCustomModal(dom.quickEditDialog);

		    currentInput = dom.quickEditInput;

		    // 关键：标记当前是快速编辑单字段模式
		    keyboardState.isQuickEdit = true;
		    saveKeyboardState();

		    updateKeyboardForInput(currentInput, fieldId); 
		    showVirtualKeyboard();

		    currentInput.focus();
		}
		function saveQuickEdit() {
		    const index = parseInt(dom.quickEditIndex.value);
		    const fieldId = dom.quickEditField.value;
		    const newValue = dom.quickEditInput.value.trim();

		    if (index >= 0 && index < tableData.length) {
		        if (['actualDiameter', 'diameter', 'length', 'weight', 'hardness'].includes(fieldId) && isNaN(parseFloat(newValue)) && newValue.length > 0) {
		            showSnackbar('请输入有效的数字或留空', 'error');
		            return;
		        }

		        tableData[index][fieldId] = newValue;
		        saveDataToIndexedDB();
		        updateTable();
		        closeCustomModal(dom.quickEditDialog);
		        dom.virtualKeyboard.style.display = 'none';
		        showSnackbar('快速修改已保存', 'success');

		keyboardState.isQuickEdit = false;
		saveKeyboardState();
		    }
		}

		// ==================== 搜索与替换优化版（支持自动翻页跳转）===================

function startSearch() {
    const query = dom.searchInput.value.trim().toLowerCase();

    searchMatches = [];
    currentMatchIndex = -1;

    if (!query) {
        isSearchActive = false;
        applySearchHighlight();
        dom.replaceOneBtn.disabled = true;
        dom.replaceAllBtn.disabled = true;
        updateCurrentMatchUI(); // ✅ 新增：清空搜索时同步更新计数
        updateTable(); 
        return;
    }

    // 构建匹配项
    tableData.forEach((item, index) => {
        searchableFields.forEach(field => {
            const value = (item[field] || '').toString().toLowerCase();
            if (value.includes(query)) {
                searchMatches.push({ rowIndex: index, field });
            }
        });
    });

    isSearchActive = true;
    const hasMatches = searchMatches.length > 0;
    dom.replaceOneBtn.disabled = !hasMatches;
    dom.replaceAllBtn.disabled = !hasMatches;

    currentPage = 1;
    updateTable();

    if (hasMatches) {
        currentMatchIndex = 0;
        updateCurrentMatchUI(); // ✅ 核心：搜索成功后立即更新计数+高亮，替代原jumpToMatch
    } else {
        applySearchHighlight();
        showSnackbar('未找到匹配项', 'info');
        updateCurrentMatchUI(); // ✅ 新增：无匹配时同步更新计数
    }
}

		function openEditModal(index, targetFieldId = null) {
		    currentEditIndex = index;
		    if (dom.editIndex) dom.editIndex.value = index;

		    const item = tableData[index];

		    // 填充表单字段
		    for (const key in formElements) {
		        if (formElements.hasOwnProperty(key)) {
		            formElements[key].value = item[key] || '';
		        }
		    }

		    dom.modalTitle.textContent = '编辑数据';
		    openCustomModal(dom.dataSheet);

		   setTimeout(() => {
		    const previewContainer = document.getElementById('cardImagePreview');
		    const noImageArea = document.getElementById('noImageUploadArea');
		    const previewImg = document.getElementById('previewImg');

		    if (item.cardImage && item.cardImage.startsWith('data:image/')) {
		        previewImg.src = item.cardImage;
		        previewContainer.style.display = 'block';
		        noImageArea.style.display = 'none';  // 隐藏上传按钮
		    } else {
		        previewContainer.style.display = 'none';
		        noImageArea.style.display = 'block'; // 显示上传按钮
		    }

		        // 输入框和键盘逻辑
		        let inputToFocus = formElements.steelType;

		        inputFields.forEach(field => {
		            if (field.id !== 'remarks') {
		                field.setAttribute('readonly', 'true');
		                field.classList.add('readonly-input');
		            } else {
		                field.removeAttribute('readonly');
		                field.classList.remove('readonly-input');
		            }
		            if (field.id === 'steelType') inputToFocus = field;
		        });

		        if (targetFieldId && formElements[targetFieldId]) {
		            inputToFocus = formElements[targetFieldId];
		        }

		        currentInput = inputToFocus;

		        if (currentInput.id === 'remarks') {
		            dom.virtualKeyboard.style.display = 'none';
		        } else {
		            currentInput.setAttribute('readonly', 'true');
		            currentInput.classList.add('readonly-input');
		            updateKeyboardForInput(currentInput);
		            showVirtualKeyboard();
		        }

		        currentInput.focus();

		        // 平滑滚动到当前输入框
		        const modalContent = document.getElementById('dataSheetContent');
		        if (modalContent) {
		            const inputRect = currentInput.getBoundingClientRect();
		            const modalRect = modalContent.getBoundingClientRect();
		            const offset = inputRect.top - modalRect.top + modalContent.scrollTop - modalRect.height * 0.3;
		            modalContent.scrollTo({ top: offset, behavior: 'smooth' });
		        }
		        bindEditModalImageButtons();
		    }, 350);
		}

		function closeVirtualKeyboardAndKeepReadOnly() {
		    dom.virtualKeyboard.style.display = 'none';
		    currentInput = null;
		}

		/* ==================== 虚拟键盘核心逻辑 ==================== */

		function saveKeyboardState() {
		  localStorage.setItem('keyboardState', JSON.stringify(keyboardState));
		}

		function toggleShift() {
		  switch (keyboardState.shiftState) {
		    case 'locked-on':   
		      keyboardState.shiftState = 'off';
		      break;
		    case 'off':         
		      keyboardState.shiftState = 'on';
		      break;
		    case 'on':          
		      keyboardState.shiftState = 'locked-on';
		      break;
		  }
		  saveKeyboardState();
		  generateVirtualKeyboard();
		}

		function createShortcutKeys(options, keyClass) {
		  const shortcutRow = document.createElement('div');
		  shortcutRow.className = 'keyboard-row';

		  options.forEach(option => {
		    const keyElement = document.createElement('div');
		    keyElement.className = `keyboard-key ${keyClass}`;
		    keyElement.textContent = option;
		    keyElement.addEventListener('click', () => {
		      if (currentInput) {
		        insertText(option);
		        currentInput.focus();
		      }
		    });
		    shortcutRow.appendChild(keyElement);
		  });

		  dom.shortcutContainer.appendChild(shortcutRow);
		}

		
// ==========================================
// === Virtual Keyboard Logic ===
// ==========================================

// 默认配置
const DEFAULT_KEYBOARD_CONFIG = {
    furnaceIdTemplates: [
        '1251', 
        'VD25/', 
        '1250', 
        '251050', 
        '251051', 
        '25D0', 
        '25C0', 
        'VD26/',
        'VD${year}/',       
        'VD${lastYear}/',   
        '${year}1',          
        '1${year}1',
        '${lastYear}1',
        '1${lastYear}1'
    ],
    productIdTemplates: ['TH', 'TH5', 'TH6'],
    cardIdTemplates: [
        '备库', 
        'V478-', 
        'SG505', 
        'SG506', 
        'V15P', 
        'AUSA502-', 
        'V2526-', 
        'V2527-', 
        'TS', 
        'TH', 
        'VT'
    ],
    steelTypeTemplates: [
        '42CrMo4', 
        'C45E', 
        '4140Q&T', 
        '1045Norm', 
        'C45', 
        'S355J2G3', 
        '16/20MnCrS5', 
        '1.2714', 
        '1.2344', 
        '4145', 
        'A105/LF2'
    ],
    statusTemplates: ['车光', '调车', '花皮', '黑皮', '黑调', '花调'],
    positionTemplates: ['外', '过道', '立车', '打卡机','校直机']
};

// 配置管理器
const KeyboardConfigManager = {
    config: { ...DEFAULT_KEYBOARD_CONFIG },
    STORAGE_KEY: 'steel_bar_keyboard_config',

    init() {
        this.load();
        this.bindEvents();
    },

    load() {
        try {
            const saved = localStorage.getItem(this.STORAGE_KEY);
            if (saved) {
                // 合并保存的配置，确保新字段也能有默认值
                const parsed = JSON.parse(saved);
                this.config = { ...DEFAULT_KEYBOARD_CONFIG, ...parsed };
                // 确保数组存在
                ['furnaceIdTemplates', 'productIdTemplates', 'cardIdTemplates', 'steelTypeTemplates', 'statusTemplates', 'positionTemplates'].forEach(key => {
                    if (!this.config[key]) this.config[key] = DEFAULT_KEYBOARD_CONFIG[key];
                });
            }
        } catch (e) {
            console.error('加载键盘配置失败', e);
        }
    },

    save() {
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.config));
        showSnackbar('键盘配置已保存', 'success');
        generateVirtualKeyboard(); // 立即刷新
    },

    reset() {
        this.config = { ...DEFAULT_KEYBOARD_CONFIG };
        this.save();
        showSnackbar('已恢复默认配置', 'success');
    },

    bindEvents() {
        const openBtn = document.getElementById('openKeyboardSettingsBtn');
        const modal = document.getElementById('keyboardSettingsModal');
        const closeBtn = document.getElementById('closeKeyboardSettingsModal');
        const cancelBtn = document.getElementById('cancelKeyboardConfigBtn');
        const saveBtn = document.getElementById('saveKeyboardConfigBtn');
        const resetBtn = document.getElementById('resetKeyboardConfigBtn');
        
        const inputs = {
            furnaceId: document.getElementById('furnaceIdConfigInput'),
            productId: document.getElementById('productIdConfigInput'),
            cardId: document.getElementById('cardIdConfigInput'),
            steelType: document.getElementById('steelTypeConfigInput'),
            status: document.getElementById('statusConfigInput'),
            position: document.getElementById('positionConfigInput')
        };

        if (openBtn) {
            openBtn.addEventListener('click', () => {
                // 填充当前配置
                inputs.furnaceId.value = this.config.furnaceIdTemplates.join('\n');
                inputs.productId.value = this.config.productIdTemplates.join('\n');
                inputs.cardId.value = (this.config.cardIdTemplates || []).join('\n');
                inputs.steelType.value = (this.config.steelTypeTemplates || []).join('\n');
                inputs.status.value = (this.config.statusTemplates || []).join('\n');
                inputs.position.value = (this.config.positionTemplates || []).join('\n');
                
                modal.open = true;
                dom.drawer.open = false;
            });
        }

        const closeModal = () => {
            modal.open = false;
        };

        [closeBtn, cancelBtn].forEach(btn => btn?.addEventListener('click', closeModal));

        if (saveBtn) {
            saveBtn.addEventListener('click', () => {
                const processInput = (textarea) => textarea.value.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0);
                
                this.config.furnaceIdTemplates = processInput(inputs.furnaceId);
                this.config.productIdTemplates = processInput(inputs.productId);
                this.config.cardIdTemplates = processInput(inputs.cardId);
                this.config.steelTypeTemplates = processInput(inputs.steelType);
                this.config.statusTemplates = processInput(inputs.status);
                this.config.positionTemplates = processInput(inputs.position);

                this.save();
                closeModal();
            });
        }

        if (resetBtn) {
            resetBtn.addEventListener('click', () => {
                if (confirm('确定要恢复默认配置吗？')) {
                    this.reset();
                    inputs.furnaceId.value = this.config.furnaceIdTemplates.join('\n');
                    inputs.productId.value = this.config.productIdTemplates.join('\n');
                    inputs.cardId.value = this.config.cardIdTemplates.join('\n');
                    inputs.steelType.value = this.config.steelTypeTemplates.join('\n');
                    inputs.status.value = this.config.statusTemplates.join('\n');
                    inputs.position.value = this.config.positionTemplates.join('\n');
                }
            });
        }
        
        // MDUI dialog handles overlay click automatically, no need for window click listener
    }
};

function generateVirtualKeyboard() {
		  dom.shortcutContainer.innerHTML = '';
		  dom.keyboardRows.innerHTML = '';

		  const isUpperCase = keyboardState.shiftState === 'locked-on' || keyboardState.shiftState === 'on';
		  let keyRows = [];

          // 辅助函数：处理模板变量
          const processTemplates = (templates) => {
              if (!Array.isArray(templates)) return [];
              const year = new Date().getFullYear().toString().slice(2);
              const lastYear = (parseInt(year) - 1).toString().slice(-2);
              return templates.map(tpl => 
                  tpl.replace(/\$\{year\}/g, year).replace(/\$\{lastYear\}/g, lastYear)
              );
          };

		  switch(keyboardState.inputType) {
		    case 'number':
		    case 'numeric-input':
		      keyRows = [
		        ['%', '1', '2', '3','+', 'clear'],
		        [':', '4', '5', '6', '-', 'backspace'],
		        ['#', '7', '8', '9','*', 'esc'], 
		        ['_', '.', '0', '/','、', 'done'] 
		      ];
		      break;

		    case 'status':
              const statusShortcuts = processTemplates(KeyboardConfigManager.config.statusTemplates);
		      createShortcutKeys(statusShortcuts, 'status-key');
		      keyRows = [['clear', 'backspace', 'esc', 'done']];
		      break;

		    case 'cardId':
		      const cardShortcuts = processTemplates(KeyboardConfigManager.config.cardIdTemplates);
              createShortcutKeys(cardShortcuts, 'shortcut-key');
              // fallthrough to text keyboard

		    case 'steelType':
              // Only process if it wasn't cardId falling through? 
              // No, switch jumps to the matching case. 
              // If inputType is 'cardId', it executes cardId case then falls through to steelType case.
              // BUT we don't want to create shortcuts for steelType if we are in cardId mode!
              // The original code had `if (keyboardState.inputType === 'steelType')` inside the case.
              // I must restore that check if I use fallthrough.
              if (keyboardState.inputType === 'steelType') {
                  const steelShortcuts = processTemplates(KeyboardConfigManager.config.steelTypeTemplates);
                  createShortcutKeys(steelShortcuts, 'shortcut-key');
              }

		    case 'productId':
              if (keyboardState.inputType === 'productId') {
                  const productShortcuts = processTemplates(KeyboardConfigManager.config.productIdTemplates);
                  createShortcutKeys(productShortcuts, 'shortcut-key');
              }
 
		    case 'furnaceId':
              if (keyboardState.inputType === 'furnaceId') {
                  const furnaceShortcuts = processTemplates(KeyboardConfigManager.config.furnaceIdTemplates);
                  createShortcutKeys(furnaceShortcuts, 'shortcut-key');
              }
              // Fallthrough to text keyboard for all above IDs
		    case 'text':
		    default:
		      const lettersRow1 = isUpperCase ? ['Q','W','E','R','T','Y','U','I','O','P'] : ['q','w','e','r','t','y','u','i','o','p'];
		      const lettersRow2 = isUpperCase ? ['A','S','D','F','G','H','J','K','L'] : ['a','s','d','f','g','h','j','k','l'];
		      const lettersRow3 = isUpperCase ? ['Z','X','C','V','B','N','M'] : ['z','x','c','v','b','n','m'];
		      keyRows = [
		        ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'],
		        [...lettersRow1],
		        [...lettersRow2, '+','-'],
		        ['shift', ...lettersRow3, 'backspace'],
		        ['symbol',',','space', '.', 'clear','done']
		      ];
		      break;

		    case 'position':
              const positionShortcuts = processTemplates(KeyboardConfigManager.config.positionTemplates);
		      createShortcutKeys(positionShortcuts, 'shortcut-key');
		      keyRows = [
		        ['%', '1', '2', '3', 'A'],
		        ['/', '4', '5', '6', 'B'],
		        ['+', '7', '8', '9', 'C'],
		        ['*', '/','0', '-','D'],
		        ['clear', 'backspace','esc','done'] 
		      ];
		      break;

		    case 'symbol':
		      keyRows = [
		        ['~', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')'],
		        ['_', '+', '=', '|', '\\', ':', '"', '<', '>', '?', ','],
		        ['`', '}', '[', ']', '{', '(', ')', '.', '/', ''],
		        ['ABC', 'space', 'backspace','clear', 'done'] 
		      ];
		      break;
		  }

		  keyRows.forEach(row => {
		    const rowElement = document.createElement('div');
		    rowElement.className = 'keyboard-row';
		    row.forEach(key => {
		      if (key !== undefined) rowElement.appendChild(createKeyElement(key));
		    });
		    dom.keyboardRows.appendChild(rowElement);
		  });
		}

		function createKeyElement(key) {
		  const keyElement = document.createElement('div');
		  keyElement.className = 'keyboard-key';

		  // 首先处理空占位键
		  if (key === '') {
		    keyElement.classList.add('empty');
		    return keyElement;
		  }

		  // 特殊功能键 - 必须尽早处理并 return，避免进入通用逻辑
		  if (key === 'shift') {
		    keyElement.className += ' special wide';
		    keyElement.innerHTML = keyboardState.shiftState === 'locked-on' ? '小写' : '大写';
		    keyElement.addEventListener('click', toggleShift);
		    return keyElement;
		  }

		  if (key === 'backspace') {
		    keyElement.className += ' special wide';
		    keyElement.innerHTML = '←';

		    let deleteInterval = null;
		    const DELETE_DELAY = 500;
		    const DELETE_SPEED = 80;

		    keyElement.addEventListener('pointerdown', (e) => {
		      e.preventDefault();
		      handleBackspace();

		      deleteInterval = setTimeout(() => {
		        deleteInterval = setInterval(handleBackspace, DELETE_SPEED);
		      }, DELETE_DELAY);
		    });

		    const stopDeleting = () => {
		      clearTimeout(deleteInterval);
		      clearInterval(deleteInterval);
		      deleteInterval = null;
		    };

		    keyElement.addEventListener('pointerup', stopDeleting);
		    keyElement.addEventListener('pointercancel', stopDeleting);
		    keyElement.addEventListener('pointerleave', stopDeleting);
		    keyElement.addEventListener('click', (e) => e.preventDefault());

		    return keyElement;
		  }

		  if (key === 'space') {
		    keyElement.className += ' special extra-wide';
		    keyElement.textContent = '';
		    keyElement.addEventListener('click', () => insertText(' '));
		    return keyElement;
		  }

		  if (key === 'esc') {
		    keyElement.className += ' system-keyboard wide';
		    keyElement.textContent = '✔';  // 正确显示对勾
		    keyElement.addEventListener('click', closeVirtualKeyboardAndKeepReadOnly);
		    return keyElement;  // 必须 return！
		  }
		if(key === 'done') {
		    keyElement.className += ' special wide';
		    keyElement.style.position = 'relative';

		    // 快速编辑模式下：显示“完成”，点击直接关闭键盘
		    if (keyboardState.isQuickEdit) {
		        keyElement.textContent = '✔'; 
		    } else {
		        keyElement.textContent = '▼';
		    }

		    let longPressTimer = null;
		    const LONG_PRESS_DURATION = 600;

		    keyElement.addEventListener('pointerdown', (e) => {
		        e.preventDefault();

		        // 长按仍保留关闭功能（备用）
		        longPressTimer = setTimeout(() => {
		            closeVirtualKeyboardAndKeepReadOnly();
		            showSnackbar('键盘已关闭（长按完成）', 'success');
		        }, 300);
		    });

		    keyElement.addEventListener('pointerup', (e) => {
		        if (longPressTimer) {
		            clearTimeout(longPressTimer);
		            longPressTimer = null;

		            if (keyboardState.isQuickEdit) {
		                // 快速编辑：短按 = 关闭键盘（不跳转）
		                closeVirtualKeyboardAndKeepReadOnly();
		            } else {
		                // 完整编辑：短按 = 跳转下一个
		                handleNextInput();
		            }
		        }
		    });

		    keyElement.addEventListener('pointercancel', () => {
		        if (longPressTimer) clearTimeout(longPressTimer);
		    });

		    keyElement.addEventListener('pointerleave', () => {
		        if (longPressTimer) clearTimeout(longPressTimer);
		    });

		    keyElement.addEventListener('click', (e) => {
		        e.preventDefault();
		        e.stopPropagation();
		    });

		    return keyElement;
		}

		  if (key === 'clear') {
		    keyElement.className += ' clear-key wide';
		    keyElement.textContent = '←✘';
		    keyElement.addEventListener('click', clearInput);
		    return keyElement;
		  }

		  if (key === 'symbol') {
		    keyElement.className += ' special wide';
		    keyElement.textContent = '符';
		    keyElement.addEventListener('click', () => {
		      keyboardState.inputType = 'symbol';
		      saveKeyboardState();
		      generateVirtualKeyboard();
		    });
		    return keyElement;
		  }

		  if (key === 'ABC') {
		    keyElement.className += ' special wide';
		    keyElement.textContent = 'ABC';
		    keyElement.addEventListener('click', () => {
		      keyboardState.inputType = 'text';
		      saveKeyboardState();
		      generateVirtualKeyboard();
		    });
		    return keyElement;
		  }

		  // 普通字符键（最后处理）
		  keyElement.textContent = key;
		  keyElement.addEventListener('click', () => {
		    insertText(key);
		    if (keyboardState.shiftState === 'on') {
		      keyboardState.shiftState = 'off';
		      saveKeyboardState();
		      generateVirtualKeyboard();
		    }
		  });

		  return keyElement;
		}

		function handleNextInput() {
		  if (!currentInput) {
		    dom.virtualKeyboard.style.display = 'none';
		    return;
		  }

		  const currentId = currentInput.id;
		  const isCalcInput = currentInput.closest('#calculatorForm');
		  const isQuickEditInput = currentId === 'quickEditInput';

		  if (isQuickEditInput) {
		      saveQuickEdit(); 
		      dom.virtualKeyboard.style.display = 'none';
		      return;
		  }

		  let nextInput = null;
		  if (isCalcInput) {
		      const calcInputs = [dom.calcDiameter1, dom.calcDiameter2, dom.calcLength];
		      const currentIndex = calcInputs.indexOf(currentInput);
		      const nextIndex = currentIndex === calcInputs.length - 1 ? 0 : currentIndex + 1;
		      nextInput = calcInputs[nextIndex];
		  } else {
		      const currentIndex = inputFieldOrder.indexOf(currentId);
		      const nextIndex = currentIndex === inputFieldOrder.length - 1 ? 0 : currentIndex + 1;
		      nextInput = formElements[inputFieldOrder[nextIndex]];
		  }

		  if (!nextInput) {
		      dom.virtualKeyboard.style.display = 'none';
		      return;
		  }

		  currentInput = nextInput;

		  if (currentInput.id === 'remarks' && !isCalcInput) {
		    currentInput.removeAttribute('readonly');
		    currentInput.classList.remove('readonly-input');
		    dom.virtualKeyboard.style.display = 'none';
		  } else {
		    currentInput.setAttribute('readonly', 'true');
		    currentInput.classList.add('readonly-input');
		    updateKeyboardForInput(currentInput);
		    showVirtualKeyboard();
		  }

		  currentInput.focus();
		  const modalContent = currentInput.closest('.modal-body-custom'); 
		  if(modalContent) {
		      setTimeout(() => {
		          const inputRect = currentInput.getBoundingClientRect();
		          const modalRect = modalContent.getBoundingClientRect();
		          const offset = inputRect.top - modalRect.top + modalContent.scrollTop - modalRect.height * 0.3; 
		          modalContent.scrollTo({ top: offset, behavior: 'smooth' });
		      }, 50);
		  }
		}

		function updateKeyboardForInput(input, overrideId = null) {
		  if (!input) return;

		  const numericFields = ['actualDiameter', 'diameter', 'length', 'weight', 'hardness', 'calcDiameter1', 'calcDiameter2', 'calcLength', 'calcDensity'];
		  const currentId = overrideId || input.id;
		  const isNumeric = numericFields.includes(currentId);

		  if (isNumeric) keyboardState.inputType = 'number';
		  else if (currentId === 'productId') keyboardState.inputType = 'productId';
		  else if (currentId === 'cardId') keyboardState.inputType = 'cardId';
		  else if (currentId === 'steelType') keyboardState.inputType = 'steelType';
		  else if (currentId === 'furnaceId') keyboardState.inputType = 'furnaceId';
		  else if (currentId === 'position') keyboardState.inputType = 'position';
		  else if (currentId === 'status') keyboardState.inputType = 'status';
		  else keyboardState.inputType = 'text';

		  saveKeyboardState();
		  generateVirtualKeyboard();
		}

		function insertText(text) {
		  if (!currentInput) return;
		  currentInput.focus(); 

		  const startPos = currentInput.selectionStart;
		  const endPos = currentInput.selectionEnd;
		  const currentValue = currentInput.value;

		  currentInput.value = currentValue.substring(0, startPos) + text + currentValue.substring(endPos);
		  currentInput.selectionStart = currentInput.selectionEnd = startPos + text.length;

		  const event = new Event('input', { bubbles: true });
		  currentInput.dispatchEvent(event);

		  if (currentInput.closest('#calculatorForm')) calculateWeight();
		  else if (currentInput.id === 'searchInput' && isSearchReplaceVisible) startSearch();
		}

		function handleBackspace() {
		  if (!currentInput) return;
		  currentInput.focus();

		  const startPos = currentInput.selectionStart;
		  const endPos = currentInput.selectionEnd;
		  const currentValue = currentInput.value;

		  if (startPos === endPos && startPos > 0) {
		    currentInput.value = currentValue.substring(0, startPos - 1) + currentValue.substring(endPos);
		    currentInput.selectionStart = currentInput.selectionEnd = startPos - 1;
		  } else if (startPos !== endPos) {
		    currentInput.value = currentValue.substring(0, startPos) + currentValue.substring(endPos);
		    currentInput.selectionStart = currentInput.selectionEnd = startPos;
		  }

		  const event = new Event('input', { bubbles: true });
		  currentInput.dispatchEvent(event);

		  if (currentInput.closest('#calculatorForm')) calculateWeight();
		  else if (currentInput.id === 'searchInput' && isSearchReplaceVisible) startSearch();
		}

		function clearInput() {
		  if (currentInput) {
		    currentInput.value = '';
		    currentInput.focus();
		    const event = new Event('input', { bubbles: true });
		    currentInput.dispatchEvent(event);
		    if (currentInput.closest('#calculatorForm')) calculateWeight();
		  }
		}

		// === IndexedDB 初始化和操作 ===
		const DB_NAME = 'RoundBarDB';
		const DB_VERSION = 1;
		const STORE_NAME = 'data';
		let db = null;

		function openDB() {
		    return new Promise((resolve, reject) => {
		        if (db) {
		            resolve(db);
		            return;
		        }

		        const request = indexedDB.open(DB_NAME, DB_VERSION);

		        request.onerror = () => {
		            console.error('IndexedDB 打开失败:', request.error);
		            reject(request.error);
		        };

		        request.onsuccess = () => {
		            db = request.result;
		            resolve(db);
		        };

		        request.onupgradeneeded = (event) => {
		            db = event.target.result;
		            if (!db.objectStoreNames.contains(STORE_NAME)) {
		                db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
		            }
		        };
		    });
		}

		// 保存所有数据（覆盖式）
		
// ==========================================
// === Data Persistence (IndexedDB) ===
// ==========================================
async function saveDataToIndexedDB() {
		    try {
		        const db = await openDB();
		        const tx = db.transaction(STORE_NAME, 'readwrite');
		        const store = tx.objectStore(STORE_NAME);

		        // 清空旧数据
		        await store.clear();

		        // 批量添加新数据
		        tableData.forEach(item => {
		            store.add({ ...item }); // 复制对象避免引用问题
		        });

		        await tx.done;
		        console.log('IndexedDB 保存成功，共', tableData.length, '条数据');
		    } catch (err) {
		        console.error('IndexedDB 保存失败:', err);
		        showSnackbar('数据保存失败（IndexedDB错误）', 'error');
		    }
		}

		// === 加载所有数据（修复加载后表格不铺满问题）===
		async function loadDataFromIndexedDB() {
		    try {
		        const db = await openDB();
		        const tx = db.transaction(STORE_NAME, 'readonly');
		        const store = tx.objectStore(STORE_NAME);
		        const request = store.getAll();

		        const data = await new Promise((resolve, reject) => {
		            request.onsuccess = () => resolve(request.result);
		            request.onerror = () => reject(request.error);
		        });

		        if (data && data.length > 0) {
		            tableData = data;
		            console.log('IndexedDB 加载成功，共', tableData.length, '条数据');
		        } else {
		            tableData = [];
		            console.log('IndexedDB 无数据，使用空数组');
		        }
		    } catch (err) {
		        console.error('IndexedDB 加载失败:', err);
		        showSnackbar('数据加载失败，使用空数据', 'warning');
		        tableData = [];
		    }

		    // === 关键修复：重置分页 + 刷新布局，确保表格铺满全屏 ===
		    currentPage = 1; // 重置到第一页
		    updateTable();   // 刷新表格内容
		    //updatePagination(); // 如果您有分页控件，刷新页码显示（如果没有可忽略）

		    // 滚动到顶部（避免残留滚动位置导致空白）
		    const container = document.querySelector('.data-table-container-div') || window;
		    if (container) {
		        container.scrollTop = 0;
		    }

		    // 更新底部统计（如“共 X 条数据”）
		    if (dom.totalCountText) {
		        dom.totalCountText.textContent = `共 ${tableData.length} 条数据`;
		    }
		}

		function showVirtualKeyboard() {
		    if (suppressVirtualKeyboard) {
		        return;
		    }
		    generateVirtualKeyboard();
		    dom.virtualKeyboard.style.display = 'block';
		}

		function loadData() {
		    try {
		        if (saved) {
		            const parsed = JSON.parse(saved);
		            if (Array.isArray(parsed)) {
		                tableData = parsed;
		                console.log('数据加载成功，共', tableData.length, '条');
		            }
		        }
		    } catch (err) {
		        console.error('数据加载失败:', err);
		        showSnackbar('加载历史数据失败，已使用空数据', 'warning');
		        localStorage.removeItem('roundBarData'); // 清除损坏数据
		        tableData = [];
		    }

		    updateTable();
		}

		/**
 * 单条添加/编辑时，检测到产品号重复 → 显示简单 mdui-dialog 警告
 * @param {Object} duplicate - 第一条重复数据对象
 * @param {Object} newData - 当前要保存的新数据
 * @param {boolean} isEditMode - 是否编辑模式
 */
function showSingleDuplicateWarnDialog(duplicate, newData, isEditMode) {
    console.log('【单条重复警告】被调用 - 产品号：', newData.productId);

    const dialog = document.getElementById('singleDuplicateWarnDialog');
    if (!dialog) {
        console.error('【单条重复警告】找不到弹窗！请检查 HTML id="singleDuplicateWarnDialog"');
        showSnackbar('重复检测失败，无法显示警告弹窗', 'error');
        return;
    }

    // 设置提示消息
    const messageEl = dialog.querySelector('#singleDuplicateMessage');
    if (messageEl) {
        messageEl.innerHTML = `
            系统中已存在相同的产品号：<strong>${newData.productId || 'N/A'}</strong><br>
            发现 <strong>1</strong> 条重复数据。<br>
            您正在<strong>${isEditMode ? '修改为' : '添加'}</strong>该产品号。
        `;
    }

    // 绑定“取消添加”按钮
    const cancelBtn = dialog.querySelector('#singleDuplicateCancelBtn');
    if (cancelBtn) {
        cancelBtn.onclick = () => {
            const index = duplicate.index;
            closeCustomModal(dom.dataSheet);
            dom.virtualKeyboard.style.display = 'none';
            highlightAndScrollToRow(index);
            dialog.open = false;
            showSnackbar('操作已取消', 'info');
        };
    }

    // 绑定“覆盖保存”按钮
    const overrideBtn = dialog.querySelector('#singleDuplicateOverrideBtn');
    if (overrideBtn) {
        overrideBtn.onclick = () => {
            // 覆盖当前重复项
            tableData[duplicate.index] = { ...newData };
            saveDataToIndexedDB();
            updateTable();
            dialog.open = false;
            closeCustomModal(dom.dataSheet);
            dom.virtualKeyboard.style.display = 'none';
            showSnackbar('已覆盖保存重复数据', 'success');
        };
    }

    // 打开弹窗
    dialog.open = true;
    console.log('【单条重复警告】弹窗已打开');
}
/**
 * 显示重复数据确认弹窗（批量导入专用，支持分页，每页50条）
 * - 无差异的重复项不显示在列表，只在顶部提示
 * @param {Array} duplicateEntries - 重复项数组
 * @param {Array} [newData=[]] - 新增的非重复数据
 * @param {number} [totalImported=1] - 总导入数量
 */
function showDuplicateConfirmationModal(duplicateEntries, newData = [], totalImported = 1) {
    console.log('【重复弹窗】被调用，重复项数量：', duplicateEntries.length);

    const modal = document.getElementById('duplicateConfirmationModalCustom');
    if (!modal) {
        console.error('【重复弹窗】找不到弹窗！请检查 HTML id="duplicateConfirmationModalCustom"');
        showSnackbar('系统错误：重复确认弹窗未找到', 'error');
        return;
    }

    console.log('【重复弹窗】弹窗已找到，开始处理...');

    // 填充统计信息
    const totalEl = modal.querySelector('#modal-total-count');
    const newEl = modal.querySelector('#modal-new-count');
    const dupEl = modal.querySelector('#modal-duplicate-count');

    if (totalEl) totalEl.textContent = totalImported;
    if (newEl) newEl.textContent = newData.length;
    if (dupEl) dupEl.textContent = duplicateEntries.length;

    // 分离有差异和无差异的重复项
    const withDiff = duplicateEntries.filter(entry => entry.differences && entry.differences.length > 0);
    const withoutDiff = duplicateEntries.filter(entry => !entry.differences || entry.differences.length === 0);

    console.log('【重复弹窗】有差异重复：', withDiff.length, '条');
    console.log('【重复弹窗】无差异重复：', withoutDiff.length, '条');

    // 顶部提示无差异项（如果有）
    const summaryP = modal.querySelector('.duplicate-summary') || document.createElement('p');
    summaryP.className = 'duplicate-summary';
    summaryP.style.marginBottom = '16px';
    summaryP.style.color = '#757575';

    if (withoutDiff.length > 0) {
        summaryP.innerHTML = `其中 <strong>${withoutDiff.length}</strong> 条重复项无任何字段差异（将自动跳过）`;
    } else {
        summaryP.innerHTML = '';
    }

    // 插入到弹窗内容顶部（如果已存在则替换）
    const body = modal.querySelector('.modal-body-custom');
    if (body) {
        const firstP = body.querySelector('p');
        if (firstP) {
            body.insertBefore(summaryP, firstP.nextSibling);
        } else {
            body.prepend(summaryP);
        }
    }

    // 只渲染有差异的项（分页基于有差异的项）
    const itemsToPaginate = withDiff; // 只分页有差异的
    const PAGE_SIZE = 50;
    let currentPage = 1;
    const totalPages = Math.max(1, Math.ceil(itemsToPaginate.length / PAGE_SIZE));

    const listContainer = modal.querySelector('#modal-duplicate-list');
    if (listContainer) {
        listContainer.innerHTML = '';

        if (itemsToPaginate.length === 0 && withoutDiff.length > 0) {
            listContainer.innerHTML = '<p style="color:#757575;text-align:center;padding:40px;">所有重复项均无差异，将自动跳过</p>';
        } else if (itemsToPaginate.length === 0) {
            listContainer.innerHTML = '<p style="color:#757575;text-align:center;padding:40px;">无需要处理的重复项</p>';
        } else {
            const template = document.getElementById('duplicate-item-template')?.innerHTML || '';
            if (!template) {
                listContainer.innerHTML = '<p style="color:red;text-align:center;padding:20px;">模板丢失，无法显示详情</p>';
            } else {
                // 渲染当前页
                function renderPage(page) {
                    listContainer.innerHTML = '';

                    const start = (page - 1) * PAGE_SIZE;
                    const end = Math.min(start + PAGE_SIZE, itemsToPaginate.length);
                    const pageItems = itemsToPaginate.slice(start, end);

                    pageItems.forEach((entry, pageIdx) => {
                        const globalIdx = start + pageIdx;
                        let html = template
                            .replace(/PRODUCT_ID/g, entry.productId || '未知')
                            .replace(/ITEM_INDEX/g, globalIdx);

                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;

                        // radio name 唯一
                        tempDiv.querySelectorAll('input[type="radio"]').forEach(radio => {
                            radio.name = `action-${globalIdx}`;
                            if (entry.action === 'override') {
                                if (radio.value === 'override') radio.checked = true;
                            } else {
                                if (radio.value === 'skip') radio.checked = true;
                            }
                        });

                        // 差异表格
                        const tbody = tempDiv.querySelector('tbody');
                        if (tbody && entry.differences?.length > 0) {
                            entry.differences.forEach(diff => {
                                tbody.innerHTML += `
                                    <tr>
                                        <th>${diff.field}</th>
                                        <td>${diff.existingItem[diff.key] || '-'}</td>
                                        <td style="color:#f44336;font-weight:bold;">${diff.newValue || '-'}</td>
                                    </tr>
                                `;
                            });
                        }

                        listContainer.appendChild(tempDiv.firstElementChild);
                    });

                    updatePageInfo();
                }

                // 页码信息
                function updatePageInfo() {
                    const pageInfo = modal.querySelector('#duplicatePageInfo');
                    if (pageInfo) {
                        pageInfo.textContent = `第 ${currentPage} / ${totalPages} 页（共 ${itemsToPaginate.length} 条有差异重复）`;
                    }
                }

                // 翻页
                function changePage(newPage) {
                    if (newPage < 1 || newPage > totalPages) return;
                    currentPage = newPage;
                    renderPage(currentPage);
                }

                // 绑定翻页按钮（需在 HTML 中添加）
                const prevBtn = modal.querySelector('#duplicatePrevPage');
                if (prevBtn) prevBtn.onclick = () => changePage(currentPage - 1);

                const nextBtn = modal.querySelector('#duplicateNextPage');
                if (nextBtn) nextBtn.onclick = () => changePage(currentPage + 1);

                const pageInput = modal.querySelector('#duplicatePageJump');
                if (pageInput) {
                    pageInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const target = parseInt(pageInput.value);
                            if (!isNaN(target)) changePage(Math.max(1, Math.min(totalPages, target)));
                        }
                    });
                    pageInput.addEventListener('blur', () => {
                        const target = parseInt(pageInput.value);
                        if (!isNaN(target)) changePage(Math.max(1, Math.min(totalPages, target)));
                    });
                }

                // 初始化第一页
                renderPage(1);
            }
        }
    }

    // 绑定全部跳过/覆盖（只影响当前显示页，但确认时会收集所有）
    const skipAllBtn = modal.querySelector('#modal-btn-select-all-skip');
    if (skipAllBtn) {
        skipAllBtn.onclick = () => {
            modal.querySelectorAll('input[value="skip"]').forEach(r => r.checked = true);
        };
    }

    const overrideAllBtn = modal.querySelector('#modal-btn-select-all-override');
    if (overrideAllBtn) {
        overrideAllBtn.onclick = () => {
            modal.querySelectorAll('input[value="override"]').forEach(r => r.checked = true);
        };
    }

    // 确认处理（收集所有页的选择）
    const confirmBtn = modal.querySelector('#modal-btn-confirm');
    if (confirmBtn) {
        confirmBtn.onclick = () => {
            // 收集所有重复项的选择（即使翻页了也能获取，因为 radio name 全局唯一）
            const actions = duplicateEntries.map((_, idx) => {
                const radio = modal.querySelector(`input[name="action-${idx}"]:checked`);
                return radio ? radio.value : 'skip';
            });

            const processedDuplicates = duplicateEntries.map((entry, idx) => ({
                ...entry,
                action: actions[idx]
            }));

            // 无差异的项强制跳过
            withoutDiff.forEach(entry => {
                processedDuplicates.push({ ...entry, action: 'skip' });
            });

            closeCustomModal(modal);
            finalizeImport(newData, processedDuplicates, totalImported);
        };
    }

    // 取消导入
    const cancelBtn = modal.querySelector('#modal-btn-cancel-import');
    if (cancelBtn) {
        cancelBtn.onclick = () => {
            closeCustomModal(modal);
            showSnackbar('导入已取消', 'info');
        };
    }

    // 关闭按钮（右上角 ×）
    const closeBtn = modal.querySelector('#closeDuplicateModal');
    if (closeBtn) {
        closeBtn.onclick = () => closeCustomModal(modal);
    }

    // 打开弹窗（自定义 modal 使用 display）
    modal.style.display = 'block';
    console.log('【重复弹窗】弹窗已打开，渲染完成');
}

async function saveData() {
    const formData = {};

    // ★★★ 清理旧残留（仅新增时，且只清理预览区，不碰临时变量） ★★★
    if (currentEditIndex === -1) {
        const previewImgClean = document.getElementById('previewImg');
        if (previewImgClean) {
            previewImgClean.src = '';
            previewImgClean.removeAttribute('src');
        }
        console.log('[SAVE] 新增模式 - 已清理预览区图片（src置空）');
        // 注意：这里不再 delete window.tempNewCardImage
        // 临时变量留到保存成功后再清理
    }

    // 1. 填充所有文本字段
    for (const key in formElements) {
        if (formElements.hasOwnProperty(key)) {
            formData[key] = formElements[key] ? formElements[key].value.trim() : '';
        }
    }

// 2. 【核心修复】处理图片 - 多重来源强制捕获 + 优先级明确
let finalImage = '';

// 来源1：优先使用临时变量（上传后已强制存入，最可靠，不会受弹窗关闭影响）
if (window.tempNewCardImage && window.tempNewCardImage.startsWith('data:image/')) {
    finalImage = window.tempNewCardImage;
    console.log('[SAVE] 从 window.tempNewCardImage 读取到图片（优先），长度：' + finalImage.length);
}
// 来源2：预览区的 img 标签（用户当前看到的图，备用）
else if (previewImg && previewImg.src && previewImg.src.startsWith('data:image/') && previewImg.src.length > 200) {
    finalImage = previewImg.src;
    console.log('[SAVE] 从 previewImg.src 捕获图片（备用），长度：' + finalImage.length);
}
// 来源3：编辑时保留旧图（如果没新上传）
else if (currentEditIndex !== -1 && tableData[currentEditIndex]?.cardImage) {
    finalImage = tableData[currentEditIndex].cardImage;
    console.log('[SAVE] 编辑模式 - 保留原有图片');
}

// 强制赋值
formData.cardImage = finalImage || '';
console.log('[SAVE] 最终 formData.cardImage 状态：' + (finalImage ? '有图片（长度 ' + finalImage.length + ')' : '空'));

    // 强制赋值（防止后续被覆盖）
    formData.cardImage = finalImage || '';
    console.log('[SAVE] 最终 formData.cardImage 状态：' + (finalImage ? '有图片（长度 ' + finalImage.length + ')' : '空'));

    // 3. 重量四舍五入取整
    if (formData.weight) {
        const num = parseFloat(formData.weight);
        if (!isNaN(num)) {
            formData.weight = Math.round(num).toString();
        }
    }

    // 4. 必填验证
    if (!formData.productId && !formData.cardId && !formData.furnaceId) {
        showSnackbar('产品号、卡片号、炉号至少填写一项！', 'warning');
        return;
    }

    // 5. 重复产品号检测
    const isEditMode = currentEditIndex !== -1;
    const isProductIdChanged = isEditMode && tableData[currentEditIndex]?.productId !== formData.productId;

    const shouldCheckDuplicate = !isEditMode || isProductIdChanged;

    if (shouldCheckDuplicate && formData.productId?.trim()) {
        const duplicates = findDuplicates(formData);
        const realDuplicates = duplicates.filter(dup => dup.index !== currentEditIndex);

        if (realDuplicates.length > 0) {
            showSingleDuplicateWarnDialog(realDuplicates[0], formData, isEditMode);
            return;
        }
    }

    // 6. 执行保存
    if (!isEditMode) {
        tableData.push(formData);
        console.log('[SAVE] 新增完成 - 新记录已推入 tableData，图片状态：' + (formData.cardImage ? '有图' : '无图'));
    } else {
        tableData[currentEditIndex] = formData;
        console.log('[SAVE] 编辑完成 - 索引 ' + currentEditIndex + ' 已更新，图片状态：' + (formData.cardImage ? '有图' : '无图'));
    }

    // ★★★ 保存成功后再清理临时变量（关键！） ★★★
    if (currentEditIndex === -1 && window.tempNewCardImage) {
        delete window.tempNewCardImage;
        console.log('[SAVE] 新增保存完成 - 已清理 tempNewCardImage');
    }

    // 7. 持久化 & 刷新
    await saveDataToIndexedDB();
    currentPage = 1;
    updateTable();
    closeCustomModal(dom.dataSheet);
    dom.virtualKeyboard.style.display = 'none';

    showSnackbar(isEditMode ? '数据修改成功' : '数据添加成功', 'success');
}

function finalizeImport(newData, duplicateEntries, totalImported) {
    let actuallyAdded = newData.length;
    let actuallyOverridden = 0;
    let actuallySkipped = 0;

    duplicateEntries.forEach(entry => {
        const action = entry.action;
        const index = tableData.findIndex(item => 
            item.productId && entry.productId && 
            item.productId.trim() === entry.productId.trim()
        );

        if (action === 'override' && index !== -1) {
            // 完整替换，包括 cardImage 图片
            tableData[index] = { ...entry.newItem };
            actuallyOverridden++;
            console.log('【导入覆盖】产品号：', entry.productId, '已替换，包括图片');
        } else if (action === 'skip') {
            actuallySkipped++;
        }
    });

    if (newData.length > 0) {
        tableData = [...tableData, ...newData];
        console.log('【导入新增】成功添加', newData.length, '条数据，包括图片');
    }

    if (actuallyAdded > 0 || actuallyOverridden > 0 || actuallySkipped > 0 || totalImported > 0) {
        console.log('【导入】开始持久化保存到 IndexedDB...');
        saveDataToIndexedDB()
            .then(() => {
                console.log('【导入】数据保存成功，开始刷新表格');
                currentPage = 1;  // 重置到第一页
                updateTable();    // 强制刷新，确保图片显示
                console.log('【导入】表格已刷新，图片应正常显示');
            })
            .catch(err => {
                console.error('【导入】保存到 IndexedDB 失败：', err);
                showSnackbar('导入数据保存失败，请重试', 'error');
            });
    } else {
        console.log('【导入】无任何变更，无需保存');
    }

    let resultMessage = `导入完成！共读取 ${totalImported} 条记录。`;
    if (actuallyAdded > 0) resultMessage += ` 成功添加 ${actuallyAdded} 条新数据。`;
    if (actuallyOverridden > 0) resultMessage += ` 覆盖 ${actuallyOverridden} 条重复数据。`;
    if (actuallySkipped > 0) resultMessage += ` 跳过 ${actuallySkipped} 条重复数据。`;
    if (totalImported === 0) resultMessage = `导入完成！文件未包含有效数据。`;
    showSnackbar(resultMessage, 'success');
}

/**
 * 比较两个对象，返回不同的字段列表（用于重复数据确认弹窗显示差异）
 * @param {Object} oldObj - 已有数据对象
 * @param {Object} newObj - 新录入的数据对象
 * @returns {Array} 差异数组，每项格式：{field: '中文字段名', key: '字段键名', existingItem: oldObj, newValue: 新值}
 */
function getObjectDifferences(oldObj, newObj) {
    const differences = [];

    // 获取所有可能的字段（合并两个对象的键，去重）
    const allKeys = new Set([
        ...Object.keys(oldObj || {}),
        ...Object.keys(newObj || {})
    ]);

    allKeys.forEach(key => {
        // 跳过图片字段（base64 太长，不适合显示差异）
        if (key === 'cardImage') return;

        // 获取旧值和新值，处理 undefined/null/空值
        const oldVal = oldObj[key] ?? '';
        const newVal = newObj[key] ?? '';

        // 字符串化比较（兼容数字、字符串等类型）
        if (String(oldVal) !== String(newVal)) {
            differences.push({
                field: fieldLabels[key] || key,  // 使用中文标签（如果有），否则用英文键名
                key: key,
                existingItem: oldObj,
                newValue: newVal
            });
        }
    });

    return differences;
}

		function renderDuplicatePage(listContainer) {
		    listContainer.innerHTML = '';

		    const entries = window.currentDuplicateEntries || [];
		    const startIndex = (duplicateCurrentPage - 1) * DUPLICATE_PAGE_SIZE;
		    const endIndex = Math.min(startIndex + DUPLICATE_PAGE_SIZE, entries.length);
		    const pageEntries = entries.slice(startIndex, endIndex);

		    const itemTemplateHtml = document.getElementById('duplicate-item-template').innerHTML;
		    const differenceTemplateHtml = document.getElementById('difference-row-template').innerHTML;

		    pageEntries.forEach((entry, pageIndex) => {
		        const globalIndex = startIndex + pageIndex;
		        let itemHtml = itemTemplateHtml
		            .replace(/PRODUCT_ID/g, entry.productId || 'N/A')
		            .replace(/ITEM_INDEX/g, globalIndex);

		        const tempDiv = document.createElement('div');
		        tempDiv.innerHTML = itemHtml;

		        const tbody = tempDiv.querySelector('.duplicate-differences tbody');
		        // 修复：新增tbody存在性判断（括号问题导致的核心报错——tbody为null时操作innerHTML）
		        if (tbody) {
		            if (entry.differences.length > 0) {
		                entry.differences.forEach(diff => {
		                    const rowHtml = differenceTemplateHtml
		                        .replace('FIELD_NAME', diff.field)
		                        .replace('OLD_VALUE', diff.existingItem[diff.key] || '-')
		                        .replace('NEW_VALUE', diff.newValue);
		                    tbody.innerHTML += rowHtml;
		                });
		            } else {
		                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#757575;font-style:italic;">无关键字段差异</td></tr>';
		            }
		        }

		        // 设置 radio name
		        tempDiv.querySelectorAll('input[type="radio"]').forEach(radio => {
		            radio.name = `action-${globalIndex}`;
		        });

		        listContainer.appendChild(tempDiv.firstElementChild);
		    });
		}

		function renderDuplicatePagination(listContainer) {
		    const old = listContainer.parentNode.querySelector('#duplicatePagination');
		    if (old) old.remove();

		    if (duplicateTotalPages <= 1) return;

		    const paginationDiv = document.createElement('div');
		    paginationDiv.id = 'duplicatePagination';
		    paginationDiv.style.cssText = 'display:flex;justify-content:center;align-items:center;gap:16px;padding:20px 0;background:var(--surface-color);';

		    const prevBtn = document.createElement('mdui-button-icon');
		    prevBtn.icon = 'navigate_before';
		    prevBtn.disabled = duplicateCurrentPage === 1;

		    let prevLongTimer = null;
		    const LONG_PRESS = 500;

		    prevBtn.addEventListener('click', (e) => {
		        e.stopPropagation();
		        if (duplicateCurrentPage > 1) {
		            duplicateCurrentPage--;
		            renderDuplicatePage(listContainer);
		            renderDuplicatePagination(listContainer);
		        }
		    });

		    prevBtn.addEventListener('pointerdown', () => {
		        if (duplicateCurrentPage === 1) return;
		        prevLongTimer = setTimeout(() => {
		            duplicateCurrentPage = 1;
		            renderDuplicatePage(listContainer);
		            renderDuplicatePagination(listContainer);
		        }, LONG_PRESS);
		    });
		    prevBtn.addEventListener('pointerup', () => clearTimeout(prevLongTimer));
		    prevBtn.addEventListener('pointercancel', () => clearTimeout(prevLongTimer));
		    prevBtn.addEventListener('pointerleave', () => clearTimeout(prevLongTimer));

		    const pageInfo = document.createElement('span');
		    pageInfo.textContent = `第 ${duplicateCurrentPage} / ${duplicateTotalPages} 页（共 ${(window.currentDuplicateEntries || []).length} 条重复）`;
		    pageInfo.style.cssText = 'font-size:0.95rem;color:#757575;';

		    const nextBtn = document.createElement('mdui-button-icon');
		    nextBtn.icon = 'navigate_next';
		    nextBtn.disabled = duplicateCurrentPage === duplicateTotalPages;

		    let nextLongTimer = null;

		    nextBtn.addEventListener('click', (e) => {
		        e.stopPropagation();
		        if (duplicateCurrentPage < duplicateTotalPages) {
		            duplicateCurrentPage++;
		            renderDuplicatePage(listContainer);
		            renderDuplicatePagination(listContainer);
		        }
		    });

		    nextBtn.addEventListener('pointerdown', () => {
		        if (duplicateCurrentPage === duplicateTotalPages) return;
		        nextLongTimer = setTimeout(() => {
		            duplicateCurrentPage = duplicateTotalPages;
		            renderDuplicatePage(listContainer);
		            renderDuplicatePagination(listContainer);
		        }, LONG_PRESS);
		    });
		    nextBtn.addEventListener('pointerup', () => clearTimeout(nextLongTimer));
		    nextBtn.addEventListener('pointercancel', () => clearTimeout(nextLongTimer));
		    nextBtn.addEventListener('pointerleave', () => clearTimeout(nextLongTimer));

		    paginationDiv.appendChild(prevBtn);
		    paginationDiv.appendChild(pageInfo);
		    paginationDiv.appendChild(nextBtn);

		    listContainer.parentNode.appendChild(paginationDiv);
		}
function handleFileImport(e) {
    const file = e.target.files[0];
    if (!file) return;

    console.log('【导入】文件选择：', file.name, '大小：', (file.size / 1024 / 1024).toFixed(2), 'MB');

    if (file.size > 20 * 1024 * 1024) {
        showSnackbar('文件太大（>20MB），请压缩后导入', 'error');
        dom.fileInput.value = '';
        return;
    }

    const fileName = file.name.toLowerCase();

    if (fileName.endsWith('.zip')) {
        showSnackbar('正在解析 ZIP 文件...', 'info');
        JSZip.loadAsync(file)
            .then(zip => {
                let excelEntry = null;
                const imageEntries = {}; // 产品号 -> zip entry

                zip.forEach((relativePath, entry) => {
                    const lowerPath = relativePath.toLowerCase();
                    if (lowerPath.endsWith('.xlsx') || lowerPath.endsWith('.xls')) {
                        excelEntry = entry;
                    } else if (/\.(jpg|jpeg|png)$/i.test(lowerPath)) {
                        // 支持多种命名格式：产品号.jpg、产品号_xxx.jpg、xxx-产品号.png
                        const match = relativePath.match(/([A-Za-z0-9]+)\.(jpg|jpeg|png)$/i);
                        if (match && match[1]) {
                            imageEntries[match[1].trim()] = entry;
                            console.log('【ZIP】找到图片：产品号', match[1], '路径', relativePath);
                        }
                    }
                });

                if (!excelEntry) {
                    showSnackbar('ZIP 中未找到 Excel 文件', 'error');
                    dom.fileInput.value = '';
                    return;
                }

                excelEntry.async('arraybuffer').then(buffer => {
                    const wb = XLSX.read(buffer, { type: 'array' });
                    processWorkbookImport(wb, imageEntries, []);
                }).catch(err => {
                    console.error('【导入 ZIP】Excel 读取失败：', err);
                    showSnackbar('ZIP 内 Excel 读取失败', 'error');
                });
            })
            .catch(err => {
                console.error('【导入 ZIP】解析失败：', err);
                showSnackbar('ZIP 文件解析失败', 'error');
                dom.fileInput.value = '';
            });
    } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
        showSnackbar('正在读取 Excel 文件（含嵌入图片）...', 'info');
        const reader = new FileReader();
        reader.onload = async function(event) {
            try {
                const data = event.target.result;
                const zip = await JSZip.loadAsync(data);
                const embeddedImages = []; // 按行顺序存储嵌入图片 base64

                let imageId = 1;
                for (const fileName in zip.files) {
                    if (fileName.match(/xl\/media\/image\d+\.(jpeg|jpg|png)/i)) {
                        const base64 = await zip.files[fileName].async('base64');
                        const ext = fileName.match(/\.(jpeg|jpg|png)/i)?.[1] || 'jpeg';
                        embeddedImages.push(`data:image/${ext};base64,${base64}`);
                        console.log('【导入】找到嵌入图片 ID:', imageId);
                        imageId++;
                    }
                }

                const wb = XLSX.read(data, { type: 'array' });
                processWorkbookImport(wb, {}, embeddedImages);
            } catch (err) {
                console.error('【导入】Excel + 嵌入图片解析失败：', err);
                showSnackbar('文件解析失败，请检查是否包含图片', 'error');
                dom.fileInput.value = '';
            }
        };
        reader.readAsArrayBuffer(file);
    } else {
        showSnackbar('仅支持 .xlsx、.xls 或 .zip 文件', 'warning');
        dom.fileInput.value = '';
    }
}

		function processWorkbookImport(workbook, zipImageEntries = {}, embeddedImages = []) {
		    console.log('【批量导入】函数被调用！当前时间：', new Date().toLocaleString());
    console.log('【批量导入】工作表数量：', workbook.SheetNames?.length || '未知');

    if (!workbook || !workbook.SheetNames) {
        console.error('【批量导入】工作簿无效或为空！');
        showSnackbar('导入文件无效，请检查格式', 'error');
        return;
    }

    console.log('【批量导入】开始解析工作表...');
		    const sheetNames = workbook.SheetNames;

		    const proceedWithSheet = (sheetName) => {
		        const headerMapping = {
		            '钢种': 'steelType',
		            '产品号': 'productId',
		            '卡片号': 'cardId',
		            '炉号': 'furnaceId',
		            '实际直径': 'actualDiameter',
		            '直径': 'diameter',
		            '长度': 'length',
		            '重量': 'weight',
		            '状态': 'status',
		            '位置': 'position',
		            '硬度': 'hardness',
		            '备注': 'remarks',
		            '卡片图片': 'cardImage'
		        };

		        const theoreticalWeightKeywords = ['理算重量', '理论重量', '理重'];

		        const worksheet = workbook.Sheets[sheetName];
		        const range = XLSX.utils.decode_range(worksheet['!ref']);
		        const rawData = [];

		        for (let r = range.s.r; r <= range.e.r; r++) {
		            const row = [];
		            for (let c = range.s.c; c <= range.e.c; c++) {
		                const cellAddress = XLSX.utils.encode_cell({ r, c });
		                const cell = worksheet[cellAddress];
		                row.push(cell ? cell.v : '');
		            }
		            rawData.push(row);
		        }

		        let headerRowIndex = -1;
		        for (let i = 0; i < Math.min(rawData.length, 20); i++) {
		            if (rawData[i].some(cell => {
		                const str = String(cell || '').trim();
		                return str.includes('产品号') || str.includes('钢种') || str.includes('炉号') || str.includes('卡片号');
		            })) {
		                headerRowIndex = i;
		                break;
		            }
		        }

		        if (headerRowIndex === -1) {
		            showSnackbar('未能找到表头行', 'error');
		            dom.fileInput.value = '';
		            return;
		        }

		        const headerRow = rawData[headerRowIndex].map(cell => String(cell || '').trim());
		        const dataRows = rawData.slice(headerRowIndex + 1);

		        const colMapping = {};
		        let theoreticalWeightCol = -1;
		        let imageColIndex = -1;

		        headerRow.forEach((header, idx) => {
		            if (!header) return;
		            const cleanHeader = header.replace(/[\s\(\)（）【】\[\]mmkg千克米]/g, '');

		            if (headerMapping[cleanHeader]) {
		                colMapping[headerMapping[cleanHeader]] = idx;
		            }
		            if (cleanHeader.includes('卡片图片') || cleanHeader.includes('图片')) {
		                imageColIndex = idx;
		            }
		            if (theoreticalWeightKeywords.some(kw => cleanHeader.includes(kw))) {
		                theoreticalWeightCol = idx;
		            }
		        });

		        const formattedData = dataRows.map((row, rowIndex) => {
		            const item = {};

		            for (const field in colMapping) {
		                const colIdx = colMapping[field];
		                if (row[colIdx] !== undefined && row[colIdx] !== '') {
		                    let value = String(row[colIdx]).trim();
		                    if (field === 'weight') {
		                        const num = parseFloat(value);
		                        if (!isNaN(num)) value = Math.round(num).toString();
		                    }
		                    item[field] = value;
		                }
		            }

		            if (theoreticalWeightCol !== -1 && row[theoreticalWeightCol] !== '') {
		                const num = parseFloat(String(row[theoreticalWeightCol]).trim());
		                if (!isNaN(num)) item.weight = Math.round(num).toString();
		            }

		            if (item.productId && zipImageEntries[item.productId]) {
		                zipImageEntries[item.productId].async('base64').then(base64 => {
		                    item.cardImage = `data:image/jpeg;base64,${base64}`;
		                }).catch(() => {});
		            } else if (embeddedImages.length > 0 && rowIndex < embeddedImages.length) {
		                item.cardImage = embeddedImages[rowIndex];
		            }

		            return (item.productId || item.cardId || item.furnaceId || item.steelType) ? item : null;
		        }).filter(item => item !== null);

		        if (formattedData.length === 0) {
		            showSnackbar('未找到有效数据行', 'warning');
		            dom.fileInput.value = '';
		            return;
		        }

		        const totalImported = formattedData.length;
		        const newData = [];
		        const duplicateEntries = [];

		        formattedData.forEach(newItem => {
		            const existingItem = tableData.find(ex => 
		                ex.productId && newItem.productId && 
		                ex.productId.trim() === newItem.productId.trim()
		            );

		            if (!existingItem) {
		                newData.push(newItem);
		            } else {
		                duplicateEntries.push({
		                    productId: newItem.productId,
		                    existingItem,
		                    newItem,
		                    differences: getObjectDifferences(existingItem, newItem)
		                });
		            }
		        });

		if (duplicateEntries.length > 0) {
    showDuplicateConfirmationModal(duplicateEntries, newData, totalImported);
} else {
    finalizeImport(newData, [], totalImported);
}
		    };

		    if (sheetNames.length > 1) {
		        const options = sheetNames.map(name => 
		            `<mdui-menu-item value="${name.replace(/"/g, '&quot;')}">${name}</mdui-menu-item>`
		        ).join('');

		        dom.confirmMessage.innerHTML = `
		            <div style="padding: 16px;">
		                <div style="font-size: 1.1rem; margin-bottom: 16px; text-align: center;">检测到多个工作表，请选择：</div>
		                <mdui-select id="sheetSelect" variant="outlined" placement="bottom" value="${sheetNames[0].replace(/"/g, '&quot;')}" style="width: 100%;">
		                    ${options}
		                </mdui-select>
		            </div>
		        `;

		        openCustomModal(dom.confirmModal);
		        dom.confirmActionBtn.textContent = '确定';

		        dom.confirmActionBtn.onclick = () => {
		            const selectEl = dom.confirmModal.querySelector('#sheetSelect');
		            const selectedSheet = selectEl.value;
		            closeCustomModal(dom.confirmModal);
		            proceedWithSheet(selectedSheet);
		        };

		        dom.cancelConfirmBtn.onclick = () => {
		            closeCustomModal(dom.confirmModal);

		            dom.fileInput.value = '';
		        };
		    } else {
		        proceedWithSheet(sheetNames[0]);
		    }
		}

		async function exportToExcel() {
		    const exportData = getFilteredData();
		    if (exportData.length === 0) {
		        showSnackbar('暂无数据可导出', 'warning');
		        return;
		    }

		    const workbook = new ExcelJS.Workbook();
		    const worksheet = workbook.addWorksheet('圆棒入库数据');

		    worksheet.columns = [
		        { header: '序号', key: 'seq', width: 8 },
		        { header: '钢种', key: 'steelType', width: 15 },
		        { header: '产品号', key: 'productId', width: 18 },
		        { header: '卡片号', key: 'cardId', width: 12 },
		        { header: '炉号', key: 'furnaceId', width: 12 },
		        { header: '实际直径', key: 'actualDiameter', width: 12 },
		        { header: '直径', key: 'diameter', width: 10 },
		        { header: '长度', key: 'length', width: 10 },
		        { header: '重量', key: 'weight', width: 10 },
		        { header: '状态', key: 'status', width: 10 },
		        { header: '位置', key: 'position', width: 10 },
		        { header: '硬度', key: 'hardness', width: 10 },
		        { header: '备注', key: 'remarks', width: 20 },
		        { header: '卡片图片', key: 'cardImage', width: 12 }
		    ];

		    const headerRow = worksheet.getRow(1);
		    headerRow.font = { bold: true };
		    headerRow.alignment = { vertical: 'middle', horizontal: 'center' };

		    exportData.forEach((item, index) => {
		        const row = worksheet.addRow({
		            seq: index + 1,
		            steelType: item.steelType || '',
		            productId: item.productId || '',
		            cardId: item.cardId || '',
		            furnaceId: item.furnaceId || '',
		            actualDiameter: item.actualDiameter || '',
		            diameter: item.diameter || '',
		            length: item.length || '',
		            weight: item.weight ? Math.round(parseFloat(item.weight)) || '' : '',
		            status: item.status || '',
		            position: item.position || '',
		            hardness: item.hardness || '',
		            remarks: item.remarks || '',
		            cardImage: ''
		        });

		        row.height = 22; // 固定高度

		        if (item.cardImage && item.cardImage.startsWith('data:image/')) {
		            const base64Data = item.cardImage.split(',')[1];
		            const ext = item.cardImage.match(/data:image\/(jpeg|png);/)?.[1] || 'jpeg';

		            const imageId = workbook.addImage({
		                base64: base64Data,
		                extension: ext,
		            });

		            worksheet.addImage(imageId, {
		                tl: { col: 13, row: index + 1 },
		                ext: { width: 40, height: 30 },
		                editAs: 'oneCell'
		            });
		        }
		    });

		    const buffer = await workbook.xlsx.writeBuffer();
		    const blob = new Blob([buffer], { type: 'application/octet-stream' });
		    const dateStr = new Date().toLocaleDateString('zh-CN').replace(/\//g, '-');
		    saveAs(blob, `圆棒入库数据_${dateStr}.xlsx`);

		    showSnackbar('导出成功！图片已嵌入表格', 'success');
		}

		function calculateWeight() {
		  const diameter1 = parseFloat(dom.calcDiameter1.value) || 0;
		  const diameter2 = parseFloat(dom.calcDiameter2.value) || 0;
		  const length = parseFloat(dom.calcLength.value) || 0;
		  const densityFactor = parseFloat(dom.calcDensity.value) || 0.00617; 

		  if (diameter1 <= 0 || diameter2 <= 0 || length <= 0) {
		    dom.calcResult.value = '';
		    return;
		  }

		  const crudeWeight = densityFactor * diameter1 * diameter2 * length / 1000;
		  dom.calcResult.value = crudeWeight.toFixed(2);
		}

		function initAutoCalculate() {
		  const calcInputs = [dom.calcDiameter1, dom.calcDiameter2, dom.calcLength];
		  calcInputs.forEach(input => {
		    if (input) {
		      input.addEventListener('input', calculateWeight);
		      input.addEventListener('change', calculateWeight);
		    }
		  });

		  dom.calcDensity.addEventListener('dblclick', (e) => {
		      e.stopPropagation();
		      const densityInput = dom.calcDensity;
		      if (densityInput.hasAttribute('readonly')) {
		          densityInput.removeAttribute('readonly');
		          densityInput.classList.remove('readonly-input');
		          densityInput.focus();
		      } else {
		          densityInput.setAttribute('readonly', 'true');
		          densityInput.classList.add('readonly-input');
		          densityInput.blur();
		      }
		  });

		  calculateWeight();
		}
		// 表格无图片格子点击 → 直接唤起拍照并替换
function startDirectTakePhoto(dataIndex) {
    const fileInput = document.getElementById('cardImageInput');

    fileInput.setAttribute('capture', 'environment'); // 强制后置摄像头
    fileInput.click();

    const handlePhotoTaken = async (e) => {
        if (e.target.files?.[0]) {
            try {
                const compressedBase64 = await handleImageSelect(e);

                if (compressedBase64 && tableData[dataIndex]) {
                    tableData[dataIndex].cardImage = compressedBase64;
                    saveDataToIndexedDB();
                    updateTable();  // 关键：立即刷新表格显示新图片
                    showSnackbar('上传成功，已填入表格', 'success');
                }
            } catch (err) {
                showSnackbar('图片处理失败', 'error');
                console.error(err);
            }
        }

        // 清理
        fileInput.removeAttribute('capture');
        fileInput.value = '';
        fileInput.removeEventListener('change', handlePhotoTaken);
    };

    fileInput.addEventListener('change', handlePhotoTaken, { once: true });
}

		function calculateAndAddData() {
		    const diameter1 = parseFloat(dom.calcDiameter1.value);
		    const diameter2 = parseFloat(dom.calcDiameter2.value);
		    const length = parseFloat(dom.calcLength.value);
		    const weight = parseFloat(dom.calcResult.value);

		    if (isNaN(diameter1) || isNaN(diameter2) || isNaN(length) || diameter1 <= 0 || diameter2 <= 0 || length <= 0) {
		      showSnackbar('请输入有效的计算参数', 'error');
		      return;
		    }

		    const minDiameter = Math.min(diameter1, diameter2);
		    const maxDiameter = Math.max(diameter1, diameter2);
		    // 修复1：不保留小数 - 四舍五入取整，同时修正模板字符串插值语法（原转义字符错误）
		    const actualDiameter = `${Math.round(minDiameter)}-${Math.round(maxDiameter)}`;
		    // 修复2：平均直径不保留小数
		    const averageDiameter = Math.round((minDiameter + maxDiameter) / 2);

		    const preFilledData = {
		      actualDiameter: actualDiameter,
		      diameter: averageDiameter, 
		      // 修复3：长度、重量不保留小数
		      length: Math.round(length),
		      weight: Math.round(weight)
		    };

		    closeCustomModal(dom.calculatorModal); 
		    dom.virtualKeyboard.style.display = 'none'; 
		    openAddModalWithData(preFilledData);
		}

		function toggleMultiSelectMode() {
		  isMultiSelectMode = !isMultiSelectMode;
		  selectedRows.clear();

		  const menuText = dom.multiSelectMenuText;
		  if (isMultiSelectMode) {
		    menuText.textContent = '退出多选模式';
		    dom.multiSelectMenuItem.icon = 'check_box';
		  } else {
		    menuText.textContent = '进入多选模式';
		    dom.multiSelectMenuItem.icon = 'check_box_outline_blank';
		  }

		  updateTable();
		}

		function initCalculatorKeyboard() {
		  const calcInputs = [dom.calcDiameter1, dom.calcDiameter2, dom.calcLength];
		  calcInputs.forEach(input => {
		    if (input) {
		      input.setAttribute('readonly', 'true');
		      input.classList.add('readonly-input');

		      input.addEventListener('click', (e) => {
		          if (input.hasAttribute('readonly')) {
		            e.stopPropagation();
		            currentInput = e.target;
		            updateKeyboardForInput(currentInput);
		            showVirtualKeyboard();
		            currentInput.focus();

		            const modalContent = document.getElementById('calculatorContent');
		            if(modalContent) {
		                setTimeout(() => {
		                    const inputRect = currentInput.getBoundingClientRect();
		                    const modalRect = modalContent.getBoundingClientRect();
		                    const offset = inputRect.top - modalRect.top + modalContent.scrollTop - modalRect.height * 0.3; 
		                    modalContent.scrollTo({ top: offset, behavior: 'smooth' });
		                }, 50);
		            }
		          }
		      });

		      input.addEventListener('dblclick', (e) => {
		          e.stopPropagation();
		          if (dom.calculatorModal.style.display !== 'block') return;
		          if (input.hasAttribute('readonly')) {
		            input.removeAttribute('readonly');
		            input.classList.remove('readonly-input');
		            dom.virtualKeyboard.style.display = 'none';
		            input.focus();
		          } else {
		            input.setAttribute('readonly', 'true');
		            input.classList.add('readonly-input');
		            currentInput = input;
		            updateKeyboardForInput(currentInput);
		            showVirtualKeyboard();
		          }
		      });
		    }
		  });
		}
		// ==================== 多字段排序核心函数（支持记忆 + 修复模板错误） ====================

		const SORT_RULES_KEY = 'sortRulesMemory'; // localStorage 键名

		// 保存当前排序规则到 localStorage
		function saveSortRulesToStorage(rules) {
		    localStorage.setItem(SORT_RULES_KEY, JSON.stringify(rules));
		}

		// 从 localStorage 读取上次排序规则
		function loadSortRulesFromStorage() {
		    const saved = localStorage.getItem(SORT_RULES_KEY);
		    if (!saved) return null;
		    try {
		        return JSON.parse(saved);
		    } catch (e) {
		        return null;
		    }
		}

		function openSortModal() {
		    dom.drawer.open = false;
		    openCustomModal(dom.sortModal);

		    // 清空容器
		    dom.sortRulesContainer.innerHTML = '';

		    // 尝试加载上次记忆的排序规则
		    const savedRules = loadSortRulesFromStorage();

		    if (savedRules && savedRules.length > 0) {
		        // 恢复记忆的规则
		        savedRules.forEach(rule => {
		            addSortRule(rule.field, rule.order);
		        });
		    } else {
		        // 没有记忆时，默认添加一条：卡片号升序
		        addSortRule('cardId', 'asc');
		    }

		    updateAddButtonState();
		}

		function addSortRule(field = 'productId', order = 'asc') {
		    if (dom.sortRulesContainer.children.length >= 5) {
		        showSnackbar('最多支持5个排序规则', 'warning');
		        return;
		    }

		    const ruleDiv = document.createElement('div');
		    ruleDiv.className = 'sort-rule';
		    ruleDiv.style.cssText = 'display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding: 14px; background-color: var(--background-color); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 2px 6px rgba(0,0,0,0.06);';

		    // === 字段选择 mdui-select ===
		    const fieldSelect = document.createElement('mdui-select');
		    fieldSelect.variant = 'outlined';
		    fieldSelect.value = field;
		    fieldSelect.placeholder = '选择字段';
		    fieldSelect.style.width = '100%';

		    sortFieldOptions.forEach(opt => {
		        const option = document.createElement('mdui-menu-item');
		        option.value = opt.value;
		        option.textContent = opt.label;
		        if (opt.value === field) option.selected = true;
		        fieldSelect.appendChild(option);
		    });

		    // === 排序方向 mdui-select ===
		    const orderSelect = document.createElement('mdui-select');
		    orderSelect.variant = 'outlined';
		    orderSelect.value = order;
		    orderSelect.style.width = '100%';

		    const ascOption = document.createElement('mdui-menu-item');
		    ascOption.value = 'asc';
		    ascOption.textContent = '升序 ↑';
		    if (order === 'asc') ascOption.selected = true;

		    const descOption = document.createElement('mdui-menu-item');
		    descOption.value = 'desc';
		    descOption.textContent = '降序 ↓';
		    if (order === 'desc') descOption.selected = true;

		    orderSelect.appendChild(ascOption);
		    orderSelect.appendChild(descOption);

		    // === 删除按钮 ===
		    const deleteBtn = document.createElement('mdui-button-icon');
		    deleteBtn.icon = 'delete';
		    deleteBtn.variant = 'tonal';
		    deleteBtn.style.flexShrink = '0';

		    deleteBtn.addEventListener('click', () => {
		        ruleDiv.remove();
		        updateAddButtonState();
		    });

		    // 组装
		    ruleDiv.appendChild(fieldSelect);
		    ruleDiv.appendChild(orderSelect);
		    ruleDiv.appendChild(deleteBtn);

		    dom.sortRulesContainer.appendChild(ruleDiv);

		    // 【关键】添加后，智能设置每个 select 的 placement
		    setTimeout(() => {
		        const selects = ruleDiv.querySelectorAll('mdui-select');
		        selects.forEach(select => {
		            // 获取元素在视口中的位置
		            const rect = select.getBoundingClientRect();
		            const spaceBelow = window.innerHeight - rect.bottom;
		            const spaceAbove = rect.top;

		            // 如果下方空间不足 200px（菜单大约高度），则向上展开
		            if (spaceBelow < 200 && spaceAbove > spaceBelow) {
		                select.placement = 'top-start';
		            } else {
		                select.placement = 'bottom-start';
		            }
		        });
		    }, 100); // 延迟确保 DOM 已渲染

		    updateAddButtonState();
		}

		function updateAddButtonState() {
		    const count = dom.sortRulesContainer.children.length;
		    dom.addSortRuleBtn.disabled = count >= 5;

		    // 可选：更新“应用排序”按钮状态（至少一条规则才能应用）
		    dom.applySortBtn.disabled = count === 0;
		}

		function applySort() {
		    const rules = [];
		    const ruleElements = dom.sortRulesContainer.querySelectorAll('.sort-rule');

		    if (ruleElements.length === 0) {
		        showSnackbar('请至少添加一个排序规则', 'warning');
		        return;
		    }

		    ruleElements.forEach(el => {
		        const fieldSelect = el.querySelector('mdui-select:first-of-type');
		        const orderSelect = el.querySelector('mdui-select:last-of-type');

		        const field = fieldSelect.value;
		        const order = orderSelect.value;

		        if (field && order) {
		            rules.push({ field, order });
		        }
		    });

		    // 执行排序
		    tableData.sort((a, b) => {
		        for (const rule of rules) {
		            let aVal = a[rule.field] ?? '';
		            let bVal = b[rule.field] ?? '';

		            let cmp = 0;
		            if (numericSortFields.includes(rule.field)) {
		                const aNum = parseFloat(aVal) || 0;
		                const bNum = parseFloat(bVal) || 0;
		                cmp = aNum - bNum;
		            } else {
		                cmp = String(aVal).localeCompare(String(bVal), 'zh-CN', { numeric: true, sensitivity: 'base' });
		            }

		            if (cmp !== 0) {
		                return rule.order === 'asc' ? cmp : -cmp;
		            }
		        }
		        return 0;
		    });

		    // 【关键】应用后保存本次规则到 localStorage，实现记忆功能
		    saveSortRulesToStorage(rules);

		    saveDataToIndexedDB();
		    currentPage = 1;  
		    updateTable();
		    closeCustomModal(dom.sortModal);

		    const msgParts = rules.map((r, i) =>
		    `第${i + 1}优先级：【${fieldLabels[r.field]}】${r.order === 'asc' ? '升序' : '降序'}`
		);
		showSnackbar('排序已应用：' + msgParts.join(' → '), 'success');

		    }
		async function compressImage(file, maxWidth = 1024, maxHeight = 1024, quality = 0.85) {
    return new Promise((resolve) => {
        const img = new Image();
        const reader = new FileReader();

        reader.onload = (e) => {
            img.src = e.target.result;
        };

        img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            if (width > maxWidth || height > maxHeight) {
                const ratio = Math.min(maxWidth / width, maxHeight / height);
                width *= ratio;
                height *= ratio;
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            resolve(canvas.toDataURL('image/jpeg', quality));
        };

        reader.readAsDataURL(file);
    });
}

// ==================== 图片上传处理函数（完整版，无 OCR） ====================
async function handleImageSelect(e) {
    // 新增模式下：每次选择新图都先清理旧临时变量
    if (currentEditIndex === -1) {
        delete window.tempNewCardImage;
        console.log('[上传] 新增模式 - 已清理旧 tempNewCardImage');
    }

    let file;
    if (e.type === 'drop') {
        e.preventDefault();
        e.stopPropagation();
        file = e.dataTransfer.files[0];
    } else {
        file = e.target.files[0];
    }

    if (!file) return null;

    if (!file.type.startsWith('image/')) {
        showSnackbar('仅支持图片格式', 'error');
        return null;
    }

    let base64;

    // ≤5MB：直接压缩
    if (file.size <= 5 * 1024 * 1024) {
        showSnackbar('正在处理图片...', 'info');
        try {
            base64 = await compressImage(file, 1024, 1024, 0.85);
        } catch (err) {
            console.error('压缩失败:', err);
            showSnackbar('图片处理失败', 'error');
            return null;
        }
    } else {
        // >5MB：弹出选择
        const dialog = document.getElementById('largeImageWarnDialog');
        if (!dialog) {
            showSnackbar('系统错误：找不到过大图片提示', 'error');
            return null;
        }

        dialog.open = true;

        base64 = await new Promise(resolve => {
            let handled = false;

            const compressBtn = dialog.querySelector('#largeImageCompressBtn');
            if (compressBtn) {
                compressBtn.onclick = async () => {
                    if (handled) return; handled = true;
                    dialog.open = false;
                    showSnackbar('正在压缩大图...', 'info');
                    try {
                        const compressed = await compressImage(file, 1024, 1024, 0.75);
                        resolve(compressed);
                    } catch {
                        showSnackbar('压缩失败', 'error');
                        resolve(null);
                    }
                };
            }

            const forceBtn = dialog.querySelector('#largeImageForceBtn');
            if (forceBtn) {
                forceBtn.onclick = async () => {
                    if (handled) return; handled = true;
                    dialog.open = false;
                    showSnackbar('正在处理大图（较慢）...', 'warning');
                    try {
                        const raw = await fileToBase64(file);
                        resolve(raw);
                    } catch {
                        showSnackbar('上传失败', 'error');
                        resolve(null);
                    }
                };
            }

            const cancelBtn = dialog.querySelector('#largeImageCancelBtn');
            if (cancelBtn) {
                cancelBtn.onclick = () => {
                    if (handled) return; handled = true;
                    dialog.open = false;
                    showSnackbar('已取消', 'info');
                    resolve(null);
                };
            }

            dialog.addEventListener('close', () => {
                if (handled) return;
                handled = true;
                dialog.open = false;
                showSnackbar('已取消', 'info');
                resolve(null);
            }, { once: true });
        });
    }

    if (!base64) return null;

    // 更新预览（仅用于用户看到）
    const previewImg = document.getElementById('previewImg');
    const previewContainer = document.getElementById('cardImagePreview');
    const noImageArea = document.getElementById('noImageUploadArea');

    if (previewImg) {
        previewImg.src = base64;
        console.log('[上传] 预览区已设置 src，长度：' + base64.length);
    }
    if (previewContainer && noImageArea) {
        previewContainer.style.display = 'block';
        noImageArea.style.display = 'none';
    }

    // ★★★ 关键：上传成功后立即存入临时变量（保存时优先用这个） ★★★
    window.tempNewCardImage = base64;
    console.log('[上传] 图片已强制存入 window.tempNewCardImage，长度：' + base64.length);

    // 编辑模式下直接写回 tableData
    if (currentEditIndex !== -1 && tableData[currentEditIndex]) {
        tableData[currentEditIndex].cardImage = base64;
        console.log('[上传] 编辑模式 - 已直接写入 tableData');
    }

    // 实时持久化一次（防止意外丢失）
    await saveDataToIndexedDB();
    updateTable();

    showSnackbar('图片处理完成', 'success');
    return base64;
}

function showFullImage(src, productId = '', dataIndex = -1) {
    const overlay = document.createElement('div');
    overlay.className = 'image-preview-overlay';
    overlay.style.cssText = `
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.92);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    `;

    // 顶部信息栏（产品号）
    const topBar = document.createElement('div');
    topBar.style.cssText = `
        padding: 16px 16px 8px;
        background: rgba(0,0,0,0.6);
        color: white;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    `;

    topBar.innerHTML = `
        <div style="font-weight: 500;">
            ${productId ? `产品号： ${productId}` : '卡片图片预览'}
        </div>
        <mdui-button-icon icon="close" style="color:white;" onclick="this.closest('.image-preview-overlay').remove()"></mdui-button-icon>
    `;

    // 图片容器（支持拖动）
    const imgContainer = document.createElement('div');
    imgContainer.style.cssText = `
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        touch-action: none;
        position: relative;
    `;

    // wrapper 用于平移 + 缩放 + 旋转 核心容器
    const imgWrapper = document.createElement('div');
    imgWrapper.style.cssText = `
        transition: transform 0.18s ease-out;
        will-change: transform;
        transform-origin: center center;
    `;

    const img = document.createElement('img');
    img.src = src;
    img.style.cssText = `
        max-width: 95%;
        max-height: 85vh;
        object-fit: contain;
        transform-origin: center center;
        user-select: none;
    `;

    imgWrapper.appendChild(img);
    imgContainer.appendChild(imgWrapper);
    overlay.appendChild(topBar);
    overlay.appendChild(imgContainer);

    // 底部操作栏（按钮排序：缩小 → 放大 → 左旋 → 右旋 → 重置 → 下拉菜单最右侧）
    const bottomBar = document.createElement('mdui-bottom-app-bar');
    bottomBar.style.position = 'relative';
    bottomBar.innerHTML = `
        <mdui-button-icon variant="filled" icon="zoom_out" id="zoomOutBtn"></mdui-button-icon>
        <mdui-button-icon variant="filled" icon="zoom_in" id="zoomInBtn"></mdui-button-icon>
        <mdui-button-icon variant="filled" icon="rotate_left" id="rotateLeftBtn"></mdui-button-icon>
        <mdui-button-icon variant="filled" icon="rotate_right" id="rotateRightBtn"></mdui-button-icon>
        <mdui-button-icon variant="filled" icon="restart_alt" id="resetZoomBtn"></mdui-button-icon>
        <div style="flex-grow: 1;"></div>
        <!-- 下拉菜单（现在包含拍照、从相册选择、删除） -->
        <mdui-dropdown placement="top">
            <mdui-button-icon slot="trigger" variant="filled" icon="more_vert"></mdui-button-icon>
            <mdui-menu>
                <!-- 拍照替换 -->
                <mdui-menu-item id="takePhotoInPreviewBtn">
                    <mdui-icon slot="start" name="photo_camera"></mdui-icon>
                    拍照替换
                </mdui-menu-item>
                <!-- 从相册选择 -->
                <mdui-menu-item id="selectGalleryInPreviewBtn">
                    <mdui-icon slot="start" name="photo_library"></mdui-icon>
                    从相册选择
                </mdui-menu-item>
                <mdui-divider></mdui-divider>
                <!-- 删除图片（红色警示） -->
                <mdui-menu-item id="deleteImageInPreviewBtn" style="color:var(--mdui-color-error);">
                    <mdui-icon slot="start" name="delete"></mdui-icon>
                    删除图片
                </mdui-menu-item>
            </mdui-menu>
        </mdui-dropdown>
    `;
    overlay.appendChild(bottomBar);

    document.body.appendChild(overlay);

    // ────────────────────────────── 核心状态 ──────────────────────────────
    let currentScale = 1;
    let translateX = 0;
    let translateY = 0;
    let rotateDeg = 0;
    let isDragging = false;
    let startX = 0, startY = 0;
    let imgWidth = 0;
    let imgHeight = 0;
    let containerWidth = imgContainer.clientWidth;
    let containerHeight = imgContainer.clientHeight;
    const OVERFLOW_PERCENT = 0.5;

    const getClampedPos = (x, y) => {
        const scaledWidth = imgWidth * currentScale;
        const scaledHeight = imgHeight * currentScale;
        const maxX = Math.max(scaledWidth, containerWidth) * OVERFLOW_PERCENT;
        const maxY = Math.max(scaledHeight, containerHeight) * OVERFLOW_PERCENT;
        return {
            x: Math.max(-maxX, Math.min(maxX, x)),
            y: Math.max(-maxY, Math.min(maxY, y))
        };
    };

    const updatePosImmediately = () => {
        imgWrapper.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale}) rotate(${rotateDeg}deg)`;
    };

    const updatePosWithTransition = () => {
        const {x, y} = getClampedPos(translateX, translateY);
        imgWrapper.style.transform = `translate(${x}px, ${y}px) scale(${currentScale}) rotate(${rotateDeg}deg)`;
        translateX = x;
        translateY = y;
    };

    const updateTransform = () => updatePosWithTransition();

    img.onload = function() {
        imgWidth = this.offsetWidth;
        imgHeight = this.offsetHeight;
        containerWidth = imgContainer.clientWidth;
        containerHeight = imgContainer.clientHeight;
        updateTransform();
    };

    window.addEventListener('resize', () => {
        containerWidth = imgContainer.clientWidth;
        containerHeight = imgContainer.clientHeight;
        updateTransform();
    });

    // ────────────────────────────── 缩放/旋转/重置按钮绑定 ──────────────────────────────
    const zoomOutBtn = bottomBar.querySelector('#zoomOutBtn');
    const zoomInBtn = bottomBar.querySelector('#zoomInBtn');
    const rotateLeftBtn = bottomBar.querySelector('#rotateLeftBtn');
    const rotateRightBtn = bottomBar.querySelector('#rotateRightBtn');
    const resetZoomBtn = bottomBar.querySelector('#resetZoomBtn');

    if (zoomOutBtn) zoomOutBtn.addEventListener('click', () => { currentScale = Math.max(0.5, currentScale - 0.25); updateTransform(); });
    if (zoomInBtn) zoomInBtn.addEventListener('click', () => { currentScale = Math.min(4, currentScale + 0.25); updateTransform(); });
    if (rotateLeftBtn) rotateLeftBtn.addEventListener('click', () => { rotateDeg -= 90; updateTransform(); });
    if (rotateRightBtn) rotateRightBtn.addEventListener('click', () => { rotateDeg += 90; updateTransform(); });
    if (resetZoomBtn) resetZoomBtn.addEventListener('click', () => { 
        currentScale = 1; translateX = 0; translateY = 0; rotateDeg = 0; 
        updateTransform();
        typeof showSnackbar === 'function' && showSnackbar('已重置到原始大小和位置', 'info');
    });

    // ────────────────────────────── 双指缩放 + 单指拖动 ──────────────────────────────
    let pinchStartDist = 0;
    let pinchStartScale = 1;
    let lastTap = 0;

    imgContainer.addEventListener('touchstart', e => {
        if (e.touches.length === 2) {
            e.preventDefault();
            const [t1, t2] = e.touches;
            pinchStartDist = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
            pinchStartScale = currentScale;
        } else if (e.touches.length === 1) {
            const now = Date.now();
            if (now - lastTap < 300) {
                currentScale = 1; translateX = 0; translateY = 0; rotateDeg = 0;
                updateTransform();
                e.preventDefault();
            }
            lastTap = now;
            isDragging = true;
            startX = e.touches[0].clientX - translateX;
            startY = e.touches[0].clientY - translateY;
        }
    }, { passive: false });

    imgContainer.addEventListener('touchmove', e => {
        if (e.touches.length === 2 && pinchStartDist > 0) {
            e.preventDefault();
            const [t1, t2] = e.touches;
            const dist = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
            currentScale = Math.max(0.5, Math.min(4, pinchStartScale * (dist / pinchStartDist)));
            updatePosImmediately();
        } else if (isDragging && e.touches.length === 1) {
            e.preventDefault();
            translateX = e.touches[0].clientX - startX;
            translateY = e.touches[0].clientY - startY;
            updatePosImmediately();
        }
    }, { passive: false });

    imgContainer.addEventListener('touchend', () => {
        pinchStartDist = 0; 
        isDragging = false;
        updatePosWithTransition();
    });

    // ────────────────────────────── 新增：下拉菜单三个按钮的业务逻辑 ──────────────────────────────
    const fileInput = document.getElementById('cardImageInput');

    // 1. 拍照替换
    overlay.querySelector('#takePhotoInPreviewBtn').onclick = () => {
        overlay.remove();
        fileInput.setAttribute('capture', 'environment');
        fileInput.click();

        const onceHandler = async (e) => {
            if (e.target.files?.[0]) {
                const base64 = await handleImageSelect(e);
                if (base64) {
                    // 更新当前预览图片
                    img.src = base64;
                    // 如果有 dataIndex，更新 tableData
                    if (dataIndex !== -1 && tableData[dataIndex]) {
                        tableData[dataIndex].cardImage = base64;
                        saveDataToIndexedDB();
                        updateTable();
                    }
                    showSnackbar('图片已通过拍照替换', 'success');
                }
            }
            fileInput.removeAttribute('capture');
            fileInput.value = '';
        };
        fileInput.addEventListener('change', onceHandler, { once: true });
    };

    // 2. 从相册选择
    overlay.querySelector('#selectGalleryInPreviewBtn').onclick = () => {
        overlay.remove();
        fileInput.removeAttribute('capture');
        fileInput.click();

        const onceHandler = async (e) => {
            if (e.target.files?.[0]) {
                const base64 = await handleImageSelect(e);
                if (base64) {
                    img.src = base64;
                    if (dataIndex !== -1 && tableData[dataIndex]) {
                        tableData[dataIndex].cardImage = base64;
                        saveDataToIndexedDB();
                        updateTable();
                    }
                    showSnackbar('图片已替换', 'success');
                }
            }
            fileInput.value = '';
        };
        fileInput.addEventListener('change', onceHandler, { once: true });
    };

    // 3. 删除图片
    overlay.querySelector('#deleteImageInPreviewBtn').onclick = () => {
        overlay.remove();
        if (dataIndex !== -1) {
            window.tempDeleteImageIndex = dataIndex;
            document.getElementById('deleteImageConfirmDialog').open = true;
        } else {
            showSnackbar('无法删除（无记录索引）', 'error');
        }
    };

    // 点击空白处关闭
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay || e.target === imgContainer) {
            overlay.remove();
        }
    });
}

		function openEditModalForImageUpload(dataIndex) {
		    // 临时抑制键盘
		    suppressVirtualKeyboard = true;
		    dom.virtualKeyboard.style.display = 'none';

		    // 打开编辑弹窗
		    openEditModal(dataIndex);

		    setTimeout(() => {
		        // 滚动到图片上传区
		        const modalContent = document.getElementById('dataSheetContent');
		        if (modalContent) {
		            modalContent.scrollTop = modalContent.scrollHeight;
		        }

		        // 关键修复：移除 capture 属性，确保打开相册而不是相机
		        const fileInput = document.getElementById('cardImageInput');
		        fileInput.removeAttribute('capture');  // ← 这里移除 capture

		        // 直接触发文件选择（相册优先）
		        fileInput.click();

		        // 选择完成后恢复键盘抑制（可选）
		        const onChangeOnce = () => {
		            suppressVirtualKeyboard = false;
		            fileInput.removeEventListener('change', onChangeOnce);
		        };
		        fileInput.addEventListener('change', onChangeOnce, { once: true });

		        // 保险：5秒后强制恢复（防止用户取消）
		        setTimeout(() => {
		            suppressVirtualKeyboard = false;
		        }, 5000);
		    }, 400);
		}
		function bindEditModalImageButtons() {
    const fileInput = document.getElementById('cardImageInput');

    // 拍照
    const takePhotoBtn = document.getElementById('takePhotoInEditBtn');
    if (takePhotoBtn) {
        takePhotoBtn.onclick = () => {
            fileInput.setAttribute('capture', 'environment');
            fileInput.click();
        };
    }

    // 从相册选择
    const galleryBtn = document.getElementById('selectFromGalleryInEditBtn');
    if (galleryBtn) {
        galleryBtn.onclick = () => {
            fileInput.removeAttribute('capture');
            fileInput.click();
        };
    }

    // 删除 → 打开确认框
    const deleteBtn = document.getElementById('deleteImageInEditBtn');
    if (deleteBtn) {
        deleteBtn.onclick = () => {
            window.tempDeleteImageIndex = currentEditIndex;
            document.getElementById('deleteImageConfirmDialog').open = true;
        };
    }
}
	function showImagePreviewByIndex(index) {
    // 边界检查：如果 index 无效，从 0 开始
    if (index < 0 || index >= tableData.length) {
        index = 0;
    }

    const currentItem = tableData[index];
    let productId = currentItem?.productId || '无产品号'; // ✅ 修改为 let 支持后续更新
    const hasImage = currentItem?.cardImage && currentItem.cardImage.startsWith('data:image/');

    const overlay = document.createElement('div');
    overlay.className = 'image-preview-overlay';
    overlay.style.cssText = `
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.92);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    `;

    // 顶部信息栏（显示产品号 + 当前第几条/总共多少条）
    const topBar = document.createElement('div');
    topBar.style.cssText = `
        padding: 16px 16px 8px;
        background: rgba(0,0,0,0.6);
        color: white;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    `;

    const updateTopBar = () => {
        topBar.innerHTML = `
            <div style="font-weight: 500;">
                产品号：${productId} (${index + 1} / ${tableData.length})
            </div>
            <mdui-button-icon icon="close" style="color:white;" onclick="this.closest('.image-preview-overlay').remove()"></mdui-button-icon>
        `;
    };
    updateTopBar();

    // 图片容器
    const imgContainer = document.createElement('div');
    imgContainer.style.cssText = `
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        touch-action: none;
        position: relative;
        background: #111;
    `;

    const imgWrapper = document.createElement('div');
    imgWrapper.style.cssText = `
        transition: transform 0.18s ease-out;
        will-change: transform;
        transform-origin: center center;
        text-align: center;
    `;

    let img = null;
    if (hasImage) {
        img = document.createElement('img');
        img.src = currentItem.cardImage;
        img.style.cssText = `
            max-width: 95%;
            max-height: 85vh;
            object-fit: contain;
            transform-origin: center center;
            user-select: none;
        `;
        imgWrapper.appendChild(img);
    } else {
        // 无图片时的占位文字
        const placeholder = document.createElement('div');
        placeholder.style.cssText = `
            color: #aaa;
            font-size: 1.4rem;
            text-align: center;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            max-width: 80%;
        `;
        placeholder.innerHTML = '当前没有图片<br><br>点击右下角菜单进行上传<br></br>提示：底部栏是可以左右滚动的';
        imgWrapper.appendChild(placeholder);
    }

    imgContainer.appendChild(imgWrapper);
    overlay.appendChild(topBar);
    overlay.appendChild(imgContainer);

    // 底部栏（可横向滚动）
    const bottomBar = document.createElement('mdui-bottom-app-bar');
    bottomBar.style.position = 'relative';
    bottomBar.style.overflowX = 'auto';
    bottomBar.style.whiteSpace = 'nowrap';
    bottomBar.style.padding = '0 16px';
    bottomBar.innerHTML = `
        <!-- 放大在前，缩小在后 -->
        <mdui-button-icon variant="filled" icon="zoom_in" id="zoomInBtn"></mdui-button-icon>
        <mdui-button-icon variant="filled" icon="zoom_out" id="zoomOutBtn"></mdui-button-icon>
        <mdui-button-icon variant="filled" icon="rotate_left" id="rotateLeftBtn"></mdui-button-icon>
        <mdui-button-icon variant="filled" icon="rotate_right" id="rotateRightBtn"></mdui-button-icon>
        <!-- 重置无底色 -->
        <mdui-button-icon variant="text" icon="restart_alt" id="resetZoomBtn"></mdui-button-icon>

        <!-- 上一个 / 下一个 -->
        <mdui-button-icon variant="filled" icon="chevron_left" id="prevImageBtn" title="上一条记录"></mdui-button-icon>
        <mdui-button-icon variant="filled" icon="chevron_right" id="nextImageBtn" title="下一条记录"></mdui-button-icon>

        <div style="flex-grow: 1; min-width: 100px;"></div>

        <mdui-dropdown placement="top">
            <mdui-button-icon slot="trigger" variant="filled" icon="more_vert"></mdui-button-icon>
            <mdui-menu>
                <mdui-menu-item id="takePhotoInPreviewBtn">
                    <mdui-icon slot="start" name="photo_camera"></mdui-icon>拍照
                </mdui-menu-item>
                <mdui-menu-item id="selectGalleryInPreviewBtn">
                    <mdui-icon slot="start" name="photo_library"></mdui-icon>从相册选择
                </mdui-menu-item>
                <mdui-divider></mdui-divider>
                <mdui-menu-item id="deleteImageInPreviewBtn" style="color:var(--mdui-color-error);">
                    <mdui-icon slot="start" name="delete"></mdui-icon>删除图片
                </mdui-menu-item>
            </mdui-menu>
        </mdui-dropdown>
    `;
    overlay.appendChild(bottomBar);
    document.body.appendChild(overlay);

    // ────────────────────────────── 核心状态（仅有图片时才启用缩放/旋转/拖动） ──────────────────────────────
    let currentScale = 1;
    let translateX = 0;
    let translateY = 0;
    let rotateDeg = 0;
    let isDragging = false;
    let startX = 0;
    let startY = 0;
    let imgWidth = 0;
    let imgHeight = 0;
    let containerWidth = imgContainer.clientWidth;
    let containerHeight = imgContainer.clientHeight;
    const OVERFLOW_PERCENT = 0.5;

    const getClampedPos = (x, y) => {
        const scaledWidth = imgWidth * currentScale;
        const scaledHeight = imgHeight * currentScale;
        const maxX = Math.max(scaledWidth, containerWidth) * OVERFLOW_PERCENT;
        const maxY = Math.max(scaledHeight, containerHeight) * OVERFLOW_PERCENT;
        return {
            x: Math.max(-maxX, Math.min(maxX, x)),
            y: Math.max(-maxY, Math.min(maxY, y))
        };
    };

    const updatePosImmediately = () => {
        imgWrapper.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale}) rotate(${rotateDeg}deg)`;
    };

    const updatePosWithTransition = () => {
        const {x, y} = getClampedPos(translateX, translateY);
        imgWrapper.style.transform = `translate(${x}px, ${y}px) scale(${currentScale}) rotate(${rotateDeg}deg)`;
        translateX = x;
        translateY = y;
    };

    const updateTransform = () => updatePosWithTransition();

    if (hasImage) {
        img.onload = function() {
            imgWidth = this.offsetWidth;
            imgHeight = this.offsetHeight;
            containerWidth = imgContainer.clientWidth;
            containerHeight = imgContainer.clientHeight;
            updateTransform();
        };
    }

    window.addEventListener('resize', () => {
        containerWidth = imgContainer.clientWidth;
        containerHeight = imgContainer.clientHeight;
        if (hasImage) updateTransform();
    });

    // ────────────────────────────── 按钮绑定（无图片时部分禁用） ──────────────────────────────
    const zoomOutBtn = bottomBar.querySelector('#zoomOutBtn');
    const zoomInBtn = bottomBar.querySelector('#zoomInBtn');
    const rotateLeftBtn = bottomBar.querySelector('#rotateLeftBtn');
    const rotateRightBtn = bottomBar.querySelector('#rotateRightBtn');
    const resetZoomBtn = bottomBar.querySelector('#resetZoomBtn');
    const prevBtn = bottomBar.querySelector('#prevImageBtn');
    const nextBtn = bottomBar.querySelector('#nextImageBtn');

    // 缩放/旋转/重置只有有图片时才有效
    const enableTransformBtns = hasImage;
    if (zoomOutBtn) zoomOutBtn.disabled = !enableTransformBtns;
    if (zoomInBtn) zoomInBtn.disabled = !enableTransformBtns;
    if (rotateLeftBtn) rotateLeftBtn.disabled = !enableTransformBtns;
    if (rotateRightBtn) rotateRightBtn.disabled = !enableTransformBtns;
    if (resetZoomBtn) resetZoomBtn.disabled = !enableTransformBtns;

    if (enableTransformBtns) {
        if (zoomOutBtn) zoomOutBtn.addEventListener('click', () => { currentScale = Math.max(0.5, currentScale - 0.25); updateTransform(); });
        if (zoomInBtn) zoomInBtn.addEventListener('click', () => { currentScale = Math.min(4, currentScale + 0.25); updateTransform(); });
        if (rotateLeftBtn) rotateLeftBtn.addEventListener('click', () => { rotateDeg -= 90; updateTransform(); });
        if (rotateRightBtn) rotateRightBtn.addEventListener('click', () => { rotateDeg += 90; updateTransform(); });
        if (resetZoomBtn) resetZoomBtn.addEventListener('click', () => { 
            currentScale = 1; translateX = 0; translateY = 0; rotateDeg = 0; 
            updateTransform();
            typeof showSnackbar === 'function' && showSnackbar('已重置到原始大小和位置', 'info');
        });
    }

    // 上一个 / 下一个（始终可用，边界禁用）
    if (prevBtn) prevBtn.addEventListener('click', () => switchImage(-1));
    if (nextBtn) nextBtn.addEventListener('click', () => switchImage(1));

    const updatePrevNext = () => {
        if (prevBtn) prevBtn.disabled = index === 0;
        if (nextBtn) nextBtn.disabled = index === tableData.length - 1;
    };
    updatePrevNext();

    // 切换到上一条/下一条记录
    const switchImage = (direction) => {
        index = Math.max(0, Math.min(tableData.length - 1, index + direction));
        const newItem = tableData[index];
        const newHasImage = newItem?.cardImage && newItem.cardImage.startsWith('data:image/');

        // 更新顶部
        productId = newItem?.productId || '无产品号';
        updateTopBar();
        updatePrevNext();

        // 清空原有图片/占位
        imgWrapper.innerHTML = '';

        if (newHasImage) {
            img = document.createElement('img');
            img.src = newItem.cardImage;
            img.style.cssText = `
                max-width: 95%;
                max-height: 85vh;
                object-fit: contain;
                transform-origin: center center;
                user-select: none;
            `;
            imgWrapper.appendChild(img);

            // 重新加载宽高并更新变换
            img.onload = function() {
                imgWidth = this.offsetWidth;
                imgHeight = this.offsetHeight;
                containerWidth = imgContainer.clientWidth;
                containerHeight = imgContainer.clientHeight;
                currentScale = 1; translateX = 0; translateY = 0; rotateDeg = 0;
                updateTransform();
            };

            // 有图片时启用变换按钮
            if (zoomOutBtn) zoomOutBtn.disabled = false;
            if (zoomInBtn) zoomInBtn.disabled = false;
            if (rotateLeftBtn) rotateLeftBtn.disabled = false;
            if (rotateRightBtn) rotateRightBtn.disabled = false;
            if (resetZoomBtn) resetZoomBtn.disabled = false;
        } else {
            const placeholder = document.createElement('div');
            placeholder.style.cssText = `
                color: #aaa;
                font-size: 1.4rem;
                text-align: center;
                padding: 20px;
                background: rgba(255,255,255,0.1);
                border-radius: 12px;
                max-width: 80%;
            `;
            placeholder.innerHTML = '当前没有图片<br><br>点击右下角菜单进行上传<br></br>提示：底部栏是可以左右滚动的';
            imgWrapper.appendChild(placeholder);

            // 无图片时禁用变换按钮状态
            if (zoomOutBtn) zoomOutBtn.disabled = true;
            if (zoomInBtn) zoomInBtn.disabled = true;
            if (rotateLeftBtn) rotateLeftBtn.disabled = true;
            if (rotateRightBtn) rotateRightBtn.disabled = true;
            if (resetZoomBtn) resetZoomBtn.disabled = true;
        }
    };

    // ────────────────────────────── 双指缩放 + 单指拖动（仅有图片时有效） ──────────────────────────────
    let pinchStartDist = 0;
    let pinchStartScale = 1;
    let lastTap = 0;

    imgContainer.addEventListener('touchstart', e => {
        if (!hasImage) return;
        if (e.touches.length === 2) {
            e.preventDefault();
            const [t1, t2] = e.touches;
            pinchStartDist = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
            pinchStartScale = currentScale;
        } else if (e.touches.length === 1) {
            const now = Date.now();
            if (now - lastTap < 300) {
                currentScale = 1; translateX = 0; translateY = 0; rotateDeg = 0;
                updateTransform();
                e.preventDefault();
            }
            lastTap = now;
            isDragging = true;
            startX = e.touches[0].clientX - translateX;
            startY = e.touches[0].clientY - translateY;
        }
    }, { passive: false });

    imgContainer.addEventListener('touchmove', e => {
        if (!hasImage) return;
        if (e.touches.length === 2 && pinchStartDist > 0) {
            e.preventDefault();
            const [t1, t2] = e.touches;
            const dist = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
            currentScale = Math.max(0.5, Math.min(4, pinchStartScale * (dist / pinchStartDist)));
            updatePosImmediately();
        } else if (isDragging && e.touches.length === 1) {
            e.preventDefault();
            translateX = e.touches[0].clientX - startX;
            translateY = e.touches[0].clientY - startY;
            updatePosImmediately();
        }
    }, { passive: false });

    imgContainer.addEventListener('touchend', () => {
        pinchStartDist = 0; 
        isDragging = false;
        if (hasImage) updatePosWithTransition();
    });

    // ────────────────────────────── 拍照/相册/删除业务逻辑 ──────────────────────────────
    const fileInput = document.getElementById('cardImageInput');

    overlay.querySelector('#takePhotoInPreviewBtn').onclick = () => {
        overlay.remove();
        fileInput.setAttribute('capture', 'environment');
        fileInput.click();

        const onceHandler = async (e) => {
            if (e.target.files?.[0]) {
                const base64 = await handleImageSelect(e);
                if (base64) {
                    tableData[index].cardImage = base64;
                    saveDataToIndexedDB();
                    updateTable();
                    showSnackbar('图片已替换', 'success');
                }
            }
            fileInput.removeAttribute('capture');
            fileInput.value = '';
        };
        fileInput.addEventListener('change', onceHandler, { once: true });
    };

    overlay.querySelector('#selectGalleryInPreviewBtn').onclick = () => {
        overlay.remove();
        fileInput.removeAttribute('capture');
        fileInput.click();

        const onceHandler = async (e) => {
            if (e.target.files?.[0]) {
                const base64 = await handleImageSelect(e);
                if (base64) {
                    tableData[index].cardImage = base64;
                    saveDataToIndexedDB();
                    updateTable();
                    showSnackbar('图片已替换', 'success');
                }
            }
            fileInput.value = '';
        };
        fileInput.addEventListener('change', onceHandler, { once: true });
    };

    overlay.querySelector('#deleteImageInPreviewBtn').onclick = () => {
        overlay.remove();
        window.tempDeleteImageIndex = index;
        document.getElementById('deleteImageConfirmDialog').open = true;
    };

    // 点击空白处关闭
    overlay.onclick = (e) => { 
        if (e.target === overlay || e.target === imgContainer) overlay.remove(); 
    };
}



		document.addEventListener('DOMContentLoaded', () => {
		  initTheme();
		  initEventListeners();

		  loadDataFromIndexedDB();
		  updateTable();
		  initAutoCalculate();
		  initCalculatorKeyboard(); 
		  dom.calcDensity.value = 0.00617;
		  ZoomManager.init();
          KeyboardConfigManager.init();
		});
	</script>
</body>
</html>