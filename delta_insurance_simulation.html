<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>三角洲大免保</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#30525E',
                        secondary: '#3E4348',
                        highlight: '#10FDD9',
                        default: '#FFFFFF',
                        green: '#4CAF50',
                        blue: '#2196F3',
                        purple: '#9C27B0',
                        gold: '#FFD700',
                        red: '#F44336',
                        gray: '#808080',
                        'safe-gray': '#D0D0D0', // 保险箱淡灰色
                        'item-border': '#FFFFFF', // 物品边框颜色
                    },
                    fontFamily: {
                        digital: ['Orbitron', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 0 8px rgba(16, 253, 217, 0.8);
            }
            .glow {
                box-shadow: 0 0 15px rgba(16, 253, 217, 0.8);
            }
            .scroll-container {
                overflow: hidden;
                position: relative;
                height: 160px; /* 精确显示5个字符的高度 */
                width: 64px; /* 正方形方框宽度 */
                border: 2px solid rgba(255, 255, 255, 0.3);
                border-radius: 4px;
            }
            .target-line {
                position: absolute;
                left: 0;
                right: 0;
                height: 2px;
                background-color: #10FDD9;
                top: 80px; /* 精确居中位置线 */
                z-index: 10;
            }
            .target-box {
                position: absolute;
                left: 8px; /* 居中显示 */
                right: 8px;
                height: 32px; /* 正好容纳一个字符 */
                top: 64px; /* 精确对准中间字符 */
                z-index: 5;
                border: 2px solid #10FDD9;
                border-radius: 2px;
                background-color: rgba(16, 253, 217, 0.1);
                pointer-events: none;
            }
            .error-highlight {
                animation: error 0.5s ease-out;
            }
            @keyframes error {
                0%, 100% { border-color: rgba(255, 255, 255, 0.3); }
                50% { border-color: #ff4444; background-color: rgba(255, 68, 68, 0.2); }
            }
            .modal-backdrop {
                backdrop-filter: blur(5px);
            }
            .progress-shine {
                position: relative;
                overflow: hidden;
            }
            .progress-shine::after {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 50%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
                animation: shine 2s infinite;
            }
            @keyframes shine {
                100% { left: 150%; }
            }
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.5; }
            }
            .pulse {
                animation: pulse 1.5s infinite;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: scale(0.9); }
                to { opacity: 1; transform: scale(1); }
            }
            .fade-in {
                animation: fadeIn 0.5s ease-out forwards;
            }
            @keyframes slideUp {
                from { transform: translateY(20px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            .slide-up {
                animation: slideUp 0.5s ease-out forwards;
            }
            .grid-cell {
                aspect-ratio: 1/1;
                background-clip: padding-box;
                transition: all 0.3s ease;
            }
            .unread-item {
                background-color: #000;
                background-image: linear-gradient(45deg, rgba(255,255,255,0.05) 25%, transparent 25%),
                                  linear-gradient(-45deg, rgba(255,255,255,0.05) 25%, transparent 25%),
                                  linear-gradient(45deg, transparent 75%, rgba(255,255,255,0.05) 75%),
                                  linear-gradient(-45deg, transparent 75%, rgba(255,255,255,0.05) 75%);
                background-size: 20px 20px;
                background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            }
            .placeholder-item {
                background-color: rgba(128, 128, 128, 0.3);
                border: 1px dashed rgba(255, 255, 255, 0.3);
            }
            .magnifier-track {
                position: absolute;
                pointer-events: none;
            }
            .magnifier {
                position: absolute;
                color: rgba(0, 0, 0, 0.7);
                animation: magnifier-path 2s linear infinite;
                pointer-events: none;
                transform: translate(-50%, -50%);
                font-size: 1.5rem !important;
            }
            @keyframes magnifier-path {
                0% { transform: translate(-50%, -50%) translate(0, 0); }
                25% { transform: translate(-50%, -50%) translate(50%, -50%); }
                50% { transform: translate(-50%, -50%) translate(50%, 50%); }
                75% { transform: translate(-50%, -50%) translate(-50%, 50%); }
                100% { transform: translate(-50%, -50%) translate(0, 0); }
            }
            @keyframes completePulse {
                0%, 100% { transform: scale(1); box-shadow: 0 0 15px rgba(76, 175, 80, 0.8); }
                50% { transform: scale(1.05); box-shadow: 0 0 25px rgba(76, 175, 80, 1); }
            }
            .complete-animation {
                animation: completePulse 1s ease-in-out;
            }
            @keyframes charScale {
                0%, 100% { transform: scale(1); }
                25% { transform: scale(1.4); }
                50% { transform: scale(1); }
                75% { transform: scale(1.2); }
            }
            .char-scale {
                animation: charScale 1s ease-out;
            }
            @keyframes buttonClick {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(0.9); }
            }
            .button-click {
                animation: buttonClick 0.2s ease-out;
            }
            .final-highlight {
                box-shadow: 0 0 20px rgba(16, 253, 217, 1);
                border-color: #10FDD9 !important;
            }
            .center-char {
                font-weight: bold !important;
                transform: scale(1.1);
            }
            .active-column {
                border-color: #10FDD9 !important;
                box-shadow: 0 0 10px rgba(16, 253, 217, 0.7);
            }
            .record-item {
                transition: all 0.3s ease;
            }
            .record-item:hover {
                background-color: rgba(255, 255, 255, 0.1);
                transform: translateX(3px);
                cursor: pointer;
            }
            .counter-badge {
                min-width: 24px;
                height: 24px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }
            .item-gradient {
                background-image: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(0,0,0,0.1) 100%);
            }
            .skip-button {
                transition: all 0.3s ease;
            }
            .skip-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            }
            /* 物品大小标签样式 */
            .size-label {
                position: absolute;
                bottom: 2px;
                right: 2px;
                font-size: 8px;
                padding: 1px 3px;
                border-radius: 2px;
                background-color: rgba(0, 0, 0, 0.5);
                color: white;
                font-weight: bold;
            }
            /* 网格线样式 */
            .grid-lines {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
            }
            .grid-line {
                position: absolute;
                background-color: rgba(0, 0, 0, 0.2);
            }
            /* 物品详情弹窗 */
            .item-detail-modal {
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
            }
            .item-detail-modal.active {
                opacity: 1;
                visibility: visible;
            }
            /* 确保图标占满整个格子 */
            .fullsize-icon {
                width: 100%;
                height: 100%;
                object-fit: contain;
                padding: 4px;
            }
            /* 图片预加载隐藏容器 */
            .preload-container {
                display: none !important;
            }
            /* 物品记录图片样式 */
            .record-image {
                width: 24px;
                height: 24px;
                object-fit: contain;
                display: inline-block;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&amp;display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900 min-h-screen flex flex-col items-center p-4 font-digital text-white">
    <!-- 图片预加载容器 - 隐藏状态 -->
    <div class="preload-container" id="imagePreloader">
        <!-- 图片将通过JS动态添加 -->
    </div>
    
    <!-- 主标题区域 -->
    <div class="text-center mb-6 w-full max-w-4xl">
        <h1 class="text-[clamp(2rem,5vw,3.5rem)] font-bold mb-4 text-highlight text-shadow">三角洲大免保</h1>
        <p class="text-gray-300 text-lg mb-6">点击下方按钮开启您的保险</p>
    </div>
    
    <!-- 保险箱区域（上方） -->
    <div class="text-center w-full max-w-4xl mb-8">
        <!-- 保险盒子 -->
        <div id="insuranceBox" class="relative w-64 h-64 md:w-80 md:h-80 mx-auto cursor-pointer transform transition-all duration-300 hover:scale-105 hover:glow bg-gradient-to-br from-primary to-secondary rounded-lg flex items-center justify-center">
            <div class="absolute inset-4 border-2 border-highlight rounded flex items-center justify-center flex-col">
                <i class="fa fa-shield text-6xl md:text-8xl text-highlight mb-4 pulse"></i>
                <span class="text-xl md:text-2xl font-bold text-highlight">点击开启</span>
            </div>
            <!-- 装饰线条 -->
            <div class="absolute top-1/4 left-0 w-full h-1 bg-highlight/30"></div>
            <div class="absolute bottom-1/4 left-0 w-full h-1 bg-highlight/30"></div>
            <div class="absolute top-0 left-1/4 w-1 h-full bg-highlight/30"></div>
            <div class="absolute top-0 right-1/4 w-1 h-full bg-highlight/30"></div>
        </div>
    </div>
    
    <!-- 物品记录区域（下方） -->
    <div class="w-full max-w-4xl bg-secondary/30 rounded-lg p-4 mb-8 border border-gray-700 slide-up">
        <h2 class="text-xl font-bold mb-4 text-highlight flex items-center">
            <i class="fa fa-list-alt mr-2"></i> 物品获取记录
        </h2>
        
        <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
            <button id="clearRecordsBtn" class="text-sm bg-red/20 text-red border border-red/50 py-1 px-3 rounded hover:bg-red/30 transition-colors duration-300">
                <i class="fa fa-trash mr-1"></i> 清空记录
            </button>
            <span class="text-sm text-gray-300" id="totalItemsCount">总计: 0 件</span>
        </div>
        
        <div id="recordsContainer" class="max-h-[200px] overflow-y-auto pr-2 text-sm space-y-2">
            <div class="text-gray-400 text-center py-4">
                暂无物品记录
            </div>
        </div>
    </div>

    <!-- 解锁弹窗 -->
    <div id="unlockModal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="modal-backdrop absolute inset-0 bg-black/70"></div>
        <div class="relative bg-primary w-full max-w-2xl mx-4 rounded-lg shadow-2xl overflow-hidden fade-in">
            <!-- 解锁界面 -->
            <div id="unlockScreen" class="p-6">
                <h2 class="text-2xl font-bold mb-6 text-center text-highlight">解锁保险</h2>
                
                <!-- 密码滚动区域 -->
                <div class="flex justify-center gap-4 mb-6" id="scrollArea">
                    <!-- 第一列 - 目标6 -->
                    <div class="scroll-container relative bg-primary/80" data-target="6" data-next="1" data-chars="2,K,6,L,D">
                        <div class="target-line"></div>
                        <div class="target-box"></div>
                        <div class="text-center text-2xl font-bold flex flex-col items-center justify-start h-full py-0" id="scroll0">
                            <!-- 内容将通过JS动态生成 -->
                        </div>
                    </div>
                    <!-- 第二列 - 目标D -->
                    <div class="scroll-container relative bg-primary/80" data-target="D" data-next="2" data-chars="O,9,D,(,~">
                        <div class="target-line"></div>
                        <div class="target-box"></div>
                        <div class="text-center text-2xl font-bold flex flex-col items-center justify-start h-full py-0" id="scroll1">
                            <!-- 内容将通过JS动态生成 -->
                        </div>
                    </div>
                    <!-- 第三列 - 目标F -->
                    <div class="scroll-container relative bg-primary/80" data-target="F" data-next="3" data-chars="+,4,F,^,&amp;">
                        <div class="target-line"></div>
                        <div class="target-box"></div>
                        <div class="text-center text-2xl font-bold flex flex-col items-center justify-start h-full py-0" id="scroll2">
                            <!-- 内容将通过JS动态生成 -->
                        </div>
                    </div>
                    <!-- 第四列 - 目标U -->
                    <div class="scroll-container relative bg-primary/80" data-target="U" data-next="4" data-chars="&amp;,M,U,=,2">
                        <div class="target-line"></div>
                        <div class="target-box"></div>
                        <div class="text-center text-2xl font-bold flex flex-col items-center justify-start h-full py-0" id="scroll3">
                            <!-- 内容将通过JS动态生成 -->
                        </div>
                    </div>
                    <!-- 第五列 - 目标P -->
                    <div class="scroll-container relative bg-primary/80" data-target="P" data-next="5" data-chars="),9,P,6,@">
                        <div class="target-line"></div>
                        <div class="target-box"></div>
                        <div class="text-center text-2xl font-bold flex flex-col items-center justify-start h-full py-0" id="scroll4">
                            <!-- 内容将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
                
                <!-- 按钮区域：包含选定密码和直接解锁按钮 -->
                <div class="flex flex-col sm:flex-row justify-center gap-4 mb-8" id="buttonContainer">
                    <div class="select-button w-24 h-14 border-2 border-green/50 text-green hover:bg-green/20 rounded-full flex items-center justify-center cursor-pointer transition-all duration-300">
                        <span class="font-bold">选定密码</span>
                    </div>
                    <div id="directUnlockBtn" class="skip-button w-24 h-14 border-2 border-highlight/70 text-highlight hover:bg-highlight/20 rounded-full flex items-center justify-center cursor-pointer transition-all duration-300">
                        <span class="font-bold">直接解锁</span>
                    </div>
                </div>
                
                <!-- 进度条 -->
                <div class="w-full bg-secondary/50 rounded-full h-4 mb-2">
                    <div id="progressBar" class="progress-shine bg-highlight h-4 rounded-full w-0 transition-all duration-1000 ease-linear"></div>
                </div>
                <div class="text-right text-sm text-gray-300">
                    <span id="progressText">0%</span>
                </div>
            </div>
            
            <!-- 奖励界面 -->
            <div id="rewardScreen" class="p-6 hidden">
                <h2 class="text-2xl font-bold mb-6 text-center text-highlight">保险物品清单</h2>
                
                <!-- 保险格子容器 - 带网格线，物品无边框 -->
                <div id="gridContainer" class="w-full aspect-square bg-safe-gray relative mb-6 p-4">
                    <!-- 网格线容器 -->
                    <div class="grid-lines" id="gridLines">
                        <!-- 网格线将通过JS动态生成 -->
                    </div>
                    <!-- 物品将通过JS动态生成 -->
                </div>
                
                <button id="closeBtn" class="w-full bg-gray-600 text-white font-bold py-2 px-4 rounded hover:bg-gray-500 transition-colors duration-300">
                    关闭
                </button>
            </div>
        </div>
    </div>

    <!-- 物品详情弹窗 -->
    <div id="itemDetailModal" class="item-detail-modal fixed inset-0 flex items-center justify-center z-50">
        <div class="modal-backdrop absolute inset-0 bg-black/70"></div>
        <div class="relative bg-secondary w-full max-w-md mx-4 rounded-lg shadow-2xl overflow-hidden fade-in p-6">
            <button id="closeDetailBtn" class="absolute top-4 right-4 text-gray-300 hover:text-white transition-colors">
                <i class="fa fa-times text-xl"></i>
            </button>
            <div class="text-center mb-4">
                <div id="detailIconContainer" class="w-24 h-24 mx-auto mb-4 rounded-full flex items-center justify-center">
                    <!-- 图标将通过JS动态生成 -->
                </div>
                <h3 id="detailName" class="text-2xl font-bold mb-2"></h3>
                <div id="detailSize" class="text-sm text-gray-300 mb-4"></div>
            </div>
            <div class="bg-black/30 rounded-lg p-4">
                <h4 class="text-highlight font-bold mb-2">物品描述</h4>
                <p id="detailDescription" class="text-gray-200"></p>
            </div>
        </div>
    </div>

    <script>
        // 获取DOM元素
        const insuranceBox = document.getElementById('insuranceBox');
        const unlockModal = document.getElementById('unlockModal');
        const unlockScreen = document.getElementById('unlockScreen');
        const rewardScreen = document.getElementById('rewardScreen');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const gridContainer = document.getElementById('gridContainer');
        const gridLines = document.getElementById('gridLines');
        const closeBtn = document.getElementById('closeBtn');
        const selectButton = document.querySelector('.select-button');
        const directUnlockBtn = document.getElementById('directUnlockBtn');
        const scrollArea = document.getElementById('scrollArea');
        const buttonContainer = document.getElementById('buttonContainer');
        const clearRecordsBtn = document.getElementById('clearRecordsBtn');
        const recordsContainer = document.getElementById('recordsContainer');
        const totalItemsCount = document.getElementById('totalItemsCount');
        const itemDetailModal = document.getElementById('itemDetailModal');
        const closeDetailBtn = document.getElementById('closeDetailBtn');
        const imagePreloader = document.getElementById('imagePreloader');
        
        // 物品详情元素
        const detailIconContainer = document.getElementById('detailIconContainer');
        const detailName = document.getElementById('detailName');
        const detailSize = document.getElementById('detailSize');
        const detailDescription = document.getElementById('detailDescription');
        
        // 滚动列元素
        const scrollCols = document.querySelectorAll('.scroll-container');
        
        // 滚动动画元素
        const scrollElements = [
            document.getElementById('scroll0'),
            document.getElementById('scroll1'),
            document.getElementById('scroll2'),
            document.getElementById('scroll3'),
            document.getElementById('scroll4')
        ];
        
        // 物品记录数据（使用localStorage持久化存储）
        let itemRecords = JSON.parse(localStorage.getItem('deltaInsuranceRecords')) || {};
        let currentRewardItems = []; // 当前奖励的物品
        
        // 当前激活的列索引
        let currentColIndex = 0;
        // 进度条百分比
        let progress = 0;
        // 进度条定时器
        let progressTimer;
        // 已经解锁的列数
        let unlockedCols = 0;
        // 滚动是否暂停
        let isPaused = false;
        // 防止重复触发奖励显示的标志
        let rewardsShown = false;
        // 存储每个滚动列的动画状态
        let scrollAnimations = [];
        // 存储已锁定的列
        let lockedColumns = [];
        // 存储每列的随机起始位置
        let randomOffsets = [];
        // 存储每列的目标位置索引
        let targetPositions = [];
        // 可视区域内显示的字符数量（上下共5个）
        const visibleCharsCount = 5;
        // 中间位置索引（第三格，0开始计数）
        const middlePositionIndex = 2;
        // 字符高度（精确计算确保对齐）
        const charHeight = 32; // 160px容器高度 / 5个字符 = 32px每个
        // 密码选择允许的误差范围（像素）
        const selectionTolerance = 35;
        // 错误停顿计时器
        let errorPauseTimer = null;
        // 已出现的红色物品数量
        let redItemCount = 0;
        // 网格大小和间隔设置
        const gridSize = 4; // 4x4网格
        const cellPercentage = 100 / gridSize; // 每个格子的百分比宽度
        const itemSpacing = 2; // 物品之间的间隔百分比
        
        // 物品数据 - 按品质和大小分类，包含完整描述
        // 本地图片命名规则：
        // 1.png - 古怪的海盗银币
        // 2.png - 初级子弹生产零件
        // 3.png - 古老的海盗望远镜
        // 4.png - 海盗弯刀
        // 5.png - 后妃耳环
        // 6.png - 图腾箭矢
        // 7.png - 阿萨拉风情水壶
        // 8.png - 阿萨拉特色酒壶
        // 9.png - 黄金饰章
        // 10.png - 犄角墙饰
        // 11.png - 马赛克灯台
        // 12.png - 仪典匕首
        // 13.png - 阿萨拉特色酒杯
        // 14.png - 亮闪闪海盗金币
        // 15.png - 功绩勋章
        // 16.png - 发条八音盒
        // 17.png - 荷美尔陶俑
        // 18.png - 珠宝头冠
        // 19.png - 金枝桂冠
        // 20.png - 座钟
        // 21.png - 本地特色首饰
        // 22.png - 名贵机械表
        // 23.png - 塞伊德的怀表
        // 24.png - 非洲之心
        // 25.png - “钻石”鱼子酱
        // 26.png - 万足金条
        // 27.png - 棘龙爪化石
        // 28.png - 黄金瞪羚
        // 29.png - 克劳迪乌斯半身像
        // 30.png - 塞伊德的留声机
        // 31.png - 步战车模型
        // 32.png - 主战坦克模型
        // 33.png - 滑膛枪展品
        // 34.png - 军用信息终端
        // 35.png - 显卡
        // 36.png - 藏秘筒
        // 37.png - 数码相机
        // 38.png - 手机
        
        const items = [
            // 蓝色1x1 - 基础权重较高
            { 
                name: '古怪的海盗银币', 
                size: [1, 1], 
                color: 'blue', 
                icon: '1.png', 
                baseWeight: 8,
                description: '一枚古老的海盗银币，上面刻有模糊的骷髅标志，边缘有些磨损，见证了无数次海上冒险。这枚银币可能是18世纪加勒比海盗常用的流通货币。'
            },
            
            // 蓝色1x2 - 基础权重中等
            { 
                name: '初级子弹生产零件', 
                size: [1, 2], 
                color: 'blue', 
                icon: '2.png', 
                baseWeight: 5,
                description: '用于生产子弹的基础零件，由耐腐蚀金属制成，表面光滑，工艺精湛。这种零件广泛应用于小型武器制造厂，是弹药生产的关键组件。'
            },
            { 
                name: '古老的海盗望远镜', 
                size: [1, 2], 
                color: 'blue', 
                icon: '3.png', 
                baseWeight: 5,
                description: '黄铜材质的海盗望远镜，镜片有些模糊但仍能使用，伸缩部分刻有精致的花纹。17-18世纪的海盗常用这类望远镜来远距离发现目标船只。'
            },
            
            // 紫色1x1 - 基础权重中等
            { 
                name: '海盗弯刀', 
                size: [1, 1], 
                color: 'purple', 
                icon: '4.png', 
                baseWeight: 5,
                description: '造型独特的海盗弯刀，刀刃锋利，刀柄由象牙制成，上面镶嵌着小颗宝石。这种弯刀是海盗的标志性武器，便于在狭窄的船舱内使用。'
            },
            { 
                name: '后妃耳环', 
                size: [1, 1], 
                color: 'purple', 
                icon: '5.png', 
                baseWeight: 5,
                description: '精致的黄金耳环，上面镶嵌着紫色宝石，可能属于某位皇室后妃，工艺极为考究。这类珠宝通常由宫廷工匠精心制作，象征着佩戴者的高贵身份。'
            },
            { 
                name: '图腾箭矢', 
                size: [1, 1], 
                color: 'purple', 
                icon: '6.png', 
                baseWeight: 5,
                description: '带有部落图腾的箭矢，箭头由黑曜石制成，箭杆上刻有神秘符号，具有仪式意义。这类箭矢不仅用于狩猎，还在重要的部落仪式中使用。'
            },
            
            // 紫色1x2 - 基础权重较低
            { 
                name: '阿萨拉风情水壶', 
                size: [1, 2], 
                color: 'purple', 
                icon: '7.png', 
                baseWeight: 3,
                description: '阿萨拉地区特有的水壶，采用传统工艺制作，表面有精美的彩绘图案，展示当地风土人情。这种水壶具有良好的保温性能，是长途旅行者的理想选择。'
            },
            { 
                name: '阿萨拉特色酒壶', 
                size: [1, 2], 
                color: 'purple', 
                icon: '8.png', 
                baseWeight: 3,
                description: '用于盛装当地特色美酒的容器，壶身雕刻有葡萄藤图案，密封性能极佳。阿萨拉地区以生产优质葡萄酒闻名，这种酒壶是当地手工艺品的代表。'
            },
            { 
                name: '黄金饰章', 
                size: [1, 2], 
                color: 'purple', 
                icon: '9.png', 
                baseWeight: 3,
                description: '由纯金打造的饰章，上面刻有家族徽章，可能是某位贵族的身份象征。在中世纪欧洲，这类饰章常用于标识贵族身份，也作为重要文件的封印使用。'
            },
            
            // 紫色2x1 - 基础权重较低
            { 
                name: '犄角墙饰', 
                size: [2, 1], 
                color: 'purple', 
                icon: '10.png', 
                baseWeight: 3,
                description: '由动物犄角制成的墙饰，经过特殊处理防止虫蛀，表面光滑，带有自然的曲线美感。这类装饰品在北欧风格的建筑中较为常见，象征着狩猎的成功。'
            },
            
            // 紫色2x3 - 基础权重低
            { 
                name: '马赛克灯台', 
                size: [2, 3], 
                color: 'purple', 
                icon: '11.png', 
                baseWeight: 2,
                description: '由彩色玻璃马赛克拼贴而成的灯台，点亮时会投射出五彩斑斓的光影效果。这种工艺源自拜占庭帝国，后流传到世界各地，成为珍贵的手工艺品。'
            },
            
            // 紫色3x2 - 基础权重低
            { 
                name: '仪典匕首', 
                size: [3, 2], 
                color: 'purple', 
                icon: '12.png', 
                baseWeight: 2,
                description: '用于宗教仪式的匕首，刀鞘由鲨鱼皮制成，刀柄镶嵌着宝石，具有重要的文化价值。许多古代文明都有使用特制匕首进行宗教仪式的传统。'
            },
            
            // 金色1x1 - 基础权重中等
            { 
                name: '阿萨拉特色酒杯', 
                size: [1, 1], 
                color: 'gold', 
                icon: '13.png', 
                baseWeight: 4,
                description: '阿萨拉地区出产的精致酒杯，由水晶制成，杯身上有手工雕刻的花纹，薄如蝉翼。这种酒杯通常用于招待贵宾，是身份和地位的象征。'
            },
            { 
                name: '亮闪闪海盗金币', 
                size: [1, 1], 
                color: 'gold', 
                icon: '14.png', 
                baseWeight: 4,
                description: '纯度极高的海盗金币，表面光滑，刻有清晰的图案，在光线下闪闪发光。这枚金币可能来自被海盗劫掠的西班牙运金船队，具有很高的收藏价值。'
            },
            { 
                name: '功绩勋章', 
                size: [1, 1], 
                color: 'gold', 
                icon: '15.png', 
                baseWeight: 4,
                description: '授予有功之臣的勋章，由黄金和宝石制成，象征着荣誉和成就。这类勋章通常由国家最高领导人颁发，是对获得者杰出贡献的认可。'
            },
            { 
                name: '发条八音盒', 
                size: [1, 1], 
                color: 'gold', 
                icon: '16.png', 
                baseWeight: 4,
                description: '小巧精致的发条八音盒，打开后能演奏优美的旋律，内部机械结构精密。19世纪欧洲贵族常用这类八音盒作为高档礼品，也是精湛工艺的代表。'
            },
            
            // 金色1x2 - 基础权重较低
            { 
                name: '荷美尔陶俑', 
                size: [1, 2], 
                color: 'gold', 
                icon: '17.png', 
                baseWeight: 3,
                description: '荷美尔文明的陶俑，造型独特，表面有金色涂层，展示了古代文明的艺术成就。荷美尔文明虽然已经消失，但其留下的艺术品仍让人惊叹于他们的工艺水平。'
            },
            
            // 金色3x1 - 基础权重低
            { 
                name: '珠宝头冠', 
                size: [3, 1], 
                color: 'gold', 
                icon: '18.png', 
                baseWeight: 2,
                description: '由黄金打造并镶嵌多种宝石的头冠，工艺精湛，可能属于皇室成员。这类头冠通常在加冕仪式等重要场合佩戴，象征着至高无上的权力。'
            },
            
            // 金色2x1 - 基础权重低
            { 
                name: '金枝桂冠', 
                size: [2, 1], 
                color: 'gold', 
                icon: '19.png', 
                baseWeight: 2,
                description: '模仿桂冠造型的金饰，由纯金打造，象征着胜利和荣誉。在古希腊和古罗马，桂冠是授予胜利者的最高荣誉，后来演变为各种形式的荣誉象征。'
            },
            
            // 金色2x2 - 基础权重低
            { 
                name: '座钟', 
                size: [2, 2], 
                color: 'gold', 
                icon: '20.png', 
                baseWeight: 2,
                description: '复古风格的座钟，外壳由黄铜制成，带有金色镀层，走时精准，敲击声清脆。这种座钟在18-19世纪的欧洲贵族家庭中非常常见，既是实用品也是装饰品。'
            },
            
            // 金色3x2 - 基础权重低
            { 
                name: '本地特色首饰', 
                size: [3, 2], 
                color: 'gold', 
                icon: '21.png', 
                baseWeight: 1,
                description: '当地工匠制作的特色首饰套装，包含项链和耳环，采用传统工艺，具有独特的文化韵味。这类首饰通常使用本地特有的材料，体现了地域文化特色。'
            },
            
            // 红色1x1 - 基础权重低
            { 
                name: '名贵机械表', 
                size: [1, 1], 
                color: 'red', 
                icon: '22.png', 
                baseWeight: 2,
                description: '瑞士制造的名贵机械表，表盘镶嵌钻石，内部机芯精密复杂，走时准确。瑞士钟表业以其精湛的工艺闻名于世，这类机械表往往价值不菲。'
            },
            { 
                name: '塞伊德的怀表', 
                size: [1, 1], 
                color: 'red', 
                icon: '23.png', 
                baseWeight: 2,
                description: '属于著名探险家塞伊德的怀表，表壳由纯金打造，背面刻有他的签名，具有重要的历史价值。塞伊德曾在19世纪进行过多次非洲探险，留下了许多珍贵文物。'
            },
            { 
                name: '非洲之心', 
                size: [1, 1], 
                color: 'red', 
                icon: '24.png', 
                rarity: 'rare', 
                baseWeight: 1,
                description: '巨大的红色钻石，被称为"非洲之心"，色泽纯正，切割完美，是稀世珍宝。红色钻石是自然界中最稀有的钻石品种之一，每克拉价值高达数百万美元。'
            },
            { 
                name: '“钻石”鱼子酱', 
                size: [1, 1], 
                color: 'red', 
                icon: '25.png', 
                baseWeight: 2,
                description: '顶级的黑色鱼子酱，因价格昂贵被称为"黑色钻石"，口感细腻，营养丰富。这种鱼子酱来自里海的白鲟，需要数十年才能成熟，因此极为珍贵。'
            },
            
            // 红色1x2 - 基础权重极低
            { 
                name: '万足金条', 
                size: [1, 2], 
                color: 'red', 
                icon: '26.png', 
                baseWeight: 1,
                description: '纯度高达99.99%的金条，表面刻有重量和纯度标记，是财富的象征。万足金是纯度最高的黄金制品，具有极高的保值和投资价值。'
            },
            
            // 红色2x1 - 基础权重极低
            { 
                name: '棘龙爪化石', 
                size: [2, 1], 
                color: 'red', 
                icon: '27.png', 
                baseWeight: 1,
                description: '保存完好的棘龙爪化石，距今已有数千万年历史，对于古生物研究具有重要价值。棘龙是一种大型肉食恐龙，其化石非常罕见，因此具有很高的科学价值。'
            },
            
            // 红色2x2 - 基础权重极低
            { 
                name: '黄金瞪羚', 
                size: [2, 2], 
                color: 'red', 
                icon: '28.png', 
                baseWeight: 0.8,
                description: '纯金打造的瞪羚雕像，造型栩栩如生，细节处理精细，可能是古代皇室的收藏品。瞪羚在许多文化中象征着敏捷和优雅，这类金雕像往往具有重要的文化意义。'
            },
            
            // 红色2x3 - 基础权重极低
            { 
                name: '克劳迪乌斯半身像', 
                size: [2, 3], 
                color: 'red', 
                icon: '29.png', 
                baseWeight: 0.5,
                description: '罗马皇帝克劳迪乌斯的大理石半身像，雕刻精美，是古罗马艺术的代表作之一。克劳迪乌斯是罗马帝国的第四位皇帝，统治时期为公元41-54年。'
            },
            { 
                name: '塞伊德的留声机', 
                size: [2, 3], 
                color: 'red', 
                icon: '30.png', 
                baseWeight: 0.5,
                description: '探险家塞伊德使用过的留声机，保存完好，仍能播放古老的唱片，带有浓厚的历史气息。留声机是爱迪生的重要发明，彻底改变了人们记录和传播声音的方式。'
            },
            
            // 红色3x2 - 基础权重极低
            { 
                name: '步战车模型', 
                size: [3, 2], 
                color: 'red', 
                icon: '31.png', 
                baseWeight: 0.5,
                description: '按比例制作的步战车模型，细节逼真，由金属制成，可能是军事爱好者的珍藏。这种模型精确复制了真实步战车的各种细节，包括武器系统和防护装甲。'
            },
            
            // 红色3x3 - 基础权重极低
            { 
                name: '主战坦克模型', 
                size: [3, 3], 
                color: 'red', 
                icon: '32.png', 
                baseWeight: 0.3,
                description: '精细的主战坦克模型，由多种材料制成，可活动部件多，是罕见的收藏品。这类模型通常由专业工匠手工制作，比例精确，细节丰富，深受军事收藏家喜爱。'
            },
            
            // 红色4x1 - 基础权重极低
            { 
                name: '滑膛枪展品', 
                size: [4, 1], 
                color: 'red', 
                icon: '33.png', 
                baseWeight: 0.3,
                description: '19世纪的滑膛枪，保存完好，带有精美雕刻，是火器发展史上的重要文物。滑膛枪在近代战争中发挥了重要作用，这种保存状态良好的古董枪支极为罕见。'
            },
            
            // 新增物品
            { 
                name: '军用信息终端', 
                size: [3, 2], 
                color: 'red', 
                icon: '34.png', 
                baseWeight: 0.5,
                description: '军用级别的信息处理终端，具有抗干扰和加密通信功能，可在恶劣环境下稳定工作。常用于战场指挥和情报分析，具有极高的军事价值。'
            },
            { 
                name: '显卡', 
                size: [2, 1], 
                color: 'red', 
                icon: '35.png', 
                baseWeight: 1,
                description: '高性能图形处理器，适用于复杂图形计算和人工智能训练，芯片采用先进制程工艺，散热设计精良，是高端计算机系统的核心组件。'
            },
            { 
                name: '藏秘筒', 
                size: [1, 1], 
                color: 'gold', 
                icon: '36.png', 
                baseWeight: 3,
                description: '用于存放机密文件的小型金属容器，具有防水防火功能，内置精密锁具，只有特定钥匙才能打开。常用于保存重要契约、遗嘱或秘密信息。'
            },
            { 
                name: '数码相机', 
                size: [1, 1], 
                color: 'gold', 
                icon: '37.png', 
                baseWeight: 3,
                description: '高像素数码摄影设备，配备专业镜头和大尺寸传感器，能捕捉细腻的图像细节，支持多种手动调节模式，是摄影爱好者的理想选择。'
            },
            { 
                name: '手机', 
                size: [1, 1], 
                color: 'gold', 
                icon: '38.png', 
                baseWeight: 3,
                description: '最新款智能手机，配备高清屏幕和多核处理器，支持5G网络和无线充电，摄像头系统先进，能拍摄高质量照片和视频，是现代生活的必备工具。'
            }
        ];
        
        // 预加载所有物品图片
        function preloadAllImages() {
            // 为每个物品创建一个隐藏的img标签进行预加载
            items.forEach(item => {
                const img = document.createElement('img');
                img.src = item.icon;
                img.alt = item.name;
                img.className = 'preload-image';
                imagePreloader.appendChild(img);
            });
        }
        
        // 颜色读取延迟时间 (秒)
        const colorDelays = {
            'default': 0.5,
            'green': 1,
            'blue': 1.5,
            'purple': 2,
            'gold': 2.5,
            'red': 3
        };
        
        // 按照新的概率分布随机选择物品数量
        function getRandomItemCount() {
            // 定义新的概率分布: [数量, 概率]
            const probabilityDistribution = [
                { count: 1, probability: 0.30 },  // 1个物品：30%概率
                { count: 2, probability: 0.30 },  // 2个物品：30%概率
                { count: 3, probability: 0.25 },  // 3个物品：25%概率
                { count: 4, probability: 0.10 },  // 4个物品：10%概率
                { count: 5, probability: 0.03 },  // 5个物品：3%概率
                { count: 6, probability: 0.015 }, // 6个物品：1.5%概率
                { count: 7, probability: 0.005 }  // 7个物品：0.5%概率
            ];
            
            // 随机生成一个0-1之间的数
            const random = Math.random();
            let cumulativeProbability = 0;
            
            // 根据概率分布选择数量
            for (const dist of probabilityDistribution) {
                cumulativeProbability += dist.probability;
                if (random <= cumulativeProbability) {
                    return dist.count;
                }
            }
            
            // 保底返回1个
            return 1;
        }
        
        // 初始化跑马灯内容和动画
        function initScrollers() {
            scrollElements.forEach((el, index) => {
                const col = scrollCols[index];
                const chars = col.dataset.chars.split(',');
                const target = col.dataset.target;
                
                // 记录目标字符在字符数组中的位置
                const targetPos = chars.indexOf(target);
                targetPositions[index] = targetPos;
                
                // 为每列生成随机起始位置
                const randomOffset = Math.floor(Math.random() * chars.length);
                randomOffsets[index] = randomOffset;
                
                // 创建扩展字符数组，确保滚动连续性
                const extendedChars = [...chars, ...chars, ...chars];
                
                // 构建HTML内容，精确控制每个字符高度
                let html = '';
                extendedChars.forEach((char, pos) => {
                    // 计算在原始字符集中的位置
                    const originalPos = pos % chars.length;
                    const isTarget = originalPos === targetPos;
                    
                    // 为每个字符设置精确高度，确保对齐
                    if (isTarget) {
                        html += `<div class="text-highlight text-shadow h-[32px] flex items-center justify-center">${char}</div>`;
                    } else {
                        html += `<div class="h-[32px] flex items-center justify-center">${char}</div>`;
                    }
                });
                
                el.innerHTML = html;
                
                // 设置初始偏移，确保从随机位置开始且精确对齐
                const initialOffset = randomOffset * charHeight;
                el.style.transform = `translateY(-${initialOffset}px)`;
                el.style.transition = 'transform 0.3s ease-out';
                
                // 创建平滑循环动画
                const animation = el.animate(
                    [
                        { transform: `translateY(-${initialOffset}px)` },
                        { transform: `translateY(-${initialOffset + chars.length * charHeight}px)` }
                    ],
                    {
                        duration: 1000, // 滚动速度1秒/圈
                        iterations: Infinity,
                        easing: 'linear'
                    }
                );
                
                // 所有列初始都处于滚动状态
                animation.play();
                scrollAnimations[index] = animation;
            });
            
            // 高亮显示第一列作为初始激活列
            highlightActiveColumn();
        }
        
        // 高亮显示当前激活的列
        function highlightActiveColumn() {
            // 移除所有列的高亮
            scrollCols.forEach(col => col.classList.remove('active-column'));
            // 高亮当前列
            scrollCols[currentColIndex].classList.add('active-column');
        }
        
        // 生成网格线
        function generateGridLines() {
            gridLines.innerHTML = '';
            
            // 添加水平线
            for (let i = 1; i < gridSize; i++) {
                const line = document.createElement('div');
                line.className = 'grid-line';
                line.style.height = '1px';
                line.style.width = '100%';
                line.style.top = `${i * cellPercentage}%`;
                gridLines.appendChild(line);
            }
            
            // 添加垂直线
            for (let i = 1; i < gridSize; i++) {
                const line = document.createElement('div');
                line.className = 'grid-line';
                line.style.width = '1px';
                line.style.height = '100%';
                line.style.left = `${i * cellPercentage}%`;
                gridLines.appendChild(line);
            }
        }
        
        // 调整按钮位置以确保可点击
        function adjustButtonPosition() {
            const scrollWidth = scrollArea.offsetWidth;
            const containerWidth = unlockModal.querySelector('.max-w-2xl').offsetWidth;
            
            // 如果按钮在右侧会超出容器，则放到下方
            if (scrollWidth + 240 > containerWidth - 40) { // 增加了直接解锁按钮的宽度计算
                buttonContainer.classList.remove('flex-row', 'justify-center');
                buttonContainer.classList.add('flex-col', 'items-center');
                scrollArea.classList.remove('mb-6');
                scrollArea.classList.add('mb-2');
            } else {
                buttonContainer.classList.add('flex-row', 'justify-center');
                buttonContainer.classList.remove('flex-col', 'items-center');
                scrollArea.classList.add('mb-6');
                scrollArea.classList.remove('mb-2');
            }
        }
        
        // 打开解锁弹窗
        insuranceBox.addEventListener('click', () => {
            unlockModal.classList.remove('hidden');
            // 重置状态
            resetUnlockState();
            // 调整按钮位置
            setTimeout(adjustButtonPosition, 100);
        });
        
        // 关闭弹窗
        closeBtn.addEventListener('click', () => {
            unlockModal.classList.add('hidden');
            rewardScreen.classList.add('hidden');
            unlockScreen.classList.remove('hidden');
            rewardsShown = false;
            redItemCount = 0; // 重置红色物品计数
            currentRewardItems = []; // 清空当前奖励物品
            // 重置按钮文字
            selectButton.querySelector('span').textContent = '选定密码';
        });
        
        // 关闭物品详情弹窗
        closeDetailBtn.addEventListener('click', () => {
            itemDetailModal.classList.remove('active');
        });
        
        // 点击详情弹窗背景关闭
        itemDetailModal.querySelector('.modal-backdrop').addEventListener('click', () => {
            itemDetailModal.classList.remove('active');
        });
        
        // 清空记录按钮点击事件
        clearRecordsBtn.addEventListener('click', function() {
            // 显示按钮点击动画
            this.classList.add('button-click');
            setTimeout(() => {
                this.classList.remove('button-click');
            }, 200);
            
            // 检查是否有记录可清空
            if (Object.keys(itemRecords).length === 0) {
                // 显示没有记录的提示
                const infoMsg = document.createElement('div');
                infoMsg.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-blue text-white px-4 py-2 rounded shadow-lg z-50 fade-in';
                infoMsg.textContent = '没有记录可清空';
                document.body.appendChild(infoMsg);
                
                setTimeout(() => {
                    infoMsg.style.opacity = '0';
                    infoMsg.style.transition = 'opacity 0.5s ease-out';
                    setTimeout(() => {
                        document.body.removeChild(infoMsg);
                    }, 500);
                }, 2000);
                return;
            }
            
            // 确认清空
            if (confirm('确定要清空所有物品记录吗？')) {
                // 清空记录数据
                itemRecords = {};
                
                // 强制更新localStorage
                localStorage.removeItem('deltaInsuranceRecords');
                localStorage.setItem('deltaInsuranceRecords', JSON.stringify(itemRecords));
                
                // 刷新物品记录显示
                renderItemRecords();
                
                // 显示清空成功的视觉反馈
                const successMsg = document.createElement('div');
                successMsg.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-green text-white px-4 py-2 rounded shadow-lg z-50 fade-in';
                successMsg.textContent = '记录已清空';
                document.body.appendChild(successMsg);
                
                // 3秒后移除提示
                setTimeout(() => {
                    successMsg.style.opacity = '0';
                    successMsg.style.transition = 'opacity 0.5s ease-out';
                    setTimeout(() => {
                        document.body.removeChild(successMsg);
                    }, 500);
                }, 3000);
            }
        });
        
        // 直接解锁按钮点击事件
        directUnlockBtn.addEventListener('click', function() {
            // 按钮点击反馈动画
            this.classList.add('button-click');
            setTimeout(() => {
                this.classList.remove('button-click');
            }, 200);
            
            // 停止所有动画
            stopAllAnimations();
            
            // 强制所有列显示正确密码
            forceAllColumnsToTarget();
            
            // 立即完成进度
            progress = 100;
            updateProgressBar();
            
            // 更新按钮文字
            selectButton.querySelector('span').textContent = '解锁完成';
            
            // 短暂延迟后显示奖励
            setTimeout(() => {
                showRewards();
            }, 800);
        });
        
        // 渲染物品记录 - 确保物品可点击
        function renderItemRecords() {
            // 清空容器
            recordsContainer.innerHTML = '';
            
            // 获取物品记录列表并按数量排序
            const recordsList = Object.values(itemRecords)
                .sort((a, b) => b.count - a.count);
            
            // 更新总计数
            const totalCount = recordsList.reduce((sum, item) => sum + item.count, 0);
            totalItemsCount.textContent = `总计: ${totalCount} 件`;
            
            if (recordsList.length === 0) {
                // 没有记录
                recordsContainer.innerHTML = `
                    <div class="text-gray-400 text-center py-4">
                        暂无物品记录
                    </div>
                `;
                return;
            }
            
            // 添加记录项 - 确保每个物品都可点击查看详情
            recordsList.forEach(item => {
                const recordItem = document.createElement('div');
                recordItem.className = 'record-item flex justify-between items-center p-2 rounded';
                recordItem.innerHTML = `
                    <div class="flex items-center">
                        <img src="${item.icon}" alt="${item.name}" class="record-image mr-2">
                        <span class="truncate max-w-[200px] sm:max-w-[400px]">${item.name}</span>
                    </div>
                    <span class="counter-badge bg-${item.color}/30 text-white rounded-full text-xs font-bold">
                        ${item.count}
                    </span>
                `;
                
                // 为每个记录项添加点击事件，显示物品详情
                recordItem.addEventListener('click', () => {
                    showItemDetail(item);
                });
                
                recordsContainer.appendChild(recordItem);
            });
        }
        
        // 自动记录物品到记录列表
        function autoRecordItems(items) {
            items.forEach(item => {
                // 使用物品名称作为唯一标识
                const itemId = item.name;
                
                if (itemRecords[itemId]) {
                    itemRecords[itemId].count++;
                } else {
                    itemRecords[itemId] = {
                        ...item,
                        count: 1
                    };
                }
            });
            
            // 保存到localStorage
            localStorage.setItem('deltaInsuranceRecords', JSON.stringify(itemRecords));
            
            // 刷新物品记录显示
            renderItemRecords();
        }
        
        // 显示物品详情
        function showItemDetail(item) {
            // 验证物品数据是否完整
            if (!item || !item.name || !item.icon || !item.description) {
                console.error('物品数据不完整', item);
                return;
            }
            
            // 设置详情内容
            detailIconContainer.innerHTML = `
                <img src="${item.icon}" alt="${item.name}" class="w-full h-full object-contain p-2">
            `;
            detailIconContainer.className = `w-24 h-24 mx-auto mb-4 rounded-full flex items-center justify-center bg-${item.color || 'gray'}/30`;
            detailName.textContent = item.name;
            detailName.className = `text-2xl font-bold mb-2 text-${item.color || 'white'}`;
            detailSize.textContent = `尺寸: ${item.size ? `${item.size[0]}x${item.size[1]}` : '未知'}`;
            detailDescription.textContent = item.description;
            
            // 显示弹窗
            itemDetailModal.classList.add('active');
        }
        
        // 为选定密码按钮添加点击事件
        selectButton.addEventListener('click', () => {
            // 按钮点击反馈动画
            selectButton.classList.add('button-click');
            setTimeout(() => {
                selectButton.classList.remove('button-click');
            }, 200);
            
            // 检查是否已显示奖励
            if (rewardsShown) return;
            
            // 如果正在错误停顿中，清除现有计时器并重新计时
            if (isPaused) {
                clearTimeout(errorPauseTimer);
            }
            
            const currentCol = scrollCols[currentColIndex];
            const targetChar = currentCol.dataset.target;
            const chars = currentCol.dataset.chars.split(',');
            const charCount = chars.length;
            const randomOffset = randomOffsets[currentColIndex];
            
            // 获取当前动画进度
            const animation = scrollAnimations[currentColIndex];
            const progress = animation.currentTime / animation.effect.getTiming().duration;
            
            // 计算当前位置 - 精确到像素级别
            const totalScrollDistance = charCount * charHeight;
            const currentPixelPosition = (progress * totalScrollDistance + randomOffset * charHeight) % totalScrollDistance;
            
            // 计算当前显示在方框（中间位置）的字符索引
            const visibleAreaStart = currentPixelPosition;
            // 按照方框位置判断，不向下调整
            const boxCharPosition = visibleAreaStart + middlePositionIndex * charHeight;
            const boxCharIndex = Math.floor(boxCharPosition / charHeight) % charCount;
            const boxChar = chars[boxCharIndex];
            
            // 计算当前位置与目标位置的像素差
            const targetPixelPosition = (targetPositions[currentColIndex] * charHeight) % totalScrollDistance;
            let pixelDiff = Math.abs(currentPixelPosition - targetPixelPosition);
            pixelDiff = Math.min(pixelDiff, totalScrollDistance - pixelDiff); // 取最短距离
            
            // 暂停当前列动画
            animation.pause();
            isPaused = true;
            
            // 检查方框中的字符是否是正确密码（带±35px容错）
            if (boxChar === targetChar || pixelDiff <= selectionTolerance) {
                // 点击正确 - 按钮变为绿色并添加动画
                selectButton.classList.add('complete-animation', 'bg-green/30');
                
                setTimeout(() => {
                    // 计算精确位置使目标字符显示在方框中
                    const targetOffset = (targetPositions[currentColIndex] - randomOffset + charCount) % charCount * charHeight;
                    scrollElements[currentColIndex].style.transform = `translateY(-${targetOffset}px)`;
                    
                    // 清除所有字符的动画效果
                    const charElements = scrollElements[currentColIndex].querySelectorAll('div');
                    charElements.forEach(el => el.classList.remove('char-scale'));
                    
                    // 只给当前列的正确密码添加弹动动画（第三格字符）
                    const targetCharIndex = chars.length + targetPositions[currentColIndex];
                    charElements[targetCharIndex].classList.add('char-scale', 'center-char');
                    
                    // 已选中的列显示淡灰色背景并高亮边框
                    currentCol.classList.add('bg-gray-700/60', 'final-highlight');
                    
                    // 停止当前列的动画
                    animation.cancel();
                    
                    // 更新状态
                    unlockedCols++;
                    lockedColumns.push(currentColIndex);
                    
                    // 移除按钮动画
                    selectButton.classList.remove('complete-animation', 'bg-green/30');
                    
                    // 激活下一列
                    const nextCol = parseInt(currentCol.dataset.next);
                    if (nextCol < 5) {
                        currentColIndex = nextCol;
                        isPaused = false;
                        highlightActiveColumn(); // 高亮新的当前列
                    } else {
                        // 全部解锁成功 - 更新按钮文字
                        selectButton.querySelector('span').textContent = '解锁完成';
                        
                        // 停止所有动画
                        stopAllAnimations();
                        
                        // 停顿1秒
                        setTimeout(() => {
                            completeProgress();
                        }, 1000);
                    }
                }, 300);
            } else {
                // 点击错误 - 跑马灯泛红提示
                currentCol.classList.add('error-highlight');
                selectButton.classList.add('error-highlight');
                
                // 错误时停止1秒后继续滚动，如果再次点击则重新计时
                errorPauseTimer = setTimeout(() => {
                    // 移除错误样式
                    currentCol.classList.remove('error-highlight');
                    selectButton.classList.remove('error-highlight');
                    
                    // 重新开始当前列动画
                    animation.play();
                    isPaused = false;
                }, 1000);
            }
        });
        
        // 停止所有动画
        function stopAllAnimations() {
            // 停止所有滚动列动画
            scrollAnimations.forEach(animation => {
                if (animation) {
                    animation.cancel();
                }
            });
            
            // 停止进度条动画
            clearInterval(progressTimer);
            
            // 停止其他可能的动画元素
            document.querySelectorAll('.pulse, .progress-shine').forEach(el => {
                el.style.animationPlayState = 'paused';
            });
        }
        
        // 强制所有列显示正确密码并停止在方框中
        function forceAllColumnsToTarget() {
            scrollCols.forEach((col, index) => {
                if (lockedColumns.includes(index)) return; // 已锁定的列不需要处理
                
                const chars = col.dataset.chars.split(',');
                const charCount = chars.length;
                const randomOffset = randomOffsets[index];
                
                // 计算目标位置并停止在正确密码（显示在方框中）
                const targetOffset = (targetPositions[index] - randomOffset + charCount) % charCount * charHeight;
                scrollElements[index].style.transform = `translateY(-${targetOffset}px)`;
                
                // 停止动画
                if (scrollAnimations[index]) {
                    scrollAnimations[index].cancel();
                }
                
                // 高亮方框中的字符（第三格）
                const charElements = scrollElements[index].querySelectorAll('div');
                const targetCharIndex = chars.length + targetPositions[index];
                charElements[targetCharIndex].classList.add('center-char');
                
                // 添加高亮效果
                col.classList.add('bg-gray-700/60', 'final-highlight');
            });
        }
        
        // 更新进度条显示
        function updateProgressBar() {
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${progress}%`;
        }
        
        // 重置解锁状态
        function resetUnlockState() {
            // 清除任何可能的计时器
            clearTimeout(errorPauseTimer);
            
            progress = 0;
            currentColIndex = 0;
            unlockedCols = 0;
            isPaused = false;
            rewardsShown = false;
            lockedColumns = [];
            randomOffsets = [];
            targetPositions = [];
            redItemCount = 0; // 重置红色物品计数
            currentRewardItems = []; // 清空当前奖励物品
            updateProgressBar();
            
            // 重置所有滚动列
            scrollCols.forEach((col, index) => {
                col.classList.remove('error-highlight', 'bg-gray-700/60', 'final-highlight', 'active-column');
                
                // 重置动画
                if (scrollAnimations[index]) {
                    scrollAnimations[index].cancel();
                }
                scrollElements[index].style.transform = 'translateY(0)';
            });
            
            // 重新初始化滚动器，实现随机起始位置
            initScrollers();
            
            // 重置选择按钮
            selectButton.classList.remove('complete-animation', 'bg-green/30', 'error-highlight');
            selectButton.querySelector('span').textContent = '选定密码';
            
            // 开始进度条
            clearInterval(progressTimer);
            progressTimer = setInterval(() => {
                if (rewardsShown) return;
                
                progress++;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(progressTimer);
                    
                    // 强制所有列显示正确密码在方框中
                    forceAllColumnsToTarget();
                    
                    // 停止所有动画
                    stopAllAnimations();
                    
                    // 停顿1秒后显示解锁完成
                    setTimeout(() => {
                        selectButton.querySelector('span').textContent = '解锁完成';
                        setTimeout(showRewards, 1000);
                    }, 1000);
                }
                updateProgressBar();
            }, 200);
        }
        
        // 完成进度
        function completeProgress() {
            if (rewardsShown) return;
            
            clearInterval(progressTimer);
            progress = 100;
            updateProgressBar();
            
            // 确保所有列都显示正确密码在方框中
            forceAllColumnsToTarget();
            
            showRewards();
        }
        
        // 显示奖励
        function showRewards() {
            if (rewardsShown) return;
            rewardsShown = true;
            
            // 生成网格线
            generateGridLines();
            
            // 延迟一点时间再显示奖励
            setTimeout(() => {
                unlockScreen.classList.add('hidden');
                rewardScreen.classList.remove('hidden');
                generateRewards();
            }, 800);
        }
        
        // 生成奖励
        function generateRewards() {
            // 清空格子内容（保留网格线）
            while (gridContainer.children.length > 1) {
                gridContainer.removeChild(gridContainer.lastChild);
            }
            
            // 使用新的概率分布选择物品数量
            let itemCount = getRandomItemCount();
            
            // 基于权重、品质和大小选择物品
            const selectedItems = [];
            
            // 计算总权重，考虑多个因素
            let totalWeight = 0;
            items.forEach(item => {
                // 计算尺寸因子 - 尺寸越大，因子越小
                const [width, height] = item.size;
                const sizeFactor = 1 / (width * height);
                
                // 计算品质因子 - 品质越高，因子越小
                const qualityFactors = {
                    'blue': 1,
                    'purple': 0.7,
                    'gold': 0.4,
                    'red': 0.2
                };
                const qualityFactor = qualityFactors[item.color] || 1;
                
                // 计算红色物品递减因子
                let redFactor = 1;
                if (item.color === 'red') {
                    redFactor = 1 / Math.pow(3, redItemCount);
                }
                
                // 计算最终权重
                item.weight = item.baseWeight * sizeFactor * qualityFactor * redFactor;
                totalWeight += item.weight;
            });
            
            // 随机选择物品
            for (let i = 0; i < itemCount; i++) {
                let random = Math.random() * totalWeight;
                let selectedIndex = -1;
                
                // 根据权重选择物品
                for (let j = 0; j < items.length; j++) {
                    const item = items[j];
                    random -= item.weight;
                    if (random <= 0) {
                        selectedIndex = j;
                        break;
                    }
                }
                
                if (selectedIndex !== -1) {
                    const selectedItem = items[selectedIndex];
                    selectedItems.push({...selectedItem});
                    
                    // 如果选择了红色物品，增加计数以降低后续概率
                    if (selectedItem.color === 'red') {
                        redItemCount++;
                    }
                }
            }
            
            // 保存当前奖励物品
            currentRewardItems = [...selectedItems];
            
            // 自动记录物品
            autoRecordItems(currentRewardItems);
            
            // 先确定所有物品的位置并显示占位符
            const allItemCells = placeAllItemPlaceholders(selectedItems);
            
            // 然后依次读取每个物品
            readItemsInOrder(selectedItems, allItemCells);
        }
        
        // 放置所有物品的占位符
        function placeAllItemPlaceholders(items) {
            const occupiedCells = new Set();
            let currentRow = 0;
            let currentCol = 0;
            const allItemCells = [];
            
            items.forEach(item => {
                const [width, height] = item.size;
                let placed = false;
                
                // 尝试放置物品，如果当前位置不行则寻找下一个位置
                while (!placed && currentRow <= gridSize - height) {
                    let canPlace = true;
                    const cellsToOccupy = [];
                    
                    for (let r = currentRow; r < currentRow + height; r++) {
                        for (let c = currentCol; c < currentCol + width; c++) {
                            if (c >= gridSize || occupiedCells.has(`${r},${c}`)) {
                                canPlace = false;
                                break;
                            }
                            cellsToOccupy.push({r, c});
                        }
                        if (!canPlace) break;
                    }
                    
                    if (canPlace) {
                        // 记录占用的格子
                        cellsToOccupy.forEach(({r, c}) => occupiedCells.add(`${r},${c}`));
                        
                        // 计算物品的边界
                        const minRow = Math.min(...cellsToOccupy.map(c => c.r));
                        const maxRow = Math.max(...cellsToOccupy.map(c => c.r));
                        const minCol = Math.min(...cellsToOccupy.map(c => c.c));
                        const maxCol = Math.max(...cellsToOccupy.map(c => c.c));
                        
                        // 计算物品的实际尺寸和位置（考虑间隔）
                        const itemWidth = (maxCol - minCol + 1) * cellPercentage - (itemSpacing * 2);
                        const itemHeight = (maxRow - minRow + 1) * cellPercentage - (itemSpacing * 2);
                        const itemLeft = minCol * cellPercentage + itemSpacing;
                        const itemTop = minRow * cellPercentage + itemSpacing;
                        
                        // 创建一个占位符元素（单个元素表示整个物品）
                        const placeholder = document.createElement('div');
                        placeholder.className = 'placeholder-item absolute transition-all duration-300';
                        placeholder.style.width = `${itemWidth}%`;
                        placeholder.style.height = `${itemHeight}%`;
                        placeholder.style.left = `${itemLeft}%`;
                        placeholder.style.top = `${itemTop}%`;
                        
                        gridContainer.appendChild(placeholder);
                        
                        // 记录这个物品的位置信息
                        allItemCells.push({
                            item,
                            cells: cellsToOccupy,
                            minRow,
                            maxRow,
                            minCol,
                            maxCol,
                            width: itemWidth,
                            height: itemHeight,
                            left: itemLeft,
                            top: itemTop,
                            placeholder
                        });
                        
                        // 更新当前位置
                        currentCol += width;
                        if (currentCol > gridSize - 1) {
                            currentCol = 0;
                            currentRow++;
                        }
                        
                        placed = true;
                    } else {
                        currentRow++;
                        currentCol = 0;
                    }
                }
            });
            
            return allItemCells;
        }
        
        // 按顺序读取物品
        function readItemsInOrder(items, allItemCells) {
            let totalDelay = 1000; // 延迟1秒开始读取，让用户看到所有占位符
            
            allItemCells.forEach((itemData, index) => {
                const { 
                    item, 
                    cells, 
                    width, 
                    height, 
                    left, 
                    top,
                    placeholder
                } = itemData;
                const delayBetweenItems = 1000; // 物品之间的延迟
                const [sizeWidth, sizeHeight] = item.size;
                
                // 安排读取这个物品
                setTimeout(() => {
                    // 添加放大镜动画 - 以物品中心为轨迹中心
                    const magnifierContainer = document.createElement('div');
                    magnifierContainer.className = 'magnifier-track';
                    magnifierContainer.style.left = `${left}%`;
                    magnifierContainer.style.top = `${top}%`;
                    magnifierContainer.style.width = `${width}%`;
                    magnifierContainer.style.height = `${height}%`;
                    
                    const magnifier = document.createElement('i');
                    magnifier.className = 'magnifier fa fa-search';
                    magnifier.style.left = '50%';
                    magnifier.style.top = '50%';
                    magnifierContainer.appendChild(magnifier);
                    gridContainer.appendChild(magnifierContainer);
                    
                    // 读取完成，显示物品
                    setTimeout(() => {
                        magnifierContainer.remove();
                        
                        // 移除占位符
                        if (placeholder && placeholder.parentNode === gridContainer) {
                            gridContainer.removeChild(placeholder);
                        }
                        
                        // 创建物品元素
                        const itemElement = document.createElement('div');
                        itemElement.className = `absolute bg-${item.color} item-gradient rounded-sm transition-all duration-500 cursor-pointer`;
                        itemElement.innerHTML = `
                            <img src="${item.icon}" alt="${item.name}" class="fullsize-icon">
                            <div class="size-label">${sizeWidth}x${sizeHeight}</div>
                        `;
                        
                        // 设置物品位置、大小和间隔
                        itemElement.style.width = `${width}%`;
                        itemElement.style.height = `${height}%`;
                        itemElement.style.left = `${left}%`;
                        itemElement.style.top = `${top}%`;
                        
                        // 添加点击事件显示详情
                        itemElement.addEventListener('click', () => {
                            showItemDetail(item);
                        });
                        
                        gridContainer.appendChild(itemElement);
                    }, colorDelays[item.color] * 1000);
                }, totalDelay);
                
                // 计算下一个物品的开始时间
                totalDelay += colorDelays[item.color] * 1000 + delayBetweenItems;
            });
        }
        
        // 初始化
        window.addEventListener('resize', adjustButtonPosition);
        window.addEventListener('load', () => {
            // 预加载所有物品图片
            preloadAllImages();
            initScrollers();
            // 初始化时渲染物品记录
            renderItemRecords();
        });
    </script>
</body>
</html>
    