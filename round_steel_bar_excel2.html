<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no,viewport-fit=cover">
	<title>åœ†æ£’å…¥åº“æ•°æ®ç®¡ç†</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Google+Sans+Text:wght@400;500&family=Google+Sans+Display:wght@400;500&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://unpkg.com/mdui@2/mdui.css">
	<script src="https://unpkg.com/mdui@2.0.3/mdui.global.js"></script>
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
	
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* ğŸ¨ å…¨å±€æ ·å¼ä¸é»‘æš—æ¨¡å¼ */
:root {
    --primary-color: #00796b;
    --background-color: #f5f5f5;
    --surface-color: #ffffff;
    --text-color: #212121;
    --border-color: #e0e0e0;
    --drawer-icon-size: 24px;
}

body.dark-mode {
    --primary-color: #80cbc4; 
    --background-color: #121212; 
    --surface-color: #1e1e1e; 
    --text-color: #ffffff;
    --border-color: #333333;
}

body.mdui-theme-dark {
    --mdui-theme-color-surface: var(--surface-color);
    --mdui-theme-color-background: var(--background-color);
    --mdui-theme-color-primary: var(--primary-color);
    --mdui-top-app-bar-background-color: var(--surface-color);
}

.data-form input, .data-form select, .search-bar input {
    background-color: var(--background-color);
    color: var(--text-color);
}

.search-bar {
    background-color: var(--background-color); 
}

body {
    font-family: 'Roboto', 'Helvetica', 'Arial', sans-serif;
    margin: 0;
    padding-bottom: 80px; /* é¢„ç•™ç©ºé—´ */
    background-color: var(--background-color);
    color: var(--text-color);
    transition: background-color 0.3s, color 0.3s;
}

/* ğŸŒŸ é¡¶éƒ¨å›ºå®šåŒºåŸŸæ ·å¼ ğŸŒŸ */
.top-fixed-area {
    position: sticky;
    top: 0;
    z-index: 100;
    background-color: var(--surface-color);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    padding: 8px 16px 0 16px;
}

.action-bar {
    display: flex;
    align-items: center; 
    justify-content: flex-start;
    gap: 8px;
    flex-wrap: nowrap; 
    background-color: var(--surface-color);
    padding-bottom: 8px;
}

.search-bar {
    display: flex;
    align-items: center;
    border-radius: 8px;
    padding: 4px 8px;
    flex-grow: 1;
    width: 50%;
    max-width: 400px;
    border: 1px solid var(--border-color);
}

.search-bar input {
    border: none;
    outline: none;
    background: none;
    padding: 8px;
    flex-grow: 1;
    min-width: 0;
}

/* æœç´¢æ›¿æ¢å®¹å™¨ - ç´§å‡‘å¸ƒå±€ï¼Œä¸Šä¸‹æŒ‰é’®ç´§è´´å³ä¾§ */
.search-replace-container {
    background-color: var(--surface-color);
    padding: 2px 2px 2px 2px !important; /* æ”¹ä¸º2dpè¾¹è· */
    box-sizing: border-box;
    width: 100%;
    max-width: 100%;
    border-top: 1px solid var(--border-color);
    margin: 0;
}

.search-replace-main {
    display: flex;
    flex-direction: column;
    gap: 2px; /* æ”¹ä¸º2dpé—´è· */
}

.search-replace-top-row {
    display: flex;
    align-items: center;
    gap: 2px; /* æ”¹ä¸º2dpé—´è· */
    width: 100%; /* ç¡®ä¿è¡Œå®¹å™¨å æ»¡å®½åº¦ */
}

.search-replace-top-row input {
    flex: none; /* å–æ¶ˆå¼¹æ€§ä¼¸ç¼©ï¼Œå›ºå®šå®½åº¦ */
    height: 40px;
    max-height: 80px;
    width: 80vw; 
    max-width: 80vw; 
    padding: 4px 4px; 
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background-color: var(--background-color);
    color: var(--text-color);
    font-size: 1rem;
    min-width: 0;
    box-sizing: border-box; /* ç¡®ä¿å†…è¾¹è·ä¸å½±å“å®½åº¦è®¡ç®— */
}

.search-replace-nav-buttons {
    display: flex;
    flex-direction: column;
    gap: 2px; /* æ”¹ä¸º2dpé—´è· */
}

/* ä¿®å¤ï¼šé™åˆ¶æœç´¢æ›¿æ¢æŒ‰é’®å®½åº¦ */
.search-replace-button-row {
    display: flex;
    gap: 2px; /* æ”¹ä¸º2dpé—´è· */
    justify-content: flex-start;
    width: 100%; /* å æ»¡çˆ¶å®¹å™¨ */
}

#replaceOneBtn, #replaceAllBtn {
    flex: 1; /* æŒ‰é’®ç­‰åˆ†å®½åº¦ */
    max-width: 200px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
    min-width: 120px; /* é™åˆ¶æœ€å°å®½åº¦ */
    width: 100%;
    padding: 2px; /* æŒ‰é’®å†…è¾¹è·æ”¹ä¸º2dp */
    margin: 2px 0; /* æŒ‰é’®ä¸Šä¸‹è¾¹è·æ”¹ä¸º2dp */
}

.search-replace-bottom-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 2px; /* æ”¹ä¸º2dpé—´è· */
    font-size: 0.9rem;
    color: #757575;
    padding: 2px 0; /* ä¸Šä¸‹å†…è¾¹è·æ”¹ä¸º2dp */
}

@media (min-width: 600px) {
    .search-replace-main { gap: 2px; } /* ä¿æŒ2dpé—´è· */
    .search-replace-top-row { gap: 2px; } /* ä¿æŒ2dpé—´è· */
    .search-replace-top-row input { 
        border-radius: 8px 0 0 8px; 
        width: 60vw; /* å¤§å±ä»ä¿æŒ60%å±å¹•å®½åº¦ */
    }
    .search-replace-nav-buttons mdui-button-icon { 
        border-radius: 0; 
        margin: 2px 0; /* æŒ‰é’®å›¾æ ‡ä¸Šä¸‹è¾¹è·2dp */
    }
    .search-replace-nav-buttons mdui-button-icon:first-child { border-radius: 0 8px 0 0; }
    .search-replace-nav-buttons mdui-button-icon:last-child { border-radius: 0 0 8px 0; }
    .search-replace-bottom-row { flex-wrap: nowrap; }
}

.search-clear-btn {
    display: none;
    cursor: pointer;
    color: #757575;
    margin: 2px; /* æ”¹ä¸º2dpè¾¹è· */
}

.search-clear-btn.active {
    display: inline-block;
}

.batch-action-container {
    width: 100%;
    padding: 0 0 8px 0;
    background-color: var(--surface-color);
    margin-top: -1px; 
}

/* åº•éƒ¨å¸¸é©»ä¿¡æ¯æ  */
.bottom-data-summary {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 10px 16px;
    background-color: var(--surface-color);
    color: #757575;
    font-size: 0.9rem;
    z-index: 900;
    box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.08);
    border-top: 1px solid var(--border-color);
   
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: center;
}

.bottom-summary-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    flex-wrap: wrap;
    gap: 12px;
}

.bottom-summary-left {
    font-weight: 500;
}

.bottom-summary-right {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
}

.page-info-container {
    display: flex;
    align-items: center;
    gap: 6px;
}

.page-info-text {
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
}

.page-input {
    width: 60px;
    padding: 4px 8px;
    font-size: 0.9rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    text-align: center;
    background-color: var(--background-color);
    color: var(--text-color);
    display: none;
}



.dark-mode .bottom-data-summary {
    background-color: rgba(30, 30, 30, 0.95);
}

@media (min-width: 600px) {
    .bottom-data-summary {
        flex-direction: row;
        padding: 10px 24px;
    }
    .bottom-summary-content {
        flex-wrap: nowrap;
    }
    .bottom-summary-right {
        gap: 16px;
    }
}

/* è¡¨å•è¾“å…¥æ¡†æ ·å¼ */
.data-form {
    padding: 16px;
    max-width: 100%; /* ä¿®å¤ï¼šé˜²æ­¢è¡¨å•æº¢å‡º */
    box-sizing: border-box;
    overflow-x: hidden; /* éšè—æ¨ªå‘æº¢å‡º */
}

.data-form input, .data-form select {
    width: 100%;
    padding: 10px;
    margin-bottom: 12px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    box-sizing: border-box;
    max-width: 100% !important; /* ä¿®å¤ï¼šé™åˆ¶è¾“å…¥æ¡†æœ€å¤§å®½åº¦ */
}

/* ä¿®å¤ï¼šå¤‡æ³¨æ–‡æœ¬æ¡†å®½åº¦æº¢å‡ºé—®é¢˜ */
#remarks {
    height: 200px; 
    font-size: 16px; 
    width: 100% !important; /* å¼ºåˆ¶100%å®½åº¦ */
    max-width: 100%; /* é™åˆ¶æœ€å¤§å®½åº¦ */
    box-sizing: border-box; /* åŒ…å«å†…è¾¹è·/è¾¹æ¡† */
    padding: 10px; /* ç»Ÿä¸€å†…è¾¹è· */
}

.data-form label {
    display: block;
    margin-bottom: 4px;
    font-size: 0.9rem;
    color: #757575;
}

.readonly-input {
     cursor: pointer !important;
     background-color: #e0e0e0 !important;
}

.dark-mode .readonly-input {
     background-color: #333333 !important;
}

/* ä¿®å¤ç©ºçŠ¶æ€å…ƒç´ å ä½å’Œè¶Šç•Œé—®é¢˜ */
.empty-state {
    text-align: center;
    padding: 50px 20px; 
    color: #757575;
    position: absolute; 
    top: 0; 
    left: 0;
    width: 100%; 
    height: 100%;
    
    z-index: 50;
    background-color: var(--background-color);
    box-sizing: border-box;
}

.empty-state p {
    word-break: break-word; 
    overflow-wrap: break-word; 
    max-width: 90%; 
    margin: 10px auto 0 auto;
}

/* è™šæ‹Ÿé”®ç›˜æ ·å¼ */
#virtualKeyboard {
    position: fixed;
    bottom: 10px; 
    padding-bottom: 15px;
    left: 0;
    width: 100%;
    background-color: var(--surface-color);
    border-top: 1px solid var(--border-color);
    box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
    z-index: 2000; 
    display: none;
    box-sizing: border-box;
}

.keyboard-row {
    display: flex;
    padding: 5px 8px;
    justify-content: center;
    margin: 0;
    gap: 4px; /* è¾¹è·å°ä¸€äº›ï¼šä»6pxæ”¹ä¸º4px */
}

.keyboard-key {
    background-color: var(--background-color);
    color: var(--text-color);
    flex: 1 1 0;
    min-width: 0;
    padding: 9px 8px; /* é«˜åº¦ä½ä¸€ç‚¹ï¼šå‚ç›´paddingä»12pxæ”¹ä¸º9px */
    border-radius: 6px;
    text-align: center;
    font-size: 16px; /* å­—ä½“ç¨å°ï¼Œé…åˆé«˜åº¦é™ä½ */
    cursor: pointer;
    user-select: none;
    transition: background-color 0.1s, transform 0.1s;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    
    /* æ‰©å¤§ç‚¹å‡»çƒ­åŒºï¼Œè¦†ç›–è§†è§‰ç¼éš™ */
    position: relative;
    margin-left: 2px;
    margin-right: 2px; /* é…åˆgap:4pxï¼Œç‚¹å‡»åŒºåŸŸæ— ç¼è¦†ç›– */
}

.keyboard-key::before {
    content: '';
    position: absolute;
    top: -6px;
    bottom: -6px;
    left: -6px;
    right: -6px;
}

.keyboard-key:active {
    background-color: var(--primary-color);
    color: #ffffff;
    transform: scale(0.95);
}

.special {
    background-color: #bdbdbd;
    color: #212121;
}

.dark-mode .special {
    background-color: #424242;
    color: #ffffff;
}

.wide { flex: 1.6 1 0; }
.extra-wide { flex: 3 1 0; }

.keyboard-key.empty {
    background: none;
    box-shadow: none;
    cursor: default;
    flex: 1 1 0;
    padding: 0;
    margin: 0;
}

.clear-key { background-color: #f44336 !important; color: white !important; }
.system-keyboard { background-color: #2196f3 !important; color: white !important; }

#shortcutContainer {
    padding: 5px 0;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 5px;
    overflow-x: auto;
    white-space: nowrap;
}

#shortcutContainer .keyboard-row {
    flex-wrap: nowrap;
    justify-content: flex-start;
    gap: 4px; /* å¿«æ·é”®è¾¹è·ä¹Ÿå°ä¸€ç‚¹ */
    padding: 5px 8px;
}

#shortcutContainer .keyboard-key {
    margin-left: 2px;
    margin-right: 2px;
}

.shortcut-key, .status-key {
    flex: none;
    padding: 6px 10px;
    margin: 2px;
}


/* çˆ¶å®¹å™¨ï¼šå›ºå®šé«˜åº¦ + åº•éƒ¨å›ºå®š 80px ç•™ç™½ */
.data-table-container-div {
    width: 100%;
    height: calc(100vh - 200px);           /* è°ƒæ•´ä¸ºä½ çš„å®é™…å¸ƒå±€ */
    overflow: auto;
    -webkit-overflow-scrolling: touch;
    position: relative;
    box-sizing: border-box;
    padding-bottom: 80px;                   /* å›ºå®šåº•éƒ¨ç•™ç™½ 80px */
}

/* å­å®¹å™¨ï¼šå®½åº¦/é«˜åº¦å®æ—¶éš scale å˜åŒ–ï¼ˆå…³é”®ï¼ï¼‰ */
.data-table-container {
    width: max-content;                     /* åˆå§‹ = å†…å®¹æ€»å®½ */
    height: auto;
    min-height: 100%;                       /* è‡³å°‘æ’‘æ»¡é«˜åº¦ */
    transform-origin: top left;
    will-change: transform, width, height;
    transition: transform 0.12s ease-out, width 0.12s ease-out, height 0.12s ease-out;
}

/* è¡¨æ ¼ï¼šä¸¥æ ¼è·Ÿéšå†…å®¹å®½åº¦ */
#dataTable {
    width: max-content !important;
    min-width: max-content;
    table-layout: auto;
    border-collapse: collapse;
}

/* è¡¨å¤´ sticky ä¸å—ç¼©æ”¾å½±å“ */
#dataTable thead th {
    position: sticky;
    top: 0;
    z-index: 50;
    background-color: var(--surface-color);
    box-shadow: 0 2px 2px -1px rgba(0,0,0,0.1);
    transform: none !important;
    font-weight: 500;
    border-bottom: 2px solid var(--border-color);
}

/* å…¶ä»–å•å…ƒæ ¼ã€é€‰ä¸­ã€é«˜äº®ç­‰æ ·å¼ä¿æŒä¸å˜ */
#dataTable th, #dataTable td {
    padding: 12px 8px;
    border: 1px solid var(--border-color);
    text-align: center;
    white-space: normal;
    word-break: break-word;
    font-size: 1rem;
    min-width: 80px;
    overflow: visible;
}

.action-col   { min-width: 100px; width: 100px; max-width: 100px; }
.seq-col      { min-width: 60px; width: 60px; position: relative; }
.checkbox-col { min-width: 50px; width: 50px; }
.remark-col   { min-width: 150px; }

.delete-btn { color: #f44336; }
.selected { background-color: rgba(0,121,107,0.1) !important; }
.dark-mode .selected { background-color: rgba(128,203,196,0.2) !important; }
.highlight { background-color: rgba(255,193,7,0.3) !important; transition: background-color 0.5s ease-out; }

.empty-state {
    position: absolute;
    inset: 0;
    display: none !important;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: var(--background-color);
    z-index: 10;
    color: #757575;
}



/* æœç´¢æ›¿æ¢é«˜äº® */
.search-match-highlight {
    background-color: #ffc107; 
    font-weight: bold;
    color: #212121;
}
.dark-mode .search-match-highlight {
    background-color: #ffd54f; 
    color: #212121;
}
.current-match-highlight {
    outline: 2px solid var(--primary-color);
    outline-offset: -2px;
}

/* ç§»åŠ¨æŒ‰é’® */
.move-buttons {
    display: none;
    flex-direction: column;
    position: absolute;
    left: 0; top: 0;
    height: 100%;
    justify-content: center;
    z-index: 10;
    background-color: rgba(255, 255, 255, 0.8);
    border-right: 1px solid var(--border-color);
    padding: 0 4px;
}
.dark-mode .move-buttons { background-color: rgba(30, 30, 30, 0.8); }
#dataTable tr:hover .move-buttons { display: flex; }

.move-btn {
    background: none;
    border: none;
    padding: 2px;
    cursor: pointer;
    margin: 1px 0;
    color: var(--primary-color);
    transition: color 0.1s;
}
.move-btn:hover { color: #f44336; }

#dataTable td, #dataTable th { position: relative; }

/* è‡ªå®šä¹‰ Modal/Sheet æ ·å¼ */
.modal-custom {
    display: none; 
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
    z-index: 1050; 
}

.modal-content-custom {
    background-color: var(--surface-color);
    margin: 15% auto; 
    padding: 0;
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    width: 90%; 
    max-width: 500px; 
    display: flex;
    flex-direction: column;
    max-height: 90vh; 
    overflow: hidden;
}

.full-height-custom .modal-content-custom {
    width: 100%;
    max-width: 100%;
    height: 100%;
    margin: 0;
    border-radius: 0; 
}

.modal-header-custom {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
    height: 56px;
    border-bottom: 1px solid var(--border-color);
    position: sticky; 
    top: 0; 
    background-color: var(--surface-color);
    z-index: 10;
    flex-shrink: 0;
}

.modal-header-custom h2 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 500;
}

.modal-body-custom {
    padding: 16px; 
    overflow-y: auto; 
    flex-grow: 1; 
    box-sizing: border-box;
    padding-bottom: 80px !important; 
    margin-bottom: -64px;
}

.full-height-custom .modal-body-custom {
    max-height: calc(100vh - 56px - 80px); 
    height: calc(100vh - 56px - 80px);
    padding: 0; 
    box-sizing: border-box;
    padding-bottom: 80px !important;
}

#calculatorModalCustom .modal-body-custom {
    max-height: calc(100vh - 370px); 
    height: auto;
    overflow-y: auto; 
    padding: 0; 
}

/* é˜²æ­¢ dropdown èœå•è¢« modal è£å‰ª */
#sortModalCustom mdui-select::part(menu) {
    max-height: 300px !important;
    overflow-y: auto;
}

.modal-footer-custom {
    padding: 16px 16px 24px 16px;
    display: flex; 
    justify-content: flex-end; 
    gap: 12px;
    position: sticky; 
    bottom: 0; 
    background-color: var(--surface-color); 
    z-index: 10;
    box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.08);
    border-top: 1px solid var(--border-color);
    box-sizing: border-box;
    flex-shrink: 0; 
    align-items: center;
}

.modal-custom:not(.full-height-custom) .modal-content-custom {
    position: absolute; 
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%; 
    max-width: 450px;
    max-height: 90vh;
}

/* æ’åºè§„åˆ™é¡¹æ ·å¼ */
#sortRulesContainer .sort-rule {
    background-color: var(--background-color);
    padding: 6px 14px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

#sortRulesContainer mdui-button-icon[icon="delete"] {
    color: #f44336;
}

#confirmModalCustom .modal-body-custom { padding: 16px; }

/* é‡å¤æ•°æ®ç¡®è®¤æ¨¡æ€æ¡† */
#duplicateConfirmationModalCustom .modal-body-custom {
    max-height: calc(100vh - 56px - 64px); 
    padding: 16px;
    overflow-y: auto;
}

.duplicate-item {
    border: 1px solid var(--border-color);
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 4px;
    background-color: var(--background-color);
}
.dark-mode .duplicate-item { background-color: #282828; }

.duplicate-actions label { margin-right: 15px; font-size: 0.9rem; }

.duplicate-item table { width: 100%; margin: 10px 0 15px; border-collapse: collapse; }
.duplicate-item table th, .duplicate-item table td { padding: 8px; border: 1px solid var(--border-color); text-align: center; }
.duplicate-item table th { background-color: var(--surface-color); }

#drawerList mdui-icon { font-size: var(--drawer-icon-size); }

.checkbox-col {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 !important; 
}

.checkbox-col > mdui-checkbox {
    margin: 0; 
    padding: 12px 8px; 
}

.top-action-buttons {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-shrink: 0; 
}

/* é¡¶éƒ¨èœå•å¼€å…³æ ·å¼é€‚é… */
#filterMatchRowsMenuItem {
    display: none; /* é»˜è®¤éšè—ï¼Œæœç´¢æ›¿æ¢æ¿€æ´»æ—¶æ˜¾ç¤º */
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
}

#mainFab {
    position: fixed;
    right: 16px;
    bottom: 76px; /* é¿å¼€åº•éƒ¨å¸¸é©»æ  */
    z-index: 1000; 
}

/* å¿«é€Ÿç¼–è¾‘å¼¹çª— */
#quickEditDialog .modal-content-custom {
    max-width: 400px;
    top: 30%; 
    transform: translate(-50%, -50%); 
}

#quickEditDialog .modal-body-custom { padding: 20px; }

#quickEditDialog label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--primary-color);
}

#quickEditInput {
    font-size: 1.2rem;
    padding: 12px;
    border: 2px solid var(--primary-color);
    border-radius: 4px;
    width: 100%;
    box-sizing: border-box;
    background-color: var(--background-color);
    color: var(--text-color);
}


.image-col {
    min-width: 100px;
    width: 100px;
    max-width: 100px;
    height: 80px;
    padding: 0 !important;
    vertical-align: middle;
}

.image-col > div {
    width: 100%;
    height: 100%;
}

/* === å¼ºåˆ¶å…¨å±€ä½¿ç”¨ Google Sans === */
*,
*::before,
*::after,
body, input, button, textarea, select,
.mdui-typography,
.mdui-button,
.mdui-list-item,
.mdui-top-app-bar,
.mdui-dialog,
.mdui-text-field-input,
#dataTable,
#dataTable th,
#dataTable td,
.data-form input,
.data-form select,
.virtualKeyboard * {
    font-family: 'Google Sans Text', 'Google Sans Display', system-ui, -apple-system, sans-serif !important;
}

/* åŠ ç²—æ–‡å­—ä½¿ç”¨ Medium å­—é‡ */
h1, h2, h3, h4, h5, h6,
.mdui-top-app-bar-title,
.mdui-button,
.mdui-list-item-headline,
.mdui-dialog-headline {
    font-family: 'Google Sans Text', 'Google Sans Display', system-ui, sans-serif !important;
    font-weight: 500 !important;
}

/* è™šæ‹Ÿé”®ç›˜é”®ä¹Ÿå¼ºåˆ¶ä½¿ç”¨ */
.keyboard-key {
    font-family: 'Google Sans Text', system-ui, sans-serif !important;
    font-weight: 500 !important;
}

/* === ç»ˆæä¿®å¤ï¼šä¿æŠ¤ Material Icons ä¸è¢«è¦†ç›– === */
/* 1. æœ€é«˜ä¼˜å…ˆçº§å…œåº• */
#app mdui-button .mdui-icon,
body mdui-button .mdui-icon {
    font-family: 'Material Icons' !important;
    font-weight: normal !important;
    font-style: normal !important;
}

/* 2. è¦†ç›–æ‰€æœ‰ mdui å›¾æ ‡å…ƒç´  */
.mdui-icon,
.material-icons,
.mdui-icon--material,
[mdui-icon],
mdui-icon {
    font-family: 'Material Icons' !important;
    font-weight: 400 !important;
    font-style: normal !important;
    letter-spacing: normal;
    text-transform: none;
    display: inline-block;
    white-space: nowrap;
    word-wrap: normal;
    direction: ltr;
    -webkit-font-feature-settings: 'liga';
    -webkit-font-smoothing: antialiased;
}

/* 3. æ˜ç¡®é’ˆå¯¹æ‰€æœ‰å˜ä½“æŒ‰é’®çš„å›¾æ ‡ */
mdui-button[variant="elevated"] .mdui-icon,
mdui-button[variant="filled"] .mdui-icon,
mdui-button[variant="tonal"] .mdui-icon,
mdui-button[variant="outlined"] .mdui-icon,
mdui-button[variant="text"] .mdui-icon,
mdui-button > mdui-icon,
mdui-button > span[class*="material-icons"],
mdui-button > i[class*="material-icons"] {
    font-family: 'Material Icons' !important;
    font-weight: normal !important;
}

/* 4. ä¿®å¤ mdui ç»„ä»¶å†…ç½®å›¾æ ‡æ ·å¼è¢«è¦†ç›– */
:host(mdui-button) .mdui-icon,
mdui-button::part(icon),
mdui-icon::part(root) {
    font-family: 'Material Icons' !important;
}


</style>
<body>

<mdui-navigation-drawer id="drawer" close-on-overlay-click placement="left" close-on-esc>
    <mdui-top-app-bar slot="header">
        <mdui-top-app-bar-title>åŠŸèƒ½èœå•</mdui-top-app-bar-title>
    </mdui-top-app-bar>
    <mdui-list id="drawerList">
        <mdui-collapse>
            <mdui-collapse-item id="themeCollapse">
                <mdui-list-item slot="header" icon="dark_mode" headline="ä¸»é¢˜æ¨¡å¼ (å½“å‰: è‡ªåŠ¨)"></mdui-list-item>
                <mdui-list id="themeCollapseContent">
                    <mdui-list-item class="theme-option" data-theme="auto" icon="brightness_auto" headline="è‡ªåŠ¨ (è·Ÿéšç³»ç»Ÿ)"></mdui-list-item>
                    <mdui-list-item class="theme-option" data-theme="light" icon="light_mode" headline="æ—¥é—´æ¨¡å¼"></mdui-list-item>
                    <mdui-list-item class="theme-option" data-theme="dark" icon="dark_mode" headline="å¤œé—´æ¨¡å¼"></mdui-list-item>
                </mdui-list>
            </mdui-collapse-item>
        </mdui-collapse>
        <mdui-list-item id="importItem" icon="file_upload" headline="å¯¼å…¥ Excel"></mdui-list-item>
        <mdui-list-item id="exportItem" icon="file_download" headline="å¯¼å‡º Excel"></mdui-list-item>
        <mdui-list-item id="calculatorBtn" icon="calculate" headline="è®¡ç®—é‡é‡"></mdui-list-item>
        <mdui-divider></mdui-divider>
        <mdui-list-item id="sortItem" icon="sort" headline="æ•°æ®æ’åº"></mdui-list-item>
    </mdui-list>
</mdui-navigation-drawer>

<div class="top-fixed-area">
    <div class="action-bar">
        <mdui-button-icon icon="menu" id="openDrawerBtn"></mdui-button-icon>
        <div class="search-bar">
            <span class="material-icons" style="color:#757575;">search</span>
            <input type="text" id="searchInput" placeholder="æœç´¢æ‰€æœ‰å­—æ®µ...">
            <span class="material-icons search-clear-btn" id="searchClearBtn">clear</span>
        </div>
        <div class="top-action-buttons">
            <mdui-button-icon icon="find_replace" id="toggleSearchReplaceBtn" style="margin-right: -8px;"></mdui-button-icon>
            <mdui-dropdown placement="bottom-end">
                <mdui-button-icon slot="trigger" icon="more_vert" id="topMenuBtn"></mdui-button-icon>
                <mdui-menu>
                    <mdui-menu-item id="multiSelectMenuItem" icon="check_box_outline_blank">
                        <span id="multiSelectMenuText">è¿›å…¥å¤šé€‰æ¨¡å¼</span>
                    </mdui-menu-item>
                    <!-- æ–°å¢ï¼šåªæ˜¾ç¤ºåŒ¹é…è¡Œå¼€å…³ï¼ˆç§»è‡³é¡¶éƒ¨èœå•ï¼‰ -->
                    <mdui-menu-item id="filterMatchRowsMenuItem" style="text-align: center;display: flex; align-items: center; justify-content: space-between;">
                        <span>åªæ˜¾ç¤ºåŒ¹é…è¡Œ</span>
                        <mdui-switch id="filterMatchRowsSwitch"></mdui-switch>
                    </mdui-menu-item>
                    <mdui-menu-item id="aboutItem" icon="info">å…³äº</mdui-menu-item>
                </mdui-menu>
            </mdui-dropdown>
        </div>
    </div>
    <div class="search-replace-container" id="searchReplaceContainer" style="display: none;">
        <div class="search-replace-main">
            <div class="search-replace-top-row">
                <input type="text" id="replaceQuery" placeholder="æ›¿æ¢ä¸º">
                <div class="search-replace-nav-buttons">
                    <mdui-button-icon icon="arrow_upward" id="prevMatchBtn"></mdui-button-icon>
                    <mdui-button-icon icon="arrow_downward" id="nextMatchBtn"></mdui-button-icon>
                </div>
            </div>
            <div class="search-replace-button-row">
                <mdui-button variant="filled" id="replaceOneBtn" disabled>æ›¿æ¢å½“å‰</mdui-button>
                <mdui-button variant="outlined" id="replaceAllBtn" color="error" disabled>æ›¿æ¢å…¨éƒ¨</mdui-button>
            </div>
            <div class="search-replace-bottom-row">
                <span id="searchResultCount">æ‰¾åˆ° 0 ä¸ªåŒ¹é…é¡¹</span>
                <!-- å·²åˆ é™¤ï¼šåŸä½ç½®çš„ filterMatchRowsSwitch å¼€å…³ -->
            </div>
        </div>
    </div>
    <div class="batch-action-container">
        <mdui-button variant="outlined" color="error" id="deleteSelectedBtn" style="display: none; width: 100%;">
            <mdui-icon name="delete"></mdui-icon> æ‰¹é‡åˆ é™¤ (<span id="selectedCount">0</span>) 
        </mdui-button>
    </div>
</div>

<div class="data-table-container-div">
    <div class="data-table-container">
        <table id="dataTable">
            <thead>
                <tr>
                    <th class="seq-col">åºå·</th>
                    <th class="checkbox-col" style="display: none;">
                        <mdui-checkbox id="selectAllCheckbox">å…¨é€‰</mdui-checkbox>
                    </th>
                    <th>é’¢ç§</th>
                    <th>äº§å“å·</th>
                    <th>å¡ç‰‡å·</th>
                    <th>ç‚‰å·</th>
                    <th>å®é™…ç›´å¾„</th>
                    <th>ç›´å¾„</th>
                    <th>é•¿åº¦</th>
                    <th>é‡é‡</th>
                    <th>çŠ¶æ€</th>
                    <th>ä½ç½®</th>
                    <th>ç¡¬åº¦</th>
                    <th class="remark-col">å¤‡æ³¨</th>
                    <th class="image-col">å¡ç‰‡å›¾ç‰‡</th>
                    <th class="action-col">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
    <div class="bottom-data-summary">
        <div class="bottom-summary-content">
            <div class="bottom-summary-left" id="totalCountText">å…± 0 æ¡æ•°æ®</div>
            <div class="bottom-summary-right">
                <div class="page-info-container">
                    <span class="page-info-text" id="pageInfoText">ç¬¬ 1 / 1 é¡µ</span>
                    <input type="number" class="page-input" id="pageJumpInput" min="1" value="1">
                </div>
                <div style="display: flex; gap: 8px;">
                    <mdui-button-icon icon="navigate_before" id="bottomPrevBtn"></mdui-button-icon>
                    <mdui-button-icon icon="navigate_next" id="bottomNextBtn"></mdui-button-icon>
                </div>
            </div>
        </div>
    </div>
    <div class="empty-state" id="emptyState">
        <span class="material-icons" style="font-size: 48px;margin-Top: 120px">inbox</span>
        <p>æš‚æ— æ•°æ®ï¼Œç‚¹å‡»å³ä¸‹è§’â€œæ·»åŠ â€æŒ‰é’®å¼€å§‹å½•å…¥ã€‚</p>
    </div>
</div>
<input type="file" id="fileInput" accept=".xlsx,.xls,.zip,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/zip" style="display:none;">
<!-- æ·»åŠ /ç¼–è¾‘æ•°æ®å¼¹çª— -->
<div id="dataSheetCustom" class="modal-custom full-height-custom">
    <div class="modal-content-custom">
        <div id="dataSheetHeader" class="modal-header-custom">
            <h2 id="modalTitle">æ·»åŠ æ•°æ®</h2>
            <mdui-button-icon icon="close" id="closeDataModal"></mdui-button-icon>
        </div>
        <div id="dataSheetContent" class="modal-body-custom">
            <form id="dataForm" class="data-form">
                <input type="hidden" id="editIndex" value="-1">
                <label for="steelType">é’¢ç§</label>
                <input type="text" id="steelType" class="readonly-input">
                <label for="productId">äº§å“å·</label>
                <input type="text" id="productId" class="readonly-input">
                <label for="cardId">å¡ç‰‡å·</label>
                <input type="text" id="cardId" class="readonly-input">
                <label for="furnaceId">ç‚‰å·</label>
                <input type="text" id="furnaceId" class="readonly-input">
                <mdui-divider style="margin-bottom:10px"></mdui-divider>
                <label for="actualDiameter">å®é™…ç›´å¾„</label>
                <input type="text" id="actualDiameter" class="numeric-input readonly-input">
                <label for="diameter">ç›´å¾„</label>
                <input type="text" id="diameter" class="numeric-input readonly-input">
                <label for="length">é•¿åº¦</label>
                <input type="text" id="length" class="numeric-input readonly-input">
                <label for="weight">é‡é‡</label>
                <input type="text" id="weight" class="numeric-input readonly-input">
                <mdui-divider style="margin-bottom:10px"></mdui-divider>
                <label for="status">çŠ¶æ€</label>
                <input type="text" id="status" class="readonly-input">
                <label for="position">ä½ç½®</label>
                <input type="text" id="position" class="readonly-input">
                <label for="hardness">ç¡¬åº¦</label>
                <input type="text" id="hardness" class="numeric-input readonly-input">
                <label for="remarks">å¤‡æ³¨</label>
                <textarea rows="5" cols="30" id="remarks"></textarea>
                
                
<mdui-divider style="margin:20px 0 10px 0"></mdui-divider>
<div style="text-align:center;margin-bottom:16px;">
    <label style="font-weight:500;color:var(--primary-color);font-size:1.1rem;">å¡ç‰‡å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
</div>

<!-- å›¾ç‰‡é¢„è§ˆåŒºï¼ˆæœ‰å›¾æ—¶æ˜¾ç¤ºï¼‰ -->
<div id="cardImagePreview" style="text-align:center;margin-bottom:20px;display:none;">
    <img id="previewImg" style="max-height:300px;max-width:100%;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.2);cursor:pointer;" onclick="showFullImage(this.src)">
    <div style="margin-top:16px;display:flex;justify-content:center;gap:20px;">
        <mdui-button variant="filled" id="changeImageBtn">
            <mdui-icon name="photo_camera"></mdui-icon> é‡æ–°é€‰æ‹©/æ‹ç…§
        </mdui-button>
        <mdui-button variant="outlined" color="error" id="deleteImageBtn">
            <mdui-icon name="delete"></mdui-icon> åˆ é™¤å›¾ç‰‡
        </mdui-button>
    </div>
</div>

<!-- æ— å›¾ç‰‡æ—¶çš„ä¸Šä¼ åŒºåŸŸ -->
<div id="noImageUploadArea" style="text-align:center;">
    <input type="file" id="cardImageInput" accept="image/*" style="display:none;"> <!-- é»˜è®¤æ—  capture -->
    
    <div id="dragDropArea" style="border:2px dashed var(--border-color);border-radius:12px;padding:40px;margin:20px;background:var(--background-color);cursor:pointer;transition:background 0.3s;">
        <mdui-icon name="cloud_upload" style="font-size:48px;color:var(--primary-color);opacity:0.6;display:block;margin-bottom:16px;"></mdui-icon>
        <div style="font-size:1.1rem;color:var(--text-color);">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</div>
        <div style="font-size:0.9rem;color:#757575;margin-top:8px;">æ”¯æŒæ‹ç…§ã€ç›¸å†Œé€‰æ‹©ã€æ–‡ä»¶æ‹–å…¥</div>
    </div>
    
    <div style="display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin-top:16px;">
        <mdui-button variant="tonal" id="selectFromGalleryBtn">
            <mdui-icon name="photo_library"></mdui-icon> ä»ç›¸å†Œé€‰æ‹©
        </mdui-button>
        <mdui-button variant="tonal" id="takePhotoBtn">
            <mdui-icon name="photo_camera"></mdui-icon> ç›´æ¥æ‹ç…§
        </mdui-button>
    </div>
</div>
                
                
            </form>
            
        </div>
        <div id="dataSheetFooter" class="modal-footer-custom">
            <mdui-button variant="text" id="cancelBtn">å–æ¶ˆ</mdui-button>
            <mdui-button variant="filled" id="saveBtn">ä¿å­˜</mdui-button>
        </div>
    </div>
</div>

<!-- å¿«é€Ÿç¼–è¾‘å¼¹çª— -->
<div id="quickEditDialog" class="modal-custom">
    <div class="modal-content-custom">
        <div class="modal-header-custom">
            <h2 id="quickEditTitle">å¿«é€Ÿç¼–è¾‘</h2>
            <mdui-button-icon icon="close" id="closeQuickEdit"></mdui-button-icon>
        </div>
        <div class="modal-body-custom">
            <label id="quickEditLabel">å­—æ®µå</label>
            <input type="text" id="quickEditInput" class="readonly-input">
            <input type="hidden" id="quickEditIndex">
            <input type="hidden" id="quickEditField">
        </div>
        <div class="modal-footer-custom" style="justify-content: space-between;">
            <mdui-button variant="text" id="openFullEditBtn">æ‰“å¼€å®Œæ•´ç¼–è¾‘ç•Œé¢</mdui-button>
            <mdui-button variant="filled" id="saveQuickEditBtn">ä¿å­˜</mdui-button>
        </div>
    </div>
</div>

<!-- è™šæ‹Ÿé”®ç›˜ -->
<div id="virtualKeyboard">
    <div id="shortcutContainer"></div>
    <div id="keyboardRows"></div>
</div>

<!-- ç¡®è®¤å¼¹çª— -->
<div id="confirmModalCustom" class="modal-custom full-height-custom">
    <div class="modal-content-custom">
        <div class="modal-header-custom">
            <h2 class="modal-title">æ“ä½œç¡®è®¤</h2>
            <mdui-button-icon icon="close" id="closeConfirmModal"></mdui-button-icon>
        </div>
        <div class="modal-body-custom">
            <div id="confirmMessage"></div>
        </div>
        <div class="modal-footer-custom">
            <mdui-button variant="text" id="cancelConfirmBtn">å–æ¶ˆ</mdui-button>
            <mdui-button variant="filled" color="error" id="confirmActionBtn">ç¡®å®š</mdui-button>
        </div>
    </div>
</div>

<!-- é‡é‡è®¡ç®—å¼¹çª— -->
<div id="calculatorModalCustom" class="modal-custom full-height-custom">
    <div class="modal-content-custom">
        <div class="modal-header-custom">
            <h2 class="modal-title">åœ†æ£’é‡é‡è®¡ç®—</h2>
            <mdui-button-icon icon="close" id="closeCalculatorModal"></mdui-button-icon>
        </div>
        <div id="calculatorContent" class="modal-body-custom">
            <form id="calculatorForm" class="data-form" style="padding: 16px;">
                <label for="calcDiameter1">ç›´å¾„ 1 (mm)</label>
                <input type="text" id="calcDiameter1" class="numeric-input readonly-input">
                <label for="calcDiameter2">ç›´å¾„ 2 (mm)</label>
                <input type="text" id="calcDiameter2" class="numeric-input readonly-input">
                <label for="calcLength">é•¿åº¦ (mm)</label>
                <input type="text" id="calcLength" class="numeric-input readonly-input">
                <label for="calcDensity">å¯†åº¦ (Kg/mmÂ³, é»˜è®¤ 0.00617)</label>
                <input type="text" id="calcDensity" readonly>
                <label for="calcResult">è®¡ç®—ç»“æœ (Kg)</label>
                <input type="text" id="calcResult" readonly style="font-weight: bold; font-size: 1.2em;">
            </form>
        </div>
        <div class="modal-footer-custom">
            <mdui-button variant="text" id="clearCalcBtn" color="error">æ¸…ç©ºå…¨éƒ¨</mdui-button>
            <mdui-button variant="text" id="cancelCalcBtn">å–æ¶ˆ</mdui-button>
            <mdui-button variant="filled" id="calculateAndAddBtn">è®¡ç®—å¹¶å¡«å……</mdui-button>
        </div>
    </div>
</div>

<!-- é‡å¤æ•°æ®ç¡®è®¤å¼¹çª— -->
<div id="duplicateConfirmationModalCustom" class="modal-custom full-height-custom">
    <div class="modal-content-custom">
        <div class="modal-header-custom">
            <h2 class="modal-title">å¯¼å…¥é‡å¤æ•°æ®ç¡®è®¤</h2>
            <mdui-button-icon icon="close" id="closeDuplicateModal"></mdui-button-icon>
        </div>
        <div class="modal-body-custom">
            <p>æ€»å…±å¯¼å…¥ <span id="modal-total-count" style="font-weight: bold;">0</span> æ¡è®°å½•ã€‚å…¶ä¸­ï¼š</p>
            <ul>
                <li>æ–°æ•°æ® <span id="modal-new-count" style="font-weight: bold; color: var(--primary-color);">0</span> æ¡ï¼ˆå°†ç›´æ¥æ·»åŠ ï¼‰</li>
                <li>é‡å¤æ•°æ® <span id="modal-duplicate-count" style="font-weight: bold; color: #f44336;">0</span> æ¡ï¼ˆè¯·é€‰æ‹©å¤„ç†æ–¹å¼ï¼‰</li>
            </ul>
            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                <mdui-button variant="outlined" id="modal-btn-select-all-skip">å…¨éƒ¨è·³è¿‡ (ä¿ç•™ç°æœ‰)</mdui-button>
                <mdui-button variant="outlined" id="modal-btn-select-all-override">å…¨éƒ¨è¦†ç›– (ä½¿ç”¨æ–°å€¼)</mdui-button>
            </div>
            <div id="modal-duplicate-list"></div>
        </div>
        <div class="modal-footer-custom">
            <mdui-button variant="text" id="modal-btn-cancel-import">å–æ¶ˆå¯¼å…¥</mdui-button>
            <mdui-button variant="filled" id="modal-btn-confirm">ç¡®è®¤å¤„ç†å¹¶å®Œæˆå¯¼å…¥</mdui-button>
        </div>
    </div>
</div>

<!-- æ•°æ®æ’åºå¼¹çª— -->
<div id="sortModalCustom" class="full-height-custom modal-custom">
    <div class="modal-content-custom">
        <div class="modal-header-custom">
            <h2 class="modal-title">æ•°æ®æ’åº</h2>
            <mdui-button-icon icon="close" id="closeSortModal"></mdui-button-icon>
        </div>
        <div class="modal-body-custom">
            <div class="data-form" style="padding: 0 16px;">
                <p style="color: #757575; font-size: 0.9rem; margin-bottom: 16px;">ä»ä¸Šåˆ°ä¸‹ä¼˜å…ˆçº§ä¾æ¬¡é™ä½ï¼ˆå…ˆæŒ‰ç¬¬ä¸€æ¡ï¼Œå†æŒ‰ç¬¬äºŒæ¡ï¼Œä»¥æ­¤ç±»æ¨ï¼‰</p>
                <mdui-button variant="outlined" id="addSortRuleBtn" style="width: 100%; margin-top: 12px;">
                    <mdui-icon name="add"></mdui-icon> æ·»åŠ æ’åºè§„åˆ™ 
                </mdui-button>
                <div id="sortRulesContainer"></div>
            </div>
        </div>
        <div class="modal-footer-custom">
            <mdui-button variant="text" id="cancelSortBtn">å–æ¶ˆ</mdui-button>
            <mdui-button variant="filled" id="applySortBtn">åº”ç”¨æ’åº</mdui-button>
        </div>
    </div>
</div>

<!-- åº•éƒ¨æ·»åŠ æŒ‰é’® -->
<mdui-fab icon="add" id="mainFab"></mdui-fab>

<!-- é‡å¤æ•°æ®é¡¹æ¨¡æ¿ -->
<script type="text/template" id="duplicate-item-template"> 
    <div class="duplicate-item">
        <h4>äº§å“å·ï¼šPRODUCT_ID</h4>
        <div class="duplicate-differences">
            <table>
                <thead>
                    <tr>
                        <th>å­—æ®µ</th>
                        <th>ç°æœ‰å€¼</th>
                        <th>æ–°å€¼</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="duplicate-actions">
            <label><input type="radio" name="action-ITEM_INDEX" value="skip" checked> è·³è¿‡ (ä¿ç•™ç°æœ‰å€¼)</label>
            <label><input type="radio" name="action-ITEM_INDEX" value="override"> è¦†ç›– (ä½¿ç”¨æ–°å€¼)</label>
        </div>
    </div>
</script>

<!-- å·®å¼‚è¡Œæ¨¡æ¿ -->
<script type="text/template" id="difference-row-template"> 
    <tr>
        <th>FIELD_NAME</th>
        <td>OLD_VALUE</td>
        <td style="color: #f44336; font-weight: bold;">NEW_VALUE</td>
    </tr>
</script>

<!-- å…³äºå¼¹çª— -->
<mdui-dialog id="aboutDialog" fullscreen headline="å…³äº & æ“ä½œæŒ‡å—" close-on-overlay-click class="full-height-custom">
    <div style="font-size: 14px; font-weight: bold; margin-bottom: 8px;"> åœ†æ£’å…¥åº“æ•°æ®ç®¡ç† <br><span style="font-size: 12px; font-weight: normal; color: #666;">ç‰ˆæœ¬ï¼š26.1.06</span>
    </div>
    <div style="font-size: 12px; color: #888; margin-bottom: 12px;"> åˆ¶ä½œï¼šä½¿ç”¨Gemini + Doubao + Grok<br /> æ›´æ–°ï¼šæŒç»­ä¿®å¤ bugï¼Œä¼˜åŒ–ç”¨æˆ·ä½“éªŒ </div>
    <mdui-divider style="margin-bottom: 12px;"></mdui-divider>
    <div style="font-size: 13px; line-height: 1.8; color: #333;">
        <strong>ã€åŸºç¡€æ“ä½œã€‘</strong><br /> â€¢ <b>æ·»åŠ /ç¼–è¾‘æ•°æ®</b>ï¼šç‚¹å‡»å³ä¸‹è§’ + æŒ‰é’®ï¼Œæˆ–ç›´æ¥ç‚¹å‡»è¡¨æ ¼è¡Œ<br /> â€¢ <b>å¿«é€Ÿç¼–è¾‘</b>ï¼šç‚¹å‡»è¡¨æ ¼å•å…ƒæ ¼ï¼Œå¯å¿«é€Ÿä¿®æ”¹å•ä¸ªå­—æ®µ<br /> â€¢ <b>å¤šé€‰åˆ é™¤</b>ï¼šç‚¹å‡»å³ä¸Šè§’ â‹® â†’ è¿›å…¥å¤šé€‰æ¨¡å¼ â†’ å‹¾é€‰è¡Œ â†’ æ‰¹é‡åˆ é™¤<br />
        <br />
        <strong>ã€æ•°æ®å¤„ç†ã€‘</strong><br /> â€¢ <b>å¯¼å…¥/å¯¼å‡º Excel</b>ï¼šå·¦ä¾§æŠ½å±‰èœå• â†’ å¯¼å…¥ Excel / å¯¼å‡º Excel<br /> â€¢ <b>æœç´¢</b>ï¼šé¡¶éƒ¨æœç´¢æ¡†è¾“å…¥å…³é”®å­—ï¼Œæ”¯æŒæœç´¢æ‰€æœ‰å­—æ®µ<br /> â€¢ <b>æœç´¢æ›¿æ¢</b>ï¼šç‚¹å‡» ğŸ”â†”ï¸ æŒ‰é’®æ‰“å¼€æ›¿æ¢é¢æ¿ï¼Œå¯æ›¿æ¢å½“å‰æˆ–å…¨éƒ¨<br /> â€¢ <b>è®¡ç®—é‡é‡</b>ï¼šæŠ½å±‰èœå• â†’ è®¡ç®—é‡é‡ â†’ è¾“å…¥å‚æ•°å¹¶å¡«å……<br /> â€¢ <b>æ•°æ®æ’åº</b>ï¼šæŠ½å±‰èœå• â†’ æ•°æ®æ’åº â†’ æ·»åŠ è§„åˆ™å¹¶åº”ç”¨<br />
        <br />
        <strong>ã€æ‰‹åŠ¿ä¸æ˜¾ç¤ºã€‘</strong><br /> â€¢ <b>è¡¨æ ¼ç¼©æ”¾</b>ï¼šåŒæŒ‡æåˆç¼©å°ï¼ŒåŒæŒ‡å¼ å¼€æ”¾å¤§ï¼ˆæœ€å¤§åŸå°ºå¯¸ï¼‰<br /> â€¢ <b>ç§»åŠ¨è¡Œåº</b>ï¼šé¼ æ ‡æ‚¬åœåœ¨è¡Œå·¦ä¾§ï¼Œä½¿ç”¨å‡ºç° â†‘â†“ æŒ‰é’®æ‹–åŠ¨<br /> â€¢ <b>æ‰‹æœºç«¯ç§»åŠ¨è¡Œåº</b>ï¼šè¿›å…¥å¤šé€‰æ¨¡å¼ï¼Œç‚¹å‡»é¡¹ç›®å‡ºç° â†‘â†“ æŒ‰é’®ç‚¹å‡»æ“ä½œ<br />
        <br />
        <strong>ã€è™šæ‹Ÿé”®ç›˜è¯´æ˜ã€‘</strong><br /> â€¢ <b>è‡ªåŠ¨å¼¹å‡º</b>ï¼šç‚¹å‡»è¾“å…¥æ¡†è‡ªåŠ¨å¼¹å‡ºè‡ªå®šä¹‰é”®ç›˜<br /> â€¢ <b>åˆ‡æ¢å­—æ®µ</b>ï¼šç‚¹å‡»å³ä¸‹è§’ <b>â–¼ï¼ˆå®Œæˆï¼‰</b> é”®è‡ªåŠ¨è·³è½¬ä¸‹ä¸€é¡¹<br /> â€¢ <b>å…³é—­é”®ç›˜</b>ï¼šé•¿æŒ‰ <b>â–¼</b> é”®æˆ–åœ¨å¿«ç¼–æ¨¡å¼ç‚¹å‡» <b>âœ”</b> é”®<br /> â€¢ <b>å¿«æ·åˆ é™¤</b>ï¼š<b>â†âœ˜</b> æ¸…ç©ºå†…å®¹ï¼›<b>â†</b> åˆ é™¤å‰ä¸€å­—ç¬¦ï¼ˆæ”¯æŒé•¿æŒ‰ï¼‰<br /> â€¢ <b>å¿«æ·è¾“å…¥</b>ï¼šé¦–è¡Œæ”¯æŒé’¢ç§ã€çŠ¶æ€ã€ä½ç½®ç­‰ä¸€é”®å¡«å…¥<br />
    </div>
    <div style="margin-top: 16px; font-size: 12px; color: #999; text-align: center;"> å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åé¦ˆæ”¹è¿›ã€‚æ„Ÿè°¢ä½¿ç”¨ï¼ </div>
    <mdui-button slot="action" variant="text" onclick="document.getElementById('aboutDialog').open = false;"> å…³é—­ </mdui-button>
</mdui-dialog>

<!-- åˆ é™¤å›¾ç‰‡ç¡®è®¤å¯¹è¯æ¡† -->
<mdui-dialog id="deleteImageConfirmDialog" headline="ç¡®è®¤åˆ é™¤" 
             close-on-overlay-click close-on-esc>
    <div style="padding:16px 0;font-size:1rem;">ç¡®å®šè¦åˆ é™¤è¿™å¼ å¡ç‰‡å›¾ç‰‡å—ï¼Ÿåˆ é™¤åä¸å¯æ¢å¤ã€‚</div>
    <mdui-button slot="action" variant="text" id="cancelDeleteImageBtn">å–æ¶ˆ</mdui-button>
    <mdui-button slot="action" variant="filled" color="error" id="confirmDeleteImageBtn">åˆ é™¤</mdui-button>
</mdui-dialog>
<!-- å–æ¶ˆç¼–è¾‘ç¡®è®¤å¯¹è¯æ¡† -->
<mdui-dialog id="cancelEditConfirmDialog" headline="ç¡®è®¤å–æ¶ˆ" 
             close-on-overlay-click close-on-esc>
    <div style="padding:16px 0;font-size:1rem;">ç¡®å®šè¦å–æ¶ˆæ“ä½œå—ï¼Ÿå–æ¶ˆåå½“å‰è¾“å…¥çš„å†…å®¹å¯èƒ½ä¼šä¸¢å¤±ã€‚</div>
    <mdui-button slot="action" variant="text" id="cancelCancelBtn">è¿”å›ç»§ç»­ç¼–è¾‘</mdui-button>
    <mdui-button slot="action" variant="filled" color="error" id="confirmCancelBtn">ç¡®è®¤å–æ¶ˆ</mdui-button>
</mdui-dialog>

<mdui-snackbar id="general-snackbar" placement="bottom-center" closeable></mdui-snackbar>
<!-- æ–°å¢ï¼šå¼€å…³æ˜¾éšé€»è¾‘ JS -->
<script>
// åˆå§‹åŒ–å¼€å…³æ˜¾éš
toggleFilterMatchSwitch();

// æœç´¢æ›¿æ¢å¼€å…³æ˜¾éšå‡½æ•°
function toggleFilterMatchSwitch() {
    const switchItem = document.getElementById('filterMatchRowsMenuItem');
    const isSearchReplaceOpen = document.getElementById('searchReplaceContainer').style.display !== 'none';
    switchItem.style.display = isSearchReplaceOpen ? 'flex' : 'none';
}

// ç»‘å®šæœç´¢æ›¿æ¢æŒ‰é’®äº‹ä»¶
document.getElementById('toggleSearchReplaceBtn').addEventListener('click', function() {
    const container = document.getElementById('searchReplaceContainer');
    container.style.display = container.style.display === 'none' ? 'block' : 'none';
    toggleFilterMatchSwitch();
});

// ä¿ç•™åŸæœ‰å¼€å…³åŠŸèƒ½é€»è¾‘ï¼ˆè¯·æ›¿æ¢ä¸ºä½ å®é™…çš„è¿‡æ»¤é€»è¾‘ï¼‰
document.getElementById('filterMatchRowsSwitch').addEventListener('change', function() {
    
    
});
</script>



	<script>
		/**
		 * =========================================================================
		 * åœ†æ£’å…¥åº“æ•°æ®ç®¡ç†ç³»ç»Ÿ - JavaScript æ ¸å¿ƒé€»è¾‘ï¼ˆæ”¯æŒå¤šå­—æ®µåŠ¨æ€æ’åºï¼‰
		 * Based on MDUI v2
		 * =========================================================================
		 */
		
		// æ ¸å¿ƒæ•°æ®å­˜å‚¨
		let tableData = [];             // å­˜å‚¨æ‰€æœ‰åœ†æ£’æ•°æ®çš„æ•°ç»„
		let currentInput = null;        // å½“å‰æ¿€æ´»çš„è¾“å…¥æ¡† DOM å…ƒç´ 
		let keyboardState = JSON.parse(localStorage.getItem('keyboardState')) || {
		    shiftState: 'locked-on',    // å¤§å°å†™çŠ¶æ€ï¼šlocked-onï¼ˆå¤§å†™é”å®šï¼‰ã€onï¼ˆä¸´æ—¶å¤§å†™ï¼‰ã€offï¼ˆå°å†™é”å®šï¼‰
		    inputType: 'text'           // ç»‘å®šçš„è¾“å…¥å­—æ®µç±»å‹ï¼Œç”¨äºå†³å®šé”®ç›˜å¸ƒå±€
		};
		let suppressVirtualKeyboard = false;  // æ–°å¢æ ‡å¿—ï¼šæ˜¯å¦æŠ‘åˆ¶è™šæ‹Ÿé”®ç›˜
		let currentEditIndex = -1;      // å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ•°æ®é¡¹åœ¨ tableData ä¸­çš„ç´¢å¼•ï¼Œ-1 è¡¨ç¤ºæ–°å¢
		let isMultiSelectMode = false;  // æ˜¯å¦å¤„äºå¤šé€‰æ¨¡å¼
		let selectedRows = new Set();   // å­˜å‚¨é€‰ä¸­çš„è¡Œåœ¨ tableData ä¸­çš„åŸå§‹ç´¢å¼•
		let selectedTheme = localStorage.getItem('theme') || 'auto'; // å½“å‰ä¸»é¢˜æ¨¡å¼
		let searchTerm = '';            // å½“å‰æœç´¢å…³é”®å­—
		let isSearchReplaceVisible = false; // æœç´¢æ›¿æ¢åŒºåŸŸæ˜¯å¦å¯è§
		let currentPage = 1;
		        const PAGE_SIZE = 50; // æ¯é¡µæ¡æ•°ï¼Œå¯æ ¹æ®è®¾å¤‡è°ƒæ•´ï¼ˆæ‰‹æœº50ï¼Œå¹³æ¿100ï¼‰
		        let totalPages = 1;
		// æœç´¢/æ›¿æ¢å˜é‡
		let searchMatches = [];         
		let currentMatchIndex = -1;     
		let isSearchActive = false;     
		const searchableFields = [
		    'steelType', 'productId', 'cardId', 'furnaceId', 'actualDiameter', 
		    'diameter', 'length', 'weight', 'status', 'position', 'hardness', 'remarks'
		];
		let duplicateCurrentPage = 1;
		        const DUPLICATE_PAGE_SIZE = 10; // é‡å¤ç¡®è®¤æ¯é¡µæ˜¾ç¤ºæ¡æ•°
		        let duplicateTotalPages = 1;
		        let isFilterMatchRows = false; // æ˜¯å¦å¯ç”¨â€œåªæ˜¾ç¤ºåŒ¹é…è¡Œâ€
		// æ•°æ®è¡¨å•å­—æ®µé¡ºåºï¼Œç”¨äºè™šæ‹Ÿé”®ç›˜çš„ Tab åˆ‡æ¢é€»è¾‘
		const inputFieldOrder = [
		  'steelType', 'productId', 'cardId', 'furnaceId',
		  'actualDiameter', 'diameter', 'length', 'weight',
		  'status', 'position', 'hardness', 'remarks'
		];
		
		// å­—æ®µä¸­æ–‡æ ‡ç­¾æ˜ å°„
		const fieldLabels = {
		    'steelType': 'é’¢ç§',
		    'productId': 'äº§å“å·',
		    'cardId': 'å¡ç‰‡å·',
		    'furnaceId': 'ç‚‰å·',
		    'actualDiameter': 'å®é™…ç›´å¾„',
		    'diameter': 'ç›´å¾„',
		    'length': 'é•¿åº¦',
		    'weight': 'é‡é‡',
		    'status': 'çŠ¶æ€',
		    'position': 'ä½ç½®',
		    'hardness': 'ç¡¬åº¦',
		    'remarks': 'å¤‡æ³¨'
		};
		
		// å¤šå­—æ®µæ’åºä¸“ç”¨é€‰é¡¹ï¼ˆå¡ç‰‡å·æ”¾åœ¨æœ€å‰é¢ï¼‰
		const sortFieldOptions = [
		    { value: 'cardId', label: 'å¡ç‰‡å·' },
		    { value: 'productId', label: 'äº§å“å·' },
		    { value: 'steelType', label: 'é’¢ç§' },
		    { value: 'furnaceId', label: 'ç‚‰å·' },
		    { value: 'actualDiameter', label: 'å®é™…ç›´å¾„' },
		    { value: 'diameter', label: 'ç›´å¾„' },
		    { value: 'length', label: 'é•¿åº¦' },
		    { value: 'weight', label: 'é‡é‡' },
		    { value: 'status', label: 'çŠ¶æ€' },
		    { value: 'position', label: 'ä½ç½®' },
		    { value: 'hardness', label: 'ç¡¬åº¦' }
		];
		
		const numericSortFields = ['actualDiameter', 'diameter', 'length', 'weight', 'hardness'];
		
		// DOM å…ƒç´ å¼•ç”¨
		const dom = {
		  themeCollapse: document.getElementById('themeCollapse'),
		  themeCollapseContent: document.getElementById('themeCollapseContent'),
		  tableBody: document.getElementById('tableBody'),
		  emptyState: document.getElementById('emptyState'),
		  itemCount: document.getElementById('itemCount'),
		  addBtn: document.getElementById('mainFab'), 
		  importItem: document.getElementById('importItem'),
		  exportItem: document.getElementById('exportItem'),
		  fileInput: document.getElementById('fileInput'),
		  deleteSelectedBtn: document.getElementById('deleteSelectedBtn'),
		  selectedCount: document.getElementById('selectedCount'),
		  selectAllCheckbox: document.getElementById('selectAllCheckbox'),
		  drawer: document.getElementById('drawer'),
		  openDrawerBtn: document.getElementById('openDrawerBtn'),
		  dataSheet: document.getElementById('dataSheetCustom'), 
		  closeDataModal: document.getElementById('closeDataModal'),
		  saveBtn: document.getElementById('saveBtn'),
		  cancelBtn: document.getElementById('cancelBtn'),
		  dataForm: document.getElementById('dataForm'),
		  modalTitle: document.getElementById('modalTitle'),
		  editIndex: document.getElementById('editIndex'),
		  quickEditDialog: document.getElementById('quickEditDialog'),
		  closeQuickEdit: document.getElementById('closeQuickEdit'),
		  quickEditLabel: document.getElementById('quickEditLabel'),
		  quickEditInput: document.getElementById('quickEditInput'),
		  quickEditIndex: document.getElementById('quickEditIndex'),
		  quickEditField: document.getElementById('quickEditField'),
		  saveQuickEditBtn: document.getElementById('saveQuickEditBtn'),
		  openFullEditBtn: document.getElementById('openFullEditBtn'),
		  confirmModal: document.getElementById('confirmModalCustom'), 
		  closeConfirmModal: document.getElementById('closeConfirmModal'),
		  confirmMessage: document.getElementById('confirmMessage'),
		  cancelConfirmBtn: document.getElementById('cancelConfirmBtn'),
		  confirmActionBtn: document.getElementById('confirmActionBtn'),
		  virtualKeyboard: document.getElementById('virtualKeyboard'),
		  keyboardRows: document.getElementById('keyboardRows'),
		  shortcutContainer: document.getElementById('shortcutContainer'),
		  searchInput: document.getElementById('searchInput'),
		  searchClearBtn: document.getElementById('searchClearBtn'),
		  calculatorModal: document.getElementById('calculatorModalCustom'), 
		  calculatorBtn: document.getElementById('calculatorBtn'),
		  closeCalculatorModal: document.getElementById('closeCalculatorModal'),
		  calculatorForm: document.getElementById('calculatorForm'),
		  calcDiameter1: document.getElementById('calcDiameter1'),
		  calcDiameter2: document.getElementById('calcDiameter2'),
		  calcLength: document.getElementById('calcLength'),
		  calcDensity: document.getElementById('calcDensity'),
		  calcResult: document.getElementById('calcResult'),
		  calculateAndAddBtn: document.getElementById('calculateAndAddBtn'),
		  cancelCalcBtn: document.getElementById('cancelCalcBtn'),
		  clearCalcBtn: document.getElementById('clearCalcBtn'),
		  duplicateConfirmationModal: document.getElementById('duplicateConfirmationModalCustom'), 
		  closeDuplicateModal: document.getElementById('closeDuplicateModal'),
		  generalSnackbar: document.getElementById('general-snackbar'),
		  filterMatchRowsSwitch: document.getElementById('filterMatchRowsSwitch'),
		  
		  cardImageInput: document.getElementById('cardImageInput'),
uploadImageBtn: document.getElementById('uploadImageBtn'),
cardImagePreview: document.getElementById('cardImagePreview'),
previewImg: document.getElementById('previewImg'),
changeImageBtn: document.getElementById('changeImageBtn'),
deleteImageBtn: document.getElementById('deleteImageBtn'),
		  
		  
		  multiSelectMenuText: document.getElementById('multiSelectMenuText'), 
		  multiSelectMenuItem: document.getElementById('multiSelectMenuItem'), 
		  
		  toggleSearchReplaceBtn: document.getElementById('toggleSearchReplaceBtn'),
		  searchReplaceContainer: document.getElementById('searchReplaceContainer'),
		  replaceQueryInput: document.getElementById('replaceQuery'),       
		  searchResultCount: document.getElementById('searchResultCount'), 
		  prevMatchBtn: document.getElementById('prevMatchBtn'),           
		  nextMatchBtn: document.getElementById('nextMatchBtn'),           
		  replaceOneBtn: document.getElementById('replaceOneBtn'),         
		  replaceAllBtn: document.getElementById('replaceAllBtn'),
		  
		  sortItem: document.getElementById('sortItem'),
		  sortModal: document.getElementById('sortModalCustom'),
		  closeSortModal: document.getElementById('closeSortModal'),
		  cancelSortBtn: document.getElementById('cancelSortBtn'),
		  applySortBtn: document.getElementById('applySortBtn'),
		  sortRulesContainer: document.getElementById('sortRulesContainer'),
		  addSortRuleBtn: document.getElementById('addSortRuleBtn'),
		  
		  aboutDialog: document.getElementById('aboutDialog'),
		  aboutItem: document.getElementById('aboutItem'),
		  totalCountText: document.getElementById('totalCountText'),
		  bottomPrevBtn: document.getElementById('bottomPrevBtn'),   // å‰ä¸€é¡µæŒ‰é’®
		            bottomNextBtn: document.getElementById('bottomNextBtn'),    // ä¸‹ä¸€é¡µæŒ‰é’®
		            pageInfoText: document.getElementById('pageInfoText'),      // "ç¬¬ x/y é¡µ" æ–‡å­—
		            pageJumpInput:document.getElementById('pageJumpInput')   // è·³è½¬è¾“å…¥æ¡†
		  
		  
		};
		
		// è¡¨å•è¾“å…¥å­—æ®µ DOM å¼•ç”¨
		const formElements = {
		  steelType: document.getElementById('steelType'),
		  productId: document.getElementById('productId'),
		  cardId: document.getElementById('cardId'),
		  furnaceId: document.getElementById('furnaceId'),
		  actualDiameter: document.getElementById('actualDiameter'),
		  diameter: document.getElementById('diameter'),
		  length: document.getElementById('length'),
		  weight: document.getElementById('weight'),
		  status: document.getElementById('status'),
		  position: document.getElementById('position'),
		  hardness: document.getElementById('hardness'),
		  remarks: document.getElementById('remarks')
		};
		const inputFields = Object.values(formElements); 
		
		// è™šæ‹Ÿé”®ç›˜çš„å¿«æ·é€‰é¡¹å¸¸é‡
		const statusOptions = ['è½¦å…‰', 'è°ƒè½¦', 'èŠ±çš®', 'é»‘çš®', 'é»‘è°ƒ', 'èŠ±è°ƒ'];
		const positionOptions = ['å¤–', 'è¿‡é“', 'ç«‹è½¦', 'æ‰“å¡æœº','æ ¡ç›´æœº'];
		const steelTypeOptions = [
		    '42CrMo4',
		    'C45E',
		    '4140Q&T',
		    '1045Norm',
		    'C45',
		    'S355J2G3',
		    '16/20MnCrS5',
		    '1.2714',
		    '18CrMo4',
		    '18NiCrMo5+A',
		    'S355J2+N',
		    '4145',
		    'A105/LF2'
		];
		const cardIdOptions = [
		    'æ— å¤‡',
		    'å¤‡åº“',
		    'V478-',
		    'V15P',
		    'AUSA502-',
		    'V2526-',
		    'V2527-',
		    'TS',
		    'TH',
		    'VT'
		];
		const furnaceIdOptions = [
		    '1251',
		    'VD25/',
		    '1250',
		    '251050',
		    '251051',
		    '25D0',
		    '25C0',
		    'VD26/'
		];
		
		/**
		 * æ˜¾ç¤ºåº•éƒ¨é€šçŸ¥æ ï¼ˆSnackbarï¼‰
		 */
		function showSnackbar(message, color) {
		  const snackbar = dom.generalSnackbar;
		  if (!snackbar) return;
		  snackbar.innerHTML = message;
		  if (color) snackbar.color = color;
		  else snackbar.removeAttribute('color');
		  snackbar.open = true;
		}
		
		function isSystemDarkMode() {
		    return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
		}
		
		function initTheme() {
		  let mode = selectedTheme === 'auto' ? (isSystemDarkMode() ? 'dark' : 'light') : selectedTheme;
		  const body = document.body;
		  if (mode === 'dark') {
		    body.classList.add('dark-mode', 'mdui-theme-dark');
		  } else {
		    body.classList.remove('dark-mode', 'mdui-theme-dark');
		  }
		  updateThemeSelectionInDrawer();
		}
		
		function changeTheme(theme) {
		  selectedTheme = theme;
		  localStorage.setItem('theme', selectedTheme);
		  initTheme();
		  dom.drawer.open = false; 
		}
		
		function updateThemeSelectionInDrawer() {
		    const themeOptions = dom.themeCollapseContent.querySelectorAll('.theme-option');
		    themeOptions.forEach(item => item.removeAttribute('selected'));
		    const current = dom.themeCollapseContent.querySelector(`.theme-option[data-theme="${selectedTheme}"]`);
		    if (current) current.setAttribute('selected', 'true');
		    
		    const headerItem = dom.themeCollapse.querySelector('mdui-list-item[slot="header"]');
		    let headlineText = "ä¸»é¢˜æ¨¡å¼ (å½“å‰: è‡ªåŠ¨)";
		    let iconName = "brightness_auto";
		    if (selectedTheme === 'light') { headlineText = "ä¸»é¢˜æ¨¡å¼ (å½“å‰: æ—¥é—´)"; iconName = "light_mode"; }
		    else if (selectedTheme === 'dark') { headlineText = "ä¸»é¢˜æ¨¡å¼ (å½“å‰: å¤œé—´)"; iconName = "dark_mode"; }
		    if (headerItem) {
		        headerItem.setAttribute('headline', headlineText);
		        headerItem.setAttribute('icon', iconName);
		    }
		}
		
		function openCustomModal(modalElement) {
		    if (modalElement) modalElement.style.display = 'block';
		}
		
		function closeCustomModal(modalElement) {
		    if (modalElement) modalElement.style.display = 'none';
		}
		
		function initEventListeners() {
		
		// å›¾ç‰‡ä¸Šä¼ ç›¸å…³
// è·å–å…ƒç´ 
const selectGalleryBtn = document.getElementById('selectFromGalleryBtn');
const takePhotoBtn = document.getElementById('takePhotoBtn');
const dragDropArea = document.getElementById('dragDropArea');
const fileInput = document.getElementById('cardImageInput');

// ç‚¹å‡»â€œä»ç›¸å†Œé€‰æ‹©â€ â†’ æ‰“å¼€ç›¸å†Œ/æ–‡ä»¶é€‰æ‹©å™¨ï¼ˆç§»é™¤ captureï¼‰
if (selectGalleryBtn) {
    selectGalleryBtn.addEventListener('click', () => {
        fileInput.removeAttribute('capture');
        fileInput.click();
    });
}

// ç‚¹å‡»â€œç›´æ¥æ‹ç…§â€ â†’ å¼ºåˆ¶æ‰“å¼€ç›¸æœº
if (takePhotoBtn) {
    takePhotoBtn.addEventListener('click', () => {
        fileInput.setAttribute('capture', 'environment'); // environment = åç½®æ‘„åƒå¤´
        // å¯é€‰ï¼šenvironment â†’ userï¼ˆå‰ç½®æ‘„åƒå¤´ï¼‰ï¼Œæ ¹æ®éœ€æ±‚é€‰
        fileInput.click();
    });
}

// ç‚¹å‡»æ‹–æ‹½åŒº â†’ é»˜è®¤ä¹Ÿå½“åšâ€œé€‰æ‹©å›¾ç‰‡â€ï¼Œæ‰“å¼€ç›¸å†Œ
dragDropArea.addEventListener('click', () => {
    fileInput.removeAttribute('capture');
    fileInput.click();
});

// æ‹–å…¥æ–‡ä»¶ â†’ ç›´æ¥å¤„ç†ï¼ˆä¸å”¤èµ·ä»»ä½•é€‰æ‹©å™¨ï¼‰
dragDropArea.addEventListener('drop', (e) => {
    e.preventDefault();
    e.stopPropagation();
    
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
        handleImageSelect({ target: { files: [file] } });
        showSnackbar('å›¾ç‰‡æ‹–å…¥æˆåŠŸ', 'success');
    } else {
        showSnackbar('è¯·æ‹–å…¥å›¾ç‰‡æ–‡ä»¶', 'warning');
    }
});

// æ‹–æ‹½è§†è§‰åé¦ˆï¼ˆä¸å˜ï¼‰
['dragenter', 'dragover'].forEach(eventName => {
    dragDropArea.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragDropArea.style.background = 'rgba(var(--primary-color-rgb), 0.1)';
        dragDropArea.style.borderColor = 'var(--primary-color)';
    });
});

['dragleave', 'drop'].forEach(eventName => {
    dragDropArea.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragDropArea.style.background = '';
        dragDropArea.style.borderColor = 'var(--border-color)';
    });
});

// æ–‡ä»¶é€‰æ‹©ç»Ÿä¸€å¤„ç†
fileInput.addEventListener('change', handleImageSelect);


// å–æ¶ˆåˆ é™¤
document.getElementById('cancelDeleteImageBtn').addEventListener('click', () => {
    const dialog = document.getElementById('deleteImageConfirmDialog');
    if (dialog) {
        dialog.open = false;
    }
});

		  dom.openDrawerBtn.addEventListener('click', () => { dom.drawer.open = true; });
		  dom.themeCollapseContent.querySelectorAll('.theme-option').forEach(item => {
		      item.addEventListener('click', (e) => {
		          const theme = e.currentTarget.getAttribute('data-theme');
		          changeTheme(theme);
		      });
		  });
		
// === å³ä¸Šè§’å…³é—­æŒ‰é’®ï¼ˆÃ—ï¼‰è§¦å‘ç¡®è®¤å¯¹è¯æ¡† ===
dom.closeDataModal.addEventListener('click', () => {
    const dialog = document.getElementById('cancelEditConfirmDialog');
    if (dialog) {
        dialog.open = true;  // æ‰“å¼€ç¡®è®¤å¯¹è¯æ¡†
    }
});


// å–æ¶ˆæŒ‰é’®ï¼ˆè§¦å‘ç¡®è®¤å¯¹è¯æ¡†ï¼‰
dom.cancelBtn.addEventListener('click', () => {
    const dialog = document.getElementById('cancelEditConfirmDialog');
    if (dialog) {
        dialog.open = true;
    }
});

// === ç¡®è®¤å–æ¶ˆæŒ‰é’® ===
document.getElementById('confirmCancelBtn').addEventListener('click', () => {
    closeCustomModal(dom.dataSheet);
    dom.virtualKeyboard.style.display = 'none';

    const dialog = document.getElementById('cancelEditConfirmDialog');
    if (dialog) {
        dialog.open = false;
    }
});

// === è¿”å›ç»§ç»­ç¼–è¾‘æŒ‰é’® ===
document.getElementById('cancelCancelBtn').addEventListener('click', () => {
    const dialog = document.getElementById('cancelEditConfirmDialog');
    if (dialog) {
        dialog.open = false;
    }
});

		
		  dom.closeQuickEdit.addEventListener('click', () => { closeCustomModal(dom.quickEditDialog); dom.virtualKeyboard.style.display = 'none'; 
		  keyboardState.isQuickEdit = false;
		saveKeyboardState();
		  
		  });
		  dom.saveQuickEditBtn.addEventListener('click', saveQuickEdit);
		  dom.openFullEditBtn.addEventListener('click', () => {
		  keyboardState.isQuickEdit = false;
		saveKeyboardState();
		    const index = parseInt(dom.quickEditIndex.value);
		    const targetFieldId = dom.quickEditField.value;  // è·å–å½“å‰å¿«é€Ÿç¼–è¾‘çš„å­—æ®µ ID
		
		    closeCustomModal(dom.quickEditDialog);
		    dom.virtualKeyboard.style.display = 'none';  // ä¿é™©èµ·è§å…³é—­é”®ç›˜
		
		    setTimeout(() => {
		        openEditModal(index, targetFieldId);  // ä¼ å…¥å­—æ®µ ID
		    }, 150);  // ç¨å»¶é•¿ä¸€ç‚¹å»¶è¿Ÿï¼Œç¡®ä¿ä¸Šä¸€ä¸ª modal å®Œå…¨å…³é—­
		});
		  
		  dom.quickEditInput.addEventListener('click', (e) => {
		      e.stopPropagation();
		      currentInput = e.target;
		      const realFieldId = dom.quickEditField.value;
		      updateKeyboardForInput(currentInput, realFieldId); 
		      showVirtualKeyboard();
		  });
		  
		  dom.closeConfirmModal.addEventListener('click', () => closeCustomModal(dom.confirmModal));
		  dom.cancelConfirmBtn.addEventListener('click', () => closeCustomModal(dom.confirmModal));
		  dom.closeCalculatorModal.addEventListener('click', () => { closeCustomModal(dom.calculatorModal); dom.virtualKeyboard.style.display = 'none'; });
		  dom.cancelCalcBtn.addEventListener('click', () => { closeCustomModal(dom.calculatorModal); dom.virtualKeyboard.style.display = 'none'; });
		  dom.clearCalcBtn.addEventListener('click', clearCalculatorInputs);
		  dom.closeDuplicateModal.addEventListener('click', () => closeCustomModal(dom.duplicateConfirmationModal));
		  document.getElementById('modal-btn-cancel-import').addEventListener('click', () => {
		      closeCustomModal(dom.duplicateConfirmationModal);
		      showSnackbar('å¯¼å…¥æ“ä½œå·²å–æ¶ˆ', 'warning');
		  });
		  
		  dom.sortItem.addEventListener('click', openSortModal);
		  dom.closeSortModal.addEventListener('click', () => closeCustomModal(dom.sortModal));
		  dom.cancelSortBtn.addEventListener('click', () => closeCustomModal(dom.sortModal));
		  dom.applySortBtn.addEventListener('click', applySort);
		  dom.addSortRuleBtn.addEventListener('click', () => addSortRule());
		  
		  dom.toggleSearchReplaceBtn.addEventListener('click', toggleSearchReplaceVisibility);
		  
		  dom.multiSelectMenuItem.addEventListener('click', () => { 
		      dom.drawer.open = false; 
		      toggleMultiSelectMode(); 
		  });
		  
		  if (dom.aboutItem && dom.aboutDialog) {
		      dom.aboutItem.addEventListener('click', () => {
		          dom.aboutDialog.open = true;
		          dom.drawer.open = false;
		      });
		  }
		  
		dom.searchInput.addEventListener('input', (e) => {
		    const newQuery = e.target.value.trim();
		    if (newQuery !== dom.searchInput.value.trim()) return; // é˜²æŠ–ç”¨ï¼ˆå¯é€‰ï¼‰
		
		    // æ¯æ¬¡è¾“å…¥éƒ½é‡æ–°æœç´¢ + é«˜äº®
		    startSearch();
		    updateTable(); // è§¦å‘é«˜äº®åº”ç”¨
		});
		  
		  dom.replaceQueryInput.addEventListener('input', () => {
		    dom.replaceOneBtn.disabled = searchMatches.length === 0;
		    dom.replaceAllBtn.disabled = searchMatches.length === 0;
		  });
		  
		  dom.prevMatchBtn.addEventListener('click', () => navigateMatch(-1));
		  dom.nextMatchBtn.addEventListener('click', () => navigateMatch(1));
		  dom.replaceOneBtn.addEventListener('click', replaceOne);
		  dom.replaceAllBtn.addEventListener('click', confirmReplaceAll);
		
		  inputFields.forEach(field => {
		    field.addEventListener('click', (e) => {
		      e.stopPropagation();
		      currentInput = e.target;
		      
		      if (currentInput.id === 'remarks') {
		        currentInput.removeAttribute('readonly');
		        currentInput.classList.remove('readonly-input');
		        dom.virtualKeyboard.style.display = 'none';
		        currentInput.focus();
		        return; 
		      }
		      
		      currentInput.setAttribute('readonly', 'true');
		      currentInput.classList.add('readonly-input');
		      updateKeyboardForInput(currentInput);
		      showVirtualKeyboard();
		      
		      setTimeout(() => {
		        const modalContent = document.getElementById('dataSheetContent');
		        if(modalContent) {
		            const inputRect = currentInput.getBoundingClientRect();
		            const modalRect = modalContent.getBoundingClientRect();
		            const offset = inputRect.top - modalRect.top + modalContent.scrollTop - modalRect.height * 0.3; 
		            modalContent.scrollTo({ top: offset, behavior: 'smooth' });
		        }
		      }, 100);
		    });
		    
		    field.addEventListener('dblclick', (e) => {
		      e.stopPropagation();
		      currentInput = e.target;
		      if (currentInput.id === 'remarks') return; 
		      
		      if (currentInput.hasAttribute('readonly')) {
		        currentInput.removeAttribute('readonly');
		        currentInput.classList.remove('readonly-input');
		        dom.virtualKeyboard.style.display = 'none';
		        currentInput.focus();
		      } else {
		        currentInput.setAttribute('readonly', 'true');
		        currentInput.classList.add('readonly-input');
		        updateKeyboardForInput(currentInput);
		        showVirtualKeyboard();
		      }
		    });
		  });
		  
		  dom.importItem.addEventListener('click', () => { dom.drawer.open = false; dom.fileInput.click(); });
		  dom.exportItem.addEventListener('click', () => { dom.drawer.open = false; exportToExcel(); });
		  dom.addBtn.addEventListener('click', openAddModal); 
		  dom.fileInput.addEventListener('change', handleFileImport);
		  dom.selectAllCheckbox.addEventListener('change', handleSelectAll);
		  dom.deleteSelectedBtn.addEventListener('click', confirmDeleteSelected);
		  dom.saveBtn.addEventListener('click', saveData);
		
		  dom.searchClearBtn.addEventListener('click', () => {
		    dom.searchInput.value = '';
		    searchTerm = '';
		    updateTable();
		  });
		
		  dom.calculatorBtn.addEventListener('click', openCalculatorModal);
		  dom.calculateAndAddBtn.addEventListener('click', calculateAndAddData);
		  
		  
		  
dom.tableBody.addEventListener('click', (e) => {
    if (isMultiSelectMode) return;

    // å¿½ç•¥æŒ‰é’®å’Œå›¾ç‰‡ç‚¹å‡»
    if (e.target.closest('mdui-button-icon') || e.target.closest('.image-col') || e.target.tagName === 'IMG') {
        return;
    }

    const row = e.target.closest('tr');
    if (!row) return;

    const index = parseInt(row.getAttribute('data-index'));
    const cell = e.target.closest('td');
    const targetFieldId = cell ? cell.getAttribute('data-field') : null;

    if (targetFieldId && targetFieldId !== 'cardImage') {
        if (targetFieldId === 'remarks') {
            openEditModal(index, targetFieldId);
        } else {
            openQuickEdit(index, targetFieldId);
        }
    } else if (!targetFieldId || targetFieldId !== 'cardImage') {
        openEditModal(index);
    }
});
	
const uploadBtn = document.getElementById('uploadImageBtn');


		  // æ–°å¢ï¼šåº•éƒ¨ç¿»é¡µæŒ‰é’®äº‹ä»¶
		    dom.bottomPrevBtn.addEventListener('click', () => {
		        if (currentPage > 1) {
		            currentPage--;
		            updateTable();
		        }
		    });
		
		    dom.bottomNextBtn.addEventListener('click', () => {
		        if (currentPage < totalPages) {
		            currentPage++;
		            updateTable();
		        }
		    });
		
		    // æ–°å¢ï¼šç‚¹å‡»é¡µç æ–‡æœ¬æ˜¾ç¤ºè¾“å…¥æ¡†
		    dom.pageInfoText.addEventListener('click', () => {
		        dom.pageInfoText.style.display = 'none';
		        dom.pageJumpInput.style.display = 'inline-block';
		        dom.pageJumpInput.focus();
		        dom.pageJumpInput.select();
		    });
		
		    // è¾“å…¥æ¡†å›è½¦æˆ–å¤±ç„¦è·³è½¬
		    dom.pageJumpInput.addEventListener('keydown', (e) => {
		        if (e.key === 'Enter') {
		            e.preventDefault();
		            jumpToPage();
		        }
		    });
		  
		  
		  dom.pageJumpInput.addEventListener('blur', jumpToPage);
		
		    
		}
		
		
		function jumpToPage() {
		        let target = parseInt(dom.pageJumpInput.value);
		        target = Math.max(1, Math.min(totalPages, isNaN(target) ? currentPage : target));
		        if (target !== currentPage) {
		            currentPage = target;
		            updateTable();
		        }
		        dom.pageJumpInput.style.display = 'none';
		        dom.pageInfoText.style.display = 'inline-block';
		    }
		function toggleSearchReplaceVisibility() {
		    isSearchReplaceVisible = !isSearchReplaceVisible;
		    const container = dom.searchReplaceContainer;
		    
		    if (isSearchReplaceVisible) {
		        container.style.display = 'flex';
		        dom.toggleSearchReplaceBtn.icon = 'expand_less';
		        startSearch();
		    } else {
		        container.style.display = 'none';
		        dom.toggleSearchReplaceBtn.icon = 'find_replace';
		        isSearchActive = false;
		        searchMatches = [];
		        currentMatchIndex = -1;
		        updateTable();
		    }
		}
		
		function handleSelectAll() {
		    if (!isMultiSelectMode) return;
		    selectedRows.clear();
		    const filteredData = getFilteredData();
		    if (dom.selectAllCheckbox.checked) {
		      filteredData.forEach(item => {
		          const originalIndex = tableData.indexOf(item);
		          if (originalIndex !== -1) selectedRows.add(originalIndex);
		      });
		    }
		    updateTable();
		}
		
		function openCalculatorModal() {
		    dom.drawer.open = false;
		    openCustomModal(dom.calculatorModal); 
		    dom.calcDiameter1.value = '';
		    dom.calcDiameter2.value = '';
		    dom.calcLength.value = '';
		    dom.calcResult.value = '';
		    
		    currentInput = dom.calcDiameter1;
		    updateKeyboardForInput(currentInput);
		    showVirtualKeyboard();
		    currentInput.focus();
		}
		
		function clearCalculatorInputs() {
		    dom.calcDiameter1.value = '';
		    dom.calcDiameter2.value = '';
		    dom.calcLength.value = '';
		    dom.calcResult.value = '';
		    calculateWeight(); 
		    
		    dom.calcDiameter1.focus();
		    currentInput = dom.calcDiameter1;
		    updateKeyboardForInput(currentInput);
		}
		
		function getFilteredData() {
		  if (!searchTerm) return [...tableData];
		  return tableData.filter(item => 
		    Object.values(item).some(value => 
		      value !== null && value !== undefined && value.toString().toLowerCase().includes(searchTerm)
		    )
		  );
		}

function updateTable() {
    // å§‹ç»ˆæ˜¾ç¤ºå…¨éƒ¨æ•°æ®ï¼ˆä¸è¿‡æ»¤ï¼Œé™¤éä½ ä»¥åæƒ³åŠ è¿‡æ»¤é€»è¾‘ï¼‰
    const displayData = [...tableData];

    totalPages = Math.max(1, Math.ceil(displayData.length / PAGE_SIZE));
    currentPage = Math.min(currentPage, totalPages);

    const startIndex = (currentPage - 1) * PAGE_SIZE;
    const endIndex = startIndex + PAGE_SIZE;
    const pageData = displayData.slice(startIndex, endIndex);

    // æ›´æ–°åº•éƒ¨æ ä¿¡æ¯
    dom.totalCountText.textContent = `å…± ${tableData.length} æ¡æ•°æ®`;
    dom.pageInfoText.textContent = `ç¬¬ ${currentPage} / ${totalPages} é¡µ`;
    dom.pageJumpInput.value = currentPage;
    dom.pageJumpInput.max = totalPages;
    dom.bottomPrevBtn.disabled = currentPage === 1;
    dom.bottomNextBtn.disabled = currentPage === totalPages;

    dom.searchClearBtn.classList.toggle('active', !!searchTerm);
    dom.selectedCount.textContent = selectedRows.size;

    // å¤šé€‰æ¨¡å¼ä¸‹æ˜¾ç¤º/éšè—å¤é€‰æ¡†åˆ—ï¼ˆåªåœ¨æœ‰æ•°æ®æ—¶ç”Ÿæ•ˆï¼‰
    const displayStyle = isMultiSelectMode ? 'table-cell' : 'none';
    const checkboxColHeader = document.querySelector('#dataTable th.checkbox-col');
    const allCheckboxColCells = document.querySelectorAll('#dataTable td.checkbox-col');

    dom.deleteSelectedBtn.style.display = isMultiSelectMode ? 'inline-flex' : 'none';
    if (checkboxColHeader) checkboxColHeader.style.display = displayStyle;
    dom.selectAllCheckbox.style.display = isMultiSelectMode ? 'block' : 'none';
    allCheckboxColCells.forEach(cell => cell.style.display = displayStyle);

    // å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
    dom.selectAllCheckbox.checked = pageData.length > 0 && pageData.every(item => {
        const origIndex = tableData.indexOf(item);
        return selectedRows.has(origIndex);
    });

    // å…³é”®æ§åˆ¶å…ƒç´ 
    const dataTable = document.getElementById('dataTable');
    const emptyState = document.getElementById('emptyState');
    const bottomSummary = document.querySelector('.bottom-data-summary');

    if (tableData.length === 0) {
        // æ— æ•°æ®ï¼šå½»åº•éšè—æ•´ä¸ªè¡¨æ ¼ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€ï¼Œéšè—åº•éƒ¨åˆ†é¡µ
        if (dataTable) dataTable.style.display = 'none';
        dom.tableBody.innerHTML = ''; // æ¸…ç©º tbodyï¼ˆä¿é™©ï¼‰
        emptyState.style.display = 'flex';
        if (bottomSummary) bottomSummary.style.display = 'none';
        document.getElementById('deleteSelectedBtn').style.display = 'none';
    } else {
        // æœ‰æ•°æ®ï¼šæ˜¾ç¤ºæ•´ä¸ªè¡¨æ ¼ï¼Œéšè—ç©ºçŠ¶æ€ï¼Œæ˜¾ç¤ºåº•éƒ¨åˆ†é¡µ
        if (dataTable) dataTable.style.display = 'table';
        emptyState.style.display = 'none';
        if (bottomSummary) bottomSummary.style.display = 'flex';

        // æ¸…ç©ºå¹¶é‡æ–°æ¸²æŸ“è¡¨æ ¼ä½“
        dom.tableBody.innerHTML = '';

        pageData.forEach((item, displayIndex) => {
            const originalIndex = tableData.indexOf(item);
            const globalSeq = originalIndex + 1;

            const row = document.createElement('tr');
            row.setAttribute('data-index', originalIndex);

            if (isMultiSelectMode && selectedRows.has(originalIndex)) row.classList.add('selected');

            row.innerHTML = `
                <td class="seq-col">
                    ${globalSeq}
                    <div class="move-buttons">
                        <button class="move-btn up-btn" data-index="${originalIndex}" ${originalIndex === 0 ? 'disabled' : ''}>
                          <i class="material-icons" style="font-size: 14px;">arrow_upward</i>
                        </button>
                        <button class="move-btn down-btn" data-index="${originalIndex}" ${originalIndex === tableData.length - 1 ? 'disabled' : ''}>
                          <i class="material-icons" style="font-size: 14px;">arrow_downward</i>
                        </button>
                    </div>
                </td>
                <td class="checkbox-col" style="display:${displayStyle};">
                    <mdui-checkbox class="row-checkbox" data-index="${originalIndex}" ${isMultiSelectMode && selectedRows.has(originalIndex) ? 'checked' : ''}></mdui-checkbox>
                </td>
                <td data-field="steelType">${item.steelType || '-'}</td>
                <td data-field="productId">${item.productId || '-'}</td>
                <td data-field="cardId">${item.cardId || '-'}</td>
                <td data-field="furnaceId">${item.furnaceId || '-'}</td>
                <td data-field="actualDiameter">${item.actualDiameter || '-'}</td>
                <td data-field="diameter">${item.diameter || '-'}</td>
                <td data-field="length">${item.length || '-'}</td>
                <td data-field="weight">${item.weight || '-'}</td>
                <td data-field="status">${item.status || '-'}</td>
                <td data-field="position">${item.position || '-'}</td>
                <td data-field="hardness">${item.hardness || '-'}</td>
                <td class="remark-col" data-field="remarks">${item.remarks || '-'}</td>
                <td class="image-col" style="text-align:center;padding:0;height:80px;width:100px;cursor:pointer;">
                    ${item.cardImage ? 
                      `<div style="width:100%;height:100%;overflow:hidden;border-radius:4px;" onclick="showImageManager('${item.cardImage.replace(/'/g, "\\'")}', ${originalIndex}); event.stopPropagation();">
                         <img src="${item.cardImage}" style="width:100%;height:100%;object-fit:cover;">
                       </div>`
                      : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:var(--background-color);border:2px dashed var(--border-color);border-radius:4px;" onclick="openEditModalForImageUpload(${originalIndex}); event.stopPropagation();">
                           <mdui-icon name="add_a_photo" style="font-size:36px;color:var(--primary-color);opacity:0.6;"></mdui-icon>
                         </div>`
                    }
                </td>
                <td class="action-col">
                    <mdui-button-icon icon="edit" class="edit-btn" data-index="${originalIndex}"></mdui-button-icon>
                    <mdui-button-icon icon="delete" class="delete-btn" data-index="${originalIndex}"></mdui-button-icon>
                </td>
            `;

            dom.tableBody.appendChild(row);
        });

        // åº”ç”¨æœç´¢é«˜äº®
        applySearchHighlight();

        // ç»‘å®šè¡Œäº‹ä»¶
        bindRowEvents();
    }
}
		/**
		 * æ›´æ–°æœç´¢ç»“æœè®¡æ•°æ˜¾ç¤ºï¼ˆä¿®å¤å ä½ç¬¦æš´éœ²é—®é¢˜ï¼‰
		 */
		function updateSearchResultCount() {
		  const resultCountEl = document.getElementById('searchResultCount');
		  if (!resultCountEl) return; // é˜²DOMå…ƒç´ ä¸å­˜åœ¨
		  
		  const matchCount = searchMatches.length;
		  let countText = `æ‰¾åˆ° ${matchCount} ä¸ªåŒ¹é…é¡¹`;
		  
		  // åªæœ‰å­˜åœ¨åŒ¹é…é¡¹æ—¶ï¼Œæ‰æ˜¾ç¤ºå½“å‰åŒ¹é…ä½ç½®
		  if (matchCount > 0 && currentMatchIndex >= 0) {
		    const currentPos = currentMatchIndex + 1;
		    countText += ` (å½“å‰ ${currentPos}/${matchCount})`;
		  }
		  
		  // å®‰å…¨è®¾ç½®æ–‡æœ¬ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šé¿å…è¯­æ³•å ä½ç¬¦æš´éœ²ï¼‰
		  resultCountEl.textContent = countText;
		}
		// æ–°å¢ï¼šç»Ÿä¸€çš„é«˜äº®å‡½æ•°ï¼Œä¾¿äºåœ¨ç¿»é¡µæˆ–æ›¿æ¢åè°ƒç”¨
		function applySearchHighlight() {
		    const query = dom.searchInput.value.trim().toLowerCase();
		
		    // å¦‚æœæ²¡æœ‰æœç´¢è¯ï¼Œæ¸…é™¤æ‰€æœ‰é«˜äº®å’Œè®¡æ•°
		    if (!query || !isSearchActive) {
		        document.querySelectorAll('.search-match-highlight, .current-match-highlight').forEach(el => {
		            el.classList.remove('search-match-highlight', 'current-match-highlight');
		        });
		        dom.searchResultCount.textContent = '';
		        return;
		    }
		
		    // æ¸…é™¤æ—§é«˜äº®
		    document.querySelectorAll('.search-match-highlight, .current-match-highlight').forEach(el => {
		        el.classList.remove('search-match-highlight', 'current-match-highlight');
		    });
		
		    // é«˜äº®å½“å‰é¡µæ‰€æœ‰åŒ…å«æœç´¢è¯çš„å•å…ƒæ ¼ï¼ˆæ— è®ºæ›¿æ¢é¢æ¿æ˜¯å¦æ‰“å¼€ï¼‰
		    document.querySelectorAll('#dataTable tbody tr').forEach(row => {
		        const rowIndex = parseInt(row.getAttribute('data-index'));
		        searchableFields.forEach(field => {
		            const cell = row.querySelector(`td[data-field="${field}"]`);
		            if (!cell) return;
		            const cellValue = (tableData[rowIndex][field] || '').toString().toLowerCase();
		            if (cellValue.includes(query)) {
		                cell.classList.add('search-match-highlight');
		            }
		        });
		    });
		
		    // æ›´æ–°æœç´¢ç»“æœè®¡æ•°ï¼ˆä»…åœ¨æ›¿æ¢é¢æ¿æ‰“å¼€æ—¶æ˜¾ç¤ºè¯¦ç»†è®¡æ•°ï¼‰
		    if (isSearchReplaceVisible) {
		        if (searchMatches.length === 0) {
		            dom.searchResultCount.textContent = 'æœªæ‰¾åˆ°åŒ¹é…é¡¹';
		        } else {
		            // é˜²æ­¢è¶Šç•Œ
		            if (currentMatchIndex < 0) currentMatchIndex = 0;
		            if (currentMatchIndex >= searchMatches.length) currentMatchIndex = searchMatches.length - 1;
		
		            dom.searchResultCount.textContent = 
		                `æ‰¾åˆ° ${searchMatches.length} ä¸ªåŒ¹é…é¡¹ (å½“å‰ \( {currentMatchIndex + 1}/ \){searchMatches.length})`;
		        }
		    } else {
		        // æ›¿æ¢é¢æ¿å…³é—­æ—¶ï¼Œåªæ˜¾ç¤ºæ‰¾åˆ°å¤šå°‘ä¸ªï¼ˆä¸æ˜¾ç¤ºå½“å‰ç¬¬å‡ ä¸ªï¼‰
		        dom.searchResultCount.textContent = searchMatches.length > 0 
		            ? `æ‰¾åˆ° ${searchMatches.length} ä¸ªåŒ¹é…é¡¹` 
		            : '';
		    }
		
		    // å¦‚æœæœ‰å½“å‰åŒ¹é…é¡¹ï¼Œé«˜äº®è¾¹æ¡†å¹¶æ»šåŠ¨ï¼ˆä»…åœ¨æ›¿æ¢é¢æ¿æ‰“å¼€æ—¶ï¼‰
		    if (isSearchReplaceVisible && currentMatchIndex !== -1 && searchMatches.length > 0) {
		        highlightAndScrollToCurrentMatch();
		    }
		}
		
		// é«˜äº®å½“å‰åŒ¹é…é¡¹å¹¶æ»šåŠ¨
		function highlightAndScrollToCurrentMatch() {
		    // å…ˆæ¸…é™¤æ—§é«˜äº®
		    document.querySelectorAll('.search-match-highlight, .current-match-highlight').forEach(el => {
		        el.classList.remove('search-match-highlight', 'current-match-highlight');
		    });
		
		    const match = searchMatches[currentMatchIndex];
		    const targetRow = document.querySelector(`tbody tr[data-index="${match.rowIndex}"]`);
		    if (!targetRow) return;
		
		    // é«˜äº®è¯¥è¡Œæ‰€æœ‰åŒ¹é…å­—æ®µ
		    searchableFields.forEach(field => {
		        const cell = targetRow.querySelector(`td[data-field="${field}"]`);
		        if (!cell) return;
		        const cellValue = (tableData[match.rowIndex][field] || '').toString().toLowerCase();
		        const query = dom.searchInput.value.trim().toLowerCase();
		        if (query && cellValue.includes(query)) {
		            cell.classList.add('search-match-highlight');
		        }
		    });
		
		    // å½“å‰åŒ¹é…å­—æ®µåŠ è¾¹æ¡†é«˜äº®
		    const currentCell = targetRow.querySelector(`td[data-field="${match.field}"]`);
		    if (currentCell) {
		        currentCell.classList.add('current-match-highlight');
		
		        // å¹³æ»‘æ»šåŠ¨åˆ°å•å…ƒæ ¼
		        const container = document.querySelector('.data-table-container');
		        if (container) {
		            const cellRect = currentCell.getBoundingClientRect();
		            const containerRect = container.getBoundingClientRect();
		
		            const offsetTop = container.scrollTop + cellRect.top - containerRect.top - (containerRect.height / 2) + (cellRect.height / 2);
		            const offsetLeft = container.scrollLeft + cellRect.left - containerRect.left - (containerRect.width / 3);
		
		            container.scrollTo({
		                top: offsetTop,
		                left: Math.max(0, offsetLeft),
		                behavior: 'smooth'
		            });
		        }
		    }
		}
		function startSearch() {
		    const query = dom.searchInput.value.trim();
		    if (!query) {
		        isSearchActive = false;
		        searchMatches = [];
		        currentMatchIndex = -1;
		        applySearchHighlight(); // æ¸…é™¤é«˜äº®
		        dom.replaceOneBtn.disabled = true;
		        dom.replaceAllBtn.disabled = true;
		        return;
		    }
		
		    searchMatches = [];
		    tableData.forEach((item, index) => {
		        searchableFields.forEach(field => {
		            const value = (item[field] || '').toString().toLowerCase();
		            if (value.includes(query.toLowerCase())) {
		                searchMatches.push({
		                    rowIndex: index,
		                    field: field
		                });
		            }
		        });
		    });
		
		    isSearchActive = true;
		    currentMatchIndex = searchMatches.length > 0 ? 0 : -1;
		
		    dom.replaceOneBtn.disabled = searchMatches.length === 0;
		    dom.replaceAllBtn.disabled = searchMatches.length === 0;
		
		    // è·³è½¬åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹ï¼ˆä¼šè‡ªåŠ¨ç¿»é¡µå¹¶æ»šåŠ¨ï¼‰
		    if (searchMatches.length > 0) {
		        jumpToMatch(0);
		    } else {
		        applySearchHighlight();
		    }
		}
		
		function navigateMatch(direction) {
		    if (searchMatches.length === 0) {
		        dom.searchResultCount.textContent = 'æœªæ‰¾åˆ°åŒ¹é…é¡¹';
		        return;
		    }
		
		    // è®¡ç®—æ–°çš„åŒ¹é…ç´¢å¼•ï¼ˆæ”¯æŒå¾ªç¯ï¼‰
		    let newIndex = currentMatchIndex + direction;
		    if (newIndex >= searchMatches.length) newIndex = 0;
		    if (newIndex < 0) newIndex = searchMatches.length - 1;
		
		    // ã€å…³é”®ä¿®å¤ã€‘ç›´æ¥è·³è½¬åˆ°ç›®æ ‡åŒ¹é…é¡¹æ‰€åœ¨é¡µé¢
		    jumpToMatch(newIndex);
		}
		
		function jumpToMatch(matchIndex) {
		    if (matchIndex < 0 || matchIndex >= searchMatches.length) return;
		
		    currentMatchIndex = matchIndex;
		    const match = searchMatches[currentMatchIndex];
		    const targetRowIndex = match.rowIndex; // è¿™æ˜¯å…¨å±€ tableData ä¸­çš„ç´¢å¼•
		
		    // è®¡ç®—ç›®æ ‡é¡µé¢
		    const targetPage = Math.floor(targetRowIndex / PAGE_SIZE) + 1;
		
		    // å¦‚æœä¸åœ¨å½“å‰é¡µï¼Œå…ˆç¿»é¡µ
		    if (currentPage !== targetPage) {
		        currentPage = targetPage;
		        updateTable(); // æ¸²æŸ“æ–°é¡µé¢
		
		        // ç­‰å¾… DOM æ›´æ–°å®Œæˆåé«˜äº®å¹¶æ»šåŠ¨
		        requestAnimationFrame(() => {
		            setTimeout(highlightAndScrollToCurrentMatch, 100);
		        });
		    } else {
		        // åŒé¡µç›´æ¥é«˜äº®æ»šåŠ¨
		        highlightAndScrollToCurrentMatch();
		    }
		
		    // æ›´æ–°è®¡æ•°æ˜¾ç¤º
		    dom.searchResultCount.textContent = 
		        `æ‰¾åˆ° ${searchMatches.length} ä¸ªåŒ¹é…é¡¹ (å½“å‰ \( {currentMatchIndex + 1}/ \){searchMatches.length})`;
		}
		
		function renderPaginationControls(totalFiltered) {
		    // ç§»é™¤æ—§çš„åˆ†é¡µæ§ä»¶
		    const oldPagination = document.getElementById('paginationControls');
		    if (oldPagination) oldPagination.remove();
		
		    if (totalPages <= 1) return;
		
		    const paginationDiv = document.createElement('div');
		    paginationDiv.id = 'paginationControls';
		    paginationDiv.style.cssText = `
		        display: flex; 
		        justify-content: center; 
		        align-items: center; 
		        gap: 8px; 
		        padding: 16px; 
		        background-color: var(--surface-color);
		        
		    `;
		
		    // ==================== ä¸Šä¸€é¡µæŒ‰é’® ====================
		    const prevBtn = document.createElement('mdui-button-icon');
		    prevBtn.icon = 'navigate_before';
		    prevBtn.disabled = currentPage === 1;
		
		    let prevLongPressTimer = null;
		    const LONG_PRESS_DELAY = 500;
		
		    prevBtn.addEventListener('click', (e) => {
		        e.stopPropagation();
		        if (currentPage > 1) {
		            currentPage--;
		            updateTable();
		            scrollToTopSmooth();
		            updatePageInfoDisplay();
		            prevBtn.disabled = currentPage === 1;
		            nextBtn.disabled = currentPage === totalPages;
		        }
		    });
		
		    // é•¿æŒ‰è·³åˆ°ç¬¬ä¸€é¡µ
		    prevBtn.addEventListener('pointerdown', (e) => {
		        if (currentPage === 1) return;
		        prevLongPressTimer = setTimeout(() => {
		            currentPage = 1;
		            updateTable();
		            scrollToTopSmooth();
		            updatePageInfoDisplay();
		            prevBtn.disabled = true;
		            nextBtn.disabled = currentPage === totalPages;
		        }, LONG_PRESS_DELAY);
		    });
		
		    prevBtn.addEventListener('pointerup', () => clearTimeout(prevLongPressTimer));
		    prevBtn.addEventListener('pointercancel', () => clearTimeout(prevLongPressTimer));
		    prevBtn.addEventListener('pointerleave', () => clearTimeout(prevLongPressTimer));
		
		    // ==================== ä¸‹ä¸€é¡µæŒ‰é’® ====================
		    const nextBtn = document.createElement('mdui-button-icon');
		    nextBtn.icon = 'navigate_next';
		    nextBtn.disabled = currentPage === totalPages;
		
		    let nextLongPressTimer = null;
		
		    nextBtn.addEventListener('click', (e) => {
		        e.stopPropagation();
		        if (currentPage < totalPages) {
		            currentPage++;
		            updateTable();
		            scrollToTopSmooth();
		            updatePageInfoDisplay();
		            prevBtn.disabled = currentPage === 1;
		            nextBtn.disabled = currentPage === totalPages;
		        }
		    });
		
		    // é•¿æŒ‰è·³åˆ°æœ€åä¸€é¡µ
		    nextBtn.addEventListener('pointerdown', (e) => {
		        if (currentPage === totalPages) return;
		        nextLongPressTimer = setTimeout(() => {
		            currentPage = totalPages;
		            updateTable();
		            scrollToTopSmooth();
		            updatePageInfoDisplay();
		            nextBtn.disabled = true;
		            prevBtn.disabled = currentPage === 1;
		        }, LONG_PRESS_DELAY);
		    });
		
		    nextBtn.addEventListener('pointerup', () => clearTimeout(nextLongPressTimer));
		    nextBtn.addEventListener('pointercancel', () => clearTimeout(nextLongPressTimer));
		    nextBtn.addEventListener('pointerleave', () => clearTimeout(nextLongPressTimer));
		
		    // ==================== é¡µç æ˜¾ç¤ºä¸è¾“å…¥ ====================
		    const pageInfoContainer = document.createElement('div');
		    pageInfoContainer.style.display = 'flex';
		    pageInfoContainer.style.alignItems = 'center';
		    pageInfoContainer.style.minWidth = '80px';
		    pageInfoContainer.style.justifyContent = 'center';
		
		    const pageInfoText = document.createElement('span');
		    pageInfoText.textContent = `ç¬¬ ${currentPage} / ${totalPages} é¡µ`;
		    pageInfoText.style.fontSize = '0.95rem';
		    pageInfoText.style.color = '#757575';
		    pageInfoText.style.cursor = 'pointer';
		    pageInfoText.style.userSelect = 'none';
		
		    const pageInput = document.createElement('input');
		    pageInput.type = 'number';
		    pageInput.value = currentPage;
		    pageInput.style.width = '60px';
		    pageInput.style.padding = '4px 8px';
		    pageInput.style.fontSize = '0.95rem';
		    pageInput.style.border = '1px solid var(--border-color)';
		    pageInput.style.borderRadius = '4px';
		    pageInput.style.textAlign = 'center';
		    pageInput.style.display = 'none';
		    pageInput.min = 1;
		    pageInput.max = totalPages;
		
		    pageInfoContainer.appendChild(pageInfoText);
		    pageInfoContainer.appendChild(pageInput);
		
		    pageInfoText.addEventListener('click', () => {
		        pageInfoText.style.display = 'none';
		        pageInput.style.display = 'inline-block';
		        pageInput.focus();
		        pageInput.select();
		    });
		
		    function confirmPageJump() {
		        let targetPage = parseInt(pageInput.value);
		        targetPage = Math.max(1, Math.min(totalPages, isNaN(targetPage) ? currentPage : targetPage));
		        if (targetPage !== currentPage) {
		            currentPage = targetPage;
		            updateTable();
		            scrollToTopSmooth();
		        }
		        prevBtn.disabled = currentPage === 1;
		        nextBtn.disabled = currentPage === totalPages;
		        updatePageInfoDisplay();
		    }
		
		    pageInput.addEventListener('keydown', (e) => {
		        if (e.key === 'Enter') {
		            e.preventDefault();
		            confirmPageJump();
		        }
		    });
		
		    pageInput.addEventListener('blur', confirmPageJump);
		
		    function updatePageInfoDisplay() {
		        pageInfoText.textContent = `ç¬¬ ${currentPage} / ${totalPages} é¡µ`;
		        pageInput.value = currentPage;
		        pageInput.max = totalPages;
		        pageInput.style.display = 'none';
		        pageInfoText.style.display = 'inline-block';
		    }
		
		    paginationDiv.appendChild(prevBtn);
		    paginationDiv.appendChild(pageInfoContainer);
		    paginationDiv.appendChild(nextBtn);
		
		    const tableContainerDiv = document.querySelector('.data-table-container-div');
		    tableContainerDiv.parentNode.insertBefore(paginationDiv, tableContainerDiv.nextSibling);
		}
		
		
		function scrollToTopSmooth() {
		    const container = document.querySelector('.data-table-container');
		    if (container) {
		        container.scrollTo({ top: 0, behavior: 'smooth' });
		    }
		}
		
		function bindRowEvents() {
		  document.querySelectorAll('.edit-btn').forEach(btn => {
		    btn.addEventListener('click', (e) => {
		      e.stopPropagation();
		      const index = parseInt(e.currentTarget.getAttribute('data-index'));
		      openEditModal(index);
		    });
		  });
		  
		  document.querySelectorAll('.delete-btn').forEach(btn => {
		    btn.addEventListener('click', (e) => {
		      e.stopPropagation();
		      const index = parseInt(e.currentTarget.getAttribute('data-index'));
		      confirmDeleteRow(index);
		    });
		  });
		  
		  document.querySelectorAll('.row-checkbox').forEach(checkbox => {
		    checkbox.addEventListener('change', (e) => {
		      e.stopPropagation();
		      const index = parseInt(e.target.getAttribute('data-index'));
		      const row = e.target.closest('tr');
		      e.target.checked ? selectedRows.add(index) : selectedRows.delete(index);
		      const filteredData = getFilteredData();
		      dom.selectAllCheckbox.checked = selectedRows.size === filteredData.length && filteredData.length > 0;
		      dom.selectedCount.textContent = selectedRows.size;
		      row.classList.toggle('selected', e.target.checked);
		    });
		  });
		  
		  document.querySelectorAll('.up-btn').forEach(btn => {
		    btn.addEventListener('click', (e) => {
		      e.stopPropagation();
		      moveRow(parseInt(e.currentTarget.getAttribute('data-index')), 'up');
		    });
		  });
		  
		  document.querySelectorAll('.down-btn').forEach(btn => {
		    btn.addEventListener('click', (e) => {
		      e.stopPropagation();
		      moveRow(parseInt(e.currentTarget.getAttribute('data-index')), 'down');
		    });
		  });
		}
		
		function confirmDeleteRow(index) {
		    const itemToDelete = tableData[index];
		    
		    // å¢å¼ºç‰ˆç¡®è®¤æ¶ˆæ¯ï¼šæ˜¾ç¤ºæ›´å¤šå­—æ®µï¼Œå¸ƒå±€æ¸…æ™°ç¾è§‚
		    const message = `
		        <div style="text-align: left; font-size: 1rem; line-height: 1.8;">
		            <div style="margin-bottom: 6px; font-weight: 500;">
		                æ‚¨ç¡®å®šè¦åˆ é™¤ä»¥ä¸‹æ•°æ®å—ï¼Ÿ
		            </div>
		            
		            <div style="padding: 4px; background-color: var(--background-color); border-radius: 8px; border: 1px solid var(--border-color);">
		                <div style="display: grid; grid-template-columns: max-content 1fr; gap: 6px 10px; align-items: center;">
		                    <strong style="color: #757575;">äº§å“å·ï¼š</strong>
		                    <strong style="color: var(--primary-color); font-size: 1.1em; word-break: break-all;">
		                        ${itemToDelete.productId || 'N/A'}
		                    </strong>
		
		                    <strong style="color: #757575;">é’¢ç§ï¼š</strong>
		                    <span>${itemToDelete.steelType || 'N/A'}</span>
		
		                    <strong style="color: #757575;">å¡ç‰‡å·ï¼š</strong>
		                    <span>${itemToDelete.cardId || 'N/A'}</span>
		
		                    <strong style="color: #757575;">ç‚‰å·ï¼š</strong>
		                    <span>${itemToDelete.furnaceId || 'N/A'}</span>
		
		                    <strong style="color: #757575;">å®é™…ç›´å¾„ï¼š</strong>
		                    <span>${itemToDelete.actualDiameter || 'N/A'}</span>
		
		                    <strong style="color: #757575;">ç›´å¾„ï¼š</strong>
		                    <span>${itemToDelete.diameter || 'N/A'}</span>
		
		                    <strong style="color: #757575;">é•¿åº¦ï¼š</strong>
		                    <span>${itemToDelete.length || 'N/A'} mm</span>
		
		                    <strong style="color: #757575;">é‡é‡ï¼š</strong>
		                    <span style="font-weight: 600;">${itemToDelete.weight || 'N/A'} Kg</span>
		
		                    <strong style="color: #757575;">çŠ¶æ€ï¼š</strong>
		                    <span>${itemToDelete.status || 'N/A'}</span>
		
		                    <strong style="color: #757575;">ä½ç½®ï¼š</strong>
		                    <span>${itemToDelete.position || 'N/A'}</span>
		
		                    <strong style="color: #757575;">ç¡¬åº¦ï¼š</strong>
		                    <span>${itemToDelete.hardness || 'N/A'}</span>
		
		                    ${itemToDelete.remarks ? 
		                        `<strong style="color: #757575; grid-column: 1;">å¤‡æ³¨ï¼š</strong>
		                         <span style="grid-column: 2; word-break: break-all; color: #e91e63;">${itemToDelete.remarks}</span>` 
		                        : ''
		                    }
		                </div>
		            </div>
		        </div>
		    `;
		
		    dom.confirmMessage.innerHTML = message;
		    openCustomModal(dom.confirmModal); 
		    
		    dom.confirmActionBtn.onclick = () => {
		        tableData.splice(index, 1);
		        selectedRows.clear();
		        saveDataToIndexedDB();
		        updateTable();
		        closeCustomModal(dom.confirmModal); 
		        dom.confirmActionBtn.onclick = null;
		        showSnackbar('æ•°æ®å·²åˆ é™¤', 'success');
		    };
		}
		
		function moveRow(index, direction) {
		  if (direction === 'up' && index > 0) {
		    [tableData[index - 1], tableData[index]] = [tableData[index], tableData[index - 1]];
		  } else if (direction === 'down' && index < tableData.length - 1) {
		    [tableData[index], tableData[index + 1]] = [tableData[index + 1], tableData[index]];
		  }
		  saveDataToIndexedDB();
		  updateTable();
		}
		
		function confirmDeleteSelected() {
		    if (selectedRows.size > 0) {
		      dom.confirmMessage.innerHTML = `æ‚¨ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ <strong style="color: #f44336;">${selectedRows.size}</strong> æ¡æ•°æ®å—ï¼Ÿ`;
		      openCustomModal(dom.confirmModal); 
		      dom.confirmActionBtn.onclick = () => {
		        deleteSelected();
		        closeCustomModal(dom.confirmModal); 
		        dom.confirmActionBtn.onclick = null;
		      };
		    }
		}
		
		function deleteSelected() {
		  const sortedIndexes = Array.from(selectedRows).sort((a, b) => b - a);
		  sortedIndexes.forEach(index => tableData.splice(index, 1));
		  const deletedCount = sortedIndexes.length;
		  selectedRows.clear();
		  dom.selectAllCheckbox.checked = false;
		  saveDataToIndexedDB();
		  updateTable();
		  showSnackbar(`æˆåŠŸåˆ é™¤ ${deletedCount} æ¡æ•°æ®`, 'success');
		}
		
		function openAddModal() {
		  openAddModalWithData({});
		}
		
	function openAddModalWithData(preFilledData) {
    if (dom.dataForm) dom.dataForm.reset();
    if (dom.modalTitle) dom.modalTitle.textContent = 'æ·»åŠ æ•°æ®';
    if (dom.editIndex) dom.editIndex.value = '-1';

    currentEditIndex = -1;

    for (const key in preFilledData) {
        if (preFilledData.hasOwnProperty(key) && formElements[key]) {
            formElements[key].value = preFilledData[key];
        }
    }

    openCustomModal(dom.dataSheet);

setTimeout(() => {
    const previewContainer = document.getElementById('cardImagePreview');
    const noImageArea = document.getElementById('noImageUploadArea');

    previewContainer.style.display = 'none';
    noImageArea.style.display = 'block'; // æ–°å¢æ—¶æ˜¾ç¤ºä¸Šä¼ æŒ‰é’®

        // é”®ç›˜é€»è¾‘
        let inputToFocus = formElements.steelType;
        inputFields.forEach(field => {
            if (field.id !== 'remarks') {
                field.setAttribute('readonly', 'true');
                field.classList.add('readonly-input');
            }
            if (field.id === 'steelType') inputToFocus = field;
        });

        currentInput = inputToFocus;
        if (currentInput.id !== 'remarks') {
            updateKeyboardForInput(currentInput);
            showVirtualKeyboard();
        }
        currentInput.focus();
    }, 350);
}
		
		function findDuplicates(newItem) {
		  const duplicates = [];
		  tableData.forEach((existingItem, index) => {
		    if (newItem.productId && newItem.productId.trim() !== '' && newItem.productId === existingItem.productId) {
		      duplicates.push({ 
		        index, 
		        reason: 'äº§å“å·é‡å¤', 
		        existingItem: existingItem,
		        newItem: newItem,
		        productId: newItem.productId,
		        differences: getObjectDifferences(existingItem, newItem)
		      });
		    }
		  });
		  return duplicates;
		}
		
		function highlightAndScrollToRow(index) {
		  setTimeout(() => {
		    const row = document.querySelector(`tbody tr[data-index="${index}"]`);
		    if (row) {
		      document.querySelectorAll('#dataTable .highlight').forEach(r => r.classList.remove('highlight'));
		      row.classList.add('highlight');
		      setTimeout(() => row.classList.remove('highlight'), 2000);
		      const container = document.querySelector('.data-table-container');
		      if (container) {
		          const rowRect = row.getBoundingClientRect();
		          const containerRect = container.getBoundingClientRect();
		          const scrollTop = container.scrollTop;
		          const offset = rowRect.top - containerRect.top + scrollTop - (containerRect.height / 2) + (rowRect.height / 2);
		          container.scrollTo({ top: offset, behavior: 'smooth' });
		      } else {
		        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
		      }
		    }
		  }, 100);
		}
		
		
		
		function openQuickEdit(index, fieldId) {
		    const item = tableData[index];
		    const fieldName = fieldLabels[fieldId] || fieldId;
		    
		    dom.quickEditLabel.textContent = fieldName;
		    dom.quickEditInput.value = item[fieldId] || '';
		    dom.quickEditIndex.value = index;
		    dom.quickEditField.value = fieldId;
		    
		    dom.quickEditInput.setAttribute('readonly', 'true');
		    dom.quickEditInput.classList.add('readonly-input');
		    
		    openCustomModal(dom.quickEditDialog);
		    
		    currentInput = dom.quickEditInput;
		    
		    // å…³é”®ï¼šæ ‡è®°å½“å‰æ˜¯å¿«é€Ÿç¼–è¾‘å•å­—æ®µæ¨¡å¼
		    keyboardState.isQuickEdit = true;
		    saveKeyboardState();
		    
		    updateKeyboardForInput(currentInput, fieldId); 
		    showVirtualKeyboard();
		    
		    currentInput.focus();
		}
		function saveQuickEdit() {
		    const index = parseInt(dom.quickEditIndex.value);
		    const fieldId = dom.quickEditField.value;
		    const newValue = dom.quickEditInput.value.trim();
		    
		    if (index >= 0 && index < tableData.length) {
		        if (['actualDiameter', 'diameter', 'length', 'weight', 'hardness'].includes(fieldId) && isNaN(parseFloat(newValue)) && newValue.length > 0) {
		            showSnackbar('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—æˆ–ç•™ç©º', 'error');
		            return;
		        }
		        
		        tableData[index][fieldId] = newValue;
		        saveDataToIndexedDB();
		        updateTable();
		        closeCustomModal(dom.quickEditDialog);
		        dom.virtualKeyboard.style.display = 'none';
		        showSnackbar('å¿«é€Ÿä¿®æ”¹å·²ä¿å­˜', 'success');
		        
		        
		keyboardState.isQuickEdit = false;
		saveKeyboardState();
		    }
		}
		
		// ==================== æœç´¢ä¸æ›¿æ¢ä¼˜åŒ–ç‰ˆï¼ˆæ”¯æŒè‡ªåŠ¨ç¿»é¡µè·³è½¬ï¼‰===================
		
		
		function startSearch() {
		    const query = dom.searchInput.value.trim();
		
		    // æ¸…ç©ºæœç´¢çŠ¶æ€
		    searchMatches = [];
		    currentMatchIndex = -1;
		
		    if (!query) {
		        isSearchActive = false;
		        applySearchHighlight(); // æ¸…é™¤é«˜äº®
		        dom.replaceOneBtn.disabled = true;
		        dom.replaceAllBtn.disabled = true;
		        return;
		    }
		
		    // é‡æ–°æ„å»ºæ‰€æœ‰åŒ¹é…é¡¹ï¼ˆå…¨å±€ï¼‰
		    tableData.forEach((item, index) => {
		        searchableFields.forEach(field => {
		            const value = (item[field] || '').toString().toLowerCase();
		            if (value.includes(query.toLowerCase())) {
		                searchMatches.push({
		                    rowIndex: index,
		                    field: field
		                });
		            }
		        });
		    });
		
		    isSearchActive = true;
		
		    // æ›´æ–°æ›¿æ¢æŒ‰é’®çŠ¶æ€
		    const hasMatches = searchMatches.length > 0;
		    dom.replaceOneBtn.disabled = !hasMatches;
		    dom.replaceAllBtn.disabled = !hasMatches;
		
		    if (hasMatches) {
		        currentMatchIndex = 0;
		        jumpToMatch(0); // ã€å…³é”®ã€‘è‡ªåŠ¨è·³è½¬åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹ï¼ˆä¼šç¿»é¡µ + æ»šåŠ¨ï¼‰
		    } else {
		        applySearchHighlight(); // æ˜¾ç¤ºâ€œæœªæ‰¾åˆ°åŒ¹é…é¡¹â€
		    }
		}
		
		function openEditModal(index, targetFieldId = null) {
    currentEditIndex = index;
    if (dom.editIndex) dom.editIndex.value = index;

    const item = tableData[index];

    // å¡«å……è¡¨å•å­—æ®µ
    for (const key in formElements) {
        if (formElements.hasOwnProperty(key)) {
            formElements[key].value = item[key] || '';
        }
    }

    dom.modalTitle.textContent = 'ç¼–è¾‘æ•°æ®';
    openCustomModal(dom.dataSheet);

   setTimeout(() => {
    const previewContainer = document.getElementById('cardImagePreview');
    const noImageArea = document.getElementById('noImageUploadArea');
    const previewImg = document.getElementById('previewImg');

    if (item.cardImage && item.cardImage.startsWith('data:image/')) {
        previewImg.src = item.cardImage;
        previewContainer.style.display = 'block';
        noImageArea.style.display = 'none';  // éšè—ä¸Šä¼ æŒ‰é’®
    } else {
        previewContainer.style.display = 'none';
        noImageArea.style.display = 'block'; // æ˜¾ç¤ºä¸Šä¼ æŒ‰é’®
    }


        // è¾“å…¥æ¡†å’Œé”®ç›˜é€»è¾‘
        let inputToFocus = formElements.steelType;

        inputFields.forEach(field => {
            if (field.id !== 'remarks') {
                field.setAttribute('readonly', 'true');
                field.classList.add('readonly-input');
            } else {
                field.removeAttribute('readonly');
                field.classList.remove('readonly-input');
            }
            if (field.id === 'steelType') inputToFocus = field;
        });

        if (targetFieldId && formElements[targetFieldId]) {
            inputToFocus = formElements[targetFieldId];
        }

        currentInput = inputToFocus;

        if (currentInput.id === 'remarks') {
            dom.virtualKeyboard.style.display = 'none';
        } else {
            currentInput.setAttribute('readonly', 'true');
            currentInput.classList.add('readonly-input');
            updateKeyboardForInput(currentInput);
            showVirtualKeyboard();
        }

        currentInput.focus();

        // å¹³æ»‘æ»šåŠ¨åˆ°å½“å‰è¾“å…¥æ¡†
        const modalContent = document.getElementById('dataSheetContent');
        if (modalContent) {
            const inputRect = currentInput.getBoundingClientRect();
            const modalRect = modalContent.getBoundingClientRect();
            const offset = inputRect.top - modalRect.top + modalContent.scrollTop - modalRect.height * 0.3;
            modalContent.scrollTo({ top: offset, behavior: 'smooth' });
        }
    }, 350);
}
		
		function navigateMatch(direction) {
		    if (searchMatches.length === 0) return;
		
		    currentMatchIndex += direction;
		    if (currentMatchIndex >= searchMatches.length) currentMatchIndex = 0;
		    if (currentMatchIndex < 0) currentMatchIndex = searchMatches.length - 1;
		
		    updateCurrentMatchUI();
		}
		
		function updateCurrentMatchUI() {
		    // æ›´æ–°è®¡æ•°æ˜¾ç¤º
		
		dom.searchResultCount.textContent = searchMatches.length === 0 
		    ? `æ‰¾åˆ° 0 ä¸ªåŒ¹é…é¡¹` 
		    : `æ‰¾åˆ° ${searchMatches.length} ä¸ªåŒ¹é…é¡¹ (å½“å‰ ${currentMatchIndex + 1}/${searchMatches.length})`;
			
		    // å…ˆæ¸…é™¤æ‰€æœ‰æ—§é«˜äº®
		    document.querySelectorAll('.search-match-highlight').forEach(el => 
		        el.classList.remove('search-match-highlight'));
		    document.querySelectorAll('.current-match-highlight').forEach(el => 
		        el.classList.remove('current-match-highlight'));
		
		    if (searchMatches.length === 0) return;
		
		    const match = searchMatches[currentMatchIndex];
		    const rowIndex = match.rowIndex;
		
		    // === å…³é”®ï¼šè‡ªåŠ¨ç¿»åˆ°åŒ…å«è¯¥è¡Œçš„é¡µé¢ ===
		    const filteredData = getFilteredData();
		    const displayIndex = filteredData.indexOf(tableData[rowIndex]);
		    if (displayIndex !== -1) {
		        const targetPage = Math.floor(displayIndex / PAGE_SIZE) + 1;
		        if (currentPage !== targetPage) {
		            currentPage = targetPage;
		            updateTable(); // å…ˆç¿»é¡µæ¸²æŸ“
		            setTimeout(highlightCurrentMatchCell, 150); // ç­‰å¾… DOM æ›´æ–°åé«˜äº®
		        } else {
		            highlightCurrentMatchCell();
		        }
		    } else {
		        highlightCurrentMatchCell();
		    }
		}
		
		function highlightCurrentMatchCell() {
		    const match = searchMatches[currentMatchIndex];
		    const row = document.querySelector(`tbody tr[data-index="${match.rowIndex}"]`);
		    if (!row) return;
		
		    // é«˜äº®è¯¥è¡Œæ‰€æœ‰åŒ…å«æœç´¢è¯çš„å•å…ƒæ ¼
		    searchableFields.forEach(field => {
		        const cell = row.querySelector(`td[data-field="${field}"]`);
		        if (cell) {
		            const query = dom.searchInput.value.trim().toLowerCase();
		            const cellValue = (tableData[match.rowIndex][field] || '').toString().toLowerCase();
		            if (query && cellValue.includes(query)) {
		                cell.classList.add('search-match-highlight');
		            }
		        }
		    });
		
		    // å½“å‰åŒ¹é…å­—æ®µåŠ ç²—è¾¹æ¡†é«˜äº®
		    const currentCell = row.querySelector(`td[data-field="${match.field}"]`);
		    if (currentCell) {
		        currentCell.classList.add('current-match-highlight');
		        
		        // å¹³æ»‘æ»šåŠ¨åˆ°å½“å‰å•å…ƒæ ¼
		        const container = document.querySelector('.data-table-container');
		        if (container) {
		            const cellRect = currentCell.getBoundingClientRect();
		            const containerRect = container.getBoundingClientRect();
		            const offset = container.scrollTop + cellRect.top - containerRect.top - (containerRect.height / 2) + (cellRect.height / 2);
		            container.scrollTo({ top: offset, behavior: 'smooth' });
		        }
		    }
		}
		
		function replaceOne() {
		    if (currentMatchIndex === -1 || searchMatches.length === 0) {
		        showSnackbar('æ²¡æœ‰é€‰ä¸­çš„åŒ¹é…é¡¹å¯æ›¿æ¢', 'warning');
		        return;
		    }
		
		    const match = searchMatches[currentMatchIndex];
		    const newText = dom.replaceQueryInput.value.trim();
		    const oldText = dom.searchInput.value.trim();
		
		    if (!oldText) {
		        showSnackbar('æœç´¢è¯ä¸èƒ½ä¸ºç©º', 'warning');
		        return;
		    }
		
		    const rowIndex = match.rowIndex;
		    const fieldId = match.field;
		    const originalValue = tableData[rowIndex][fieldId] || '';
		
		    const regex = new RegExp(escapeRegExp(oldText), 'gi');
		    const newValue = originalValue.replace(regex, newText);
		
		    if (newValue !== originalValue) {
		        tableData[rowIndex][fieldId] = newValue;
		        saveDataToIndexedDB();
		        showSnackbar(`å·²æ›¿æ¢å½“å‰åŒ¹é…é¡¹`, 'success');
		    } else {
		        showSnackbar('å½“å‰åŒ¹é…é¡¹æ— éœ€æ›¿æ¢', 'info');
		    }
		
		    // ã€å…³é”®ä¿®å¤ã€‘æ›¿æ¢åç«‹å³åˆ·æ–°è¡¨æ ¼ + é‡æ–°æœç´¢ä¿æŒé«˜äº®å’Œå½“å‰ä½ç½®
		    updateTable();
		    startSearch();  // é‡æ–°è®¡ç®—åŒ¹é…é¡¹å¹¶å°½é‡ä¿æŒåœ¨ä¸‹ä¸€ä¸ª
		    
		}
		
		function confirmReplaceAll() {
		    const oldText = dom.searchInput.value.trim();
		    const newText = dom.replaceQueryInput.value.trim();
		
		    if (!oldText) {
		        showSnackbar('æœç´¢è¯ä¸èƒ½ä¸ºç©º', 'warning');
		        return;
		    }
		
		    if (searchMatches.length === 0) {
		        showSnackbar('æ²¡æœ‰åŒ¹é…é¡¹å¯æ›¿æ¢', 'warning');
		        return;
		    }
		
		    dom.confirmMessage.innerHTML = `
		        <div style="text-align:center;">
		            <p>ç¡®å®šå°†æ‰€æœ‰ <strong style="color:var(--primary-color);">${escapeHtml(oldText)}</strong> 
		               æ›¿æ¢ä¸º <strong style="color:#f44336;">${escapeHtml(newText || '(ç©º)')}</strong> å—ï¼Ÿ</p>
		            <p style="margin-top:12px;color:#757575;">å…±å°†å½±å“ ${searchMatches.length} å¤„</p>
		        </div>
		    `;
		
		    openCustomModal(dom.confirmModal);
		
		    dom.confirmActionBtn.onclick = () => {
		        let replaceCount = 0;
		        const regex = new RegExp(escapeRegExp(oldText), 'gi');
		
		        tableData.forEach(item => {
		            searchableFields.forEach(field => {
		                const val = (item[field] || '').toString();
		                if (val.toLowerCase().includes(oldText.toLowerCase())) {
		                    const newVal = val.replace(regex, newText);
		                    if (newVal !== val) {
		                        item[field] = newVal;
		                        replaceCount++;
		                    }
		                }
		            });
		        });
		
		        saveDataToIndexedDB();
		
		        if (replaceCount > 0) {
		            showSnackbar(`æˆåŠŸæ›¿æ¢ ${replaceCount} å¤„ï¼`, 'success');
		        } else {
		            showSnackbar('æ²¡æœ‰å‘ç”Ÿå®é™…æ›¿æ¢', 'info');
		        }
		
		        // ã€å…³é”®ä¿®å¤ã€‘æ›¿æ¢å…¨éƒ¨ååˆ·æ–°è¡¨æ ¼ + å…³é—­æœç´¢é¢æ¿ + æ¸…ç©ºæœç´¢è¯
		    updateTable();
		    dom.searchInput.value = '';
		    dom.replaceQueryInput.value = '';
		    searchTerm = '';
		    isSearchActive = false;
		    searchMatches = [];
		    currentMatchIndex = -1;
		    toggleSearchReplaceVisibility();
		
		        closeCustomModal(dom.confirmModal);
		        dom.confirmActionBtn.onclick = null;
		    };
		}
		
		// è¾…åŠ©å‡½æ•°ï¼šHTMLè½¬ä¹‰å’Œæ­£åˆ™è½¬ä¹‰
		function escapeRegExp(string) {
		    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
		}
		
		function escapeHtml(text) {
		    const div = document.createElement('div');
		    div.textContent = text;
		    return div.innerHTML;
		}
		function replaceAll() {
		    const oldText = dom.searchInput.value.trim();
		    const newText = dom.replaceQueryInput.value;
		
		    if (!oldText) return;
		
		    let replaceCount = 0;
		    const regex = new RegExp(escapeRegExp(oldText), 'gi');
		
		    tableData.forEach(item => {
		        searchableFields.forEach(field => {
		            const originalValue = (item[field] || '').toString();
		            if (originalValue.toLowerCase().includes(oldText.toLowerCase())) {
		                const newValue = originalValue.replace(regex, newText);
		                if (newValue !== originalValue) {
		                    item[field] = newValue;
		                    replaceCount++;
		                }
		            }
		        });
		    });
		
		    if (replaceCount > 0) {
		        saveDataToIndexedDB();
		        showSnackbar(`æˆåŠŸæ›¿æ¢ ${replaceCount} å¤„åŒ¹é…é¡¹ï¼`, 'success');
		    } else {
		        showSnackbar('æ²¡æœ‰åŒ¹é…é¡¹è¢«æ›¿æ¢', 'warning');
		    }
		
		    // æ›¿æ¢å®Œæˆåè‡ªåŠ¨å…³é—­æ›¿æ¢é¢æ¿å¹¶æ¸…é™¤æœç´¢
		    isSearchActive = false;
		    searchMatches = [];
		    currentMatchIndex = -1;
		    updateTable();
		    toggleSearchReplaceVisibility(); // å…³é—­æ›¿æ¢åŒºåŸŸ
		}
		
		
		function closeVirtualKeyboardAndKeepReadOnly() {
		    dom.virtualKeyboard.style.display = 'none';
		    currentInput = null;
		}
		
		/* ==================== è™šæ‹Ÿé”®ç›˜æ ¸å¿ƒé€»è¾‘ ==================== */
		
		function saveKeyboardState() {
		  localStorage.setItem('keyboardState', JSON.stringify(keyboardState));
		}
		
		function toggleShift() {
		  switch (keyboardState.shiftState) {
		    case 'locked-on':   
		      keyboardState.shiftState = 'off';
		      break;
		    case 'off':         
		      keyboardState.shiftState = 'on';
		      break;
		    case 'on':          
		      keyboardState.shiftState = 'locked-on';
		      break;
		  }
		  saveKeyboardState();
		  generateVirtualKeyboard();
		}
		
		function createShortcutKeys(options, keyClass) {
		  const shortcutRow = document.createElement('div');
		  shortcutRow.className = 'keyboard-row';
		  
		  options.forEach(option => {
		    const keyElement = document.createElement('div');
		    keyElement.className = `keyboard-key ${keyClass}`;
		    keyElement.textContent = option;
		    keyElement.addEventListener('click', () => {
		      if (currentInput) {
		        insertText(option);
		        currentInput.focus();
		      }
		    });
		    shortcutRow.appendChild(keyElement);
		  });
		  
		  dom.shortcutContainer.appendChild(shortcutRow);
		}
		
		function generateVirtualKeyboard() {
		  dom.shortcutContainer.innerHTML = '';
		  dom.keyboardRows.innerHTML = '';
		
		  const isUpperCase = keyboardState.shiftState === 'locked-on' || keyboardState.shiftState === 'on';
		  let keyRows = [];
		
		  switch(keyboardState.inputType) {
		    case 'number':
		    case 'numeric-input':
		      keyRows = [
		        ['%', '1', '2', '3','+', 'clear'],
		        [':', '4', '5', '6', '-', 'backspace'],
		        ['#', '7', '8', '9','*', 'esc'], 
		        ['_', '.', '0', '/','ã€', 'done'] 
		      ];
		      break;
		      
		    case 'status':
		      createShortcutKeys(statusOptions, 'status-key');
		      keyRows = [['clear', 'backspace', 'esc', 'done']];
		      break;
		      
		    case 'cardId':
		      createShortcutKeys(cardIdOptions, 'shortcut-key');
		    case 'steelType':
		      if (keyboardState.inputType === 'steelType') createShortcutKeys(steelTypeOptions, 'shortcut-key');
		    case 'productId':
		      if (keyboardState.inputType === 'productId') createShortcutKeys(['TH','TH5','TH6'], 'shortcut-key'); 
		    case 'furnaceId':
		if (keyboardState.inputType === 'furnaceId') {
		    const year = new Date().getFullYear().toString().slice(2);
		    const lastyear = (parseInt(year) - 1).toString().slice(-2);
		    // ä¿®æ­£ï¼šç§»é™¤å¤šä½™åæ–œæ ï¼Œä½¿ç”¨ ${å˜é‡} æ­£ç¡®æ’å€¼
		    const furnaceShortcuts = [
		        `VD${year}/`,       
		        `VD${lastyear}/`,   
		        `${year}1`,          
		        `1${year}1`,
		        `${lastyear}1`,
		        `1${lastyear}1`
		    ];
		    createShortcutKeys(furnaceShortcuts, 'shortcut-key');
		}
		    case 'text':
		    default:
		      const lettersRow1 = isUpperCase ? ['Q','W','E','R','T','Y','U','I','O','P'] : ['q','w','e','r','t','y','u','i','o','p'];
		      const lettersRow2 = isUpperCase ? ['A','S','D','F','G','H','J','K','L'] : ['a','s','d','f','g','h','j','k','l'];
		      const lettersRow3 = isUpperCase ? ['Z','X','C','V','B','N','M'] : ['z','x','c','v','b','n','m'];
		      keyRows = [
		        ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'],
		        [...lettersRow1],
		        ['', ...lettersRow2, '+','-'],
		        ['shift', ...lettersRow3, 'backspace'],
		        ['symbol',',','space', '.', 'clear','done']
		      ];
		      break;
		      
		    case 'position':
		      createShortcutKeys(positionOptions, 'shortcut-key');
		      keyRows = [
		        ['%', '1', '2', '3', 'A'],
		        ['/', '4', '5', '6', 'B'],
		        ['+', '7', '8', '9', 'C'],
		        ['*', '/','0', '-','D'],
		        ['clear', 'backspace','esc','done'] 
		      ];
		      break;
		      
		    case 'symbol':
		      keyRows = [
		        ['~', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')'],
		        ['_', '+', '=', '|', '\\', ':', '"', '<', '>', '?', ','],
		        ['`', '}', '[', ']', '{', '(', ')', '.', '/', ''],
		        ['ABC', 'space', 'backspace','clear', 'done'] 
		      ];
		      break;
		  }
		
		  keyRows.forEach(row => {
		    const rowElement = document.createElement('div');
		    rowElement.className = 'keyboard-row';
		    row.forEach(key => {
		      if (key !== undefined) rowElement.appendChild(createKeyElement(key));
		    });
		    dom.keyboardRows.appendChild(rowElement);
		  });
		}
		
		function createKeyElement(key) {
		  const keyElement = document.createElement('div');
		  keyElement.className = 'keyboard-key';
		
		  // é¦–å…ˆå¤„ç†ç©ºå ä½é”®
		  if (key === '') {
		    keyElement.classList.add('empty');
		    return keyElement;
		  }
		
		  // ç‰¹æ®ŠåŠŸèƒ½é”® - å¿…é¡»å°½æ—©å¤„ç†å¹¶ returnï¼Œé¿å…è¿›å…¥é€šç”¨é€»è¾‘
		  if (key === 'shift') {
		    keyElement.className += ' special wide';
		    keyElement.innerHTML = keyboardState.shiftState === 'locked-on' ? 'â‡ª' : 'â‡§';
		    keyElement.addEventListener('click', toggleShift);
		    return keyElement;
		  }
		
		  if (key === 'backspace') {
		    keyElement.className += ' special wide';
		    keyElement.innerHTML = 'â†';
		
		    let deleteInterval = null;
		    const DELETE_DELAY = 500;
		    const DELETE_SPEED = 80;
		
		    keyElement.addEventListener('pointerdown', (e) => {
		      e.preventDefault();
		      handleBackspace();
		
		      deleteInterval = setTimeout(() => {
		        deleteInterval = setInterval(handleBackspace, DELETE_SPEED);
		      }, DELETE_DELAY);
		    });
		
		    const stopDeleting = () => {
		      clearTimeout(deleteInterval);
		      clearInterval(deleteInterval);
		      deleteInterval = null;
		    };
		
		    keyElement.addEventListener('pointerup', stopDeleting);
		    keyElement.addEventListener('pointercancel', stopDeleting);
		    keyElement.addEventListener('pointerleave', stopDeleting);
		    keyElement.addEventListener('click', (e) => e.preventDefault());
		
		    return keyElement;
		  }
		
		  if (key === 'space') {
		    keyElement.className += ' special extra-wide';
		    keyElement.textContent = '';
		    keyElement.addEventListener('click', () => insertText(' '));
		    return keyElement;
		  }
		
		  if (key === 'esc') {
		    keyElement.className += ' system-keyboard wide';
		    keyElement.textContent = 'âœ”';  // æ­£ç¡®æ˜¾ç¤ºå¯¹å‹¾
		    keyElement.addEventListener('click', closeVirtualKeyboardAndKeepReadOnly);
		    return keyElement;  // å¿…é¡» returnï¼
		  }
		if(key === 'done') {
		    keyElement.className += ' special wide';
		    keyElement.style.position = 'relative';
		
		    // å¿«é€Ÿç¼–è¾‘æ¨¡å¼ä¸‹ï¼šæ˜¾ç¤ºâ€œå®Œæˆâ€ï¼Œç‚¹å‡»ç›´æ¥å…³é—­é”®ç›˜
		    if (keyboardState.isQuickEdit) {
		        keyElement.textContent = 'âœ”'; 
		    } else {
		        keyElement.textContent = 'â–¼';
		    }
		
		    let longPressTimer = null;
		    const LONG_PRESS_DURATION = 600;
		
		    keyElement.addEventListener('pointerdown', (e) => {
		        e.preventDefault();
		
		        // é•¿æŒ‰ä»ä¿ç•™å…³é—­åŠŸèƒ½ï¼ˆå¤‡ç”¨ï¼‰
		        longPressTimer = setTimeout(() => {
		            closeVirtualKeyboardAndKeepReadOnly();
		            showSnackbar('é”®ç›˜å·²å…³é—­ï¼ˆé•¿æŒ‰å®Œæˆï¼‰', 'success');
		        }, 300);
		    });
		
		    keyElement.addEventListener('pointerup', (e) => {
		        if (longPressTimer) {
		            clearTimeout(longPressTimer);
		            longPressTimer = null;
		
		            if (keyboardState.isQuickEdit) {
		                // å¿«é€Ÿç¼–è¾‘ï¼šçŸ­æŒ‰ = å…³é—­é”®ç›˜ï¼ˆä¸è·³è½¬ï¼‰
		                closeVirtualKeyboardAndKeepReadOnly();
		            } else {
		                // å®Œæ•´ç¼–è¾‘ï¼šçŸ­æŒ‰ = è·³è½¬ä¸‹ä¸€ä¸ª
		                handleNextInput();
		            }
		        }
		    });
		
		    keyElement.addEventListener('pointercancel', () => {
		        if (longPressTimer) clearTimeout(longPressTimer);
		    });
		
		    keyElement.addEventListener('pointerleave', () => {
		        if (longPressTimer) clearTimeout(longPressTimer);
		    });
		
		    keyElement.addEventListener('click', (e) => {
		        e.preventDefault();
		        e.stopPropagation();
		    });
		
		    return keyElement;
		}
		
		  if (key === 'clear') {
		    keyElement.className += ' clear-key wide';
		    keyElement.textContent = 'â†âœ˜';
		    keyElement.addEventListener('click', clearInput);
		    return keyElement;
		  }
		
		  if (key === 'symbol') {
		    keyElement.className += ' special wide';
		    keyElement.textContent = 'ç¬¦';
		    keyElement.addEventListener('click', () => {
		      keyboardState.inputType = 'symbol';
		      saveKeyboardState();
		      generateVirtualKeyboard();
		    });
		    return keyElement;
		  }
		
		  if (key === 'ABC') {
		    keyElement.className += ' special wide';
		    keyElement.textContent = 'ABC';
		    keyElement.addEventListener('click', () => {
		      keyboardState.inputType = 'text';
		      saveKeyboardState();
		      generateVirtualKeyboard();
		    });
		    return keyElement;
		  }
		
		  // æ™®é€šå­—ç¬¦é”®ï¼ˆæœ€åå¤„ç†ï¼‰
		  keyElement.textContent = key;
		  keyElement.addEventListener('click', () => {
		    insertText(key);
		    if (keyboardState.shiftState === 'on') {
		      keyboardState.shiftState = 'off';
		      saveKeyboardState();
		      generateVirtualKeyboard();
		    }
		  });
		
		  return keyElement;
		}
		
		function handleNextInput() {
		  if (!currentInput) {
		    dom.virtualKeyboard.style.display = 'none';
		    return;
		  }
		  
		  const currentId = currentInput.id;
		  const isCalcInput = currentInput.closest('#calculatorForm');
		  const isQuickEditInput = currentId === 'quickEditInput';
		  
		  if (isQuickEditInput) {
		      saveQuickEdit(); 
		      dom.virtualKeyboard.style.display = 'none';
		      return;
		  }
		  
		  let nextInput = null;
		  if (isCalcInput) {
		      const calcInputs = [dom.calcDiameter1, dom.calcDiameter2, dom.calcLength];
		      const currentIndex = calcInputs.indexOf(currentInput);
		      const nextIndex = currentIndex === calcInputs.length - 1 ? 0 : currentIndex + 1;
		      nextInput = calcInputs[nextIndex];
		  } else {
		      const currentIndex = inputFieldOrder.indexOf(currentId);
		      const nextIndex = currentIndex === inputFieldOrder.length - 1 ? 0 : currentIndex + 1;
		      nextInput = formElements[inputFieldOrder[nextIndex]];
		  }
		  
		  if (!nextInput) {
		      dom.virtualKeyboard.style.display = 'none';
		      return;
		  }
		  
		  currentInput = nextInput;
		  
		  if (currentInput.id === 'remarks' && !isCalcInput) {
		    currentInput.removeAttribute('readonly');
		    currentInput.classList.remove('readonly-input');
		    dom.virtualKeyboard.style.display = 'none';
		  } else {
		    currentInput.setAttribute('readonly', 'true');
		    currentInput.classList.add('readonly-input');
		    updateKeyboardForInput(currentInput);
		    showVirtualKeyboard();
		  }
		
		  currentInput.focus();
		  const modalContent = currentInput.closest('.modal-body-custom'); 
		  if(modalContent) {
		      setTimeout(() => {
		          const inputRect = currentInput.getBoundingClientRect();
		          const modalRect = modalContent.getBoundingClientRect();
		          const offset = inputRect.top - modalRect.top + modalContent.scrollTop - modalRect.height * 0.3; 
		          modalContent.scrollTo({ top: offset, behavior: 'smooth' });
		      }, 50);
		  }
		}
		
		function updateKeyboardForInput(input, overrideId = null) {
		  if (!input) return;
		  
		  const numericFields = ['actualDiameter', 'diameter', 'length', 'weight', 'hardness', 'calcDiameter1', 'calcDiameter2', 'calcLength', 'calcDensity'];
		  const currentId = overrideId || input.id;
		  const isNumeric = numericFields.includes(currentId);
		  
		  if (isNumeric) keyboardState.inputType = 'number';
		  else if (currentId === 'productId') keyboardState.inputType = 'productId';
		  else if (currentId === 'cardId') keyboardState.inputType = 'cardId';
		  else if (currentId === 'steelType') keyboardState.inputType = 'steelType';
		  else if (currentId === 'furnaceId') keyboardState.inputType = 'furnaceId';
		  else if (currentId === 'position') keyboardState.inputType = 'position';
		  else if (currentId === 'status') keyboardState.inputType = 'status';
		  else keyboardState.inputType = 'text';
		  
		  saveKeyboardState();
		  generateVirtualKeyboard();
		}
		
		function insertText(text) {
		  if (!currentInput) return;
		  currentInput.focus(); 
		  
		  const startPos = currentInput.selectionStart;
		  const endPos = currentInput.selectionEnd;
		  const currentValue = currentInput.value;
		  
		  currentInput.value = currentValue.substring(0, startPos) + text + currentValue.substring(endPos);
		  currentInput.selectionStart = currentInput.selectionEnd = startPos + text.length;
		  
		  const event = new Event('input', { bubbles: true });
		  currentInput.dispatchEvent(event);
		
		  if (currentInput.closest('#calculatorForm')) calculateWeight();
		  else if (currentInput.id === 'searchInput' && isSearchReplaceVisible) startSearch();
		}
		
		function handleBackspace() {
		  if (!currentInput) return;
		  currentInput.focus();
		  
		  const startPos = currentInput.selectionStart;
		  const endPos = currentInput.selectionEnd;
		  const currentValue = currentInput.value;
		  
		  if (startPos === endPos && startPos > 0) {
		    currentInput.value = currentValue.substring(0, startPos - 1) + currentValue.substring(endPos);
		    currentInput.selectionStart = currentInput.selectionEnd = startPos - 1;
		  } else if (startPos !== endPos) {
		    currentInput.value = currentValue.substring(0, startPos) + currentValue.substring(endPos);
		    currentInput.selectionStart = currentInput.selectionEnd = startPos;
		  }
		  
		  const event = new Event('input', { bubbles: true });
		  currentInput.dispatchEvent(event);
		
		  if (currentInput.closest('#calculatorForm')) calculateWeight();
		  else if (currentInput.id === 'searchInput' && isSearchReplaceVisible) startSearch();
		}
		
		function clearInput() {
		  if (currentInput) {
		    currentInput.value = '';
		    currentInput.focus();
		    const event = new Event('input', { bubbles: true });
		    currentInput.dispatchEvent(event);
		    if (currentInput.closest('#calculatorForm')) calculateWeight();
		  }
		}
		
		
		
		
async function saveData() {
    const formData = {};

    // å¡«å……è¡¨å•å­—æ®µ
    for (const key in formElements) {
        if (formElements.hasOwnProperty(key)) {
            formData[key] = formElements[key] ? formElements[key].value.trim() : '';
        }
    }

    // å•å¼ å›¾ç‰‡ä¿å­˜
    const previewContainer = document.getElementById('cardImagePreview');
    if (previewContainer && previewContainer.style.display !== 'none') {
        const previewImg = document.getElementById('previewImg');
        if (previewImg) {
            formData.cardImage = previewImg.src;
        } else {
            formData.cardImage = '';
        }
    } else {
        formData.cardImage = '';
    }

    // é‡é‡å››èˆäº”å…¥å–æ•´
    if (formData.weight) {
        const num = parseFloat(formData.weight);
        if (!isNaN(num)) {
            formData.weight = Math.round(num).toString();
        }
    }

    // å¿…å¡«éªŒè¯
    if (!formData.productId && !formData.cardId && !formData.furnaceId) {
        showSnackbar('äº§å“å·ã€å¡ç‰‡å·ã€ç‚‰å·è‡³å°‘å¡«å†™ä¸€é¡¹ï¼', 'warning');
        return;
    }

    // é‡å¤äº§å“å·æ£€æµ‹
    const isEditMode = currentEditIndex !== -1;
    const isProductIdChanged = isEditMode && tableData[currentEditIndex].productId !== formData.productId;

    if (!isEditMode || isProductIdChanged) {
        const duplicateItems = findDuplicates(formData);
        const realDuplicates = duplicateItems.filter(dup => dup.index !== currentEditIndex);
        if (realDuplicates.length > 0) {
            if (!window.confirm(`å‘ç° ${realDuplicates.length} æ¡äº§å“å·é‡å¤çš„æ•°æ®ï¼æ‚¨æ­£åœ¨ \( {isEditMode ? 'ä¿®æ”¹ä¸º' : 'æ·»åŠ äº§å“å·'}ï¼š \){formData.productId || 'N/A'}\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ`)) {
                const firstDuplicateIndex = realDuplicates[0].index;
                closeCustomModal(dom.dataSheet);
                dom.virtualKeyboard.style.display = 'none';
                highlightAndScrollToRow(firstDuplicateIndex);
                return;
            }
        }
    }

    // ä¿å­˜åˆ°æ•°æ®æ•°ç»„
    if (!isEditMode) {
        tableData.push(formData);
    } else {
        tableData[currentEditIndex] = formData;
    }

    // === ä½¿ç”¨ IndexedDB ä¿å­˜ ===
   saveDataToIndexedDB();

    // åˆ·æ–°ç•Œé¢
    currentPage = 1;
    updateTable();
    closeCustomModal(dom.dataSheet);
    dom.virtualKeyboard.style.display = 'none';

    showSnackbar(isEditMode ? 'æ•°æ®ä¿®æ”¹æˆåŠŸ' : 'æ•°æ®æ·»åŠ æˆåŠŸ', 'success');
}

// === IndexedDB åˆå§‹åŒ–å’Œæ“ä½œ ===
const DB_NAME = 'RoundBarDB';
const DB_VERSION = 1;
const STORE_NAME = 'data';
let db = null;

function openDB() {
    return new Promise((resolve, reject) => {
        if (db) {
            resolve(db);
            return;
        }

        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onerror = () => {
            console.error('IndexedDB æ‰“å¼€å¤±è´¥:', request.error);
            reject(request.error);
        };

        request.onsuccess = () => {
            db = request.result;
            resolve(db);
        };

        request.onupgradeneeded = (event) => {
            db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
            }
        };
    });
}

// ä¿å­˜æ‰€æœ‰æ•°æ®ï¼ˆè¦†ç›–å¼ï¼‰
async function saveDataToIndexedDB() {
    try {
        const db = await openDB();
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);

        // æ¸…ç©ºæ—§æ•°æ®
        await store.clear();

        // æ‰¹é‡æ·»åŠ æ–°æ•°æ®
        tableData.forEach(item => {
            store.add({ ...item }); // å¤åˆ¶å¯¹è±¡é¿å…å¼•ç”¨é—®é¢˜
        });

        await tx.done;
        console.log('IndexedDB ä¿å­˜æˆåŠŸï¼Œå…±', tableData.length, 'æ¡æ•°æ®');
    } catch (err) {
        console.error('IndexedDB ä¿å­˜å¤±è´¥:', err);
        showSnackbar('æ•°æ®ä¿å­˜å¤±è´¥ï¼ˆIndexedDBé”™è¯¯ï¼‰', 'error');
    }
}

// === åŠ è½½æ‰€æœ‰æ•°æ®ï¼ˆä¿®å¤åŠ è½½åè¡¨æ ¼ä¸é“ºæ»¡é—®é¢˜ï¼‰===
async function loadDataFromIndexedDB() {
    try {
        const db = await openDB();
        const tx = db.transaction(STORE_NAME, 'readonly');
        const store = tx.objectStore(STORE_NAME);
        const request = store.getAll();

        const data = await new Promise((resolve, reject) => {
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });

        if (data && data.length > 0) {
            tableData = data;
            console.log('IndexedDB åŠ è½½æˆåŠŸï¼Œå…±', tableData.length, 'æ¡æ•°æ®');
        } else {
            tableData = [];
            console.log('IndexedDB æ— æ•°æ®ï¼Œä½¿ç”¨ç©ºæ•°ç»„');
        }
    } catch (err) {
        console.error('IndexedDB åŠ è½½å¤±è´¥:', err);
        showSnackbar('æ•°æ®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨ç©ºæ•°æ®', 'warning');
        tableData = [];
    }

    // === å…³é”®ä¿®å¤ï¼šé‡ç½®åˆ†é¡µ + åˆ·æ–°å¸ƒå±€ï¼Œç¡®ä¿è¡¨æ ¼é“ºæ»¡å…¨å± ===
    currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
    updateTable();   // åˆ·æ–°è¡¨æ ¼å†…å®¹
    //updatePagination(); // å¦‚æœæ‚¨æœ‰åˆ†é¡µæ§ä»¶ï¼Œåˆ·æ–°é¡µç æ˜¾ç¤ºï¼ˆå¦‚æœæ²¡æœ‰å¯å¿½ç•¥ï¼‰
    
    // æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼ˆé¿å…æ®‹ç•™æ»šåŠ¨ä½ç½®å¯¼è‡´ç©ºç™½ï¼‰
    const container = document.querySelector('.data-table-container-div') || window;
    if (container) {
        container.scrollTop = 0;
    }

    // æ›´æ–°åº•éƒ¨ç»Ÿè®¡ï¼ˆå¦‚â€œå…± X æ¡æ•°æ®â€ï¼‰
    if (dom.totalCountText) {
        dom.totalCountText.textContent = `å…± ${tableData.length} æ¡æ•°æ®`;
    }
}



		function showVirtualKeyboard() {
    if (suppressVirtualKeyboard) {
        return;
    }
    generateVirtualKeyboard();
    dom.virtualKeyboard.style.display = 'block';
}
		
function loadData() {
    try {
        if (saved) {
            const parsed = JSON.parse(saved);
            if (Array.isArray(parsed)) {
                tableData = parsed;
                console.log('æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', tableData.length, 'æ¡');
            }
        }
    } catch (err) {
        console.error('æ•°æ®åŠ è½½å¤±è´¥:', err);
        showSnackbar('åŠ è½½å†å²æ•°æ®å¤±è´¥ï¼Œå·²ä½¿ç”¨ç©ºæ•°æ®', 'warning');
        localStorage.removeItem('roundBarData'); // æ¸…é™¤æŸåæ•°æ®
        tableData = [];
    }

    updateTable();
}
		
		function saveData() {
    const formData = {};

    // å¡«å……è¡¨å•å­—æ®µ
    for (const key in formElements) {
        if (formElements.hasOwnProperty(key)) {
            formData[key] = formElements[key] ? formElements[key].value.trim() : '';
        }
    }

    // å•å¼ å›¾ç‰‡ä¿å­˜ï¼ˆåŠ¨æ€è·å–ï¼‰
    const previewContainer = document.getElementById('cardImagePreview');
    if (previewContainer && previewContainer.style.display !== 'none') {
        const previewImg = document.getElementById('previewImg');
        if (previewImg) {
            formData.cardImage = previewImg.src;
        } else {
            formData.cardImage = '';
        }
    } else {
        formData.cardImage = '';
    }

    // å¿…å¡«éªŒè¯
    if (!formData.productId && !formData.cardId && !formData.furnaceId) {
        showSnackbar('äº§å“å·ã€å¡ç‰‡å·ã€ç‚‰å·è‡³å°‘å¡«å†™ä¸€é¡¹ï¼', 'warning');
        return;
    }

    // é‡å¤äº§å“å·æ£€æµ‹
    const isEditMode = currentEditIndex !== -1;
    const isProductIdChanged = isEditMode && tableData[currentEditIndex].productId !== formData.productId;

    if (!isEditMode || isProductIdChanged) {
        const duplicateItems = findDuplicates(formData);
        const realDuplicates = duplicateItems.filter(dup => dup.index !== currentEditIndex);
        if (realDuplicates.length > 0) {
            if (!window.confirm(`å‘ç° ${realDuplicates.length} æ¡äº§å“å·é‡å¤çš„æ•°æ®ï¼æ‚¨æ­£åœ¨ \( {isEditMode ? 'ä¿®æ”¹ä¸º' : 'æ·»åŠ äº§å“å·'}ï¼š \){formData.productId || 'N/A'}\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ`)) {
                const firstDuplicateIndex = realDuplicates[0].index;
                closeCustomModal(dom.dataSheet);
                dom.virtualKeyboard.style.display = 'none';
                highlightAndScrollToRow(firstDuplicateIndex);
                return;
            }
        }
    }

    // ä¿å­˜åˆ°æ•°æ®æ•°ç»„
    if (!isEditMode) {
        tableData.push(formData);
    } else {
        tableData[currentEditIndex] = formData;
    }

    // æŒä¹…åŒ–å¹¶åˆ·æ–°
    saveDataToIndexedDB();
    currentPage = 1;
    updateTable();
    closeCustomModal(dom.dataSheet);
    dom.virtualKeyboard.style.display = 'none';

    showSnackbar(isEditMode ? 'æ•°æ®ä¿®æ”¹æˆåŠŸ' : 'æ•°æ®æ·»åŠ æˆåŠŸ', 'success');
}
		
		function finalizeImport(newData, duplicateEntries, totalImported) {
		    let actuallyAdded = newData.length;
		    let actuallyOverridden = 0;
		    let actuallySkipped = 0;
		
		    duplicateEntries.forEach(entry => {
		        const action = entry.action;
		        const index = tableData.findIndex(item => item.productId && item.productId.trim() !== '' && item.productId === entry.productId);
		        if (action === 'override' && index !== -1) {
		            tableData[index] = entry.newItem;
		            actuallyOverridden++;
		        } else if (action === 'skip') {
		            actuallySkipped++;
		        }
		    });
		
		    if (newData.length > 0) tableData = [...tableData, ...newData];
		    
		    if (actuallyAdded > 0 || actuallyOverridden > 0 || actuallySkipped > 0 || totalImported > 0) {
		        saveDataToIndexedDB();
		        currentPage = 1;  // ã€æ–°å¢ã€‘å¯¼å…¥åé‡ç½®åˆ°ç¬¬ä¸€é¡µ
		        updateTable();
		    }
		
		    let resultMessage = `å¯¼å…¥å®Œæˆï¼å…±è¯»å– ${totalImported} æ¡è®°å½•ã€‚`;
		    if (actuallyAdded > 0) resultMessage += ` æˆåŠŸæ·»åŠ  ${actuallyAdded} æ¡æ–°æ•°æ®ã€‚`;
		    if (actuallyOverridden > 0) resultMessage += ` è¦†ç›– ${actuallyOverridden} æ¡é‡å¤æ•°æ®ã€‚`;
		    if (actuallySkipped > 0) resultMessage += ` è·³è¿‡ ${actuallySkipped} æ¡é‡å¤æ•°æ®ã€‚`;
		    if (totalImported === 0) resultMessage = `å¯¼å…¥å®Œæˆï¼æ–‡ä»¶æœªåŒ…å«æœ‰æ•ˆæ•°æ®ã€‚`;
		    showSnackbar(resultMessage, 'success');
		}
		
		
		
		function showDuplicateConfirmationModal(duplicateEntries, newData, totalImported) {
		    // ä¸´æ—¶ä¿å­˜æ•°æ®ä¾›åˆ†é¡µä½¿ç”¨
		    window.currentDuplicateEntries = duplicateEntries;
		
		    const modalElement = dom.duplicateConfirmationModal;
		    openCustomModal(modalElement); 
		    
		    const listContainer = modalElement.querySelector('#modal-duplicate-list');
		    const totalCountEl = modalElement.querySelector('#modal-total-count');
		    const newCountEl = modalElement.querySelector('#modal-new-count');
		    const duplicateCountEl = modalElement.querySelector('#modal-duplicate-count');
		
		    totalCountEl.textContent = totalImported;
		    newCountEl.textContent = newData.length;
		    duplicateCountEl.textContent = duplicateEntries.length;
		
		    // åˆå§‹åŒ–åˆ†é¡µ
		    duplicateTotalPages = Math.max(1, Math.ceil(duplicateEntries.length / DUPLICATE_PAGE_SIZE));
		    duplicateCurrentPage = 1;
		
		    listContainer.innerHTML = '';
		    renderDuplicatePage(listContainer);
		    renderDuplicatePagination(listContainer);
		
		    // å…¨éƒ¨è·³è¿‡ / å…¨éƒ¨è¦†ç›–
		    document.getElementById('modal-btn-select-all-skip').onclick = () => {
		        modalElement.querySelectorAll('input[type="radio"][value="skip"]').forEach(radio => radio.checked = true);
		    };
		
		    document.getElementById('modal-btn-select-all-override').onclick = () => {
		        modalElement.querySelectorAll('input[type="radio"][value="override"]').forEach(radio => radio.checked = true);
		    };
		
		    // ç¡®è®¤å¯¼å…¥
		    document.getElementById('modal-btn-confirm').onclick = () => {
		        const finalDuplicateData = window.currentDuplicateEntries.map((entry, index) => {
		            const radio = modalElement.querySelector(`input[name="action-${index}"]:checked`);
		            return { ...entry, action: radio ? radio.value : 'skip' };
		        });
		
		        closeCustomModal(modalElement);
		        delete window.currentDuplicateEntries; // æ¸…ç†
		        setTimeout(() => finalizeImport(newData, finalDuplicateData, totalImported), 300);
		    };
		}
		
		function renderDuplicatePage(listContainer) {
		    listContainer.innerHTML = '';
		
		    const entries = window.currentDuplicateEntries || [];
		    const startIndex = (duplicateCurrentPage - 1) * DUPLICATE_PAGE_SIZE;
		    const endIndex = Math.min(startIndex + DUPLICATE_PAGE_SIZE, entries.length);
		    const pageEntries = entries.slice(startIndex, endIndex);
		
		    const itemTemplateHtml = document.getElementById('duplicate-item-template').innerHTML;
		    const differenceTemplateHtml = document.getElementById('difference-row-template').innerHTML;
		
		    pageEntries.forEach((entry, pageIndex) => {
		        const globalIndex = startIndex + pageIndex;
		        let itemHtml = itemTemplateHtml
		            .replace(/PRODUCT_ID/g, entry.productId || 'N/A')
		            .replace(/ITEM_INDEX/g, globalIndex);
		
		        const tempDiv = document.createElement('div');
		        tempDiv.innerHTML = itemHtml;
		
		        const tbody = tempDiv.querySelector('.duplicate-differences tbody');
		        // ä¿®å¤ï¼šæ–°å¢tbodyå­˜åœ¨æ€§åˆ¤æ–­ï¼ˆæ‹¬å·é—®é¢˜å¯¼è‡´çš„æ ¸å¿ƒæŠ¥é”™â€”â€”tbodyä¸ºnullæ—¶æ“ä½œinnerHTMLï¼‰
		        if (tbody) {
		            if (entry.differences.length > 0) {
		                entry.differences.forEach(diff => {
		                    const rowHtml = differenceTemplateHtml
		                        .replace('FIELD_NAME', diff.field)
		                        .replace('OLD_VALUE', diff.existingItem[diff.key] || '-')
		                        .replace('NEW_VALUE', diff.newValue);
		                    tbody.innerHTML += rowHtml;
		                });
		            } else {
		                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#757575;font-style:italic;">æ— å…³é”®å­—æ®µå·®å¼‚</td></tr>';
		            }
		        }
		
		        // è®¾ç½® radio name
		        tempDiv.querySelectorAll('input[type="radio"]').forEach(radio => {
		            radio.name = `action-${globalIndex}`;
		        });
		
		        listContainer.appendChild(tempDiv.firstElementChild);
		    });
		}
		
		function renderDuplicatePagination(listContainer) {
		    const old = listContainer.parentNode.querySelector('#duplicatePagination');
		    if (old) old.remove();
		
		    if (duplicateTotalPages <= 1) return;
		
		    const paginationDiv = document.createElement('div');
		    paginationDiv.id = 'duplicatePagination';
		    paginationDiv.style.cssText = 'display:flex;justify-content:center;align-items:center;gap:16px;padding:20px 0;background:var(--surface-color);';
		
		    const prevBtn = document.createElement('mdui-button-icon');
		    prevBtn.icon = 'navigate_before';
		    prevBtn.disabled = duplicateCurrentPage === 1;
		
		    let prevLongTimer = null;
		    const LONG_PRESS = 500;
		
		    prevBtn.addEventListener('click', (e) => {
		        e.stopPropagation();
		        if (duplicateCurrentPage > 1) {
		            duplicateCurrentPage--;
		            renderDuplicatePage(listContainer);
		            renderDuplicatePagination(listContainer);
		        }
		    });
		
		    prevBtn.addEventListener('pointerdown', () => {
		        if (duplicateCurrentPage === 1) return;
		        prevLongTimer = setTimeout(() => {
		            duplicateCurrentPage = 1;
		            renderDuplicatePage(listContainer);
		            renderDuplicatePagination(listContainer);
		        }, LONG_PRESS);
		    });
		    prevBtn.addEventListener('pointerup', () => clearTimeout(prevLongTimer));
		    prevBtn.addEventListener('pointercancel', () => clearTimeout(prevLongTimer));
		    prevBtn.addEventListener('pointerleave', () => clearTimeout(prevLongTimer));
		
		    const pageInfo = document.createElement('span');
		    pageInfo.textContent = `ç¬¬ ${duplicateCurrentPage} / ${duplicateTotalPages} é¡µï¼ˆå…± ${(window.currentDuplicateEntries || []).length} æ¡é‡å¤ï¼‰`;
		    pageInfo.style.cssText = 'font-size:0.95rem;color:#757575;';
		
		    const nextBtn = document.createElement('mdui-button-icon');
		    nextBtn.icon = 'navigate_next';
		    nextBtn.disabled = duplicateCurrentPage === duplicateTotalPages;
		
		    let nextLongTimer = null;
		
		    nextBtn.addEventListener('click', (e) => {
		        e.stopPropagation();
		        if (duplicateCurrentPage < duplicateTotalPages) {
		            duplicateCurrentPage++;
		            renderDuplicatePage(listContainer);
		            renderDuplicatePagination(listContainer);
		        }
		    });
		
		    nextBtn.addEventListener('pointerdown', () => {
		        if (duplicateCurrentPage === duplicateTotalPages) return;
		        nextLongTimer = setTimeout(() => {
		            duplicateCurrentPage = duplicateTotalPages;
		            renderDuplicatePage(listContainer);
		            renderDuplicatePagination(listContainer);
		        }, LONG_PRESS);
		    });
		    nextBtn.addEventListener('pointerup', () => clearTimeout(nextLongTimer));
		    nextBtn.addEventListener('pointercancel', () => clearTimeout(nextLongTimer));
		    nextBtn.addEventListener('pointerleave', () => clearTimeout(nextLongTimer));
		
		    paginationDiv.appendChild(prevBtn);
		    paginationDiv.appendChild(pageInfo);
		    paginationDiv.appendChild(nextBtn);
		
		    listContainer.parentNode.appendChild(paginationDiv);
		}
		

function handleFileImport(e) {
    const file = e.target.files[0];
    if (!file) return;

    if (file.size > 20 * 1024 * 1024) {
        showSnackbar('æ–‡ä»¶å¤ªå¤§ï¼ˆ>20MBï¼‰ï¼Œè¯·å‹ç¼©åå¯¼å…¥', 'error');
        dom.fileInput.value = '';
        return;
    }

    const fileName = file.name.toLowerCase();

    if (fileName.endsWith('.zip')) {
        showSnackbar('æ­£åœ¨è§£æ ZIP æ–‡ä»¶...', 'info');
        JSZip.loadAsync(file)
            .then(zip => {
                let excelEntry = null;
                const imageEntries = {};

                zip.forEach((relativePath, entry) => {
                    const lowerPath = relativePath.toLowerCase();
                    if (lowerPath.endsWith('.xlsx') || lowerPath.endsWith('.xls')) {
                        excelEntry = entry;
                    } else if (/\.(jpg|jpeg|png)$/i.test(lowerPath)) {
                        const match = relativePath.match(/[_-]([^_.-]+)\.(jpg|jpeg|png)$/i);
                        if (match) {
                            imageEntries[match[1].trim()] = entry;
                        }
                    }
                });

                if (!excelEntry) {
                    showSnackbar('ZIP ä¸­æœªæ‰¾åˆ° Excel æ–‡ä»¶', 'error');
                    dom.fileInput.value = '';
                    return;
                }

                excelEntry.async('arraybuffer').then(buffer => {
                    const wb = XLSX.read(buffer, { type: 'array' });
                    processWorkbookImport(wb, imageEntries, {});
                });
            })
            .catch(err => {
                showSnackbar('ZIP æ–‡ä»¶è§£æå¤±è´¥', 'error');
                console.error(err);
                dom.fileInput.value = '';
            });

    } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
        showSnackbar('æ­£åœ¨è¯»å– Excel æ–‡ä»¶...', 'info');
        const reader = new FileReader();
        reader.onload = async function(event) {
            try {
                const data = event.target.result;
                const zip = await JSZip.loadAsync(data);
                const embeddedImages = [];

                let imageId = 1;
                for (const fileName in zip.files) {
                    if (fileName.match(/xl\/media\/image\d+\.(jpeg|jpg|png)/i)) {
                        const base64 = await zip.files[fileName].async('base64');
                        const ext = fileName.match(/\.(jpeg|jpg|png)/i)?.[1] || 'jpeg';
                        embeddedImages.push(`data:image/${ext};base64,${base64}`);
                        imageId++;
                    }
                }

                const wb = XLSX.read(data, { type: 'array' });
                processWorkbookImport(wb, {}, embeddedImages);
            } catch (err) {
                showSnackbar('æ–‡ä»¶è§£æå¤±è´¥', 'error');
                console.error(err);
                dom.fileInput.value = '';
            }
        };
        reader.readAsArrayBuffer(file);
    } else {
        showSnackbar('ä»…æ”¯æŒ .xlsxã€.xls æˆ– .zip æ–‡ä»¶', 'warning');
        dom.fileInput.value = '';
    }
}

function processWorkbookImport(workbook, zipImageEntries = {}, embeddedImages = []) {
    const sheetNames = workbook.SheetNames;

    const proceedWithSheet = (sheetName) => {
        const headerMapping = {
            'é’¢ç§': 'steelType',
            'äº§å“å·': 'productId',
            'å¡ç‰‡å·': 'cardId',
            'ç‚‰å·': 'furnaceId',
            'å®é™…ç›´å¾„': 'actualDiameter',
            'ç›´å¾„': 'diameter',
            'é•¿åº¦': 'length',
            'é‡é‡': 'weight',
            'çŠ¶æ€': 'status',
            'ä½ç½®': 'position',
            'ç¡¬åº¦': 'hardness',
            'å¤‡æ³¨': 'remarks',
            'å¡ç‰‡å›¾ç‰‡': 'cardImage'
        };

        const theoreticalWeightKeywords = ['ç†ç®—é‡é‡', 'ç†è®ºé‡é‡', 'ç†é‡'];

        const worksheet = workbook.Sheets[sheetName];
        const range = XLSX.utils.decode_range(worksheet['!ref']);
        const rawData = [];

        for (let r = range.s.r; r <= range.e.r; r++) {
            const row = [];
            for (let c = range.s.c; c <= range.e.c; c++) {
                const cellAddress = XLSX.utils.encode_cell({ r, c });
                const cell = worksheet[cellAddress];
                row.push(cell ? cell.v : '');
            }
            rawData.push(row);
        }

        let headerRowIndex = -1;
        for (let i = 0; i < Math.min(rawData.length, 20); i++) {
            if (rawData[i].some(cell => {
                const str = String(cell || '').trim();
                return str.includes('äº§å“å·') || str.includes('é’¢ç§') || str.includes('ç‚‰å·') || str.includes('å¡ç‰‡å·');
            })) {
                headerRowIndex = i;
                break;
            }
        }

        if (headerRowIndex === -1) {
            showSnackbar('æœªèƒ½æ‰¾åˆ°è¡¨å¤´è¡Œ', 'error');
            dom.fileInput.value = '';
            return;
        }

        const headerRow = rawData[headerRowIndex].map(cell => String(cell || '').trim());
        const dataRows = rawData.slice(headerRowIndex + 1);

        const colMapping = {};
        let theoreticalWeightCol = -1;
        let imageColIndex = -1;

        headerRow.forEach((header, idx) => {
            if (!header) return;
            const cleanHeader = header.replace(/[\s\(\)ï¼ˆï¼‰ã€ã€‘\[\]mmkgåƒå…‹ç±³]/g, '');

            if (headerMapping[cleanHeader]) {
                colMapping[headerMapping[cleanHeader]] = idx;
            }
            if (cleanHeader.includes('å¡ç‰‡å›¾ç‰‡') || cleanHeader.includes('å›¾ç‰‡')) {
                imageColIndex = idx;
            }
            if (theoreticalWeightKeywords.some(kw => cleanHeader.includes(kw))) {
                theoreticalWeightCol = idx;
            }
        });

        const formattedData = dataRows.map((row, rowIndex) => {
            const item = {};

            for (const field in colMapping) {
                const colIdx = colMapping[field];
                if (row[colIdx] !== undefined && row[colIdx] !== '') {
                    let value = String(row[colIdx]).trim();
                    if (field === 'weight') {
                        const num = parseFloat(value);
                        if (!isNaN(num)) value = Math.round(num).toString();
                    }
                    item[field] = value;
                }
            }

            if (theoreticalWeightCol !== -1 && row[theoreticalWeightCol] !== '') {
                const num = parseFloat(String(row[theoreticalWeightCol]).trim());
                if (!isNaN(num)) item.weight = Math.round(num).toString();
            }

            if (item.productId && zipImageEntries[item.productId]) {
                zipImageEntries[item.productId].async('base64').then(base64 => {
                    item.cardImage = `data:image/jpeg;base64,${base64}`;
                }).catch(() => {});
            } else if (embeddedImages.length > 0 && rowIndex < embeddedImages.length) {
                item.cardImage = embeddedImages[rowIndex];
            }

            return (item.productId || item.cardId || item.furnaceId || item.steelType) ? item : null;
        }).filter(item => item !== null);

        if (formattedData.length === 0) {
            showSnackbar('æœªæ‰¾åˆ°æœ‰æ•ˆæ•°æ®è¡Œ', 'warning');
            dom.fileInput.value = '';
            return;
        }

        const totalImported = formattedData.length;
        const newData = [];
        const duplicateEntries = [];

        formattedData.forEach(newItem => {
            const existingItem = tableData.find(ex => 
                ex.productId && newItem.productId && 
                ex.productId.trim() === newItem.productId.trim()
            );

            if (!existingItem) {
                newData.push(newItem);
            } else {
                duplicateEntries.push({
                    productId: newItem.productId,
                    existingItem,
                    newItem,
                    differences: getObjectDifferences(existingItem, newItem)
                });
            }
        });

        if (duplicateEntries.length > 0) {
            showDuplicateConfirmationModal(duplicateEntries, newData, totalImported);
        } else {
            finalizeImport(newData, [], totalImported);
        }
    };

    if (sheetNames.length > 1) {
        const options = sheetNames.map(name => 
            `<mdui-menu-item value="${name.replace(/"/g, '&quot;')}">${name}</mdui-menu-item>`
        ).join('');

        dom.confirmMessage.innerHTML = `
            <div style="padding: 16px;">
                <div style="font-size: 1.1rem; margin-bottom: 16px; text-align: center;">æ£€æµ‹åˆ°å¤šä¸ªå·¥ä½œè¡¨ï¼Œè¯·é€‰æ‹©ï¼š</div>
                <mdui-select id="sheetSelect" variant="outlined" placement="bottom" value="${sheetNames[0].replace(/"/g, '&quot;')}" style="width: 100%;">
                    ${options}
                </mdui-select>
            </div>
        `;

        openCustomModal(dom.confirmModal);
        dom.confirmActionBtn.textContent = 'ç¡®å®š';

        dom.confirmActionBtn.onclick = () => {
            const selectEl = dom.confirmModal.querySelector('#sheetSelect');
            const selectedSheet = selectEl.value;
            closeCustomModal(dom.confirmModal);
            proceedWithSheet(selectedSheet);
        };

        dom.cancelConfirmBtn.onclick = () => {
            closeCustomModal(dom.confirmModal);
            dom.fileInput.value = '';
        };
    } else {
        proceedWithSheet(sheetNames[0]);
    }
}


async function exportToExcel() {
    const exportData = getFilteredData();
    if (exportData.length === 0) {
        showSnackbar('æš‚æ— æ•°æ®å¯å¯¼å‡º', 'warning');
        return;
    }

    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('åœ†æ£’å…¥åº“æ•°æ®');

    worksheet.columns = [
        { header: 'åºå·', key: 'seq', width: 8 },
        { header: 'é’¢ç§', key: 'steelType', width: 15 },
        { header: 'äº§å“å·', key: 'productId', width: 18 },
        { header: 'å¡ç‰‡å·', key: 'cardId', width: 12 },
        { header: 'ç‚‰å·', key: 'furnaceId', width: 12 },
        { header: 'å®é™…ç›´å¾„', key: 'actualDiameter', width: 12 },
        { header: 'ç›´å¾„', key: 'diameter', width: 10 },
        { header: 'é•¿åº¦', key: 'length', width: 10 },
        { header: 'é‡é‡', key: 'weight', width: 10 },
        { header: 'çŠ¶æ€', key: 'status', width: 10 },
        { header: 'ä½ç½®', key: 'position', width: 10 },
        { header: 'ç¡¬åº¦', key: 'hardness', width: 10 },
        { header: 'å¤‡æ³¨', key: 'remarks', width: 20 },
        { header: 'å¡ç‰‡å›¾ç‰‡', key: 'cardImage', width: 12 }
    ];

    const headerRow = worksheet.getRow(1);
    headerRow.font = { bold: true };
    headerRow.alignment = { vertical: 'middle', horizontal: 'center' };

    exportData.forEach((item, index) => {
        const row = worksheet.addRow({
            seq: index + 1,
            steelType: item.steelType || '',
            productId: item.productId || '',
            cardId: item.cardId || '',
            furnaceId: item.furnaceId || '',
            actualDiameter: item.actualDiameter || '',
            diameter: item.diameter || '',
            length: item.length || '',
            weight: item.weight ? Math.round(parseFloat(item.weight)) || '' : '',
            status: item.status || '',
            position: item.position || '',
            hardness: item.hardness || '',
            remarks: item.remarks || '',
            cardImage: ''
        });

        row.height = 22; // å›ºå®šé«˜åº¦

        if (item.cardImage && item.cardImage.startsWith('data:image/')) {
            const base64Data = item.cardImage.split(',')[1];
            const ext = item.cardImage.match(/data:image\/(jpeg|png);/)?.[1] || 'jpeg';

            const imageId = workbook.addImage({
                base64: base64Data,
                extension: ext,
            });

            worksheet.addImage(imageId, {
                tl: { col: 13, row: index + 1 },
                ext: { width: 40, height: 30 },
                editAs: 'oneCell'
            });
        }
    });

    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: 'application/octet-stream' });
    const dateStr = new Date().toLocaleDateString('zh-CN').replace(/\//g, '-');
    saveAs(blob, `åœ†æ£’å…¥åº“æ•°æ®_${dateStr}.xlsx`);

    showSnackbar('å¯¼å‡ºæˆåŠŸï¼å›¾ç‰‡å·²åµŒå…¥è¡¨æ ¼', 'success');
}

		function calculateWeight() {
		  const diameter1 = parseFloat(dom.calcDiameter1.value) || 0;
		  const diameter2 = parseFloat(dom.calcDiameter2.value) || 0;
		  const length = parseFloat(dom.calcLength.value) || 0;
		  const densityFactor = parseFloat(dom.calcDensity.value) || 0.00617; 
		  
		  if (diameter1 <= 0 || diameter2 <= 0 || length <= 0) {
		    dom.calcResult.value = '';
		    return;
		  }
		  
		  const crudeWeight = densityFactor * diameter1 * diameter2 * length / 1000;
		  dom.calcResult.value = crudeWeight.toFixed(2);
		}
		
		function initAutoCalculate() {
		  const calcInputs = [dom.calcDiameter1, dom.calcDiameter2, dom.calcLength];
		  calcInputs.forEach(input => {
		    if (input) {
		      input.addEventListener('input', calculateWeight);
		      input.addEventListener('change', calculateWeight);
		    }
		  });
		  
		  dom.calcDensity.addEventListener('dblclick', (e) => {
		      e.stopPropagation();
		      const densityInput = dom.calcDensity;
		      if (densityInput.hasAttribute('readonly')) {
		          densityInput.removeAttribute('readonly');
		          densityInput.classList.remove('readonly-input');
		          densityInput.focus();
		      } else {
		          densityInput.setAttribute('readonly', 'true');
		          densityInput.classList.add('readonly-input');
		          densityInput.blur();
		      }
		  });
		  
		  calculateWeight();
		}
		
function calculateAndAddData() {
    const diameter1 = parseFloat(dom.calcDiameter1.value);
    const diameter2 = parseFloat(dom.calcDiameter2.value);
    const length = parseFloat(dom.calcLength.value);
    const weight = parseFloat(dom.calcResult.value);

    if (isNaN(diameter1) || isNaN(diameter2) || isNaN(length) || diameter1 <= 0 || diameter2 <= 0 || length <= 0) {
      showSnackbar('è¯·è¾“å…¥æœ‰æ•ˆçš„è®¡ç®—å‚æ•°', 'error');
      return;
    }

    const minDiameter = Math.min(diameter1, diameter2);
    const maxDiameter = Math.max(diameter1, diameter2);
    // ä¿®å¤1ï¼šä¸ä¿ç•™å°æ•° - å››èˆäº”å…¥å–æ•´ï¼ŒåŒæ—¶ä¿®æ­£æ¨¡æ¿å­—ç¬¦ä¸²æ’å€¼è¯­æ³•ï¼ˆåŸè½¬ä¹‰å­—ç¬¦é”™è¯¯ï¼‰
    const actualDiameter = `${Math.round(minDiameter)}-${Math.round(maxDiameter)}`;
    // ä¿®å¤2ï¼šå¹³å‡ç›´å¾„ä¸ä¿ç•™å°æ•°
    const averageDiameter = Math.round((minDiameter + maxDiameter) / 2);

    const preFilledData = {
      actualDiameter: actualDiameter,
      diameter: averageDiameter, 
      // ä¿®å¤3ï¼šé•¿åº¦ã€é‡é‡ä¸ä¿ç•™å°æ•°
      length: Math.round(length),
      weight: Math.round(weight)
    };

    closeCustomModal(dom.calculatorModal); 
    dom.virtualKeyboard.style.display = 'none'; 
    openAddModalWithData(preFilledData);
}

function toggleMultiSelectMode() {
  isMultiSelectMode = !isMultiSelectMode;
  selectedRows.clear();
  
  const menuText = dom.multiSelectMenuText;
  if (isMultiSelectMode) {
    menuText.textContent = 'é€€å‡ºå¤šé€‰æ¨¡å¼';
    dom.multiSelectMenuItem.icon = 'check_box';
  } else {
    menuText.textContent = 'è¿›å…¥å¤šé€‰æ¨¡å¼';
    dom.multiSelectMenuItem.icon = 'check_box_outline_blank';
  }
  
  updateTable();
}
		
		function initCalculatorKeyboard() {
		  const calcInputs = [dom.calcDiameter1, dom.calcDiameter2, dom.calcLength];
		  calcInputs.forEach(input => {
		    if (input) {
		      input.setAttribute('readonly', 'true');
		      input.classList.add('readonly-input');
		      
		      input.addEventListener('click', (e) => {
		          if (input.hasAttribute('readonly')) {
		            e.stopPropagation();
		            currentInput = e.target;
		            updateKeyboardForInput(currentInput);
		            showVirtualKeyboard();
		            currentInput.focus();
		            
		            const modalContent = document.getElementById('calculatorContent');
		            if(modalContent) {
		                setTimeout(() => {
		                    const inputRect = currentInput.getBoundingClientRect();
		                    const modalRect = modalContent.getBoundingClientRect();
		                    const offset = inputRect.top - modalRect.top + modalContent.scrollTop - modalRect.height * 0.3; 
		                    modalContent.scrollTo({ top: offset, behavior: 'smooth' });
		                }, 50);
		            }
		          }
		      });
		      
		      input.addEventListener('dblclick', (e) => {
		          e.stopPropagation();
		          if (dom.calculatorModal.style.display !== 'block') return;
		          if (input.hasAttribute('readonly')) {
		            input.removeAttribute('readonly');
		            input.classList.remove('readonly-input');
		            dom.virtualKeyboard.style.display = 'none';
		            input.focus();
		          } else {
		            input.setAttribute('readonly', 'true');
		            input.classList.add('readonly-input');
		            currentInput = input;
		            updateKeyboardForInput(currentInput);
		            showVirtualKeyboard();
		          }
		      });
		    }
		  });
		}
		// ==================== å¤šå­—æ®µæ’åºæ ¸å¿ƒå‡½æ•°ï¼ˆæ”¯æŒè®°å¿† + ä¿®å¤æ¨¡æ¿é”™è¯¯ï¼‰ ====================
		
		const SORT_RULES_KEY = 'sortRulesMemory'; // localStorage é”®å
		
		// ä¿å­˜å½“å‰æ’åºè§„åˆ™åˆ° localStorage
		function saveSortRulesToStorage(rules) {
		    localStorage.setItem(SORT_RULES_KEY, JSON.stringify(rules));
		}
		
		// ä» localStorage è¯»å–ä¸Šæ¬¡æ’åºè§„åˆ™
		function loadSortRulesFromStorage() {
		    const saved = localStorage.getItem(SORT_RULES_KEY);
		    if (!saved) return null;
		    try {
		        return JSON.parse(saved);
		    } catch (e) {
		        return null;
		    }
		}
		
		function openSortModal() {
		    dom.drawer.open = false;
		    openCustomModal(dom.sortModal);
		
		    // æ¸…ç©ºå®¹å™¨
		    dom.sortRulesContainer.innerHTML = '';
		
		    // å°è¯•åŠ è½½ä¸Šæ¬¡è®°å¿†çš„æ’åºè§„åˆ™
		    const savedRules = loadSortRulesFromStorage();
		
		    if (savedRules && savedRules.length > 0) {
		        // æ¢å¤è®°å¿†çš„è§„åˆ™
		        savedRules.forEach(rule => {
		            addSortRule(rule.field, rule.order);
		        });
		    } else {
		        // æ²¡æœ‰è®°å¿†æ—¶ï¼Œé»˜è®¤æ·»åŠ ä¸€æ¡ï¼šå¡ç‰‡å·å‡åº
		        addSortRule('cardId', 'asc');
		    }
		
		    updateAddButtonState();
		}
		
		function addSortRule(field = 'productId', order = 'asc') {
		    if (dom.sortRulesContainer.children.length >= 5) {
		        showSnackbar('æœ€å¤šæ”¯æŒ5ä¸ªæ’åºè§„åˆ™', 'warning');
		        return;
		    }
		
		    const ruleDiv = document.createElement('div');
		    ruleDiv.className = 'sort-rule';
		    ruleDiv.style.cssText = 'display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding: 14px; background-color: var(--background-color); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 2px 6px rgba(0,0,0,0.06);';
		
		    // === å­—æ®µé€‰æ‹© mdui-select ===
		    const fieldSelect = document.createElement('mdui-select');
		    fieldSelect.variant = 'outlined';
		    fieldSelect.value = field;
		    fieldSelect.placeholder = 'é€‰æ‹©å­—æ®µ';
		    fieldSelect.style.width = '100%';
		
		    sortFieldOptions.forEach(opt => {
		        const option = document.createElement('mdui-menu-item');
		        option.value = opt.value;
		        option.textContent = opt.label;
		        if (opt.value === field) option.selected = true;
		        fieldSelect.appendChild(option);
		    });
		
		    // === æ’åºæ–¹å‘ mdui-select ===
		    const orderSelect = document.createElement('mdui-select');
		    orderSelect.variant = 'outlined';
		    orderSelect.value = order;
		    orderSelect.style.width = '100%';
		
		    const ascOption = document.createElement('mdui-menu-item');
		    ascOption.value = 'asc';
		    ascOption.textContent = 'å‡åº â†‘';
		    if (order === 'asc') ascOption.selected = true;
		
		    const descOption = document.createElement('mdui-menu-item');
		    descOption.value = 'desc';
		    descOption.textContent = 'é™åº â†“';
		    if (order === 'desc') descOption.selected = true;
		
		    orderSelect.appendChild(ascOption);
		    orderSelect.appendChild(descOption);
		
		    // === åˆ é™¤æŒ‰é’® ===
		    const deleteBtn = document.createElement('mdui-button-icon');
		    deleteBtn.icon = 'delete';
		    deleteBtn.variant = 'tonal';
		    deleteBtn.style.flexShrink = '0';
		
		    deleteBtn.addEventListener('click', () => {
		        ruleDiv.remove();
		        updateAddButtonState();
		    });
		
		    // ç»„è£…
		    ruleDiv.appendChild(fieldSelect);
		    ruleDiv.appendChild(orderSelect);
		    ruleDiv.appendChild(deleteBtn);
		
		    dom.sortRulesContainer.appendChild(ruleDiv);
		
		    // ã€å…³é”®ã€‘æ·»åŠ åï¼Œæ™ºèƒ½è®¾ç½®æ¯ä¸ª select çš„ placement
		    setTimeout(() => {
		        const selects = ruleDiv.querySelectorAll('mdui-select');
		        selects.forEach(select => {
		            // è·å–å…ƒç´ åœ¨è§†å£ä¸­çš„ä½ç½®
		            const rect = select.getBoundingClientRect();
		            const spaceBelow = window.innerHeight - rect.bottom;
		            const spaceAbove = rect.top;
		
		            // å¦‚æœä¸‹æ–¹ç©ºé—´ä¸è¶³ 200pxï¼ˆèœå•å¤§çº¦é«˜åº¦ï¼‰ï¼Œåˆ™å‘ä¸Šå±•å¼€
		            if (spaceBelow < 200 && spaceAbove > spaceBelow) {
		                select.placement = 'top-start';
		            } else {
		                select.placement = 'bottom-start';
		            }
		        });
		    }, 100); // å»¶è¿Ÿç¡®ä¿ DOM å·²æ¸²æŸ“
		
		    updateAddButtonState();
		}
		
		function updateAddButtonState() {
		    const count = dom.sortRulesContainer.children.length;
		    dom.addSortRuleBtn.disabled = count >= 5;
		
		    // å¯é€‰ï¼šæ›´æ–°â€œåº”ç”¨æ’åºâ€æŒ‰é’®çŠ¶æ€ï¼ˆè‡³å°‘ä¸€æ¡è§„åˆ™æ‰èƒ½åº”ç”¨ï¼‰
		    dom.applySortBtn.disabled = count === 0;
		}
		
		function applySort() {
		    const rules = [];
		    const ruleElements = dom.sortRulesContainer.querySelectorAll('.sort-rule');
		
		    if (ruleElements.length === 0) {
		        showSnackbar('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªæ’åºè§„åˆ™', 'warning');
		        return;
		    }
		
		    ruleElements.forEach(el => {
		        const fieldSelect = el.querySelector('mdui-select:first-of-type');
		        const orderSelect = el.querySelector('mdui-select:last-of-type');
		
		        const field = fieldSelect.value;
		        const order = orderSelect.value;
		
		        if (field && order) {
		            rules.push({ field, order });
		        }
		    });
		
		    // æ‰§è¡Œæ’åº
		    tableData.sort((a, b) => {
		        for (const rule of rules) {
		            let aVal = a[rule.field] ?? '';
		            let bVal = b[rule.field] ?? '';
		
		            let cmp = 0;
		            if (numericSortFields.includes(rule.field)) {
		                const aNum = parseFloat(aVal) || 0;
		                const bNum = parseFloat(bVal) || 0;
		                cmp = aNum - bNum;
		            } else {
		                cmp = String(aVal).localeCompare(String(bVal), 'zh-CN', { numeric: true, sensitivity: 'base' });
		            }
		
		            if (cmp !== 0) {
		                return rule.order === 'asc' ? cmp : -cmp;
		            }
		        }
		        return 0;
		    });
		
		    // ã€å…³é”®ã€‘åº”ç”¨åä¿å­˜æœ¬æ¬¡è§„åˆ™åˆ° localStorageï¼Œå®ç°è®°å¿†åŠŸèƒ½
		    saveSortRulesToStorage(rules);
		
		    saveDataToIndexedDB();
		    currentPage = 1;  
		    updateTable();
		    closeCustomModal(dom.sortModal);
		
		    const msgParts = rules.map((r, i) =>
		    `ç¬¬${i + 1}ä¼˜å…ˆçº§ï¼šã€${fieldLabels[r.field]}ã€‘${r.order === 'asc' ? 'å‡åº' : 'é™åº'}`
		);
		showSnackbar('æ’åºå·²åº”ç”¨ï¼š' + msgParts.join(' â†’ '), 'success');
		    
		    }
		
		
async function handleImageSelect(e) {
    let file;
    if (e.type === 'drop') {
        e.preventDefault();
        file = e.dataTransfer.files[0];
    } else {
        file = e.target.files[0];
    }

    if (!file) return;

    // æ”¯æŒå›¾ç‰‡å’Œè§†é¢‘ï¼ˆå¦‚æœéœ€è¦è§†é¢‘æˆªå¸§ï¼Œå¯åç»­æ‰©å±•ï¼‰
    if (!file.type.startsWith('image/')) {
        showSnackbar('ä»…æ”¯æŒå›¾ç‰‡æ ¼å¼', 'error');
        return;
    }

    if (file.size > 5 * 1024 * 1024) { // é™åˆ¶5MB
        showSnackbar('å›¾ç‰‡å¤ªå¤§ï¼ˆ>5MBï¼‰ï¼Œè¯·å‹ç¼©åä¸Šä¼ ', 'error');
        return;
    }

    showSnackbar('æ­£åœ¨å¤„ç†å›¾ç‰‡ï¼Œè¯·ç¨ç­‰...', 'info');

    try {
        const compressedBase64 = await compressImage(file, 1024, 1024, 0.85);

        const previewImg = document.getElementById('previewImg');
        const previewContainer = document.getElementById('cardImagePreview');
        const noImageArea = document.getElementById('noImageUploadArea');

        previewImg.src = compressedBase64;
        previewContainer.style.display = 'block';
        noImageArea.style.display = 'none';

        if (currentEditIndex !== -1) {
            tableData[currentEditIndex].cardImage = compressedBase64;
        }

        showSnackbar('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
    } catch (err) {
        showSnackbar('å›¾ç‰‡å¤„ç†å¤±è´¥', 'error');
        console.error(err);
    }

    // æ¸…ç©ºinput
    e.target.value = '';
}
async function compressImage(file, maxWidth = 1024, maxHeight = 1024, quality = 0.85) {
    return new Promise((resolve) => {
        const img = new Image();
        const reader = new FileReader();

        reader.onload = (e) => {
            img.src = e.target.result;
        };

        img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            if (width > maxWidth || height > maxHeight) {
                const ratio = Math.min(maxWidth / width, maxHeight / height);
                width *= ratio;
                height *= ratio;
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            resolve(canvas.toDataURL('image/jpeg', quality));
        };

        reader.readAsDataURL(file);
    });
}

function renderCardImagesPreview(images) {
    const container = dom.cardImagesPreview;
    container.innerHTML = '';

    if (images.length === 0) {
        container.innerHTML = '<span style="color:#999;padding:20px;">æš‚æ— å›¾ç‰‡ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </span>';
        return;
    }

    images.forEach((base64, idx) => {
        const wrapper = document.createElement('div');
        wrapper.style.cssText = 'position:relative;display:inline-block;';

        wrapper.innerHTML = `
            <img src="${base64}" style="width:120px;height:120px;object-fit:cover;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.2);">
            <mdui-button-icon icon="delete" style="position:absolute;top:-8px;right:-8px;background:white;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,0.3);"
                              onclick="deleteSingleImage(${currentEditIndex}, ${idx})"></mdui-button-icon>
        `;

        // ç‚¹å‡»å›¾ç‰‡æ”¾å¤§æŸ¥çœ‹
        wrapper.querySelector('img').onclick = () => showFullImage(base64);

        container.appendChild(wrapper);
    });
}
		function deleteSingleImage(dataIndex, imageIndex) {
    if (dataIndex === -1 || !tableData[dataIndex].cardImages) return;

    tableData[dataIndex].cardImages.splice(imageIndex, 1);
    saveDataToIndexedDB();
    renderCardImagesPreview(tableData[dataIndex].cardImages);
    updateTable(); // åˆ·æ–°è¡¨æ ¼æ˜¾ç¤º
    showSnackbar('å·²åˆ é™¤å›¾ç‰‡', 'success');
}

		function showFullImage(src) {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);
        display:flex;align-items:center;justify-content:center;z-index:9999;
    `;
    modal.innerHTML = `
        <img src="${src}" style="max-width:95%;max-height:95%;object-fit:contain;border-radius:8px;">
        <mdui-button-icon icon="close" style="position:absolute;top:16px;right:16px;color:white;"
                          onclick="this.closest('div').remove()"></mdui-button-icon>
    `;
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    document.body.appendChild(modal);
}


function openEditModalForImageUpload(dataIndex) {
    // ä¸´æ—¶æŠ‘åˆ¶é”®ç›˜
    suppressVirtualKeyboard = true;
    dom.virtualKeyboard.style.display = 'none';

    // æ‰“å¼€ç¼–è¾‘å¼¹çª—
    openEditModal(dataIndex);

    setTimeout(() => {
        // æ»šåŠ¨åˆ°å›¾ç‰‡ä¸Šä¼ åŒº
        const modalContent = document.getElementById('dataSheetContent');
        if (modalContent) {
            modalContent.scrollTop = modalContent.scrollHeight;
        }

        // å…³é”®ä¿®å¤ï¼šç§»é™¤ capture å±æ€§ï¼Œç¡®ä¿æ‰“å¼€ç›¸å†Œè€Œä¸æ˜¯ç›¸æœº
        const fileInput = document.getElementById('cardImageInput');
        fileInput.removeAttribute('capture');  // â† è¿™é‡Œç§»é™¤ capture

        // ç›´æ¥è§¦å‘æ–‡ä»¶é€‰æ‹©ï¼ˆç›¸å†Œä¼˜å…ˆï¼‰
        fileInput.click();

        // é€‰æ‹©å®Œæˆåæ¢å¤é”®ç›˜æŠ‘åˆ¶ï¼ˆå¯é€‰ï¼‰
        const onChangeOnce = () => {
            suppressVirtualKeyboard = false;
            fileInput.removeEventListener('change', onChangeOnce);
        };
        fileInput.addEventListener('change', onChangeOnce, { once: true });

        // ä¿é™©ï¼š5ç§’åå¼ºåˆ¶æ¢å¤ï¼ˆé˜²æ­¢ç”¨æˆ·å–æ¶ˆï¼‰
        setTimeout(() => {
            suppressVirtualKeyboard = false;
        }, 5000);
    }, 400);
}
function showImageManager(src, dataIndex) {
    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.92);
        display:flex;flex-direction:column;align-items:center;justify-content:center;
        z-index:9999;padding:20px;box-sizing:border-box;
    `;

    overlay.innerHTML = `
        <img src="${src}" style="max-width:100%;max-height:70vh;object-fit:contain;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.6);">
        
        <div style="margin-top:32px;display:flex;gap:20px;">
            <mdui-button variant="filled" id="reselectImageBtn">
                <mdui-icon name="photo_camera"></mdui-icon> é‡æ–°æ‹ç…§
            </mdui-button>
            <mdui-button variant="outlined" color="error" id="previewDeleteImageBtn">
                <mdui-icon name="delete"></mdui-icon> åˆ é™¤å›¾ç‰‡
            </mdui-button>
        </div>
        
        <mdui-button-icon icon="close" style="position:absolute;top:16px;right:16px;color:white;font-size:32px;"
                          onclick="this.closest('div').remove()"></mdui-button>
    `;

    document.body.appendChild(overlay);

    // é‡æ–°é€‰æ‹©ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
    overlay.querySelector('#reselectImageBtn').addEventListener('click', () => {
        overlay.remove();
        suppressVirtualKeyboard = true;
        openEditModal(dataIndex);
        setTimeout(() => {
            const modalContent = document.getElementById('dataSheetContent');
            if (modalContent) modalContent.scrollTop = modalContent.scrollHeight;
            document.getElementById('cardImageInput').click();
            document.getElementById('cardImageInput').addEventListener('change', () => {
                suppressVirtualKeyboard = false;
            }, { once: true });
        }, 400);
    });

// é¢„è§ˆç•Œé¢åˆ é™¤æŒ‰é’® â†’ æ‰“å¼€ç¡®è®¤å¯¹è¯æ¡†å¹¶è®°å½•è¡Œç´¢å¼•
    overlay.querySelector('#previewDeleteImageBtn').addEventListener('click', () => {
        overlay.remove();
        window.tempDeleteImageIndex = dataIndex; // ä¸´æ—¶ä¿å­˜è¦åˆ é™¤çš„è¡Œç´¢å¼•
        const dialog = document.getElementById('deleteImageConfirmDialog');
        if (dialog) {
            dialog.open = true;
        }
    });

    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) overlay.remove();
    });
}
function initTableZoom() {
    const container = document.querySelector('.data-table-container');
    if (!container) return;

    let scale = 1;
    let startDistance = 0;
    let startScale = 1;

    // é¢„å­˜åŸå§‹å°ºå¯¸ï¼ˆå†…å®¹æ›´æ–°æ—¶é‡æ–°æµ‹é‡ï¼‰
    let naturalWidth = 0;
    let naturalHeight = 0;

    const measureNaturalSize = () => {
        const oldTransform = container.style.transform;
        container.style.transform = 'none';
        naturalWidth = container.scrollWidth;
        naturalHeight = container.scrollHeight;
        container.style.transform = oldTransform || 'scale(1)';
    };

    // åˆå§‹æµ‹é‡
    measureNaturalSize();

    const MIN_SCALE = 0.5;
    const MAX_SCALE = 2.0;

    const clamp = (val, min, max) => Math.max(min, Math.min(max, val));

    const getDistance = (t1, t2) => Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);

    const handlePinch = (e) => {
        if (e.touches.length !== 2) {
            if (e.type === 'touchend' || e.type === 'touchcancel') startDistance = 0;
            return;
        }

        e.preventDefault();

        const currentDist = getDistance(e.touches[0], e.touches[1]);

        if (e.type === 'touchstart') {
            startDistance = currentDist;
            startScale = scale;
        } else if (startDistance > 0) {
            const ratio = currentDist / startDistance;
            scale = clamp(startScale * ratio, MIN_SCALE, MAX_SCALE);

            // å®æ—¶åŒæ­¥å®¹å™¨å®é™…å°ºå¯¸
            const newWidth = naturalWidth * scale;
            const newHeight = naturalHeight * scale;

            container.style.width = `${newWidth}px`;
            container.style.height = `${newHeight}px`;
            container.style.transform = `scale(${scale})`;
        }
    };

    // ç»‘å®šäº‹ä»¶ï¼ˆé˜²é‡å¤ï¼‰
    ['touchstart', 'touchmove', 'touchend', 'touchcancel'].forEach(ev => {
        container.removeEventListener(ev, handlePinch, { passive: false });
        container.addEventListener(ev, handlePinch, { passive: false });
    });

    // åŒå‡»è¡¨å¤´é‡ç½®ä¸º 1x
    const thead = document.querySelector('#dataTable thead');
    if (thead) {
        let lastTap = 0;
        thead.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTap < 300) {
                e.preventDefault();
                scale = 1;
                container.style.width = `${naturalWidth}px`;
                container.style.height = `${naturalHeight}px`;
                container.style.transform = 'scale(1)';
            }
            lastTap = now;
        });
    }

    // æ•°æ®æ›´æ–°åé‡æ–°æµ‹é‡ + é‡ç½®ç¼©æ”¾
    const origUpdateTable = window.updateTable;
    window.updateTable = function (...args) {
        origUpdateTable?.apply(this, args);
        setTimeout(() => {
            measureNaturalSize(); // é‡æ–°æµ‹çœŸå®å†…å®¹å°ºå¯¸
            scale = 1;
            container.style.width = `${naturalWidth}px`;
            container.style.height = `${naturalHeight}px`;
            container.style.transform = 'scale(1)';
        }, 150); // ç»™ DOM æ¸²æŸ“ç•™ç‚¹æ—¶é—´
    };

    // åˆå§‹é‡ç½®
    container.style.width = `${naturalWidth}px`;
    container.style.height = `${naturalHeight}px`;
    container.style.transform = 'scale(1)';
}
		document.addEventListener('DOMContentLoaded', () => {
		  initTheme();
		  initEventListeners();
		  //loadData();
		  loadDataFromIndexedDB();
		  updateTable();
		  initAutoCalculate();
		  initCalculatorKeyboard(); 
		  dom.calcDensity.value = 0.00617;
		  initTableZoom(); 
		});
	</script>
</body>
</html>