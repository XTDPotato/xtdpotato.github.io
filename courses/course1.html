<!doctype html>
<html lang="zh-CN" class="mdui-theme-auto">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no"
    />
    <meta name="renderer" content="webkit" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <link rel="stylesheet" href="https://unpkg.com/mdui@2.0.3/mdui.css" />
    <script src="https://unpkg.com/mdui@2.0.3/mdui.global.js"></script>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />

    <link rel="stylesheet" href="../css/markdown.css" />

    <title>MC 基岩版自定义界面 UI</title>

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }

      body {
        overflow-x: hidden;
      }

      .page {
        padding: 14px;
        box-sizing: border-box;
        max-width: 980px;
        margin: 0 auto;
        min-height: 100%;
        padding-bottom: 24px;
      }

      .hero-title {
        margin: 0;
        font-size: 20px;
        font-weight: 800;
      }

      .hero-desc {
        margin: 8px 0 0 0;
        opacity: 0.86;
        line-height: 1.6;
      }

      .meta-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 10px;
      }

      .md-card {
        padding: 14px;
      }
    </style>
  </head>

  <body>
    <div class="page">
      <mdui-card variant="outlined" style="width: 100%">
        <div class="md-card">
          <div class="mdui-prose">
            <h2 class="hero-title">MC 基岩版自定义界面 UI</h2>
            <p class="hero-desc">绑定 NPC 对话（Dialogue）视图，以及在服务端触发并显示自定义 UI。</p>
          </div>
          <div class="meta-row">
            <mdui-chip icon="tips_and_updates" variant="tonal">教程</mdui-chip>
            <mdui-chip icon="code" variant="tonal">示例驱动</mdui-chip>
            <mdui-chip icon="school" variant="tonal">从 0 到可跑</mdui-chip>
          </div>
          <div style="height: 12px"></div>
          <mdui-button
            href="https://d.feiliupan.com/t/83696425556250624/xtdpotato/自定义NPC界面绑定.mcaddon.zip"
            target="_blank"
            variant="tonal"
            full-width
            >下载示例（mcaddon）</mdui-button
          >
        </div>
      </mdui-card>

      <div style="height: 12px"></div>

      <mdui-card variant="outlined" style="width: 100%">
        <div class="md-card">
          <div id="courseBody" class="markdown-body"></div>
        </div>
      </mdui-card>
    </div>

    <script src="../js/markdown.js"></script>
    <script>
      const PRIMARY_KEY = "xtd_theme_primary";

      function applyColorScheme(color) {
        if (!color || !/^#[0-9a-fA-F]{6}$/.test(color)) return;
        if (window.mdui?.setColorScheme) window.mdui.setColorScheme(color);
      }

      const savedPrimary = localStorage.getItem(PRIMARY_KEY);
      if (savedPrimary) applyColorScheme(savedPrimary);

      window.addEventListener("message", (event) => {
        const data = event?.data;
        if (!data || data.type !== "theme:primary") return;
        const color = data.color;
        if (!color || !/^#[0-9a-fA-F]{6}$/.test(color)) return;
        localStorage.setItem(PRIMARY_KEY, color);
        applyColorScheme(color);
      });

      const md = `
## 你将学到什么

- 认识「对话（Dialogue）」与「表单（Form）」两套 UI 思路的区别
- 用一套**可维护**的方式组织 UI：资源文件、命名规则、版本管理
- 让服务端在合适的时机把 UI 发给玩家，并处理玩家选择

> 说明：不同服务端/插件框架（BDS + 插件、LLSE、其他服务端）API 不同。本文用「通用流程」讲清楚怎么拆分与落地，你需要把“发 UI / 收结果”的 API 换成你所用框架的调用方式。

---

## 基本概念（先把名词对齐）

### Dialogue（对话）

- 更像“NPC 对话树”：你点选项 → 下一句/触发指令
- 适合：任务引导、剧情对话、简单选项

### Server Form（服务端表单）

- 更像“服务端弹窗 UI”：按钮/输入框/列表等
- 适合：菜单、配置页、传送、商店、设置

---

## 推荐的目录结构（示例）

\`\`\`
BP/
  dialogs/
    npc_dialog_guide.json
  ui/
    ui_main.json
  scripts/
    ui/
      open-ui.js
\`\`\`

关键点：

- 文件名要能看懂用途：\`npc_dialog_guide\`、\`ui_main\`
- 同一功能的 UI 资源放同一目录，便于迁移与排查
- UI 入口只留一个（例如 \`open-ui.js\`），后续扩展不会失控

---

## Part A：给指定 Dialogue 绑定“视图”

### 1. 定义对话内容（对话树）

建议先写出一个“最小可用”对话树：

- 1 句欢迎词
- 2 个选项：打开菜单 / 关闭

然后再逐步加分支，不要一口气把剧情写完。

### 2. 绑定触发点（关键）

你需要一个“事件”把对话选项与“打开 UI”连起来：

- 选项点击后触发指令 / 触发脚本事件
- 脚本事件里调用「打开表单」

伪代码（示意）：

\`\`\`
onDialogueOption("open_menu"):
  openServerForm(player, "main_menu")
\`\`\`

---

## Part B：让 ServerForm 显示自定义 UI

### 1. 设计 UI 的“数据结构”

先把 UI 当成数据来写：标题、描述、按钮数组。

\`\`\`
{
  "title": "主菜单",
  "buttons": [
    { "text": "传送" },
    { "text": "设置" }
  ]
}
\`\`\`

### 2. 在服务端“发出 UI”

推荐封装一个统一入口，做到：

- 任何地方都只调用 \`openMainMenu(player)\`
- 内部负责组装 UI + 调用框架 API
- 出问题好定位，换框架也好迁移

伪代码（示意）：

\`\`\`
function openMainMenu(player):
  form = buildForm("主菜单", buttons)
  sendForm(player, form, (result) => {
    if (result.cancelled) return
    if (result.index == 0) openTeleport(player)
    if (result.index == 1) openSettings(player)
  })
\`\`\`

---

## 常见坑（排错清单）

- UI 点了没反应：检查“回调”是否被覆盖 / 事件名是否一致
- 只有部分玩家能打开：检查权限判断与玩家对象是否为空
- UI 切换闪屏/卡顿：减少一次打开里加载的资源量，拆分成多页
- 文本乱码：统一 UTF-8，避免混用编码

---

## 下一步（建议增强）

1. 给每个 UI 加一个 \`id\` 与版本号，避免后续改动难追踪
2. 为“按钮索引”做枚举映射，避免写一堆 \`if (index==...)\`
3. 做一个“返回”栈（上一页/主页），体验会好很多
`;

      const courseBody = document.getElementById("courseBody");
      if (courseBody && window.XTDMarkdown?.renderMarkdown) {
        courseBody.innerHTML = window.XTDMarkdown.renderMarkdown(md);
      }
    </script>
  </body>
</html>
